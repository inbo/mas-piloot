---
title: "Modelleren en distance sampling Gele kwikstaart"
author: "Ward Langeraert, Hans Van Calster"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
renv::restore()
library(Distance)
library(Hmisc)
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE)
opts_knit$set(root.dir = here::here())
library(tidyverse)
library(sf)
library(lubridate)
library(targets)
library(terra)
library(brms)
targets_store <- here("src", "targets", "mas_steekproef_pilootfase", "_targets")
source(here("src", "R", "berekening_hulpvariabelen.R"))
source(here("src", "R", "wfs_wcs.R"))
```


# Inlezen data

```{r ronde-intervallen}
r1_start <- "04-01"
r1_stop <- "04-20"
r2_start <- "04-21"
r2_stop <- "05-10"
r3_start <- "05-11"
r3_stop <- "06-10"
r4_start <- "06-21"
r4_stop <- "07-15"
```

```{r inlezen-mas-data}
mas <- read_sf(
  here("data/mas/20220906_qgis_export_sovon_wfs.gpkg")) %>%
  mutate(
    datum = ymd(paste(jaar, maand, dag, sep = "-")),
    periode_in_jaar = case_when(
      datum %within% interval(
        ymd(paste(jaar, r1_start, sep = "-")),
        ymd(paste(jaar, r1_stop, sep = "-"))) ~ "R1",
      datum %within% interval(
        ymd(paste(jaar, r2_start, sep = "-")),
        ymd(paste(jaar, r2_stop, sep = "-"))) ~ "R2",
      datum %within% interval(
        ymd(paste(jaar, r3_start, sep = "-")),
        ymd(paste(jaar, r3_stop, sep = "-"))) ~ "R3",
      datum %within% interval(
        ymd(paste(jaar, r4_start, sep = "-")),
        ymd(paste(jaar, r4_stop, sep = "-"))) ~ "R4"
    ))
```

```{r design2022}
design2022 <- read_csv(here(
    "data",
    "processed",
    "steekproef_piloot_avimap.csv")) %>%
  select(plotnaam = definitief_punt,
         regio,
         stratum) %>%
  mutate(openheid = ifelse(grepl("HOL", stratum), "HOL", "OL"),
         sbp = ifelse(grepl("binnen", stratum), "binnen", "buiten"),
         stratum = gsub("L\\s{1}", "L\\\n", stratum))
```

```{r design-2018-2022}
telpunten_avimap_2021 <- read_sf(
  here("data", "mas",
       "avimap_514_0_MAS_Werkgroep_Grauwe_Kiekendief_Belgi__telpunten_xy.shp")
) %>%
  rename(teller_2021 = teller) %>%
  mutate(
    regio = ifelse(is.na(regio), "Vlaanderen - Bilzen", regio),
    type_teller_2021 = case_when(
      teller_2021 %in% c("WVNT00", "JJNN16", "NOVN00") |
        regio == "Vlaanderen - Leefdaal" ~ "professioneel",
      is.na(teller_2021) &
        regio != "Vlaanderen - Leefdaal" ~ "niet geteld in 2021",
      TRUE ~ "vrijwilliger")) %>%
  select(-st_x, -st_y)

perimeters <- read_sf(
  here("data", "processed", "piloot_perimeters.gpkg"))

vlaanderen <- get_feature_wfs(
  wfs = "https://eservices.minfin.fgov.be/arcgis/services/R2C/Regions/MapServer/WFSServer",
  layername = "regions",
  crs = "EPSG:31370",
  filter = "<Filter><PropertyIsEqualTo><PropertyName>regions:NameDUT</PropertyName><Literal>'Vlaams Gewest'</Literal></PropertyIsEqualTo></Filter>") %>%
  select(NameDUT)


sbp_akkervogels <- tar_read(sbp_akkervogels,
                            store = targets_store)

design_2018_2021 <- add_openheid_landschap_to_frame(
  path = here("data", "dem",
    "openness300m_chm_res25_c300_mean_vlaanderen.tif"),
  punten_sf = telpunten_avimap_2021,
  gebied = vlaanderen,
  cutlevels = c(1.25, 1.35, 1.51),
  class_labels = c("GL", "HGL", "HOL", "OL")) %>%
  select(plotnaam = naam, regio, openheid = openheid_klasse) %>%
  mutate(sbp = st_intersects(.,
                             st_union(sbp_akkervogels),
                             sparse = FALSE) %>%
           as.logical(),
         sbp = ifelse(sbp, "binnen", "buiten")
  ) %>%
  st_drop_geometry() %>%
  mutate(stratum = paste0(openheid, "\n", sbp, " plan"),
         regio = gsub("Vlaanderen - ", "", regio),
         regio = ifelse(regio == "Leemstreek", "Oostelijke leemstreek", regio))
 
plotlijst_2018_2022 <- mas %>%
  st_drop_geometry() %>%
  distinct(plotnaam) %>%
  arrange(plotnaam)

design_2018_2022 <- bind_rows(
  design_2018_2021,
  design2022) %>%
  distinct() %>%
  arrange(plotnaam)
# er zitten duplos in (zie volgende chunk)
```

```{r probleemgevallen, eval=FALSE}
# probleemgevallen met verschillende classificatie
is_duplo <- duplicated(design_2018_2022$plotnaam)
duplo_plotnaam <- design_2018_2022 %>%
  select(plotnaam) %>%
  filter(is_duplo)
design_2018_2022 %>%
  inner_join(duplo_plotnaam) %>%
  View()

# volgens bestand buiten plan, maar lijkt niet te kloppen
# iets mis in targets analyse pipeline?
avimap <- telpunten_avimap_2021 %>%
  filter(naam == "VL0003")

read_csv(here(
    "data",
    "processed",
    "steekproef_piloot_avimap.csv")) %>%
  filter(definitief_punt == "VL0003") %>%
  st_as_sf(coords = c("X", "Y"), crs = 31370) %>%
  mapview::mapview()  +
  mapview::mapview(sbp_akkervogels, col.regions = "yellow") +
  mapview::mapview(avimap)

read_csv(here(
    "data",
    "processed",
    "steekproef_piloot_avimap.csv")) %>%
  inner_join(duplo_plotnaam, by = c("definitief_punt" = "plotnaam")) %>%
  st_as_sf(coords = c("X", "Y"), crs = 31370) %>%
  mapview::mapview()  +
  mapview::mapview(sbp_akkervogels, col.regions = "yellow")
```

```{r omzeilen-probleemgevallen}
# probleemgevallen voorlopig omzeilen
design_2018_2022 <- bind_rows(
  design_2018_2021,
  design2022 %>%
    filter(!grepl("^VL", plotnaam))) %>%
  distinct() %>%
  arrange(plotnaam)
```


```{r overzicht-data, eval=FALSE}
head(mas)
summary(mas)
glimpse(mas)
```

Dubbeltellingen zijn eruit (soort gezien op meerdere teldagen binnen eenzelfde telperiode): in dat geval de laatste teldag genomen.

```{r check-dubbeltelling}
dubbels <- mas %>%
  st_drop_geometry() %>%
  group_by(plotid, jaar, periode_in_jaar, soortnr) %>%
  summarize(aantal_teldagen = n_distinct(doy),
            .groups = "drop") %>%
  filter(aantal_teldagen > 1)
# kan zowel zelfde waarnemer als andere waarnemer zijn

mas_clean <- mas %>%
  semi_join(dubbels, by = c("plotid", "jaar", "periode_in_jaar")) %>%
  group_by(plotid, jaar, periode_in_jaar) %>%
  filter(doy == max(doy)) %>%
  ungroup() %>%
  bind_rows(mas %>%
              anti_join(dubbels, by = c("plotid", "jaar", "periode_in_jaar")))
```


# Gele kwikstaart 2022

We starten met een beperkte dataset om het aantal broedparen van de Gele kwikstaart te modelleren. We beginnen met data exploratie en bouwen dan verschillende modellen op van simpel naar meer complexe modellen. 

We selecteren de data voor Gele kwikstaart van 2022 met broedcode > 0. Voorlopig houden we geen rekening met detectiekans. We sommen de aantallen op per plot per telperiode (elke plot is 1x per telperiode bezocht). Opmerking: wat met *Gele kwikstaart (spec)*?

```{r selectie-gelekwik-2022}
gele_kwik_2022_presences <- mas_clean %>% 
  st_drop_geometry() %>%
  filter(naam == "Gele Kwikstaart", jaar == 2022, 
         !is.na(periode_in_jaar), wrntype > 0L) %>%  
  inner_join(design2022, by = "plotnaam") # Moeren en Leemstreek

# Totale lijst van bezochte plots in 2022
bezoekenlijst_2022 <- design2022 %>% 
  expand_grid(distinct(mas_clean, periode_in_jaar)) %>% # Voeg telperiodes toe
  filter(!is.na(periode_in_jaar))

# Voeg afwezigheden toe door te mergen met alle bezoeken
gele_kwik_2022 <- gele_kwik_2022_presences %>%
  group_by(plotnaam, periode_in_jaar) %>%
  summarise(aantal = sum(aantal)) %>% # Som aantallen gespot per dag 
  full_join(bezoekenlijst_2022, by = c("plotnaam", "periode_in_jaar")) %>%
  replace(is.na(.), 0) %>%
  arrange(plotnaam, periode_in_jaar)
```


## Data exploratie

Enkele samenvattende statistieken:

```{r stats-aantallen-nodist}
gele_kwik_2022 %>%
  group_by(regio, periode_in_jaar) %>%
  summarise(min = min(aantal), 
            mediaan = median(aantal),
            gemiddelde = mean(aantal),
            max = max(aantal),
            varantie = var(aantal)) %>%
  kable()
```

Aantal tellingen per categorie:

```{r tellingen-aantallen-nodist}
gele_kwik_2022 %>%
  group_by(regio, periode_in_jaar, aantal) %>%
  summarise(n = n(), .groups = "drop") %>%
  arrange(aantal) %>%
  pivot_wider(names_from = aantal, values_from = n) %>%
  replace(is.na(.), 0) %>%
  kable()
```

Verdeling van de tellingen:

```{r histogram-aantallen-nodist}
gele_kwik_2022 %>%
  group_by(regio, periode_in_jaar, aantal) %>%
  summarise(n = n(), .groups = "drop_last") %>%
  ggplot(aes(x = aantal, y = n, fill = regio)) +
    geom_histogram(stat = "identity", col = "black") +
    theme(panel.grid.minor.x = element_blank(),
          panel.grid.major.x = element_blank()) + 
    facet_wrap(~periode_in_jaar, scales = "free") +
    labs(y = "", x = "Aantal Gele kwikstaarten")
```

Totaal aantal getelde Gele kwikstaarten per telcirkel met aanduiding van gemiddelde en 95% bootstrap betrouwbaarheidsinterval.

```{r boxplots-aantallen-nodist}
gele_kwik_2022 %>%
  ggplot(aes(x = periode_in_jaar, y = aantal, colour = periode_in_jaar)) +
  stat_sum(position = position_dodge(width = 0.5), alpha = 0.5) +
  stat_summary(fun.data = mean_cl_boot,
               position = position_dodge(width = 0.5),
               fatten = 4, shape = "square") +
  facet_wrap(~regio) +
  labs(y = "Aantal Gele kwikstaarten", x = "Telperiode")
```


## Modellen
### Generalized linear mixed models

Met deze data fitten we een model waarbij de aantallen Gele kwikstaarten per telcirkel afhangen van regio en een effect van tijdstip van de telling in 2022. Als random effect wordt de plot in het model gestoken om rekening te houden met gepaardheid van de waarnemingen doorheen het jaar. 

We vergelijken vier modellen met verschillende verdelingsassumpties gebruikmakend van 5-fold cross validation (leave one out CV en WAIC berekenen niet mogelijk):

1. Poisson
2. Negative binomial
3. Zero-inflated Poisson
4. Zero-inflated Negative binomial

```{r fit-GLMMs, results=FALSE, fig.show='hide'}
# Save brms models to this path
model_path <- "./src/markdown/mas/brms_models/"

# MCMC parameters
nchains <- 3
niter <- 4000
burnin <- niter / 2
nparallel <- nchains

# 1. Poisson
brmpois1 <- brm(bf(aantal ~ regio + periode_in_jaar + (1 | plotnaam)), 
               data = gele_kwik_2022, family = poisson(), 
               chains = nchains, warmup = burnin, iter = niter, 
               cores = nparallel, sample_prior = "only",
               file = paste0(model_path, "brmpois1"), 
               file_refit = "on_change")
summary(brmpois1)
plot(brmpois1)

# 2. Negative binomial
brmnegbin1 <- brm(bf(aantal ~ regio + periode_in_jaar + (1 | plotnaam)), 
                 data = gele_kwik_2022, family = negbinomial(), 
                 chains = nchains, warmup = burnin, iter = niter, 
                 cores = nparallel, sample_prior = "only",
                 file = paste0(model_path, "brmnegbin1"), 
                 file_refit = "on_change")
summary(brmnegbin1)
plot(brmnegbin1)

# 3. Zero-inflated Poisson
brmZIP1 <- brm(bf(aantal ~ regio + periode_in_jaar + (1 | plotnaam)), 
               data = gele_kwik_2022, family = zero_inflated_poisson(), 
               chains = nchains, warmup = burnin, iter = niter, 
               cores = nparallel, sample_prior = "only",
               file = paste0(model_path, "brmZIP1"), 
               file_refit = "on_change")
summary(brmZIP1)
plot(brmZIP1)

# 4. Zero-inflated Negative binomial
brmZINB1 <- brm(bf(aantal ~ regio + periode_in_jaar + (1 | plotnaam)), 
               data = gele_kwik_2022, family = zero_inflated_negbinomial(), 
               chains = nchains, warmup = burnin, iter = niter, 
               cores = nparallel, sample_prior = "only",
               file = paste0(model_path, "brmZINB1"), 
               file_refit = "on_change")
summary(brmZINB1)
plot(brmZINB1)
```

Convergentie voor alle modellen ok (scale reduction factors, trace plots, posterior density).

Eerst worden de gegevens opgedeeld in $K$ delen (subsets) van gelijke (of zo goed mogelijk gelijke) grootte. Vervolgens wordt het model $K$ keer gefit, waarbij telkens een van de $K$ subsets wordt weggelaten. We stratificeren volgens regio. Hierbij wordt er voor gezorgt dat relatieve frequenties per regio bij benadering behouden blijven.

```{r k-foldCV-GLMMs}
if (!file.exists(paste0(model_path, "fit_brmpois1.rds"))) {
  fit_brmpois1 <- add_criterion(brmpois1, c("kfold"), K = 5, 
                                folds = "stratified", group = "regio", 
                                file = paste0(model_path, "fit_brmpois1"))
  fit_brmnegbin1 <- add_criterion(brmnegbin1, c("kfold"), K = 5, 
                                folds = "stratified", group = "regio", 
                                file = paste0(model_path, "fit_brmnegbin1"))
  fit_brmZIP1 <- add_criterion(brmZIP1, c("kfold"), K = 5, 
                                folds = "stratified", group = "regio", 
                                file = paste0(model_path, "fit_brmZIP1"))
  fit_brmZINB1 <- add_criterion(brmZINB1, c("kfold"), K = 5, 
                                folds = "stratified", group = "regio",
                                file = paste0(model_path, "fit_brmZINB1"))
} else {
  fit_brmpois1 <- readRDS(paste0(model_path, "fit_brmpois1.rds"))
  fit_brmnegbin1 <- readRDS(paste0(model_path, "fit_brmnegbin1.rds"))
  fit_brmZIP1 <- readRDS(paste0(model_path, "fit_brmZIP1.rds"))
  fit_brmZINB1 <- readRDS(paste0(model_path, "fit_brmZINB1.rds"))
}

comparisons <- loo_compare(fit_brmpois1, fit_brmnegbin1, fit_brmZIP1, 
                           fit_brmZINB1, criterion = "kfold")[, c(1, 2)] %>%
                as.data.frame() %>%
                mutate(model = rev(c("Poisson", "Negative binomial", 
                                     "Zero-inflated Poisson", 
                                     "Zero-inflated Negative binomial")))
```

```{r table-CV-GLMMs}
rbind(fit_brmpois1$criteria$kfold$estimates[, "Estimate"],
  fit_brmnegbin1$criteria$kfold$estimates[, "Estimate"],
  fit_brmZIP1$criteria$kfold$estimates[, "Estimate"], 
  fit_brmZINB1$criteria$kfold$estimates[, "Estimate"]
  ) %>%
  as.data.frame() %>%
  mutate(model = c("Poisson", "Negative binomial", 
                   "Zero-inflated Poisson", 
                   "Zero-inflated Negative binomial")) %>%
  full_join(comparisons, by = "model") %>%
  select(model, everything()) %>%
  kable(digits = 3)
```

Het Zero-inflated Negative binomial model toont de beste fit. Dat zien we ook bij de posterior predictive check. We vergelijken de waargenomen tellingen met gesimuleerde tellingen van de posterior predictive distribution.


```{r ppcheck-final-GLMM}
pp_check(fit_brmZINB1, ndraws = 100)

pp_check(fit_brmZINB1, type = "bars_grouped", ndraws = 100, group = "regio",
         facet_args = list(ncol = 1, scales = "free_y"))

pp_check(fit_brmZINB1, type = "bars_grouped", ndraws = 100, 
         group = "periode_in_jaar",
         facet_args = list(ncol = 1, scales = "free_y"))
```

Overzicht van de gefitte modelparameters, hun onzekerheid en enkele maten die aangeven of het model geconvergeerd is.

```{r parameters-final-GLMM}
summary(brmZINB1)
```

Visualisatie van de modelpredicties voor de verschillende regios en telperiodes.

```{r prediction-plots-final-GLMM}
pred <- conditional_effects(brmZINB1, effects = c("regio:periode_in_jaar"))

cirkelopp <- pi * 300^2
plot(pred, plot = FALSE)[[1]] + 
  scale_y_continuous(sec.axis = sec_axis( ~. / cirkelopp * 1e6, 
                      name = "Aantal Gele kwikstaarten per 100 ha")) +
  labs(y = "Aantal Gele kwikstaarten", x = "Regio")
```

Testen van een hypothese bv.: Is het gemiddeld aantal Gele kwikstaarten significant lager in de Oostelijke leemstreek dan in De Moeren?

Nulhypothese:

\begin{aligned}
  &\frac{\exp(\beta_0) + \exp(\beta_0 + \beta_2) + \exp(\beta_0 + \beta_3) + \exp(\beta_0 + \beta_4)}{4} > \frac{\exp(\beta_0 + \beta_1) + \exp(\beta_0 + \beta_1 + \beta_2) + \exp(\beta_0 + \beta_1 + \beta_3) + \exp(\beta_0 + \beta_1 + \beta_4)}{4}\\
  &\Rightarrow \exp(\beta_0)(\exp(\beta_2) + \exp(\beta_3) + \exp(\beta_4)) > \exp(\beta_0)\exp(\beta_1)(\exp(\beta_2) + \exp(\beta_3) + \exp(\beta_4))\\
  &\Rightarrow \exp(\beta_1) < 1\\
  &\Rightarrow \beta_1 < 0
\end{aligned}

```{r hypothesis-regio}
hyp1 <- hypothesis(
  x = brmZINB1,
  "regioOostelijkeleemstreek < 0",
  class = "b", alpha = 0.05)
hyp1
plot(hyp1)
```

De evidence ratio is groot wat er op duidt dat er gemiddeld gezien een significant hoger aantal Gele kwikstaarten in De Moeren aanwezig zijn. De evidence ratio is de verhouding tussen posterior probability a < b t.o.v. posterior probability a > b. De schatting is -0.47. Dit is een verschil in de log-schaal, dus als we dit exponentiëren bekomen we 0.63 keer minder Gele kwikstaarten in de Oostelijke leemstreek dan in De Moeren.

Het toevoegen van een interactie `regio:periode_in_jaar` blijkt geen meerwaarde voor het model: interactieparameters niet significant verschillend van nul en elpd_diff = -23.4 voor interactiemodel (resultaten niet getoond).


### Distance sampling

In de GLMM's houden we echter geen rekening met een afnemende detectiekans naarmate de dieren zich verder bevinden. In voorgaande sectie hadden we de data geaggregeerd per telcirkel per telperiode, in deze sectie werken we met de directe observaties: waarnemingen van $n$ aantal Gele kwikstaarten op een afstand van $x$ meter van het telpunt per telperiode in 2022.

```{r data-dist}
gele_kwik_2022_distance <- gele_kwik_2022_presences %>%
  # Add absences
  full_join(bezoekenlijst_2022, by = c("plotnaam", "periode_in_jaar", "regio", 
                                       "stratum", "openheid", "sbp")) %>%
  # Replace NA's by 0's
  mutate(aantal = ifelse(is.na(aantal), 0, aantal)) %>%
  arrange(plotnaam, periode_in_jaar)
```

Wat is de verdeling van de geregistreerde afstanden?

```{r tabel-dist}
gele_kwik_2022_distance %>%
  group_by(regio, periode_in_jaar) %>%
  summarise(min = min(distance2plot, na.rm = T), 
            mediaan = median(distance2plot, na.rm = T),
            gemiddelde = mean(distance2plot, na.rm = T),
            max = max(distance2plot, na.rm = T),
            varantie = var(distance2plot, na.rm = T)) %>%
  kable(digits = 1)
```

```{r histogram-dist}
gele_kwik_2022_distance %>%
  ggplot() +
    geom_histogram(aes(x = distance2plot, fill = periode_in_jaar)) +
    facet_wrap(~regio) +
    labs(y = "Aantal tellingen van Gele kwikstaart", x = "Afstand",
         title = "2022")
```



welke afstand absences?


```{r}
dsmodel <- ds(gele_kwik_2022_distance$distance2plot, key = "hn", 
              adjustment = NULL, truncation = 300)
plot(dsmodel)
```

