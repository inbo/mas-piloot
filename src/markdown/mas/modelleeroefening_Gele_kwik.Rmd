---
title: "Modelleren en distance sampling Gele kwikstaart"
author: "Ward Langeraert, Hans Van Calster"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
renv::restore()
library(Distance)
library(Hmisc)
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE)
opts_knit$set(root.dir = here::here())
library(tidyverse)
library(sf)
library(lubridate)
library(targets)
library(terra)
library(brms)
targets_store <- here("src", "targets", "mas_steekproef_pilootfase", "_targets")
source(here("src", "R", "berekening_hulpvariabelen.R"))
source(here("src", "R", "wfs_wcs.R"))
```


# Inlezen data

```{r ronde-intervallen}
r1_start <- "04-01"
r1_stop <- "04-20"
r2_start <- "04-21"
r2_stop <- "05-10"
r3_start <- "05-11"
r3_stop <- "06-10"
r4_start <- "06-21"
r4_stop <- "07-15"
```

```{r inlezen-mas-data}
mas <- read_sf(
  here("data/mas/20220906_qgis_export_sovon_wfs.gpkg")) %>%
  mutate(
    datum = ymd(paste(jaar, maand, dag, sep = "-")),
    periode_in_jaar = case_when(
      datum %within% interval(
        ymd(paste(jaar, r1_start, sep = "-")),
        ymd(paste(jaar, r1_stop, sep = "-"))) ~ "R1",
      datum %within% interval(
        ymd(paste(jaar, r2_start, sep = "-")),
        ymd(paste(jaar, r2_stop, sep = "-"))) ~ "R2",
      datum %within% interval(
        ymd(paste(jaar, r3_start, sep = "-")),
        ymd(paste(jaar, r3_stop, sep = "-"))) ~ "R3",
      datum %within% interval(
        ymd(paste(jaar, r4_start, sep = "-")),
        ymd(paste(jaar, r4_stop, sep = "-"))) ~ "R4"
    ))
```

```{r design2022}
design2022 <- read_csv(here(
    "data",
    "processed",
    "steekproef_piloot_avimap.csv")) %>%
  select(plotnaam = definitief_punt,
         regio,
         stratum) %>%
  mutate(openheid = ifelse(grepl("HOL", stratum), "HOL", "OL"),
         sbp = ifelse(grepl("binnen", stratum), "binnen", "buiten"),
         stratum = gsub("L\\s{1}", "L\\\n", stratum))
```

```{r design-2018-2022}
telpunten_avimap_2021 <- read_sf(
  here("data", "mas",
       "avimap_514_0_MAS_Werkgroep_Grauwe_Kiekendief_Belgi__telpunten_xy.shp")
) %>%
  rename(teller_2021 = teller) %>%
  mutate(
    regio = ifelse(is.na(regio), "Vlaanderen - Bilzen", regio),
    type_teller_2021 = case_when(
      teller_2021 %in% c("WVNT00", "JJNN16", "NOVN00") |
        regio == "Vlaanderen - Leefdaal" ~ "professioneel",
      is.na(teller_2021) &
        regio != "Vlaanderen - Leefdaal" ~ "niet geteld in 2021",
      TRUE ~ "vrijwilliger")) %>%
  select(-st_x, -st_y)

perimeters <- read_sf(
  here("data", "processed", "piloot_perimeters.gpkg"))

vlaanderen <- get_feature_wfs(
  wfs = "https://eservices.minfin.fgov.be/arcgis/services/R2C/Regions/MapServer/WFSServer",
  layername = "regions",
  crs = "EPSG:31370",
  filter = "<Filter><PropertyIsEqualTo><PropertyName>regions:NameDUT</PropertyName><Literal>'Vlaams Gewest'</Literal></PropertyIsEqualTo></Filter>") %>%
  select(NameDUT)


sbp_akkervogels <- tar_read(sbp_akkervogels,
                            store = targets_store)

design_2018_2021 <- add_openheid_landschap_to_frame(
  path = here("data", "dem",
    "openness300m_chm_res25_c300_mean_vlaanderen.tif"),
  punten_sf = telpunten_avimap_2021,
  gebied = vlaanderen,
  cutlevels = c(1.25, 1.35, 1.51),
  class_labels = c("GL", "HGL", "HOL", "OL")) %>%
  select(plotnaam = naam, regio, openheid = openheid_klasse) %>%
  mutate(sbp = st_intersects(.,
                             st_union(sbp_akkervogels),
                             sparse = FALSE) %>%
           as.logical(),
         sbp = ifelse(sbp, "binnen", "buiten")
  ) %>%
  st_drop_geometry() %>%
  mutate(stratum = paste0(openheid, "\n", sbp, " plan"),
         regio = gsub("Vlaanderen - ", "", regio),
         regio = ifelse(regio == "Leemstreek", "Oostelijke leemstreek", regio))
 
plotlijst_2018_2022 <- mas %>%
  st_drop_geometry() %>%
  distinct(plotnaam) %>%
  arrange(plotnaam)

design_2018_2022 <- bind_rows(
  design_2018_2021,
  design2022) %>%
  distinct() %>%
  arrange(plotnaam)
# er zitten duplos in (zie volgende chunk)
```

```{r probleemgevallen, eval=FALSE}
# probleemgevallen met verschillende classificatie
is_duplo <- duplicated(design_2018_2022$plotnaam)
duplo_plotnaam <- design_2018_2022 %>%
  select(plotnaam) %>%
  filter(is_duplo)
design_2018_2022 %>%
  inner_join(duplo_plotnaam) %>%
  View()

# volgens bestand buiten plan, maar lijkt niet te kloppen
# iets mis in targets analyse pipeline?
avimap <- telpunten_avimap_2021 %>%
  filter(naam == "VL0003")

read_csv(here(
    "data",
    "processed",
    "steekproef_piloot_avimap.csv")) %>%
  filter(definitief_punt == "VL0003") %>%
  st_as_sf(coords = c("X", "Y"), crs = 31370) %>%
  mapview::mapview()  +
  mapview::mapview(sbp_akkervogels, col.regions = "yellow") +
  mapview::mapview(avimap)

read_csv(here(
    "data",
    "processed",
    "steekproef_piloot_avimap.csv")) %>%
  inner_join(duplo_plotnaam, by = c("definitief_punt" = "plotnaam")) %>%
  st_as_sf(coords = c("X", "Y"), crs = 31370) %>%
  mapview::mapview()  +
  mapview::mapview(sbp_akkervogels, col.regions = "yellow")
```

```{r omzeilen-probleemgevallen}
# probleemgevallen voorlopig omzeilen
design_2018_2022 <- bind_rows(
  design_2018_2021,
  design2022 %>%
    filter(!grepl("^VL", plotnaam))) %>%
  distinct() %>%
  arrange(plotnaam)
```


```{r overzicht-data, eval=FALSE}
head(mas)
summary(mas)
glimpse(mas)
```

Dubbeltellingen zijn eruit (soort gezien op meerdere teldagen binnen eenzelfde telperiode): in dat geval de laatste teldag genomen.

```{r check-dubbeltelling}
dubbels <- mas %>%
  st_drop_geometry() %>%
  group_by(plotid, jaar, periode_in_jaar, soortnr) %>%
  summarize(aantal_teldagen = n_distinct(doy),
            .groups = "drop") %>%
  filter(aantal_teldagen > 1)
# kan zowel zelfde waarnemer als andere waarnemer zijn

mas_clean <- mas %>%
  semi_join(dubbels, by = c("plotid", "jaar", "periode_in_jaar")) %>%
  group_by(plotid, jaar, periode_in_jaar) %>%
  filter(doy == max(doy)) %>%
  ungroup() %>%
  bind_rows(mas %>%
              anti_join(dubbels, by = c("plotid", "jaar", "periode_in_jaar")))
```


# Gele kwikstaart 2022

We starten met een beperkte dataset om het aantal broedparen van de Gele kwikstaart te modelleren. We beginnen met data exploratie en bouwen dan verschillende modellen op van simpel naar meer complexe modellen. 

We selecteren de data voor Gele kwikstaart van 2022 met broedcode > 0. Voorlopig houden we geen rekening met detectiekans. We sommen de aantallen op per plot per telperiode (elke plot is 1x per telperiode bezocht). Opmerking: wat met *Gele kwikstaart (spec)*?

```{r selectie-gelekwik-2022}
gele_kwik_2022_presences <- mas_clean %>% 
  st_drop_geometry() %>%
  filter(naam == "Gele Kwikstaart", jaar == 2022, 
         !is.na(periode_in_jaar), wrntype > 0L) %>%  
  inner_join(design2022, by = "plotnaam") # Moeren en Leemstreek

# Totale lijst van bezochte plots in 2022
bezoekenlijst_2022 <- design2022 %>% 
  expand_grid(distinct(mas_clean, periode_in_jaar)) %>% # Voeg telperiodes toe
  filter(!is.na(periode_in_jaar))

# Voeg afwezigheden toe door te mergen met alle bezoeken
gele_kwik_2022 <- gele_kwik_2022_presences %>%
  group_by(plotnaam, periode_in_jaar) %>%
  summarise(aantal = sum(aantal)) %>% # Som aantallen gespot per dag 
  full_join(bezoekenlijst_2022, by = c("plotnaam", "periode_in_jaar")) %>%
  replace(is.na(.), 0) %>%
  arrange(plotnaam, periode_in_jaar)
```


## Data exploratie

Enkele samenvattende statistieken:

```{r summary-stats}
gele_kwik_2022 %>%
  group_by(periode_in_jaar) %>%
  summarise(min = min(aantal), 
            mediaan = median(aantal),
            gemiddelde = mean(aantal),
            max = max(aantal),
            varantie = var(aantal)) %>%
  kable()
```

Aantal tellingen per categorie:

```{r tellingen}
gele_kwik_2022 %>%
  group_by(periode_in_jaar, aantal) %>%
  summarise(n = n(), .groups = "drop") %>%
  arrange(aantal) %>%
  pivot_wider(names_from = aantal, values_from = n) %>%
  replace(is.na(.), 0) %>%
  kable()
```

```{r tellingen-regio}
gele_kwik_2022 %>%
  group_by(regio, periode_in_jaar, aantal) %>%
  summarise(n = n(), .groups = "drop") %>%
  arrange(aantal) %>%
  pivot_wider(names_from = aantal, values_from = n) %>%
  replace(is.na(.), 0) %>%
  kable()
```

Verdeling van de tellingen

```{r histogram}
gele_kwik_2022 %>%
  group_by(periode_in_jaar, aantal) %>%
  summarise(n = n(), .groups = "drop_last") %>%
  ggplot(aes(x = aantal, y = n)) +
    geom_histogram(stat = "identity", fill = "orange", col = "black") +
    theme(panel.grid.minor.x = element_blank(),
          panel.grid.major.x = element_blank()) + 
    facet_wrap(~periode_in_jaar, scales = "free") +
    labs(y = "", x = "Aantal Gele kwikstaarten")
```

Totaal aantal getelde Gele kwikstaarten per telcirkel met aanduiding van gemiddelde en 95% bootstrap betrouwbaarheidsinterval.

```{r boxplots}
gele_kwik_2022 %>%
  ggplot(aes(x = periode_in_jaar, y = aantal, colour = periode_in_jaar)) +
  stat_sum(position = position_dodge(width = 0.5), alpha = 0.5) +
  stat_summary(fun.data = mean_cl_boot,
               position = position_dodge(width = 0.5),
               fatten = 4, shape = "square") +
  facet_wrap(~regio) +
  labs(y = "Aantal Gele kwikstaarten", x = "Telperiode")
```


## Modellen

Met deze data fitten we een model waarbij de aantallen Gele kwikstaarten per telcirkel afhangen van regio en een effect van tijdstip van de telling in 2022. Als random effect wordt plotid in het model gestoken om rekening te houden met gepaardheid van de waarnemingen doorheen het jaar. 

We vergelijken vier modellen met verschillende verdelingsassumpties gebruikmakend van 5-fold cross validation (leave one out CV en WAIC berekenen niet mogelijk):
1. Poisson
2. Negative binomial
3. Zero-inflated Poisson
4. Zero-inflated Negative binomial

```{r fit-models, results=FALSE}
brmpois1 <- brm(bf(aantal ~ regio + periode_in_jaar + (1 | plotnaam)), 
               data = gele_kwik_2022, family = poisson(), 
               chains = 3, iter = 3000, cores = 3,
               file = "brmpois1", file_refit = "on_change")
summary(brmpois1)
plot(brmpois1)

brmnegbin1 <- brm(bf(aantal ~ regio + periode_in_jaar + (1 | plotnaam)), 
                 data = gele_kwik_2022, family = negbinomial(), 
               chains = 3, iter = 3000, cores = 3,
               file = "brmnegbin1", file_refit = "on_change")
summary(brmnegbin1)
plot(brmnegbin1)

brmZIP1 <- brm(bf(aantal ~ regio + periode_in_jaar + (1 | plotnaam)), 
              data = gele_kwik_2022, family = zero_inflated_poisson(), 
               chains = 3, iter = 3000, cores = 3,
               file = "brmZIP1", file_refit = "on_change")
summary(brmZIP1)
plot(brmZIP1)

brmZINB1 <- brm(bf(aantal ~ regio + periode_in_jaar + (1 | plotnaam)), 
               data = gele_kwik_2022, family = zero_inflated_negbinomial(), 
               chains = 3, iter = 3000, cores = 3,
               file = "brmZINB1", file_refit = "on_change")
summary(brmZINB1)
plot(brmZINB1)
```

Convergentie voor alle modellen ok.

```{r k-foldCV}
if (!file.exists("fit_brmpois1.rds")) {
  fit_brmpois1 <- add_criterion(brmpois1, c("kfold"), K = 5,
                                file = "fit_brmpois1")
  fit_brmnegbin1 <- add_criterion(brmnegbin1, c("kfold"), K = 5,
                                file = "fit_brmnegbin1")
  fit_brmZIP1 <- add_criterion(brmZIP1, c("kfold"), K = 5,
                                file = "fit_brmZIP1")
  fit_brmZINB1 <- add_criterion(brmZINB1, c("kfold"), K = 5,
                                file = "fit_brmZINB1")
} else {
  fit_brmpois1 <- readRDS("fit_brmpois1.rds")
  fit_brmnegbin1 <- readRDS("fit_brmnegbin1.rds")
  fit_brmZIP1 <- readRDS("fit_brmZIP1.rds")
  fit_brmZINB1 <- readRDS("fit_brmZINB1.rds")
}
```


```{r table-CV}
as_tibble(rbind(c("Poisson", fit_brmpois1$criteria$kfold$estimates[, "Estimate"]),
c("Negative binomial", fit_brmnegbin1$criteria$kfold$estimates[, "Estimate"]),
c("Zero-inflated Poisson", fit_brmZIP1$criteria$kfold$estimates[, "Estimate"]),
c("Zero-inflated Negative binomial", fit_brmZINB1$criteria$kfold$estimates[, "Estimate"]))) %>%
  kable(digits = 3)
```



```{r}
pp_check(brmpois1, type = "bars_grouped", ndraws = 100, group = "regio",
         facet_args = list(ncol = 1, scales = "free_y"))
```



```{r}
pp_check(fit_brmnegbin1, type = "bars_grouped", ndraws = 100, group = "regio",
         facet_args = list(ncol = 1, scales = "free_y"))
```



```{r}
pp_check(fit_brmZIP1, type = "bars_grouped", ndraws = 100, group = "regio",
         facet_args = list(ncol = 1, scales = "free_y"))
```


```{r}
pp_check(fit_brmZINB1, type = "bars_grouped", ndraws = 100, group = "regio",
         facet_args = list(ncol = 1, scales = "free_y"))
```

handige links:
file:///G:/Gedeelde%20drives/PRJ_MAS/project-rapport/verkenning_haas.html
https://www.rensvandeschoot.com/tutorials/brms-started/
https://ourcodingclub.github.io/tutorials/brms/#part2
https://tem11010.github.io/regression_brms/

