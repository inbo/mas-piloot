---
title: "Data exploratie verklarende variabelen"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
bibliography: references.json
---

```{r setup, include=FALSE}
# renv
renv::restore()

# Set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE)
opts_knit$set(root.dir = here())

# Conflicting packages
conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)

# Packages
library(tidyverse)
library(INBOtheme)
library(sf)
```

# Inlezen data

```{r}
data_path <- here("data", "processed")
mas_data_df <- read_csv(here(data_path, "MAS_data_full_2018_2022.csv"))
mas_data_sf <- st_as_sf(mas_data_df, coords = c("x_lambert", "y_lambert"), 
                        crs = 31370)

perimeters <- read_sf(
  here("data", "processed", "piloot_perimeters.gpkg"))
```

# Dataset structuur
## Algemeen

Hoe ziet de dataset eruit?

```{r}
glimpse(mas_data_df)
```

We visualiseren ook de waarnemingen en kleuren hoeveel jaren het telpunt geteld is.

```{r}
visits_per_jaar <- mas_data_sf %>%
  st_drop_geometry() %>%
  group_by(plotnaam) %>%
  mutate(n_per_jaar = n_distinct(jaar)) %>%
  ungroup() %>%
  select(plotnaam, n_per_jaar) %>%
  distinct()

mas_data_sf %>%
  filter(regio == "De Moeren") %>%
  left_join(visits_per_jaar, by = join_by(plotnaam)) %>%
  ggplot() +
    geom_sf(data = perimeters %>% filter(Naam == "De Moeren"), 
            colour = "firebrick") +
    geom_sf(aes(colour = factor(n_per_jaar)), size = 0.5) +
    labs(title = "De Moeren", colour = "aantal jaren\ntelpunt geteld") +
    guides(colour = guide_legend(override.aes = list(size = 3)))
```

```{r}
mas_data_sf %>%
  filter(regio == "Oostelijke leemstreek") %>%
  left_join(visits_per_jaar, by = join_by(plotnaam)) %>%
  ggplot() +
    geom_sf(data = perimeters %>% filter(Naam == "Oostelijke leemstreek"), 
            colour = "firebrick") +
    geom_sf(aes(colour = factor(n_per_jaar)), size = 0.5) +
    labs(title = "Oostelijke leemstreek", 
         colour = "aantal jaren\ntelpunt geteld") +
    guides(colour = guide_legend(override.aes = list(size = 3)))
```

## Aantal tellingen en waarnemingen

Aantal verschillende telpunten geteld per regio, jaar en telperiode.

```{r}
mas_data_df %>%
  group_by(regio, jaar, periode_in_jaar) %>%
  mutate(n_per_telperiode = n_distinct(plotnaam)) %>%
  ungroup() %>%
  group_by(regio, jaar) %>%
  mutate(n_per_jaar = n_distinct(plotnaam)) %>%
  ungroup() %>%
  group_by(regio) %>%
  mutate(n_per_regio = n_distinct(plotnaam)) %>%
  ungroup() %>%
  select(regio, jaar, periode_in_jaar, n_per_telperiode, n_per_jaar,
         n_per_regio) %>%
  distinct() %>%
  arrange(regio, jaar, periode_in_jaar) %>%
  kable()
```

```{r}
mas_data_df %>%
  group_by(regio, jaar, periode_in_jaar) %>%
  mutate(n_per_telperiode = n_distinct(plotnaam)) %>%
  ungroup() %>%
  select(regio, jaar, periode_in_jaar, n_per_telperiode) %>%
  distinct() %>%
  ggplot(aes(x = periode_in_jaar, y = n_per_telperiode, 
             fill = periode_in_jaar)) +
    geom_bar(stat = "identity") +
    facet_grid(regio~jaar, scales = "free_y") +
    labs(x = "telperiode", y = "aantal tellingen") +
    theme(legend.position = "")
```

```{r}
mas_data_df %>%
  group_by(regio, jaar, periode_in_jaar, plotnaam) %>%
  summarise(n = n(), .groups = "drop") %>%
  ggplot(aes(x = periode_in_jaar, y = n, colour = periode_in_jaar)) +
    geom_boxplot() +
    facet_grid(regio~jaar, scales = "free_y") +
    labs(x = "telperiode", y = "aantal waarnemingen") +
    theme(legend.position = "")
```

```{r}
mas_data_df %>%
  filter(aantal < 3000) %>%
  group_by(regio, jaar, periode_in_jaar, plotnaam) %>%
  summarise(n = sum(aantal), .groups = "drop") %>%
  ggplot(aes(x = periode_in_jaar, y = n, colour = periode_in_jaar)) +
    geom_boxplot() +
    facet_grid(regio~jaar, scales = "free_y") +
    labs(x = "telperiode", y = "aantal individuen") +
    theme(legend.position = "")
```


# Univariate exploratie

Niet strikt univariaat. We groeperen de variabelen per regio en indien van toepassing ook nog per jaar en/of telperiode.

## Plot-specifieke variabelen

```{r}
kle_vars <- c("haag", "houtkant", "boom", "bomengroep", "bomenrij", "bosrand")
plot_vars <- c("status_teller", "sbp", "openheid_waarde_1000", "natuur_exp",
               kle_vars)
```

Variabelen eigen aan het telpunt niet variabel over de jaren: `r plot_var_list`.



## Plot-jaar-specifieke variabelen

```{r}
hfdtlt_vars <- sort(names(mas_data_df)[grep("hfdtlt$", names(mas_data_df))])
vrtlt_vars <- sort(names(mas_data_df)[grep("vrtlt$", names(mas_data_df))])
plotyear_vars <- c("area_prop_sb", "area_prop_bo_overig", hfdtlt_vars, 
                   "gewas_div_shannon", "gewas_div_n", vrtlt_vars, 
                   "perceel_median_area", "perceel_iqr_area", "perceel_cv_area",
                   "inertie_sb", "inertie_rest")
```

Variabelen eigen aan het telpunt variabel over de jaren: `r plotyear_vars`.



## Telling-specifieke variabelen

```{r}
telling_vars <- c("n_predators", "n_predators_spec")
```

Variabelen eigen aan de telling: `r telling_vars`.


