---
title: "Data exploratie verklarende variabelen"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
bibliography: references.json
---

```{r setup, include=FALSE}
# renv
renv::restore()

# Set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE)
opts_knit$set(root.dir = here())

# Conflicting packages
conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)

# Packages
library(tidyverse)
library(INBOtheme)
library(sf)
```

# Inlezen data

```{r}
data_path <- here("data", "processed")
mas_data_df <- read_csv(here(data_path, "MAS_data_full_2018_2022.csv"))
mas_data_sf <- st_as_sf(mas_data_df, coords = c("x_lambert", "y_lambert"), 
                        crs = 31370)

perimeters <- read_sf(
  here("data", "processed", "piloot_perimeters.gpkg"))
```

# Dataset structuur
## Algemeen

Hoe ziet de dataset eruit?

```{r}
glimpse(mas_data_df)
```

We visualiseren ook de waarnemingen en kleuren hoeveel jaren het telpunt geteld is.

```{r}
visits_per_jaar <- mas_data_sf %>%
  st_drop_geometry() %>%
  group_by(plotnaam) %>%
  mutate(n_per_jaar = n_distinct(jaar)) %>%
  ungroup() %>%
  select(plotnaam, n_per_jaar) %>%
  distinct()

mas_data_sf %>%
  filter(regio == "De Moeren") %>%
  left_join(visits_per_jaar, by = join_by(plotnaam)) %>%
  ggplot() +
    geom_sf(data = perimeters %>% filter(Naam == "De Moeren"), 
            colour = "firebrick") +
    geom_sf(aes(colour = factor(n_per_jaar)), size = 0.5) +
    labs(title = "De Moeren", colour = "aantal jaren\ntelpunt geteld") +
    guides(colour = guide_legend(override.aes = list(size = 3)))
```

```{r}
mas_data_sf %>%
  filter(regio == "Oostelijke leemstreek") %>%
  left_join(visits_per_jaar, by = join_by(plotnaam)) %>%
  ggplot() +
    geom_sf(data = perimeters %>% filter(Naam == "Oostelijke leemstreek"), 
            colour = "firebrick") +
    geom_sf(aes(colour = factor(n_per_jaar)), size = 0.5) +
    labs(title = "Oostelijke leemstreek", 
         colour = "aantal jaren\ntelpunt geteld") +
    guides(colour = guide_legend(override.aes = list(size = 3)))
```

## Aantal tellingen en waarnemingen

Aantal verschillende telpunten geteld per regio, jaar en telperiode.

```{r}
mas_data_df %>%
  group_by(regio, jaar, periode_in_jaar) %>%
  mutate(n_per_telperiode = n_distinct(plotnaam)) %>%
  ungroup() %>%
  group_by(regio, jaar) %>%
  mutate(n_per_jaar = n_distinct(plotnaam)) %>%
  ungroup() %>%
  group_by(regio) %>%
  mutate(n_per_regio = n_distinct(plotnaam)) %>%
  ungroup() %>%
  select(regio, jaar, periode_in_jaar, n_per_telperiode, n_per_jaar,
         n_per_regio) %>%
  distinct() %>%
  arrange(regio, jaar, periode_in_jaar) %>%
  kable()
```

```{r}
mas_data_df %>%
  group_by(regio, jaar, periode_in_jaar) %>%
  mutate(n_per_telperiode = n_distinct(plotnaam)) %>%
  ungroup() %>%
  select(regio, jaar, periode_in_jaar, n_per_telperiode) %>%
  distinct() %>%
  ggplot(aes(x = periode_in_jaar, y = n_per_telperiode, 
             fill = periode_in_jaar)) +
    geom_bar(stat = "identity") +
    facet_grid(regio~jaar, scales = "free_y") +
    labs(x = "telperiode", y = "aantal tellingen") +
    theme(legend.position = "")
```

```{r}
mas_data_df %>%
  group_by(regio, jaar, periode_in_jaar, plotnaam) %>%
  summarise(n = n(), .groups = "drop") %>%
  ggplot(aes(x = periode_in_jaar, y = n, colour = periode_in_jaar)) +
    geom_boxplot() +
    facet_grid(regio~jaar, scales = "free_y") +
    labs(x = "telperiode", y = "aantal waarnemingen") +
    theme(legend.position = "")
```

```{r}
mas_data_df %>%
  filter(aantal < 3000) %>%
  group_by(regio, jaar, periode_in_jaar, plotnaam) %>%
  summarise(n = sum(aantal), .groups = "drop") %>%
  ggplot(aes(x = periode_in_jaar, y = n, colour = periode_in_jaar)) +
    geom_boxplot() +
    facet_grid(regio~jaar, scales = "free_y") +
    labs(x = "telperiode", y = "aantal individuen") +
    theme(legend.position = "")
```


# Univariate exploratie

Niet strikt univariaat. We groeperen de variabelen per regio en indien van toepassing ook nog per jaar en/of telperiode.

```{r}
is_discrete   <- function(vec) all(is.numeric(vec)) && all(vec %% 1 == 0)

is_continuous <- function(vec) all(is.numeric(vec)) && !is_discrete(vec)

select_df <- function(df, var, grouping) {
  df %>%
    select(plotnaam, all_of(grouping), !!sym(var))
}

univar_tab <- function(df, var, grouping) {
  df_select <- select_df(df, var, grouping)
  
  if (is.numeric(pull(df[var]))) {
    out <- df_select %>%
      group_by_at(grouping) %>%
      summarise(min = min(!!sym(var)),
                mean = mean(!!sym(var)),
                max = max(!!sym(var)),
                Q1 = quantile(!!sym(var), 0.25),
                Q2 = quantile(!!sym(var), 0.5),
                Q3 = quantile(!!sym(var), 0.75))
    
  } else {
    out <- df_select %>%
      group_by_at(c(grouping, var)) %>%
      summarise(n = n(), .groups = "drop") %>%
      group_by(regio) %>%
      mutate(prop = n / sum(n)) %>%
      arrange(regio, !!sym(var))
      
  }
  
  out %>% 
    kable(caption = var, digits = 5) %>%
    print()
}

univar_plot <- function(df, selection, grouping) {
  df_select <- select_df(df, var, grouping)
  
  if (length(grouping) < 3) {
    if (is_continuous(pull(df[var]))) {
      out <- df_select %>%
        ggplot() +
          geom_histogram(aes(x = .data[[var]])) +
          theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
          labs(y = "Aantal telcirkels")
    } else {
      out <- df_select %>%
        group_by_at(c(grouping, var)) %>%
        summarise(n = n(), .groups = "drop") %>%
        ggplot(aes(x = .data[[var]], y = n)) +
          geom_bar(stat = "identity") +
          theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
          labs(y = "Aantal telcirkels")
    }
  } else {
    out <- df_select %>%
        ggplot(aes(x = .data[[grouping[3]]], y = .data[[var]], 
                   colour = .data[[grouping[3]]])) +
          geom_boxplot() +
          labs(x = "telperiode") +
          theme(legend.position = "")
  }
  
  if (length(grouping) == 1) {
    out <- out + facet_wrap(~.data[[grouping]], scales = "free")
  } else {
    out <- out + facet_grid(rows = vars(!!sym(grouping[1])),
                            cols = vars(!!sym(grouping[2])), 
                            scales = "free")
  }
  
  return(print(out))
}
```


## Plot-specifieke variabelen

```{r}
kle_vars <- c("haag", "houtkant", "boom", "bomengroep", "bomenrij", "bosrand")
plot_vars <- c("openheid_waarde_1000", "natuur_exp",
               kle_vars)

plot_df <- mas_data_df %>%
  select(plotnaam, regio, all_of(plot_vars)) %>%
  distinct() %>%
  arrange(regio, plotnaam)
```

Variabelen eigen aan het telpunt niet variabel over de jaren: `r plot_vars`.

```{r}
for (var in plot_vars) {
  univar_tab(plot_df, var, "regio")
  univar_plot(plot_df, var, "regio")
}
```


## Plot-jaar-specifieke variabelen

```{r}
hfdtlt_vars <- sort(names(mas_data_df)[grep("hfdtlt$", names(mas_data_df))])
vrtlt_vars <- sort(names(mas_data_df)[grep("vrtlt$", names(mas_data_df))])
plotjaar_vars <- c("area_prop_sb", "area_prop_bo_overig", hfdtlt_vars, 
                   "gewas_div_shannon", "gewas_div_n", "gewas_evenness",
                   vrtlt_vars, "perceel_median_area", "perceel_iqr_area", 
                   "perceel_cv_area", "inertie_sb", "inertie_rest", 
                   "status_teller", "sbp")

plotjaar_df <- mas_data_df %>%
  select(plotnaam, regio, jaar, all_of(plotjaar_vars)) %>%
  distinct() %>%
  arrange(regio, jaar, plotnaam)
```

Variabelen eigen aan het telpunt variabel over de jaren: `r plotjaar_vars`.

```{r}
for (var in plotjaar_vars) {
  univar_tab(plotjaar_df, var, c("regio", "jaar"))
  univar_plot(plotjaar_df, var, c("regio", "jaar"))
}
```

## Telling-specifieke variabelen

```{r}
telling_vars <- c("n_predators", "n_predators_spec")

telling_df <- mas_data_df %>%
  select(plotnaam, regio, jaar, periode_in_jaar, all_of(telling_vars)) %>%
  distinct() %>%
  arrange(regio, jaar, plotnaam, periode_in_jaar)
```

Variabelen eigen aan de telling: `r telling_vars`.

```{r}
for (var in telling_vars) {
  univar_tab(telling_df, var, c("regio", "jaar", "periode_in_jaar"))
  univar_plot(telling_df, var, c("regio", "jaar", "periode_in_jaar"))
}
```

## Discussie

...
