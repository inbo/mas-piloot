---
title: "Inlezen MAS data"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
#renv::restore()

# Set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE)
opts_knit$set(root.dir = here::here())

# Packages
library(tidyverse)
library(lubridate)
library(sf)

# Source
mbag_dir <- here()
data_path <- file.path("data", "mas")
```

# Controles
## Oude exports

Eerst controleren we of `20220906_qgis_export_sovon_wfs.gpkg` en `20220906_qgis_export_sovon_wfs.geojson` dezelfde informatie bevatten.

File size `20220906_qgis_export_sovon_wfs.gpkg`:

```{r}
file_gpkg <- file.path(data_path, "20220906_qgis_export_sovon_wfs.gpkg")
info_gpkg <- file.info(file_gpkg)
info_gpkg$size
```

File size `20220906_qgis_export_sovon_wfs.geojson`:

```{r}
file_geojson <- file.path(data_path, "20220906_qgis_export_sovon_wfs.geojson")
info_geojson <- file.info(file_geojson)
info_geojson$size
```

We vergelijken beide bestanden.

```{r}
mas_gpkg <- read_sf(file_gpkg)
mas_geojson <- read_sf(file_geojson)
```

Het enige verschil tussen beide bestanden is de benaming van de geometry kolom en het type van 3 kolommen die enkel maar `NA`'s bevatten.

```{r}
waldo::compare(mas_gpkg, mas_geojson)
```

## Nieuwe export

File size `20230509_qgis_export_sovon_wfs.geojson`:

```{r}
file_geojson_new <- file.path(data_path, 
                              "20230509_qgis_export_sovon_wfs.geojson")
info_geojson_new <- file.info(file_geojson_new)
info_geojson_new$size
```

```{r}
mas_geojson_new <- read_sf(file_geojson_new)
```

We selecteren eerst de MAS-data binnen 2018 en 2022.

```{r}
mas_geojson_new <- mas_geojson_new %>%
  filter(jaar %in% 2018:2022)
```

Zelfde bounding box:

```{r}
st_bbox(mas_geojson)
st_bbox(mas_geojson_new)
```

```{r}
diff_df1 <- setdiff(x = mas_geojson, y = mas_geojson_new)
diff_df2 <- setdiff(x = mas_geojson_new, y = mas_geojson)
```

Er zitten `r nrow(diff_df1)` in de oude export die niet in de nieuwe zitten en `r nrow(diff_df2)` in de nieuwe die niet in de oude zitten.

*Welke waarnemingen zitten niet meer in de nieuwe export?*

De waarnemingen zitten wel nog in de nieuwe export:

```{r}
old_oids <- diff_df1$oid
test1 <- mas_geojson %>% 
  filter(oid %in% old_oids) %>%
  arrange(oid)
test2 <- mas_geojson_new %>%
  filter(oid %in% old_oids) %>%
  arrange(oid)

all(c(nrow(test1), nrow(test2)) == length(old_oids))
```

Waar zit dan wel het verschil?

```{r}
waldo::compare(test1, test2, max_diffs = Inf)
```

Het verschil zit in de plotnamen, de soortnaam voor het groene kikker-complex en `distance2plot`.

*Welke waarnemingen zijn nieuw in de nieuwe export?*

Het gaat dus om `r nrow(diff_df2)` - `r nrow(diff_df1)`  = `r nrow(diff_df2) - nrow(diff_df1)` waarnemingen.

```{r}
new_oids <- diff_df2$oid
diff_new_oids <- setdiff(new_oids, old_oids)

new_obs_df <- mas_geojson_new %>%
  filter(oid %in% diff_new_oids)
```

Het gaat om waarnemingen van `r sort(unique(new_obs_df$jaar))` door `r sort(unique(new_obs_df$waarneme))`.  
Niet alle waarnemingen vallen binnen het MAS pilootmeetnet, maar toch een aantal:

```{r}
mapview::mapview(new_obs_df)
```

```{r}
test_plots <- c("Ol_2279.16", "VL0203", "Ol_11033.1", "VL0584")
```

We nemen enkele voorbeelden: `r test_plots`.

```{r}
out <- vector(mode = "list", length = length(test_plots))
for (i in seq_along(test_plots)) {
  oid_old <- mas_geojson %>% 
    filter(plotnaam == test_plots[i]) %>%
    pull(oid)
  oid_extra <- new_obs_df %>% 
    filter(plotnaam == test_plots[i]) %>%
    pull(oid)
  
  df <- data.frame(plotnaam = test_plots[i],
                   old_oid = paste(oid_old, collapse = ", "),
                   extra_oid = paste(oid_extra, collapse = ", "))
  out[[i]] <- df
}

do.call(rbind.data.frame, out) %>%
  kable()
```

We zien vaak al waarnemingen voor de punten in de oude export. In de nieuwe export zitten deze ook, maar toch zitten er veel meer extra waarnemingen in de nieuwe export.

Zouden er nieuwe waarnemingen ingevoerd zijn na de laatste export?



