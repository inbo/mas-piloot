---
title: "Berekening zichtbaarheid"
author: "Hans Van Calster"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
renv::restore()
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
library(terra)
library(GVI)
library(sf)
library(dplyr)
library(ggplot2)
library(inbospatial)
library(targets)
```

```{r steekproef}
targets_store <- here::here(
  "src", "targets", "mas_steekproef_pilootfase", "_targets")
steekproef <- tar_read(steekproef_zichtbaarheid, store = targets_store) %>%
  mutate(openheid_sbp = paste(openheid_klasse,
                             ifelse(is_sbp,
                                    "binnen plan",
                                    "buiten plan"))
         )
```

```{r bereken-zichtbaarheid}
bereken_vvi <- function(point,
                       dist = 300,
                       obs_height = 1.7,
                       resolution = 1,
                       spacing = 5,
                       dsm_offset = 0,
                       output_type) {

  bbox_buffer <- point %>% st_buffer(dist = dist + 10) %>% st_bbox()

  dsm_r1 <- get_coverage_wcs(wcs = "dsm",
                             bbox = bbox_buffer,
                             layername = "EL.GridCoverage.DSM",
                             resolution = resolution)
  dtm_r1 <- get_coverage_wcs(wcs = "dtm",
                             bbox = bbox_buffer,
                             layername = "EL.GridCoverage.DTM",
                             resolution = resolution)
  
  poly25 <- point %>% st_buffer(dist = 25)

  vvi_from_sf(
    observer = poly25,
    spacing = spacing,
    cores = 1,
    progress = TRUE,
    max_distance = dist,
    dsm_rast = dsm_r1 + dsm_offset,
    dtm_rast = dtm_r1,
    observer_height = obs_height,
    raster_res = resolution,
    output_type = output_type)
}
```

## Vooraf

::: {#cores .warning}
De functie `vvi_from_sf()` heeft een argument cores.
Er is een bug in de functie wanneer cores niet gelijk aan 1 is.
:::

## Voorbeeld voor 1 telpunt:

### spacing 5 m, raster resolutie 1 m

Berekening zichtbaarheidsindex binnen straal van 25 m rond telpunt in een raster van locaties die 5 m van elkaar liggen:

```{r}
vvi <- steekproef %>%
  filter(pointid == "Ol_4269.12") %>%
  bereken_vvi(output_type = "VVI")

vvi %>%
  ggplot() +
  geom_sf(aes(colour = VVI))
```

Summed viewshed:

```{r summed-viewshed}
sviewshed <- steekproef %>%
  filter(pointid == "Ol_4269.12") %>%
  bereken_vvi(output_type = "viewshed")

plot(sviewshed)
```

```{r cumulatief}
cvvi <- steekproef %>%
  filter(pointid == "Ol_4269.12") %>%
  bereken_vvi(output_type = "cumulative")
```

Cumulatief is de visibiliteit gelijk aan `r round(cvvi, 2)`.

Alles voorgesteld op 1 figuur:

```{r}
punt <- steekproef %>%
  filter(pointid == "Ol_4269.12")

cirkel_25m <- steekproef %>%
  filter(pointid == "Ol_4269.12") %>%
  st_buffer(25)

cirkel_300m <- steekproef %>%
  filter(pointid == "Ol_4269.12") %>%
  st_buffer(300)

ggplot() +
  tidyterra::geom_spatraster(data = sviewshed) +
  geom_sf(data = cirkel_300m, alpha = 0, colour = "lightblue") +
  geom_sf(data = cirkel_25m, alpha = 0, colour = "lightblue") +
  geom_sf(data = vvi, aes(colour =  VVI)) +
  tidyterra::scale_fill_terrain_c() +
  labs(title = paste("Cumulatieve VVI = ", round(cvvi, 2)))
```

### Spacing 5 m, raster resolutie 5 m

Effect van lagere resolutie:

```{r}
vvi_res5 <- steekproef %>%
  filter(pointid == "Ol_4269.12") %>%
  bereken_vvi(output_type = "VVI", resolution = 5)

cvvi_res5 <- steekproef %>%
  filter(pointid == "Ol_4269.12") %>%
  bereken_vvi(output_type = "cumulative", resolution = 5)

sviewshed_res5 <- steekproef %>%
  filter(pointid == "Ol_4269.12") %>%
  bereken_vvi(output_type = "viewshed", resolution = 5)


ggplot() +
  tidyterra::geom_spatraster(data = sviewshed_res5) +
  geom_sf(data = cirkel_300m, alpha = 0, colour = "lightblue") +
  geom_sf(data = cirkel_25m, alpha = 0, colour = "lightblue") +
  geom_sf(data = vvi_res5, aes(colour =  VVI)) +
  tidyterra::scale_fill_terrain_c() +
  labs(title = paste("Cumulatieve VVI = ", round(cvvi_res5, 2)))
```

### Spacing 10 m, raster resolutie 5 m

Effect van lagere resolutie en hogere spacing:

```{r}
vvi_res5sp10 <- steekproef %>%
  filter(pointid == "Ol_4269.12") %>%
  bereken_vvi(output_type = "VVI", resolution = 5, spacing = 10)

cvvi_res5sp10 <- steekproef %>%
  filter(pointid == "Ol_4269.12") %>%
  bereken_vvi(output_type = "cumulative", resolution = 5, spacing = 10)

sviewshed_res5sp10 <- steekproef %>%
  filter(pointid == "Ol_4269.12") %>%
  bereken_vvi(output_type = "viewshed", resolution = 5, spacing = 10)


ggplot() +
  tidyterra::geom_spatraster(data = sviewshed_res5sp10) +
  geom_sf(data = cirkel_300m, alpha = 0, colour = "lightblue") +
  geom_sf(data = cirkel_25m, alpha = 0, colour = "lightblue") +
  geom_sf(data = vvi_res5sp10, aes(colour =  VVI)) +
  tidyterra::scale_fill_terrain_c() +
  labs(title = paste("Cumulatieve VVI = ", round(cvvi_res5sp10, 2)))
```

### Spacing 25 m, raster resolutie 5 m


```{r}
vvi_res5sp25 <- steekproef %>%
  filter(pointid == "Ol_4269.12") %>%
  bereken_vvi(output_type = "VVI", resolution = 5, spacing = 25)

cvvi_res5sp25 <- steekproef %>%
  filter(pointid == "Ol_4269.12") %>%
  bereken_vvi(output_type = "cumulative", resolution = 5, spacing = 25)

sviewshed_res5sp25 <- steekproef %>%
  filter(pointid == "Ol_4269.12") %>%
  bereken_vvi(output_type = "viewshed", resolution = 5, spacing = 25)


ggplot() +
  tidyterra::geom_spatraster(data = sviewshed_res5sp25) +
  geom_sf(data = cirkel_300m, alpha = 0, colour = "lightblue") +
  geom_sf(data = cirkel_25m, alpha = 0, colour = "lightblue") +
  geom_sf(data = vvi_res5sp25, aes(colour =  VVI)) +
  tidyterra::scale_fill_terrain_c() +
  labs(title = paste("Cumulatieve VVI = ", round(cvvi_res5sp25, 2)))
```



## Test op groter aantal punten

Rechtstreeks via WCS werkt niet want laat niet toe om groot gebied te downloaden.

```{r eval=FALSE}
test2 <- steekproef %>%
  filter(Naam == "De Moeren") %>%
  bereken_vvi()
```

Dus data afhalen van onze GIS server.
Echter volledige bestand voor heel Vlaanderen is 30Gb...

```{r}
perimeters <- tar_read(perimeters_data, store = targets_store) %>%
  select(-section)

dm <- perimeters %>% filter(Naam == "De Moeren")
ol <- perimeters %>% filter(Naam == "Oostelijke leemstreek")
```

De volgende chunks lezen van de server en schrijven het deel weg dat valt binnen bounding box van de Moeren (naar data/dem folder).
Voor de Moeren zijn deze bestanden 160 Mb groot.
Voor de Oostelijke leemstreek bijna 3 Gb.

```{r eval=!file.exists(here::here("data", "dem", "dhmvii_dsm_1m_demoeren.tif"))}
dsm_dm <- terra::rast("S:/Vlaanderen/Hoogte/DHMVII/DHMVIIDSMRAS1m.tif") %>%
  terra::crop(
    dm,
    filename = here::here("data", "dem", "dhmvii_dsm_1m_demoeren.tif"))
```

```{r eval=file.exists(here::here("data", "dem", "dhmvii_dsm_1m_demoeren.tif"))}
dsm_dm <- terra::rast(here::here("data", "dem", "dhmvii_dsm_1m_demoeren.tif"))
crs(dsm_dm) <- "epsg:31370"
```

```{r eval=!file.exists(here::here("data", "dem", "dhmvii_dtm_1m_demoeren.tif"))}
dtm_dm <- terra::rast("S:/Vlaanderen/Hoogte/DHMVII/DHMVIIDTMRAS1m.tif") %>%
  terra::crop(
    dm,
    filename = here::here("data", "dem", "dhmvii_dtm_1m_demoeren.tif"))
```

```{r eval=file.exists(here::here("data", "dem", "dhmvii_dtm_1m_demoeren.tif"))}
dtm_dm <- terra::rast(here::here("data", "dem", "dhmvii_dtm_1m_demoeren.tif"))
crs(dtm_dm) <- "epsg:31370"
```

```{r eval=!file.exists(here::here("data", "dem", "dhmvii_dsm_1m_oostelijkeleemstreek.tif"))}
dsm_ol <- terra::rast("S:/Vlaanderen/Hoogte/DHMVII/DHMVIIDSMRAS1m.tif") %>%
  terra::crop(
    ol,
    filename = here::here(
      "data", "dem", "dhmvii_dsm_1m_oostelijkeleemstreek.tif"))
```

```{r eval=file.exists(here::here("data", "dem", "dhmvii_dsm_1m_oostelijkeleemstreek.tif"))}
dsm_ol <- terra::rast(
  here::here("data", "dem", "dhmvii_dsm_1m_oostelijkeleemstreek.tif"))
crs(dsm_ol) <- "epsg:31370"
```

```{r eval=!file.exists(here::here("data", "dem", "dhmvii_dtm_1m_oostelijkeleemstreek.tif"))}
dtm_ol <- terra::rast("S:/Vlaanderen/Hoogte/DHMVII/DHMVIIDTMRAS1m.tif") %>%
  terra::crop(
    ol,
    filename = here::here(
      "data", "dem", "dhmvii_dtm_1m_oostelijkeleemstreek.tif"))
```

```{r eval=file.exists(here::here("data", "dem", "dhmvii_dtm_1m_oostelijkeleemstreek.tif"))}
dtm_ol <- terra::rast(here::here("data", "dem", "dhmvii_dtm_1m_oostelijkeleemstreek.tif"))
crs(dtm_ol) <- "epsg:31370"
```


```{r}
dm_25mpoly <- steekproef %>%
  filter(Naam == "De Moeren") %>%
  st_buffer(dist = 25)

ol_25mpoly <- steekproef %>%
  filter(Naam == "Oostelijke leemstreek") %>%
  st_buffer(dist = 25)
```

```{r vvi-dm}
start <- proc.time()
vvi_dm <- vvi_from_sf(
    observer = dm_25mpoly,
    spacing = 25,
    cores = 1,
    progress = TRUE,
    max_distance = 300,
    dsm_rast = dsm_dm,
    dtm_rast = dtm_dm,
    observer_height = 1.7,
    raster_res = 5,
    output_type = "cumulative",
    by_row = TRUE)
stop <- proc.time()
stop - start
```

```{r vvi-ol}
start <- proc.time()
vvi_ol <- vvi_from_sf(
    observer = ol_25mpoly,
    spacing = 25,
    cores = 1,
    progress = TRUE,
    max_distance = 300,
    dsm_rast = dsm_ol,
    dtm_rast = dtm_ol,
    observer_height = 1.7,
    raster_res = 5,
    output_type = "cumulative",
    by_row = TRUE)
stop <- proc.time()
stop - start
```


```{r}
vvi_dm_viewshed <- vvi_from_sf(
    observer = dm_25mpoly,
    spacing = 25,
    cores = 1,
    progress = TRUE,
    max_distance = 300,
    dsm_rast = dsm_dm,
    dtm_rast = dtm_dm,
    observer_height = 1.7,
    raster_res = 5,
    output_type = "viewshed",
    by_row = TRUE)

# raster lijkt verschoven tov OSM, polygonen liggen juist
# nochtans hebben beide dezelfde crs
waldo::compare(st_crs(vvi_dm_viewshed), st_crs(dm_25mpoly)) # niets belangrijk anders
vvi_dm_viewshed_raster <- raster::raster(vvi_dm_viewshed)
#raster::crs(vvi_dm_viewshed_raster) <- st_crs(dm_25mpoly)$wkt
mapview::mapview(vvi_dm_viewshed_raster, 
                 col.region = function(n) grDevices::hcl.colors(n, palette = "terrain")) +
  mapview::mapview(dm_25mpoly)

# maar volgens deze figuur is wel alles ok
dm_25mpoly %>%
  ggplot() +
  tidyterra::geom_spatraster(data = vvi_dm_viewshed) +
  geom_sf() +
  tidyterra::scale_fill_terrain_c()

```


```{r}
dm_25mpoly %>%
  bind_cols(vvi_dm) %>%
  ggplot() +
  geom_sf(data = perimeters %>% filter(Naam == "De Moeren")) +
  geom_sf(aes(fill = cvvi, colour = cvvi))
```

```{r}
ol_25mpoly %>%
  bind_cols(vvi_ol) %>%
  ggplot() +
  geom_sf(data = ol) +
  geom_sf(aes(fill = cvvi, colour = cvvi))
```


```{r}
vvi_dm %>%
  ggplot() + 
  geom_histogram(aes(x = cvvi))
```

```{r}
vvi_ol %>%
  bind_cols(ol_25mpoly) %>%
  ggplot() + 
  geom_density(aes(x = cvvi, fill = openheid_klasse), alpha = 0.2)
```



```{r}
steekproefkader <- tar_read(steekproefkader_finaal, store = targets_store)
```

Berekening op volledige steekproefkader (Moeren en Leemstreek) zou minimaal `r round(nrow(steekproefkader) * 4 * 5 * 1e-3 /3600, 1)` uur duren bij resolutie van 5 m en spacing van 25 m.

## Wanneer is zichtbaarheid te laag?

Vanaf wanneer besluiten we dat de zichtbaarheid te laag is?
De Moeren is een zeer plat open landschap waar de zichtbaarheid normaal hoog is.
Verdeling van de zichtbaarheidsindices in de Moeren:

```{r}
dm_25mpoly %>%
  bind_cols(vvi_dm) %>%
  ungroup() %>%
  mutate(pointid = reorder(pointid, cvvi, mean)) %>%
  ggplot() +
  geom_point(aes(x = cvvi, y = pointid))
```

En in de Oostelijke leemstreek:

```{r}
ol_25mpoly %>%
  bind_cols(vvi_ol) %>%
  ungroup() %>%
  mutate(pointid = reorder(pointid, cvvi, mean)) %>%
  ggplot() +
  geom_point(aes(x = cvvi, y = pointid)) +
  facet_wrap(~openheid_klasse, scales = "free")
```
