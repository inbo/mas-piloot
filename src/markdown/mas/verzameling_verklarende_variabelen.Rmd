---
title: "Verzameling verklarende variabelen"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
renv::restore()

# Set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE)
opts_knit$set(root.dir = here())

conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)

# Packages
library(tidyverse)
library(INBOtheme)

library(sf)
library(lubridate)

# Source
mbag_dir <- here()
source(file.path("src", "R", "berekening_hulpvariabelen.R"))
source(file.path("src", "R", "geocomputations.R"))
```

# Kadering

We willen een evaluatie van het effect van de maatregelen die getroffen worden binnen het agrarisch natuurbeleid op de trends en het voorkomen van akkervogels. Dit per soort, en op plotniveau (telcirkelniveau).

Dit document geeft een overzicht van de verklarende variabelen die we gaan gebruiken in de modellen die we gaan fitten om bovenstaande te onderzoeken.

1. Welke variabelen?
2. Welk datatype (continu, categorisch, proporties, compositioneel ...)?
3. Waar verzameld?
4. Hoe verzameld?
5. Hoe berekend?
6. Verdere bedenkingen/opmerkingen. Zijn er bijvoorbeeld transformaties nodig?

# Inlezen data

We moeten de variabelen bepalen/berekenen op plotniveau (= telcirkelniveau). We hebben dus een lijst nodig met alle plots die geteld zijn met coördinaten.

De dataframe `telpunten_2018_2021` bevat alle MAS telpunten die in de periode 2018-2021 zijn doorgegeven aan SOVON. Het is echter niet zo dat al deze telpunten in elk jaar geteld zijn. Het kan zelfs zijn dat een telpunt uit deze lijst in geen enkel jaar werd geteld (= helemaal niet bezocht geweest). Het kan ook zijn dat het wel bezocht is geweest, maar dat er geen waarnemingen zijn.

> We moeten navragen welke punten bezocht zijn in 2018-2021. Nu weten we enkel dat een plot bezocht is als er ook effectief waarnemingen waren, maar we hebben geen idee in welke plots er nultellingen zijn geweest.

```{r}
Sys.setenv("PROJ_NETWORK" = "ON")
sf_proj_network(TRUE)
pipelines <- sf_proj_pipelines("EPSG:28992", "EPSG:31370")

# We select the pipeline with lowest accuracy (< 0.02), by filtering on accuracy.
# If the grids are installed, this should match the first line of the pipelines object.
chosen_pipeline_definition <- pipelines %>%
  filter(accuracy < 0.02) %>% 
  pull(definition)

telpunten_2018_2021_raw <- read_sf(
  here("data", "mas",
       "avimap_514_0_MAS_Werkgroep_Grauwe_Kiekendief_Belgi__telpunten_xy.shp")) %>%
  rename(teller_2021 = teller) %>%
  mutate(
    regio = ifelse(is.na(regio), "Vlaanderen - Bilzen", regio),
    type_teller_2021 = case_when(
      teller_2021 %in% c("WVNT00", "JJNN16", "NOVN00") |
        regio == "Vlaanderen - Leefdaal" ~ "professioneel",
      is.na(teller_2021) &
        regio != "Vlaanderen - Leefdaal" ~ "niet geteld in 2021",
      TRUE ~ "vrijwilliger"))

telpunten_2018_2021_amersfoort <- telpunten_2018_2021_raw %>%
  st_drop_geometry() %>%
  st_as_sf(coords = c("st_x", "st_y"), crs = 28992)

telpunten_2018_2021 <- st_transform(
  st_geometry(telpunten_2018_2021_amersfoort), "EPSG:31370",
  pipeline = chosen_pipeline_definition) %>% 
  st_sf(st_drop_geometry(telpunten_2018_2021_raw), geometry = .) %>% 
  as_tibble %>% 
  st_as_sf %>%
  mutate(regio = gsub("Vlaanderen - ", "", regio),
         regio = ifelse(regio == "Leemstreek", "Oostelijke leemstreek", regio),
         regio = ifelse(regio == "Bilzen", "Oostelijke leemstreek", regio))

design_2018_2021 <- telpunten_2018_2021 %>%
  select(plotnaam = naam)
```

Voor 2022 kennen we alle telpunten die geteld/bezocht moesten worden. Wel zijn de locaties in 2022 verkeerd voor VL plots. Dit zijn reeds bestaande plots en zitten dus al in de lijst van 2018-2021. We selecteren voor 2022 dus enkel de nieuwe plots.

```{r}
design_2022_raw <- read_csv(here(
    "data",
    "processed",
    "steekproef_piloot_avimap.csv")) %>%
  select(plotnaam = definitief_punt,
         regio,
         stratum,
         X, Y) %>%
  mutate(openheid = ifelse(grepl("HOL", stratum), "HOL", "OL"),
         sbp = ifelse(grepl("binnen", stratum), "binnen", "buiten"),
         stratum = gsub("L\\s{1}", "L\\\n", stratum),
         jaar = 2022L) %>%
  st_as_sf(coords = c("X", "Y"), crs = 31370)

design_2022 <- design_2022_raw %>%
  filter(!grepl("^VL", plotnaam)) %>%
  select(plotnaam)
```

Finaal voegen we alles samen. We behouden enkel plots binnen de perimeters van de pilootstudie: De Moeren en Oostelijke leemstreek.

```{r}
perimeters <- read_sf(
  here("data", "processed", "piloot_perimeters.gpkg"))

telpunten_2018_2022 <- bind_rows(design_2018_2021, design_2022) %>%
  st_intersection(perimeters) %>%
  select(pointid = plotnaam, regio = Naam)
```

In totaal gaat het om `r nrow(telpunten_2018_2022)` telpunten. `r nrow(filter(telpunten_2018_2022, regio == "De Moeren"))` in De Moeren en `r nrow(filter(telpunten_2018_2022, regio == "Oostelijke leemstreek"))` in de Oostelijke leemstreek.

```{r}
ggplot() +
  geom_sf(data = perimeters, colour = "firebrick") +
  geom_sf(data = telpunten_2018_2022, size = 0.5)
```

Ook gaan we er voorlopig van uit dat elke plot in elk jaar geteld is. Beter voorlopig te veel variabelen berekenen en achteraf filteren dan te weinig.

```{r}
jaar <- 2018:2022
telpunten_2018_2022_df <- merge(telpunten_2018_2022, as.data.frame(jaar))
```

# Verklarende variabelen van prioritair belang
## Oppervlakte-aandeel beheerovereenkomsten
### Beschrijving

Het aandeel oppervlakte aan beheerovereenkomsten binnen de telcirkel (in percent).

Indeling voor niet-productieve gewassen/beheerovereenkomsten (instrumenten):

-   soortbeschermingsmaatregelen
    -   perceelsniveau
    -   randen
-   erosiemaatregelen
-   bufferstroken

Voor de steekproeftrekking zijn vooral de oppervlakte aan soortbeschermingsmaatregelen van belang.
Eventueel verder opgesplitst in winter-, zomer- en jaarrondmaatregelen.

### Welk datatype?

Continue variabele. Percentage tussen 0 en 100.

### Waar verzameld?

??

`BO_2022_VLM_EXTERN.shp`

### Hoe verzameld?

??

`BO_2022_VLM_EXTERN.shp`

### Hoe berekend?

Elke overeenkomst is een polygoon met informatie over begin en einde van de beheerovereenkomst. Start is steeds op 1 januari en stop is steeds op 31 december. We filteren dus telkens de punten per jaar en we filteren de beheerovereenkomsten zodat ze reeds in werking waren in dat jaar. Daarna gebruiken we de `add_bo_to_frame()` functie om de proporties per telcirkel te berekenen.

```{r}
add_bo_by_year <- function(punten_df, path_bo) {
  # Read in bo layer and calculate start and stop year
  bo_layer <- read_bo(path = bo_file_2022)
  bo_layer2 <- bo_layer %>% 
    mutate(startjaar = year(START), 
           stopjaar = year(STOP))
  
  # Loop over years
  years <- unique(punten_df$jaar)
  out_list <- vector(mode = "list", length = length(years))
  
  for (i in seq_along(years)) {
    year <- years[i]
    
    # Filter by year
    punten_df_year <- punten_df %>% filter(jaar == year)
    bo_layer_year <- bo_layer2 %>% 
      filter(startjaar <= year & stopjaar >= year)
    
    out_df_year <- add_bo_to_frame(punten_df = punten_df_year, 
                                   bo_layer = bo_layer_year)
    
    out_list[[i]] <- out_df_year %>% mutate(area_prop_sb = area_prop_sb * 100)
  }
  
  return(do.call(rbind.data.frame, out_list))
}
```

```{r}
# Path to bo file
bo_file_2022 <- path_to_bo(jaar = 2022)

# Add proportion bo per year
telpunten_2018_2022_df <- add_bo_by_year(telpunten_2018_2022_df, bo_file_2022)
```

### Visualisatie

```{r}
telpunten_2018_2022_df %>%
  ggplot() +
    geom_histogram(aes(x = area_prop_sb)) +
    labs(
      title = "Oppervlakte-aandeel soortbeschermingsmaatregelen",
      x = "Percentage (%)",
      y = "Aantal telpunten") +
    facet_wrap(~jaar)
```

### Opmerkingen



## Oppervlakte-aandeel hoofdteelten
### Beschrijving

### Welk datatype?

### Waar verzameld?

### Hoe verzameld?

### Hoe berekend?

### Visualisatie

### Opmerkingen

## Diversiteit aan hoofdteelten
### Beschrijving

### Welk datatype?

### Waar verzameld?

### Hoe verzameld?

### Hoe berekend?

### Visualisatie

# Verklarende variabelen van secundair belang
## Regio
### Beschrijving

### Welk datatype?

### Waar verzameld?

### Hoe verzameld?

### Hoe berekend?

### Visualisatie

## Openheid landschap
### Beschrijving

### Welk datatype?

### Waar verzameld?

### Hoe verzameld?

### Hoe berekend?

### Visualisatie

## Soortbeschermingsplan
### Beschrijving

### Welk datatype?

### Waar verzameld?

### Hoe verzameld?

### Hoe berekend?

### Visualisatie

## Status teller
### Beschrijving

### Welk datatype?

### Waar verzameld?

### Hoe verzameld?

### Hoe berekend?

### Visualisatie

## Oppervlakte-aandeel kleine landschapselementen
### Beschrijving

### Welk datatype?

### Waar verzameld?

### Hoe verzameld?

### Hoe berekend?

### Visualisatie

## Oppervlakte-aandeel biolandbouw
### Beschrijving

### Welk datatype?

### Waar verzameld?

### Hoe verzameld?

### Hoe berekend?

### Visualisatie

## Perceelsgroottes
### Beschrijving

### Welk datatype?

### Waar verzameld?

### Hoe verzameld?

### Hoe berekend?

### Visualisatie

## X- en Y-coördinaten
### Beschrijving

### Welk datatype?

### Waar verzameld?

### Hoe verzameld?

### Hoe berekend?

### Visualisatie

## Inertie beheerovereenkomsten
### Beschrijving

### Welk datatype?

### Waar verzameld?

### Hoe verzameld?

### Hoe berekend?

### Visualisatie

## Aantal predatoren
### Beschrijving

### Welk datatype?

### Waar verzameld?

### Hoe verzameld?

### Hoe berekend?

### Visualisatie

## Jaar
### Beschrijving

### Welk datatype?

### Waar verzameld?

### Hoe verzameld?

### Hoe berekend?

### Visualisatie

## Telperiode
### Beschrijving

### Welk datatype?

### Waar verzameld?

### Hoe verzameld?

### Hoe berekend?

### Visualisatie

# Random effects
## Telpunt

## Jaar
