---
title: "Verkenning MAS veldwerk data van 2018 tot en met 2023"
author: "Ward Langeraert, Hans Van Calster"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# renv
renv::restore()

# Set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE)
opts_knit$set(root.dir = here())

# Conflicting packages
conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)

# Packages
library(tidyverse)
library(INBOtheme)
library(sf)
library(terra)

theme_set(theme_inbo(transparent = TRUE))

# Targets
library(targets)

## to use tar_read()
new_tar_vector <- function(value, objects) {
    out <- do.call(vctrs::vec_rbind, objects)
    if (any(sapply(out, inherits, what = "sfc"))) {
      sf::st_as_sf(out)
    } else {out}
}
try(assignInNamespace(
  "value_produce_aggregate.tar_vector",
  new_tar_vector,
  ns = "targets"))

targets_store <- here("src", "targets", "mas_steekproef_pilootfase", "_targets")

# Source
source(here("src", "R", "berekening_hulpvariabelen.R"))
source(here("src", "R", "wfs_wcs.R"))
media_folder <- here("media", "data_exploratie")
```

# Inlezen data

```{r}
data_path <- here("data", "processed")
mas_data_df_raw <- read_csv(here(data_path, "MAS_data_full_2018_2023.csv"))
mas_data_df <- mas_data_df_raw %>%
  rename(openheid  = openheid_klasse_300) %>%
  mutate(stratum = paste(openheid, sbp, sep = " - ")) %>%
  filter(!(regio ==  "De Moeren" & openheid == "HOL"))
mas_data_sf <- st_as_sf(mas_data_df, coords = c("x_lambert", "y_lambert"), 
                        crs = 31370)
```


# Resultaten vogels 2022-2023

```{r selectie-vogels}
mas2022_2023 <- mas_data_sf %>%
  filter(soortgrp == 2,  # vogels
         jaar %in% 2022:2023,
         openheid %in% c("HOL", "OL"))

design2022_2023 <- mas_data_df %>%
  filter(jaar %in% 2022:2023,
         openheid %in% c("HOL", "OL")) %>%
  distinct(plotnaam, regio, openheid, sbp)

# To detect absences
bezoekenlijst_2022_2023 <- mas_data_df %>%
  filter(jaar %in% 2022:2023,
         openheid %in% c("HOL", "OL")) %>%
  distinct(plotnaam, regio, openheid, sbp, stratum, periode_in_jaar) %>%
  select(plotnaam, periode_in_jaar, everything())
```

Selectie van vogelsoorten waargenomen in 2022_2023 in HOL en OL.


## Enkele cijfers

```{r tabel-vogels, message=FALSE}
summary_mas2022_2023 <- mas2022_2023 %>%
  st_drop_geometry() %>%
  group_by(regio, jaar, openheid, sbp) %>%
  summarise(aantal_waarnemingen = n_distinct(oid), 
            aantal_plots = n_distinct(plotid), 
            aantal_soorten = n_distinct(naam)) %>%
  arrange(regio, jaar, openheid, sbp)

write_csv(summary_mas2022_2023, here(media_folder, "summary_mas_2022_2023.csv"))

summary_mas2022_2023 %>%
  kable()

mas2022_2023 <- mas2022_2023 %>% 
  group_by(regio) %>%
  mutate(plots_per_regio = n_distinct(plotid))
```


## Soortendiversiteit

Is de soortendiversiteit in De Moeren hoger dan in de leemstreek?

```{r soortendiversiteit}
diversiteit <- mas2022_2023 %>%
  st_drop_geometry() %>%
  group_by(regio, jaar, plotnaam, openheid, sbp, stratum, periode_in_jaar,
           naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop_last") %>%
  summarise(aantal_soorten = n(),
            .groups = "drop")
```

```{r soortenaantal-boxplot}
p <- diversiteit %>%
  ggplot() +
    geom_boxplot(aes(x = stratum, y = aantal_soorten,
                     fill = periode_in_jaar)) +
    facet_grid(jaar~regio, scales = "free_x") +
    labs(y = "Aantal soorten", x = "", fill = "Telperiode")

ggsave(here(media_folder, "soortenaantal_mas_2022_2023.jpg"),
       p,
       dpi = 300,
       width = 8,
       height = 6)

p
```

Om welke soorten gaat het?

```{r relfreqs-vogels}
relfreqs <- mas2022_2023 %>%
  st_drop_geometry() %>%
  group_by(regio, jaar, plotnaam, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  mutate(jaar = factor(jaar)) %>%
  group_by(jaar, periode_in_jaar, regio) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
                   .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")
```

Overzicht van relatieve frequenties van de 30 meest frequente soorten in een bepaalde regio. Elk punt staat voor een relatieve frequentie in een bepaalde telperiode van 2022_2023.

```{r soortenfreqs-vogels, fig.height = 200/25.4}
p <- relfreqs %>%
  mutate(naam = reorder(naam, relfreq, FUN = "mean")) %>%
  filter(as.numeric(naam) > length(unique(naam)) - 30) %>%
  ggplot() +
    labs(y = "", x = "Relatieve frequentie") +
    geom_point(aes(x = relfreq, y = naam, colour = regio)) +
    labs(colour = "Regio") +
    facet_wrap(~jaar) +
    theme(legend.position = "top")

ggsave(here(media_folder, "soortenfreqs_mas_2022_2023.jpg"),
       p,
       dpi = 300,
       width = 8,
       height = 6)

p
```

Top 20 van soorten die in termen van verschil in gemiddelde relatieve frequentie van voorkomen meer voorkomen in **De Moeren**:

```{r meerfrequent-moeren}
relfreqs %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  slice_max(verschilfreq, n = 20) %>%
  kable(digits = 2)
```

```{r}
verschil_dm <- relfreqs %>%
  group_by(jaar, regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(jaar, regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  group_by(jaar) %>%
  slice_max(verschilfreq, n = 20) %>%
  mutate(rang = row_number()) %>%
  ungroup()
```


Top 20 van soorten die in termen van verschil in gemiddelde relatieve frequentie van voorkomen meer voorkomen in de **Oostelijke Leemstreek**:

```{r meerfrequent-leemstreek}
relfreqs %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  slice_max(-verschilfreq, n = 20) %>%
  kable(digits = 2)
```

```{r}
verschil_ol <- relfreqs %>%
  group_by(jaar, regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(jaar, regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  group_by(jaar) %>%
  slice_max(-verschilfreq, n = 20) %>%
  mutate(rang = row_number()) %>%
  ungroup()
```


```{r}
bind_rows(verschil_dm, verschil_ol) %>%
  mutate(regio = ifelse(verschilfreq > 0,
                        "De Moeren", "Oostelijke leemstreek")) %>%
  write_csv(here(media_folder, "verschilfreq_mas_2022_2023.csv"))
```


## Doelsoorten

```{r selectie-doelsoorten}
doelsoorten <- c(
  "Veldleeuwerik", 
  "Gele Kwikstaart", 
  "Geelgors", 
  "Kievit", 
  "Grasmus",
  "Witte Kwikstaart",
  "Ringmus",
  "Kwartel",
  "Kneu",
  "Torenvalk")

doel_df <- mas2022_2023 %>% 
  filter(naam %in% doelsoorten, 
         ifelse(naam == "Torenvalk", wrntype >= 0L, wrntype > 0L))
```

Enkel data met broedcode > 0 zijn weerhouden tenzij voor Torenvalk.

<!--Opgepast: verwarrend is dat het veld broedcode niet de broedcode bevat. Hiervoor moet je het veld `wrntype` hebben. In De Moeren is geen half-open landschap aanwezig (NA).-->

```{r diversiteit-doelsoorten}
relfreqs_doel <- doel_df %>% 
  st_drop_geometry() %>%
  group_by(regio, jaar, plotnaam, stratum, openheid, sbp, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  mutate(jaar = factor(jaar)) %>%
  group_by(jaar, periode_in_jaar, regio, stratum, openheid, sbp) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
                   .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")

relfreqs_doel %>%
  group_by(regio, jaar, stratum, openheid, sbp, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, jaar, stratum, openheid, sbp, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  group_by(openheid, sbp) %>%
  arrange(naam) %>%
  select(-stratum) %>%
  kable(digits = 2)

relfreqs_doel %>%
  group_by(regio, jaar, stratum, openheid, sbp, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, jaar, stratum, openheid, sbp, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  group_by(openheid, sbp) %>%
  arrange(naam) %>%
  select(-stratum) %>%
  write_csv(here(media_folder, "verschilfreq_mas_2022_2023_doel.csv"))
```

De volgende figuur geeft een overzicht van de genoteerde broedcodes per regio voor elke soort. Een telling is hier geïnterpreteerd als een waarneming van een bepaalde soort op een bepaalde afstand in een bepaalde plot in een bepaalde telperiode. Er is dus geen rekening gehouden met het aantal vogels genoteerd per telling. De tellingen zijn hoger in de Leemstreek maar daar waren ook meer plots. Deze figuur geeft dus enkel de absolute aantallen weer. 

```{r broedcodes-doelsoorten, message=FALSE, fig.height=14, fig.width=9}
# Save totals to put labels on plot
strata_df <- doel_df %>%
  st_drop_geometry() %>%
  select(stratum, regio, jaar) %>%
  distinct()

# summarise data and make plot
for (spec in sort(doelsoorten)) {
  p <- doel_df %>%
    st_drop_geometry() %>%
    mutate(wrntype_omschrijving2 = paste(wrntype, wrntype_omschrijving, 
                                         sep = ": "),
           wrntype_omschrijving2 = reorder(wrntype_omschrijving2, wrntype,
                                           decreasing = TRUE)) %>%
    filter(naam == spec) %>%
    select(jaar, stratum, regio, wrntype_omschrijving2) %>%
    group_by(jaar, stratum, regio, wrntype_omschrijving2) %>%
    summarise(N = n(), .groups = "drop") %>%
    full_join(strata_df, by = join_by(stratum, regio, jaar)) %>%
    mutate(stratum = gsub(" - ", " -\n", stratum)) %>%
    ggplot(aes(x = stratum, y = N, fill = wrntype_omschrijving2)) +
      geom_bar(stat = "identity") +
      scale_fill_discrete(drop = FALSE) +
      labs(y = "Aantal tellingen", x = "", title = spec, fill = "Broedcode") +
      facet_grid(regio~jaar, scales = "free")
  
  print(p)
  
  name <- tolower(gsub("\\s", "", spec))
  
  ggsave(here(media_folder, paste0("broedcode_", name, "_mas_2022_2023.jpg")),
         p + ggtitle(""),
         dpi = 300,
         width = 8,
         height = 6)
}
```

De volgende figuur toont de relatieve frequentie van de doelsoorten in een bepaalde telperiode voor de verschillende regio's gestratificeerd volgens openheid van het landschap en binnen of buiten sbp's. 

```{r telperiode-doelsoorten, message=FALSE}
for (spec in sort(doelsoorten)) {
  p <- relfreqs_doel %>%
    filter(naam == spec) %>%
    ggplot() +
      labs(y = "Relatieve frequentie", x = "Telperiode", title = spec) +
      geom_point(aes(x = periode_in_jaar, y = relfreq,
                     colour = sbp, shape = openheid),
                 size = 3, position = position_dodge2(width = 0.2)) +
      facet_grid(jaar~regio) +
      scale_y_continuous(limits = c(0, 1))
  print(p)
  
  name <- tolower(gsub("\\s", "", spec))
  
  ggsave(here(media_folder, paste0("relfreq_", name, "_mas_2022_2023.jpg")),
         p + ggtitle(""),
         dpi = 300,
         width = 8,
         height = 6)
}
```


# Resultaten zoogdieren 2022_2023

```{r selectie-zoogdieren}
zoogdieren <- mas_data_sf %>%
  filter(soortgrp == 1,                # zoogdieren
         jaar %in% 2022:2023,                 # 2022_2023
         openheid %in% c("HOL", "OL"))
```

Selectie van zoogdieren waargenomen in 2022_2023 in HOL en OL.

## Enkele cijfers

```{r tabel-zoogdieren}
zoogdieren %>%
  st_drop_geometry() %>% 
  group_by(regio) %>%
  summarise(aantal_waarnemingen = n_distinct(oid), 
            aantal_plots = n_distinct(plotid), 
            aantal_soorten = n_distinct(naam)) %>%
  kable()
```


## Soortendiversiteit

```{r relfreqs-zoogdieren}
relfreqs_z <- zoogdieren %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  group_by(periode_in_jaar, regio) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
                   .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")
```

Overzicht van relatieve frequenties van de zoogdieren in een bepaalde regio. Elk punt staat voor een relatieve frequentie in een bepaalde telperiode van 2022_2023. De frequenties zijn relatief ten opzichte van de andere zoogdieren. Als er een zoogdier wordt gezien, is dit vaak de Haas.

```{r soortenfreqs-zoogdieren}
relfreqs_z %>%
  mutate(naam = reorder(naam, relfreq, FUN = "mean")) %>%
  ggplot() +
    labs(y = "", x = "Relatieve frequentie") +
    geom_point(aes(x = relfreq, y = naam, colour = regio))
```

```{r freqtable-zoogdieren}
relfreqs_z %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  # Same order as in the previous plot
  rowwise() %>%
  mutate(max = max(`De Moeren`, `Oostelijke leemstreek`)) %>%
  arrange(desc(max)) %>% select(-max) %>%
  kable(digits = 3)
```


# Resultaten vogels 2023

```{r selectie-vogels-2023}
mas2023 <- mas_data_sf %>%
  filter(soortgrp == 2,  # vogels
         jaar == 2023,
         openheid %in% c("HOL", "OL"))

design2023 <- mas_data_df %>%
  filter(jaar == 2023,
         openheid %in% c("HOL", "OL")) %>%
  distinct(plotnaam, regio, openheid, sbp)

# To detect absences
bezoekenlijst_2023 <- mas_data_df %>%
  filter(jaar == 2023,
         openheid %in% c("HOL", "OL")) %>%
  distinct(plotnaam, regio, openheid, sbp, stratum, periode_in_jaar) %>%
  select(plotnaam, periode_in_jaar, everything())
```

Selectie van vogelsoorten waargenomen in 2023 in HOL en OL.


## Enkele cijfers

```{r tabel-vogels-2023, message=FALSE}
mas2023 %>%
  st_drop_geometry() %>%
  group_by(regio, openheid, sbp) %>%
  summarise(aantal_waarnemingen = n_distinct(oid), 
            aantal_plots = n_distinct(plotid), 
            aantal_soorten = n_distinct(naam)) %>%
  kable()

mas2023 <- mas2023 %>% 
  group_by(regio) %>%
  mutate(plots_per_regio = n_distinct(plotid))
```


## Soortendiversiteit

Is de soortendiversiteit in De Moeren hoger dan in de leemstreek?

```{r soortendiversiteit-2023}
diversiteit <- mas2023 %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, openheid, sbp, stratum, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop_last") %>%
  summarise(aantal_soorten = n(),
            .groups = "drop")
```

```{r soortenaantal-boxplot-2023}
diversiteit %>%
  ggplot() +
    geom_boxplot(aes(x = stratum, y = aantal_soorten,
                     fill = periode_in_jaar)) +
    facet_wrap(~regio, scales = "free_x") +
    labs(y = "Aantal soorten", x = "Stratum", fill = "Telperipode")
```

Om welke soorten gaat het?

```{r relfreqs-vogels-2023}
relfreqs <- mas2023 %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  group_by(periode_in_jaar, regio) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
                   .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")
```

Overzicht van relatieve frequenties van de 30 meest frequente soorten in een bepaalde regio. Elk punt staat voor een relatieve frequentie in een bepaalde telperiode van 2023.

```{r soortenfreqs-vogels-2023, fig.height = 200/25.4}
relfreqs %>%
  mutate(naam = reorder(naam, relfreq, FUN = "mean")) %>%
  filter(as.numeric(naam) > length(unique(naam)) - 30) %>%
  ggplot() +
    labs(y = "", x = "Relatieve frequentie") +
    geom_point(aes(x = relfreq, y = naam, colour = regio))
```

Top 20 van soorten die in termen van verschil in gemiddelde relatieve frequentie van voorkomen meer voorkomen in **De Moeren**:

```{r meerfrequent-moeren-2023}
relfreqs %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  slice_max(verschilfreq, n = 20) %>%
  kable(digits = 2)
```

Top 20 van soorten die in termen van verschil in gemiddelde relatieve frequentie van voorkomen meer voorkomen in de **Oostelijke Leemstreek**:

```{r meerfrequent-leemstreek-2023}
relfreqs %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  slice_max(-verschilfreq, n = 20) %>%
  kable(digits = 2)
```


## Doelsoorten

```{r selectie-doelsoorten-2023}
doelsoorten <- c("Veldleeuwerik", "Gele Kwikstaart", "Geelgors", "Fazant")
doel_df <- mas2023 %>% 
  filter(naam %in% doelsoorten, 
         wrntype > 0L) 
```

Enkel data met broedcode > 0 zijn weerhouden in HOL en OL. De relatieve frequenties zullen dus niet exact hetzelfde zijn als in **2.2**.

<!--Opgepast: verwarrend is dat het veld broedcode niet de broedcode bevat. Hiervoor moet je het veld `wrntype` hebben. In De Moeren is geen half-open landschap aanwezig (NA).-->

```{r diversiteit-doelsoorten-2023}
relfreqs_doel <- doel_df %>% 
  st_drop_geometry() %>%
  group_by(regio, plotnaam, stratum, openheid, sbp, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  group_by(periode_in_jaar, regio, stratum, openheid, sbp) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
                   .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")

relfreqs_doel %>%
  group_by(regio, stratum, openheid, sbp, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, stratum, openheid, sbp, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  group_by(openheid, sbp) %>%
  arrange(naam) %>%
  select(-stratum) %>%
  kable(digits = 2)
```

De volgende figuur geeft een overzicht van de genoteerde broedcodes per regio voor elke soort. Een telling is hier geïnterpreteerd als een waarneming van een bepaalde soort op een bepaalde afstand in een bepaalde plot in een bepaalde telperiode. Er is dus geen rekening gehouden met het aantal vogels genoteerd per telling. De tellingen zijn hoger in de Leemstreek maar daar waren ook meer plots. Deze figuur geeft dus enkel de absolute aantallen weer. 

```{r broedcodes-doelsoorten-2023, message=FALSE, fig.height=7, fig.width=9}
# Save totals to put labels on plot
totals <- doel_df %>%
    st_drop_geometry() %>%
    group_by(naam, stratum, regio) %>%
    summarise(total = n(), .groups = "drop")

# summarise data and make plot
doel_df %>% 
  st_drop_geometry() %>%
  mutate(wrntype_omschrijving2 = paste(wrntype, wrntype_omschrijving, 
                                       sep = ": ")) %>%
  group_by(naam, stratum, regio, wrntype_omschrijving2) %>%
  summarise(N = n(), .groups = "drop") %>%
  ggplot(aes(x = stratum, y = N, fill = wrntype_omschrijving2)) +
    geom_bar(stat = "identity", colour = "black") +
    geom_text(data = totals, aes(x = stratum, 
                                 y = total + c(rep(30, 17), rep(125, 6)),
                                 label = total, fill = NULL)) +
    labs(y = "Aantal tellingen", x = "") +
    guides(fill = guide_legend(title = "broedcode")) +
    facet_grid(naam~regio, scales = "free") 
```

De volgende figuur toont de relatieve frequentie van de doelsoorten in een bepaalde telperiode voor de verschillende regio's gestratificeerd volgens openheid van het landschap en binnen of buiten sbp's. 

```{r telperiode-doelsoorten-2023, message=FALSE}
relfreqs_doel %>%
  ggplot() +
    labs(y = "Relatieve frequentie", x = "Telperiode") +
    geom_point(aes(x = periode_in_jaar, y = relfreq,
                   colour = openheid, shape = sbp)) +
    facet_grid(naam~regio) +
    scale_y_continuous(limits = c(0, 1))
```

Voor de Torenvalk wordt geen rekening gehouden met broedcodes. Alle waarnemingen zijn relevant o.w.v. terreingebruik. De relatieve frequentie is dus identiek als in **2.2**.

```{r relfreq-torenvalk-2023, message=FALSE}
relfreq_torenvalk <- mas2023 %>%
  st_drop_geometry() %>%
  filter(naam == "Torenvalk") %>%
  group_by(regio, plotnaam, stratum, openheid, sbp, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  full_join(bezoekenlijst_2023, 
            by = join_by(regio, plotnaam, stratum, openheid, sbp,
                         periode_in_jaar)) %>%
  mutate(totaal_aantal = ifelse(is.na(totaal_aantal), 0, totaal_aantal)) %>%
  group_by(periode_in_jaar, regio, stratum, openheid, sbp) %>%
  summarise(relfreq = sum(totaal_aantal > 0) / n(),
                   .groups = "drop")
```

```{r freq-torenvalk-2023}
relfreq_torenvalk %>%
  group_by(regio, openheid, sbp) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, openheid, sbp, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  kable(digits = 2)
```

De volgende figuur toont de relative frequentie van de soort in een bepaalde telperiode voor de verschillende regio's en strata.

```{r telperiode-torenvalk-2023, message=FALSE}
relfreq_torenvalk %>%
  ggplot() +
    labs(y = "Relatieve frequentie", x = "Telperiode") +
    geom_point(aes(x = periode_in_jaar, y = relfreq,
                   colour = openheid, shape = sbp)) +
    facet_wrap(~regio) +
    scale_y_continuous(limits = c(0, 1))
```


# Resultaten zoogdieren 2023

```{r selectie-zoogdieren-2023}
zoogdieren <- mas_data_sf %>%
  filter(soortgrp == 1,                # zoogdieren
         jaar == 2023,                 # 2023
         openheid %in% c("HOL", "OL"))
```

Selectie van zoogdieren waargenomen in 2023 in HOL en OL.

## Enkele cijfers

```{r tabel-zoogdieren-2023}
zoogdieren %>%
  st_drop_geometry() %>% 
  group_by(regio) %>%
  summarise(aantal_waarnemingen = n_distinct(oid), 
            aantal_plots = n_distinct(plotid), 
            aantal_soorten = n_distinct(naam)) %>%
  kable()
```


## Soortendiversiteit

```{r relfreqs-zoogdieren-2023}
relfreqs_z <- zoogdieren %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  group_by(periode_in_jaar, regio) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
                   .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")
```

Overzicht van relatieve frequenties van de zoogdieren in een bepaalde regio. Elk punt staat voor een relatieve frequentie in een bepaalde telperiode van 2023. De frequenties zijn relatief ten opzichte van de andere zoogdieren. Als er een zoogdier wordt gezien, is dit vaak de Haas.

```{r soortenfreqs-zoogdieren-2023}
relfreqs_z %>%
  mutate(naam = reorder(naam, relfreq, FUN = "mean")) %>%
  ggplot() +
    labs(y = "", x = "Relatieve frequentie") +
    geom_point(aes(x = relfreq, y = naam, colour = regio))
```

```{r freqtable-zoogdieren-2023}
relfreqs_z %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  # Same order as in the previous plot
  rowwise() %>%
  mutate(max = max(`De Moeren`, `Oostelijke leemstreek`)) %>%
  arrange(desc(max)) %>% select(-max) %>%
  kable(digits = 3)
```


# Resultaten vogels 2018--2023

```{r selectie-vogels-langetermijn}
mas_vogels <- mas_data_sf %>%
  filter(soortgrp == 2,                # vogels
         openheid %in% c("HOL", "OL"))
```

Selectie van vogelsoorten in HOL en OL


## Enkele cijfers

```{r tabel-langetermijn, message=FALSE}
mas_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, jaar) %>%
  summarise(aantal_waarnemingen = n_distinct(oid), 
            aantal_plots = n_distinct(plotid), 
            aantal_soorten = n_distinct(naam),
            .groups = "drop") %>%
  kable()
```

```{r aantal-plots, message=FALSE}
mas_vogels %>% 
  group_by(regio, jaar, openheid, sbp) %>%
  st_drop_geometry() %>%
  summarise(tellingen = n_distinct(oid), 
            plots = n_distinct(plotid),
            .groups = "drop") %>%
  pivot_longer(cols = c(tellingen, plots),
               names_to = "legende",
               values_to = "aantal") %>%
  group_by(regio, jaar, legende) %>%
  mutate(tot = sum(aantal)) %>%
  ggplot() +
    geom_point(aes(x = jaar, y = aantal, colour = openheid, shape = sbp)) +
    geom_point(aes(x = jaar, y = tot, alpha = ""),
             shape = 8, colour = "darkgreen") +
    labs(x = "", y = "Aantal", alpha = "totaal aantal\nper jaar in regio") +
    scale_alpha_manual(values = 1) +
    facet_grid(legende~regio, scales = "free_y") 
```

## Soortendiversiteit

Is de soortendiversiteit in De Moeren hoger dan in de leemstreek?

```{r soortendiversiteit-langetermijn}
diversiteit_vogels <- mas_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop_last") %>%
  summarise(aantal_soorten = n(),
            .groups = "drop")
```

```{r soortenaantal-boxplot-langetermijn}
diversiteit_vogels %>%
  ggplot() +
    geom_boxplot(aes(x = periode_in_jaar, y = aantal_soorten, fill = regio)) +
    labs(y = "Aantal soorten", x = "Telperiode") +
    facet_wrap(~jaar)
```

Overzichtelijkere figuren om te vergelijken binnen gebieden:

```{r soortenaantal-boxplot-langetermijn2}
cols <- c("#F8766D", "#00BA38")
for (i in 1:length(unique(diversiteit_vogels$regio))) {
  reg <- unique(diversiteit_vogels$regio)[i]
  print(
    diversiteit_vogels %>%
    filter(regio == reg) %>%
    ggplot() +
      geom_boxplot(aes(x = periode_in_jaar, y = aantal_soorten), 
                   fill = cols[i]) +
      facet_wrap(regio~jaar) +
      labs(y = "Aantal soorten", x = "Telperiode")
  )
}
```

Gestratificeerd:

```{r soortendiversiteit-langetermijn-strat}
diversiteit_vogels_strat <- mas_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, openheid, sbp, stratum, jaar, periode_in_jaar, 
           naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop_last") %>%
  summarise(aantal_soorten = n(),
            .groups = "drop")
```

```{r soortenaantal-boxplot-langetermijn-strat}
for (reg in unique(diversiteit_vogels_strat$regio)) {
  print(
    diversiteit_vogels_strat %>%
    filter(regio == reg) %>%
    ggplot() +
      labs(y = "Aantal soorten", x = "Telperiode") +
      geom_boxplot(aes(x = periode_in_jaar, y = aantal_soorten, fill = stratum)) +
      facet_wrap(regio~jaar)
  )
}
```

Om welke soorten gaat het?

```{r relfreqs-langetermijn}
relfreqs_vogels <- mas_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  mutate(jaar = factor(jaar)) %>%
  group_by(jaar, periode_in_jaar, regio) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
                   .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")
```

Overzicht van relatieve frequenties van de 30 meest frequente soorten in een bepaalde regio. Elk punt staat voor een relatieve frequentie in een bepaald jaar en een bepaalde telperiode van dat jaar.

```{r soortenfreqs-langetermijn, fig.height = 200/25.4}
relfreqs_vogels %>%
  mutate(naam = reorder(naam, relfreq, FUN = "mean")) %>%
  filter(as.numeric(naam) > length(unique(naam)) - 30) %>%
  ggplot() +
    labs(y = "", x = "Relatieve frequentie") +
    geom_point(aes(x = relfreq, y = naam, colour = regio))
```

> Opgepast! In de volgende tabellen wordt de gemiddelde relatieve frequentie berekend door een gemiddelde te nemen over de telperiodes en over de jaren (per regio en per soort). Het is mogelijks niet correct een ongewogen gemiddelde te nemen over de jaren heen. Dit moet verder uitgezocht worden. Over de telperiodes is op zich wel correct want dit zijn replicaten.

Top 20 van soorten die in termen van verschil in gemiddelde relatieve frequentie van voorkomen meer voorkomen in **De Moeren** dan in de Oostelijke leemstreek:

```{r meerfrequent-moeren-langetermijn}
relfreqs_vogels %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>% # Correct?
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  slice_max(verschilfreq, n = 20) %>%
  kable(digits = 2)
```

Top 20 van soorten die in termen van verschil in gemiddelde relatieve frequentie van voorkomen meer voorkomen in **de Oostelijke leemstreek** dan in De Moeren:

```{r meerfrequent-leemstreek-langetermijn}
relfreqs_vogels %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>% # Correct?
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  slice_max(-verschilfreq, n = 20) %>%
  kable(digits = 2)
```


## Doelsoorten

```{r selectie-doelsoorten-langetermijn}
doel_vogels <- mas_vogels %>% 
  filter(naam %in% doelsoorten, 
         wrntype > 0L,
         openheid %in% c("HOL", "OL")) 
```

Enkel data met broedcode > 0 zijn weerhouden in OL en HOL. De relatieve frequenties zullen dus niet exact hetzelfde zijn als in **4.2**.

<!--Opgepast: verwarrend is dat het veld broedcode niet de broedcode bevat. Hiervoor moet je het veld `wrntype` hebben.-->

> Opgepast! In de volgende tabel wordt de gemiddelde relatieve frequentie berekend door een gemiddelde te nemen over de telperiodes en over de jaren (per regio en per soort). Het is mogelijks niet correct een ongewogen gemiddelde te nemen over de jaren heen. Dit moet verder uitgezocht worden. Over de telperiodes is op zich wel correct want dit zijn replicaten.

```{r diversiteit-doelsoorten-langetermijn}
relfreqs_doelvogels <- mas_vogels %>% 
  filter(wrntype > 0L,
         openheid %in% c("HOL", "OL")) %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  mutate(jaar = factor(jaar)) %>%
  group_by(periode_in_jaar, jaar, regio) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
                   .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")

relfreqs_doelvogels %>%
  filter(naam %in% doelsoorten) %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>% # Correct?
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  ungroup() %>%
  arrange(naam) %>%
  kable(digits = 2)
```

De volgende figuren tonen de relatieve frequentie van de doelsoorten in een bepaalde telperiode voor de verschillende regio’s over de jaren.

```{r telperiode-doelsoorten-langetermijn, message=FALSE}
for (soort in doelsoorten) {
  print(
    relfreqs_doelvogels %>% 
      filter(naam == soort) %>%
      ggplot() +
        geom_point(aes(x = periode_in_jaar, y = relfreq, colour = regio)) +
        labs(title = toString(soort), 
             y = "Relatieve frequentie", 
             x = "Telperiode") +
        scale_y_continuous(limits = c(0, 1)) +
        facet_wrap(~jaar)
    )
}
```

Telperiodes zijn herhalingen binnen een jaar en we zijn vooral geïnteresseerd in de wijzigingen van jaar tot jaar:

```{r telperiode-doelsoorten-langetermijn2, message=FALSE}
for (soort in doelsoorten) {
  print(
    relfreqs_doelvogels %>% 
    filter(naam == soort) %>%
    ggplot() +
      geom_jitter(aes(x = jaar, y = relfreq, colour = regio, 
                     shape = periode_in_jaar),
                  width = 0.1) +
      labs(title = toString(soort), y = "Relatieve frequentie", x = "") +
      scale_y_continuous(limits = c(NA, 1))
    )
}
```

> We berekenen de relatieve frequenties apart binnen voor elke regio binnen elk stratum in elke telperiode in elk jaar. Deze resultaten kunnen niet zomaar uitgemiddeld worden om tot een gemiddelde over de strata en over de jaren te komen. Dit moet verder uitgezocht worden.

```{r diversiteit-doelsoorten-langetermijn-strat}
relfreqs_doelvogels_strat <- mas_vogels %>% 
  filter(wrntype > 0L,
         openheid %in% c("HOL", "OL")) %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, stratum, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  mutate(jaar = factor(jaar)) %>%
  group_by(periode_in_jaar, jaar, regio, stratum) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
                   .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")
```

```{r telperiode-doelsoorten-langetermijn-strat, message=FALSE}
for (soort in doelsoorten) {
  for (reg in unique(diversiteit_vogels_strat$regio)) {
    print(
      relfreqs_doelvogels_strat %>% 
        filter(naam == soort, regio == reg) %>%
        ggplot() +
          geom_jitter(aes(x = as.factor(jaar), y = relfreq, colour = stratum,
                         shape = periode_in_jaar),
                      width = 0.1) +
          labs(title = toString(soort), 
               y = "Relatieve frequentie", 
               x = "") +
          expand_limits(y = 1) +
          facet_wrap(~regio)
        )
  }
}
```

Voor de Torenvalk wordt geen rekening gehouden met broedcodes. Alle waarnemingen zijn relevant o.w.v. terreingebruik. De relatieve frequentie is dus identiek als in **2.2**.

> Opgepast! In de volgende tabel wordt de gemiddelde relatieve frequentie berekend door een gemiddelde te nemen over de telperiodes en over de jaren (per regio en per soort). Het is mogelijks niet correct een ongewogen gemiddelde te nemen over de jaren heen. Dit moet verder uitgezocht worden. Over de telperiodes is op zich wel correct want dit zijn replicaten.

```{r freq-torenvalk-langetermijn}
relfreqs_vogels %>%
  filter(naam == "Torenvalk") %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  ungroup() %>%
  arrange(naam) %>%
  kable(digits = 2)
```

De volgende figuur toont de relatieve frequentie van de soort in een bepaalde telperiode voor de verschillende regio's over de jaren.

```{r telperiode-torenvalk-langetermijn, message=FALSE}
relfreqs_vogels %>%
  filter(naam == "Torenvalk") %>%
  ggplot() +
    geom_point(aes(x = periode_in_jaar, y = relfreq, colour = regio)) +
    labs(title = "Torenvalk", y = "Relatieve frequentie", x = "Telperiode") +
    scale_y_continuous(limits = c(0, 1)) +
    facet_wrap(~jaar, scales = "free_y")
```

Telperiodes zijn herhalingen binnen een jaar en we zijn vooral geïnteresseerd in de wijzigingen van jaar tot jaar:

```{r telperiode-torenvalk-langetermijn2, message=FALSE}
relfreqs_doelvogels %>% 
filter(naam == "Torenvalk") %>%
group_by(regio, jaar, periode_in_jaar) %>%
mutate(gemiddelde_freq = mean(relfreq)) %>%
ggplot() +
  geom_jitter(aes(x = jaar, y = gemiddelde_freq, colour = regio, 
                 shape = periode_in_jaar),
              width = 0.1) +
  labs(title = "Torenvalk", y = "Relatieve frequentie", x = "") +
  expand_limits(y = 1)
```

> We berekenen de relatieve frequenties apart binnen voor elke regio binnen elk stratum in elke telperiode in elk jaar. Deze resultaten kunnen niet zomaar uitgemiddeld worden om tot een gemiddelde over de strata en over de jaren te komen. Dit moet verder uitgezocht worden.

```{r diversiteit-torenvalk-langetermijn-strat}
relfreqs_torenvalk_strat <- mas_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, stratum, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  mutate(jaar = factor(jaar)) %>%
  group_by(periode_in_jaar, jaar, regio, stratum) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
                   .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")
```

```{r telperiode-torenvalk-langetermijn-strat, message=FALSE}
for (reg in unique(diversiteit_vogels_strat$regio)) {
  print(
    relfreqs_torenvalk_strat %>% 
      filter(naam == "Torenvalk", regio == reg) %>%
      ggplot() +
        geom_jitter(aes(x = as.factor(jaar), y = relfreq, colour = stratum,
                       shape = periode_in_jaar),
                    width = 0.1) +
        labs(title = "Torenvalk", 
             y = "Relatieve frequentie", 
             x = "") +
        expand_limits(y = 1) +
        facet_wrap(~regio)
    )
}
```


## Oppervlakte beheerovereenkomsten


```{r bo-2022}
bo_2022 <- read_sf(
  here("data/bo_vlm/BO_2022_VLM_EXTERN.shp")) %>%
  janitor::clean_names() %>%
  mutate(start = lubridate::ymd(start),
         stop = lubridate::ymd(stop),
         startjaar = year(start),
         stopjaar = year(stop)) %>%
  st_transform(crs = 31370)

perimeters <- read_sf(
  here("data", "processed", "piloot_perimeters.gpkg"))

sbp_akkervogels <- tar_read(sbp_akkervogels,
                            store = targets_store)
```

```{r opp-bo-data}
bo_dm_ol <- bo_2022 %>%
  st_intersection(y = perimeters)

openheid_sf <- rast(here("data", "dem",
    "openness300m_chm_res25_c300_mean_vlaanderen_classified.tif")) %>%
  mask(perimeters %>% st_buffer(dist = 50)) %>%
  as.polygons() %>%
  st_as_sf() %>%
  mutate(openheid = factor(focal_sum, labels = c("GL", "HGL", "HOL", "OL")))

#mapview::mapview(openheid_sf, zcol = "openheid")
binnen_sbp <- perimeters %>%
  st_intersection(sbp_akkervogels) %>%
  select(Naam) %>%
  mutate(opp = st_area(.),
         is_sbp = "binnen sbp")

buiten_sbp <- perimeters %>%
  st_difference(sbp_akkervogels %>%
                  st_union() %>%
                  st_combine()) %>%
  select(Naam) %>%
  mutate(opp = st_area(.),
         is_sbp = "buiten sbp")

sbp_sf <- bind_rows(buiten_sbp, binnen_sbp)

regio_sbp_openheid <- sbp_sf %>%
  select(regio = Naam, is_sbp) %>%
  st_intersection(openheid_sf %>% select(openheid))

opp_evolutie <- bo_dm_ol %>%
  filter(eenheid == "Hectare") %>%
  select(bh_doelst, srt_object, bh_pakket, start, stop, startjaar, stopjaar) %>%
  st_intersection(regio_sbp_openheid) %>%
  mutate(opp = st_area(.)) %>%
  st_drop_geometry()
```

De volgende figuur geeft de cumulatieve oppervlakte aan afgesloten beheerovereenkomsten voor de verschillende soortbeschermingsmaatregelen over de jaren en opgesplitst per stratum.
Deze cijfers gelden voor het volledige projectgebied van de Moeren en de Oostelijke leemstreek zoals gedefinieerd in het MAS pilootproject.

```{r opp-bo-evolutie, out.width="100%"}
opp_evolutie %>%
  expand_grid(jaar = 2018:2023) %>%
  mutate(
    opp2 = ifelse(startjaar <= jaar & stopjaar >= jaar, opp, 0)
  ) %>%
  filter(bh_doelst == "soortenbescherming (SB)",
         openheid %in% c("HOL", "OL")) %>%
  group_by(bh_doelst, srt_object, regio, is_sbp, openheid, jaar) %>%
  summarise(tot_opp_ha = sum(opp2) / 1e4,
            .groups = "drop") %>%
  ggplot() +
    geom_bar(aes(x = jaar, weight = tot_opp_ha,
                 fill = srt_object)) +
    scale_x_continuous(breaks = 2018:2023) +
    facet_grid(regio ~ openheid + is_sbp, scales = "free_y") +
    labs(y = "Oppervlakte (ha)",
         x = "") +
    theme(legend.position = "bottom",
          legend.title = element_blank(),
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```


## Dichtheden (aantal per 100ha)

> dichtheden herberekend aantal broedpaar per 100ha (internationale maat, en ook beschreven als doelen bij soortbeschermingsplan akkervogels), zodat we die kunnen vergelijken gemiddeld voor de moeren en de leemstreek.  

### Algemeen

Zijn de dichtheden in de Moeren opvallend hoger/lager dan in de leemstreek? **echter zonder rekening te houden met koppels, territoria of detectiekansen**.

```{r dichtheden}
meanabu <- mas_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  mutate(jaar = factor(jaar)) %>%
  group_by(jaar, periode_in_jaar, regio) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x) / n() * (100 * 1e4) / (pi * 300^2)),
            .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "aantal_per_100ha")
```

Overzicht van de 30 meest abundante soorten in een bepaalde regio. Elk punt staat voor een gemiddeld aantal broedparen per 100 ha in een bepaald jaar en een bepaalde telperiode van dat jaar.

```{r}
meanabu %>%
  mutate(naam = reorder(naam, aantal_per_100ha, FUN = "mean")) %>%
  filter(as.numeric(naam) > length(unique(naam)) - 30) %>%
  ggplot() +
    labs(y = "", x = "aantal_per_100ha") +
    geom_point(aes(x = aantal_per_100ha, y = naam, colour = regio))
```

Zonder spreeuw:

```{r, warning=FALSE}
meanabu %>%
  mutate(naam = reorder(naam, aantal_per_100ha, FUN = "mean")) %>%
  filter(as.numeric(naam) > length(unique(naam)) - 30) %>%
  mutate(aantal_per_100ha = replace(aantal_per_100ha, 
                                    naam == "Spreeuw", NA)) %>%
  ggplot() +
    labs(y = "", x = "aantal_per_100ha") +
    geom_point(aes(x = aantal_per_100ha, y = naam, colour = regio))
```

> Opgepast! In de volgende tabellen wordt de gemiddelde densiteit berekend door een gemiddelde te nemen over de telperiodes en over de jaren (per regio en per soort). Het is mogelijks niet correct een ongewogen gemiddelde te nemen over de jaren heen. Dit moet verder uitgezocht worden. Over de telperiodes is op zich wel correct want dit zijn replicaten.

Top 20 van soorten die in termen van verschil in gemiddelde aantallen meer abundant zijn in **de Moeren** (aantallen per 100 ha):

```{r meerabundant-moeren}
meanabu %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_aantal_per_100ha = mean(aantal_per_100ha)) %>%
  distinct(regio, naam, gemiddelde_aantal_per_100ha) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_aantal_per_100ha,
              values_fill = 0) %>%
  mutate(verschil = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  slice_max(verschil, n = 20) %>%
  kable(digits = 2)
```

Top 20 van soorten die in termen van verschil in gemiddelde aantallen meer abundant zijn in **de Leemstreek**:

```{r meerabundant-leemstreek}
meanabu %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_aantal_per_100ha = mean(aantal_per_100ha)) %>%
  distinct(regio, naam, gemiddelde_aantal_per_100ha) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_aantal_per_100ha,
              values_fill = 0) %>%
  mutate(verschil = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  slice_max(-verschil, n = 20) %>%
  kable(digits = 2)
```

### Doelsoorten

#### Gemiddelde dichtheden

Enkel data met broedcode > 0 zijn weerhouden. De dichtheden zullen dus niet exact hetzelfde zijn als in sectie \@ref(algemeen).

<!--Opgepast: verwarrend is dat het veld broedcode niet de broedcode bevat. Hiervoor moet je het veld `wrntype` hebben.-->

```{r dichtheden-doelsoorten}
meanabu_doel <- mas_vogels %>%
  filter(wrntype > 0L) %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  mutate(jaar = factor(jaar)) %>%
  group_by(jaar, periode_in_jaar, regio) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x) / n() * (100 * 1e4) / (pi * 300^2)),
            .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "aantal_per_100ha")
```

> Opgepast! In de volgende tabellen wordt de gemiddelde densiteit berekend door een gemiddelde te nemen over de telperiodes en over de jaren (per regio en per soort). Het is mogelijks niet correct een ongewogen gemiddelde te nemen over de jaren heen. Dit moet verder uitgezocht worden. Over de telperiodes is op zich wel correct want dit zijn replicaten.

```{r tabel-doelsoorten}
meanabu_doel %>%
  filter(naam %in% doelsoorten) %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_aantal_per_100ha = mean(aantal_per_100ha)) %>%
  distinct(regio, naam, gemiddelde_aantal_per_100ha) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_aantal_per_100ha,
              values_fill = 0) %>%
  ungroup() %>%
  arrange(naam) %>%
  kable(digits = 3)
```

De volgende figuren tonen de dichtheden van de doelsoorten in een bepaalde telperiode voor de verschillende regio’s over de jaren.

```{r telperiode-doelsoorten-dichtheden, message=FALSE}
for (soort in doelsoorten) {
  print(
    meanabu_doel %>% 
      filter(naam == soort) %>%
      ggplot() +
        geom_point(aes(x = periode_in_jaar, y = aantal_per_100ha, colour = regio)) +
        labs(title = toString(soort), 
             y = "Aantal per 100 ha", 
             x = "Telperiode") +
        facet_wrap(~jaar)
    )
}
```

Telperiodes zijn herhalingen binnen een jaar en we zijn vooral geïnteresseerd in de wijzigingen van jaar tot jaar:

```{r telperiode-doelsoorten-dichtheden2, message=FALSE}
for (soort in doelsoorten) {
  print(
    meanabu_doel %>% 
      filter(naam == soort) %>%
      ggplot() +
        geom_jitter(aes(x = jaar, y = aantal_per_100ha, colour = regio, 
                       shape = periode_in_jaar),
                    width = 0.1) +
        labs(title = toString(soort), y = "Aantal per 100 ha", x = "")
    )
}
```

> We berekenen de relatieve frequenties apart binnen voor elke regio binnen elk stratum in elke telperiode in elk jaar. Deze resultaten kunnen niet zomaar uitgemiddeld worden om tot een gemiddelde over de strata en over de jaren te komen. Dit moet verder uitgezocht worden.

```{r diversiteit-doelsoorten-dichtheden-strat}
meanabu_doelvogels_strat <- mas_vogels %>% 
  filter(wrntype > 0L) %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, stratum, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  mutate(jaar = factor(jaar)) %>%
  group_by(jaar, periode_in_jaar, stratum, regio) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x) / n() * (100 * 1e4) / (pi * 300^2)),
            .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "aantal_per_100ha")
```



```{r telperiode-doelsoorten-dichtheden-strat, message=FALSE}
for (soort in doelsoorten) {
  for (reg in unique(meanabu_doelvogels_strat$regio)) {
    print(
      meanabu_doelvogels_strat %>% 
        filter(naam == soort, regio == reg) %>%
        ggplot() +
          geom_jitter(aes(x = as.factor(jaar), y = aantal_per_100ha, 
                         colour = stratum, shape = periode_in_jaar),
                     width = 0.1) +
          labs(title = toString(soort), 
               y = "Aantal per 100 ha", 
               x = "") +
          facet_wrap(~regio, scales = "free_y")
      )
  }
}
```

Voor de Torenvalk wordt geen rekening gehouden met broedcodes. Alle waarnemingen zijn relevant o.w.v. terreingebruik. De densiteit is dus identiek als in **4.5.1**.

```{r tabel-torenvalk}
meanabu %>%
  filter(naam == "Torenvalk") %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_aantal_per_100ha = mean(aantal_per_100ha)) %>%
  distinct(regio, naam, gemiddelde_aantal_per_100ha) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_aantal_per_100ha,
              values_fill = 0) %>%
  ungroup() %>%
  arrange(naam) %>%
  kable(digits = 2)
```

De volgende figuur toont de dichtheden van de soort in een bepaalde telperiode voor de verschillende regio's over de jaren.

```{r telperiode-torenvalk-dichtheden, message=FALSE}
meanabu %>%
  filter(naam == "Torenvalk") %>%
  ggplot() +
    geom_point(aes(x = periode_in_jaar, y = aantal_per_100ha, colour = regio)) +
    labs(title = "Torenvalk", y = "Aantal per 100 ha", x = "Telperiode") +
    facet_wrap(~jaar)
```

Telperiodes zijn herhalingen binnen een jaar en we zijn vooral geïnteresseerd in de wijzigingen van jaar tot jaar:

```{r telperiode-torenvalk-dichtheden2, message=FALSE}
meanabu %>% 
filter(naam == "Torenvalk") %>%
ggplot() +
  geom_jitter(aes(x = jaar, y = aantal_per_100ha, colour = regio, 
                 shape = periode_in_jaar), 
              width = 0.1) +
  labs(title = "Torenvalk", y = "Aantal per 100 ha", x = "")
```

> We berekenen de relatieve frequenties apart binnen voor elke regio binnen elk stratum in elke telperiode in elk jaar. Deze resultaten kunnen niet zomaar uitgemiddeld worden om tot een gemiddelde over de strata en over de jaren te komen. Dit moet verder uitgezocht worden.

```{r diversiteit-torenvalk-dichtheden-strat}
meanabu_torenvalk_strat <- mas_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, stratum, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  mutate(jaar = factor(jaar)) %>%
  group_by(periode_in_jaar, jaar, regio, stratum) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x) / n() * (100 * 1e4) / (pi * 300^2)),
            .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "aantal_per_100ha")
```

```{r telperiode-torenvalk-dichtheden-strat, message=FALSE}
for (reg in unique(diversiteit_vogels_strat$regio)) {
  print(
    meanabu_torenvalk_strat %>% 
    filter(naam == "Torenvalk", regio == reg) %>%
    ggplot() +
      geom_jitter(aes(x = as.factor(jaar), y = aantal_per_100ha, colour = stratum,
                     shape = periode_in_jaar),
                  width = 0.1) +
      labs(title = "Torenvalk", 
           y = "Aantal per 100 ha", 
           x = "") +
      facet_wrap(~regio, scales = "free_y")
    )
}
```


#### Gemiddelde dichtheden op basis van max-aantal broedparen

Voor de volgende figuren werd eerst per soort voor elk telpunt het max aantal broedparen bepaald in een jaar (over telrondes heen).
Dit werd gedaan om de methodiek van SOVON te benaderen.
Deze maximum aantallen zijn een benadering voor het aantal territoria.
De gemiddelden werden hiervan berekend en een 95% betrouwbaarheidsinterval op basis van bootstrap samples.
**Hier is ook geen rekening gehouden met detectiekansen.**


```{r diversiteit-doelsoorten-dichtheden-strat-maxaantal}
mean_maxabu_doelvogels_strat <- mas_vogels %>% 
  filter((wrntype > 0L & 
         naam %in% doelsoorten) |
           naam == "Torenvalk") %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, stratum, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  mutate(jaar = factor(jaar)) %>%
  group_by(jaar, plotnaam, stratum, regio) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~max(.x)),
            .groups = "drop") %>%
  pivot_longer(cols = where(~ is.numeric(.x) && min(.x) == 0),
               names_to = "naam",
               values_to = "max_aantal") %>%
  group_by(jaar, stratum, regio, naam) %>%
  summarise(n = n(),
            mean_cl_boot(max_aantal),
            .groups = "drop") %>%
  mutate(y = y * (100 * 1e4) / (pi * 300^2),
         ymin = ymin * (100 * 1e4) / (pi * 300^2),
         ymax = ymin * (100 * 1e4) / (pi * 300^2))
```

```{r plot-maxaantal-dichtheden}
plotdichtheden <- function(data, regio, naam) {
  if (naam != "Torenvalk") {
    ggplot(data = data) +
      geom_pointrange(aes(x = factor(jaar), y = y, ymin = ymin, ymax = ymax,
                          colour = stratum),
                      position = position_dodge(width = 0.5)) +
      labs(x = "Jaar", y = "Aantal broedparen per 100 ha") +
      ggtitle(paste(regio, naam))
  } else {
    ggplot(data = data) +
      geom_pointrange(aes(x = factor(jaar), y = y, ymin = ymin, ymax = ymax,
                          colour = stratum),
                      position = position_dodge(width = 0.5)) +
      labs(x = "Jaar",
           y = "Aantal waarnemingen per 100 ha (incl. broedcode 0)") +
      ggtitle(paste(regio, naam))
  }
}
  
mean_maxabu_doelvogels_strat %>%
  group_by(regio, naam) %>%
  nest() %>%
  mutate(plot = pmap(list(data = data, regio = regio, naam = naam),
                     plotdichtheden)) %>%
  select(plot) %>%
  pull(plot)
```

