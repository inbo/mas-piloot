---
title: "Verkenning MAS veldwerk data van 2018 tot en met 2023"
author: "Ward Langeraert, Hans Van Calster"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# renv
renv::restore()

# Set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE)
opts_knit$set(root.dir = here())

# Conflicting packages
conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)

# Packages
library(tidyverse)
library(INBOtheme)
library(sf)
library(terra)

theme_set(theme_inbo(transparent = TRUE))

# Targets
library(targets)

## to use tar_read()
new_tar_vector <- function(value, objects) {
    out <- do.call(vctrs::vec_rbind, objects)
    if (any(sapply(out, inherits, what = "sfc"))) {
      sf::st_as_sf(out)
    } else {out}
}
try(assignInNamespace(
  "value_produce_aggregate.tar_vector",
  new_tar_vector,
  ns = "targets"))

targets_store <- here("src", "targets", "mas_steekproef_pilootfase", "_targets")

# Source
source(here("src", "R", "berekening_hulpvariabelen.R"))
source(here("src", "R", "wfs_wcs.R"))
media_folder <- here("media", "data_exploratie")
```

# Inlezen data

```{r}
data_path <- here("data", "processed")
mas_data_df_raw <- read_csv(here(data_path, "MAS_data_full_2018_2023.csv"))
mas_data_df <- mas_data_df_raw %>%
  rename(openheid  = openheid_klasse_300) %>%
  mutate(stratum = paste(openheid, sbp, sep = " - ")) %>%
  filter(!(regio ==  "De Moeren" & openheid == "HOL"))
mas_data_sf <- st_as_sf(mas_data_df, coords = c("x_lambert", "y_lambert"), 
                        crs = 31370)
```

```{r}
roofvogels_f <- function() {
  roofvogels <- c("Blauwe Kiekendief", "Boomvalk", "Bruine Kiekendief",
                  "Buizerd",
                  "Grauwe Kiekendief", "Ransuil", "Slechtvalk", "Sperwer",
                  "Steenuil", "Steppekiekendief", "Torenvalk", "Velduil",
                  "Wespendief", "Zwarte Wouw")

  return(roofvogels)
}

doelsoorten <- c(
  "Veldleeuwerik", 
  "Gele Kwikstaart", 
  "Geelgors", 
  "Kievit", 
  "Grasmus",
  "Witte Kwikstaart",
  "Ringmus",
  "Kwartel",
  "Kneu",
  "Torenvalk")
```

# Resultaten vogels 2022-2023

```{r selectie-vogels}
mas2022_2023 <- mas_data_sf %>%
  filter(soortgrp == 2,  # vogels
         jaar %in% 2022:2023,
         openheid %in% c("HOL", "OL"))

# To detect absences
bezoekenlijst_2022_2023 <- mas_data_df %>%
  filter(jaar %in% 2022:2023,
         openheid %in% c("HOL", "OL")) %>%
  distinct(plotnaam, regio, jaar, openheid, sbp, stratum, periode_in_jaar) %>%
  select(plotnaam, periode_in_jaar, everything())
```

Selectie van vogelsoorten waargenomen in 2022-2023 in HOL en OL.


## Enkele cijfers

```{r tabel-vogels, message=FALSE}
summary_mas2022_2023 <- mas2022_2023 %>%
  st_drop_geometry() %>%
  group_by(regio, jaar) %>%
  mutate(aantal_soorten_regiojaar = n_distinct(naam)) %>%
  group_by(regio, jaar, openheid, sbp) %>%
  mutate(aantal_waarnemingen = n_distinct(oid), 
         aantal_plots = n_distinct(plotid), 
         aantal_soorten_stratum = n_distinct(naam)) %>%
  ungroup() %>%
  distinct(regio, jaar, openheid, sbp, aantal_waarnemingen, aantal_plots,
           aantal_soorten_stratum, aantal_soorten_regiojaar) %>%
  arrange(regio, jaar, openheid, sbp)

summary_mas2022_2023 %>%
  kable()

mas2022_2023 <- mas2022_2023 %>% 
  group_by(regio) %>%
  mutate(plots_per_regio = n_distinct(plotid))
```


## Soortendiversiteit

Is de soortendiversiteit in De Moeren hoger dan in de leemstreek?

```{r soortendiversiteit}
diversiteit <- mas2022_2023 %>%
  st_drop_geometry() %>%
  group_by(regio, jaar, plotnaam, openheid, sbp, stratum, periode_in_jaar,
           naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop_last") %>%
  summarise(aantal_soorten = n(),
            .groups = "drop")
```

```{r soortenaantal-boxplot}
p <- diversiteit %>%
  mutate(stratum = gsub(" - ", " -\n", stratum)) %>%
  ggplot() +
    geom_hline(yintercept = 0, alpha = 0.2, linetype = "dashed") +
    geom_boxplot(aes(x = stratum, y = aantal_soorten,
                     colour = periode_in_jaar)) +
    facet_grid(jaar~regio, scales = "free_x") +
    labs(y = "Aantal soorten", x = "", colour = "Telperiode")
p
```

Om welke soorten gaat het?

```{r relfreqs-vogels}
relfreqs <- mas2022_2023 %>%
  st_drop_geometry() %>%
  group_by(regio, jaar, plotnaam, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  full_join(bezoekenlijst_2022_2023,
            by = join_by(regio, jaar, plotnaam, periode_in_jaar)) %>%
  replace(is.na(.), 0) %>%
  mutate(jaar = factor(jaar)) %>%
  group_by(jaar, periode_in_jaar, regio) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
            n = n(),
            .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")
```

Overzicht van relatieve frequenties van de 30 meest frequente soorten in een bepaalde regio. Elk punt staat voor een relatieve frequentie in een bepaalde telperiode van 2022_2023.

```{r soortenfreqs-vogels, fig.height = 200/25.4}
p <- relfreqs %>%
  mutate(naam = reorder(naam, relfreq, FUN = "mean")) %>%
  filter(as.numeric(naam) > length(unique(naam)) - 30) %>%
  ggplot() +
    geom_vline(xintercept = 0, alpha = 0.2, linetype = "dashed") +
    labs(y = "", x = "Relatieve frequentie") +
    geom_point(aes(x = relfreq, y = naam, colour = regio)) +
    labs(colour = "Regio") +
    facet_wrap(~jaar) +
    theme(legend.position = "top")
p
```

Top 20 van soorten die in termen van verschil in gemiddelde relatieve frequentie van voorkomen meer voorkomen in **De Moeren**. We nemen een gewogen gemiddelde omdat in bepaalde jaren en bepaalde telperiodes meer tellingen zijn geweest (hoewel dit bijna geen verschil is voor 2022-2023).

```{r meerfrequent-moeren}
relfreqs %>%
  group_by(regio, naam) %>%
  mutate(
    w = n / sum(n),
    gemiddelde_freq = weighted.mean(relfreq, w)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  slice_max(verschilfreq, n = 20) %>%
  kable(digits = 2)
```

Top 20 van soorten die in termen van verschil in gemiddelde relatieve frequentie van voorkomen meer voorkomen in de **Oostelijke Leemstreek**:

```{r meerfrequent-leemstreek}
relfreqs %>%
  group_by(regio, naam) %>%
  mutate(
    w = n / sum(n),
    gemiddelde_freq = weighted.mean(relfreq, w)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  slice_max(-verschilfreq, n = 20) %>%
  kable(digits = 2)
```


## Doelsoorten

```{r selectie-doelsoorten}
doel_df <- mas2022_2023 %>% 
  filter(naam %in% doelsoorten, 
         ifelse(naam == "Torenvalk", wrntype >= 0L, wrntype > 0L))
```

Enkel data met broedcode > 0 zijn weerhouden tenzij voor Torenvalk. We nemen een gewogen gemiddelde omdat in bepaalde telperiodes meer tellingen zijn geweest (hoewel dit bijna geen verschil is voor 2022-2023).

<!--Opgepast: verwarrend is dat het veld broedcode niet de broedcode bevat. Hiervoor moet je het veld `wrntype` hebben. In De Moeren is geen half-open landschap aanwezig (NA).-->

```{r diversiteit-doelsoorten}
relfreqs_doel <- doel_df %>% 
  st_drop_geometry() %>%
  group_by(regio, jaar, plotnaam, stratum, openheid, sbp, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  full_join(bezoekenlijst_2022_2023,
            by = join_by(regio, jaar, plotnaam, stratum, openheid, sbp,
                         periode_in_jaar)) %>%
  replace(is.na(.), 0) %>%
  mutate(jaar = factor(jaar)) %>%
  group_by(jaar, periode_in_jaar, regio, stratum, openheid, sbp) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
            n = n(),
            .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")

relfreqs_doel %>%
  group_by(regio, jaar, stratum, openheid, sbp, naam) %>%
  mutate(
    w = n / sum(n),
    gemiddelde_freq = weighted.mean(relfreq, w)) %>%
  distinct(regio, jaar, stratum, openheid, sbp, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  group_by(openheid, sbp) %>%
  arrange(naam) %>%
  select(-stratum) %>%
  kable(digits = 2)
```

De volgende figuur geeft een overzicht van de genoteerde broedcodes per regio voor elke soort. Een telling is hier geïnterpreteerd als een waarneming van een bepaalde soort op een bepaalde afstand in een bepaalde plot in een bepaalde telperiode. Er is dus geen rekening gehouden met het aantal vogels genoteerd per telling. De tellingen zijn hoger in de Leemstreek maar daar waren ook meer plots. Deze figuur geeft dus enkel de absolute aantallen weer. 

```{r broedcodes-doelsoorten, message=FALSE}
# Save totals to put labels on plot
strata_df <- doel_df %>%
  st_drop_geometry() %>%
  select(stratum, regio, jaar) %>%
  distinct()

# summarise data and make plot
i = 0
for (spec in sort(doelsoorten)) {
  i <- i + 1
  p <- doel_df %>%
    st_drop_geometry() %>%
    mutate(wrntype_omschrijving2 = paste(wrntype, wrntype_omschrijving, 
                                         sep = ": "),
           wrntype_omschrijving2 = reorder(wrntype_omschrijving2, wrntype,
                                           decreasing = TRUE)) %>%
    filter(naam == spec) %>%
    select(jaar, stratum, regio, wrntype_omschrijving2) %>%
    group_by(jaar, stratum, regio, wrntype_omschrijving2) %>%
    summarise(N = n(), .groups = "drop") %>%
    full_join(strata_df, by = join_by(stratum, regio, jaar)) %>%
    mutate(stratum = gsub(" - ", " -\n", stratum)) %>%
    mutate(regio = ifelse(regio =="Oostelijke leemstreek",
                          gsub("\\s", "\n", regio),
                          regio)) %>%
    ggplot(aes(x = stratum, y = N, fill = wrntype_omschrijving2)) +
      geom_hline(yintercept = 0, alpha = 0.2, linetype = "dashed") +
      geom_bar(stat = "identity") +
      scale_fill_discrete(drop = FALSE) +
      labs(y = "Aantal tellingen", x = "", title = spec, fill = "Broedcode") +
      facet_grid(regio~jaar, scales = "free")
  
  print(p)
  legend <- cowplot::get_legend(
    p + theme(legend.key.size = unit(0.5, 'cm'), #change legend key size
              legend.key.height = unit(0.5, 'cm'), #change legend key height
              legend.key.width = unit(0.5, 'cm'), #change legend key width
              legend.title = element_text(size = 10), #change legend title font size
              legend.text = element_text(size = 8))) #change legend text font size
  
  name <- tolower(gsub("\\s", "", spec))
  
  assign(paste0("p", i), p +
           theme(axis.title = element_text(size = 8),
                 axis.text = element_text(size = 6),
                 plot.title = element_text(size = 8),
                 strip.text = element_text(size = 8),
                 legend.position = "",
                 axis.text.x = element_text(angle = 90, vjust = 0.5,
                                            hjust = 1)))
}

lay <- rbind(c(1, 2, 3),
             c(4, 5, 6),
             c(7, 8, 9),
             c(10, 11, 11))

p_summ <- gridExtra::grid.arrange(
  p1 +
    theme(
      strip.background.y = element_blank(),
      strip.text.y = element_blank()
      ),
  p2 + 
    labs(y = "") +
    theme(
      strip.background.y = element_blank(),
      strip.text.y = element_blank()
      ),
  p3 + labs(y = ""),
  p4 + 
    theme(
      strip.background.y = element_blank(),
      strip.text.y = element_blank()
      ),
  p5 + labs(y = "") + 
    labs(y = "") +
    theme(
      strip.background.y = element_blank(),
      strip.text.y = element_blank()
      ),
  p6 + labs(y = ""),
  p7 +
    theme(
      strip.background.y = element_blank(),
      strip.text.y = element_blank()
      ),
  p8 + labs(y = "") + 
    labs(y = "") +
    theme(
      strip.background.y = element_blank(),
      strip.text.y = element_blank()
      ),
  p9 + labs(y = ""),
  p10 +
    theme(
      strip.background.y = element_blank(),
      strip.text.y = element_blank()
      ),
  legend,
  ncol = 3, nrow = 4, layout_matrix = lay)

ggsave(here(media_folder, "broedcode_mas_2022_2023.jpg"),
       p_summ,
       dpi = 300,
       width = 8,
       height = 10)
```

De volgende figuur toont de relatieve frequentie van de doelsoorten in een bepaalde telperiode voor de verschillende regio's gestratificeerd volgens openheid van het landschap en binnen of buiten sbp's. 

```{r telperiode-doelsoorten, message=FALSE}
for (spec in sort(doelsoorten)) {
  p <- relfreqs_doel %>%
    filter(naam == spec) %>%
    ggplot() +
      geom_hline(yintercept = 0, alpha = 0.2, linetype = "dashed") +
      labs(y = "Relatieve frequentie", x = "Telperiode", title = spec) +
      geom_point(aes(x = periode_in_jaar, y = relfreq,
                     colour = sbp, shape = openheid),
                 size = 3, position = position_dodge2(width = 0.3)) +
      facet_grid(jaar~regio) +
      scale_y_continuous(limits = c(0, NA))
  print(p)
}
```


# Resultaten zoogdieren 2022-2023

```{r selectie-zoogdieren}
zoogdieren <- mas_data_sf %>%
  filter(soortgrp == 1,                # zoogdieren
         jaar %in% 2022:2023,                 # 2022_2023
         openheid %in% c("HOL", "OL"))
```

Selectie van zoogdieren waargenomen in 2022-2023 in HOL en OL.

## Enkele cijfers

```{r tabel-zoogdieren}
summary_zoogdieren_2022_2023 <- zoogdieren %>%
  st_drop_geometry() %>% 
  group_by(regio, jaar, openheid, sbp) %>%
  summarise(aantal_waarnemingen = n_distinct(oid), 
            aantal_plots = n_distinct(plotid), 
            aantal_soorten = n_distinct(naam)) %>%
  arrange(regio, jaar, openheid, sbp)

write_csv(summary_zoogdieren_2022_2023,
          here(media_folder, "summary_zoogdieren_2022_2023.csv"))

summary_zoogdieren_2022_2023 %>%
  kable()
```


## Soortendiversiteit

```{r relfreqs-zoogdieren}
relfreqs_z <- zoogdieren %>%
  st_drop_geometry() %>%
  group_by(regio, jaar, plotnaam, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  full_join(bezoekenlijst_2022_2023,
            by = join_by(regio, jaar, plotnaam, periode_in_jaar)) %>%
  replace(is.na(.), 0) %>%
  mutate(jaar = factor(jaar)) %>%
  group_by(jaar, periode_in_jaar, regio) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
            n = n(),
            .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")
```

Overzicht van relatieve frequenties van de zoogdieren in een bepaalde regio. Elk punt staat voor een relatieve frequentie in een bepaalde telperiode van 2022_2023. De frequenties zijn relatief ten opzichte van de andere zoogdieren. Als er een zoogdier wordt gezien, is dit vaak de Haas.

```{r soortenfreqs-zoogdieren}
p <- relfreqs_z %>%
  mutate(naam = reorder(naam, relfreq, FUN = "mean")) %>%
  ggplot() +
    geom_vline(xintercept = 0, alpha = 0.2, linetype = "dashed") +
    labs(y = "", x = "Relatieve frequentie", colour = "Regio") +
    geom_point(aes(x = relfreq, y = naam, colour = regio)) +
    facet_wrap(~jaar) +
    theme(legend.position = "top")
p

ggsave(here(media_folder, "soortenfreqs_zoogdieren_2022_2023.jpg"),
       p,
       dpi = 300,
       width = 8,
       height = 6)
```

We nemen een gewogen gemiddelde omdat in bepaalde jaren en bepaalde telperiodes meer tellingen zijn geweest (hoewel dit bijna geen verschil is voor 2022-2023).
 
```{r freqtable-zoogdieren}
relfreqs_z %>%
  group_by(regio, naam) %>%
  mutate(
    w = n / sum(n),
    gemiddelde_freq = weighted.mean(relfreq, w)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  # Same order as in the previous plot
  rowwise() %>%
  mutate(max = max(`De Moeren`, `Oostelijke leemstreek`)) %>%
  arrange(desc(max)) %>% select(-max) %>%
  kable(digits = 5)

relfreqs_z %>%
  group_by(regio, naam) %>%
  mutate(
    w = n / sum(n),
    gemiddelde_freq = weighted.mean(relfreq, w)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  # Same order as in the previous plot
  rowwise() %>%
  mutate(max = max(`De Moeren`, `Oostelijke leemstreek`)) %>%
  ungroup() %>%
  arrange(desc(max)) %>% select(-max) %>%
  mutate(regio = ifelse(verschilfreq > 0,
                        "De Moeren", "Oostelijke leemstreek"),
         rang = row_number()) %>%
  write_csv(here(media_folder, "verschilfreq_zoogdieren_2022_2023.csv"))
```


# Resultaten vogels 2018--2023

```{r selectie-vogels-langetermijn}
mas_vogels <- mas_data_sf %>%
  st_drop_geometry() %>%
  filter(soortgrp == 2,                # vogels
         openheid %in% c("HOL", "OL"))

# To detect absences
bezoekenlijst_2018_2023 <- mas_data_df %>%
  filter(openheid %in% c("HOL", "OL")) %>%
  distinct(plotnaam, regio, jaar, openheid, sbp, stratum, periode_in_jaar) %>%
  select(plotnaam, periode_in_jaar, everything())
```

Selectie van vogelsoorten in HOL en OL


## Enkele cijfers

```{r tabel-langetermijn, message=FALSE}
summary_mas2018_2023 <- mas_vogels %>%
  group_by(regio, jaar) %>%
  mutate(aantal_soorten_regiojaar = n_distinct(naam)) %>%
  group_by(regio, jaar, openheid, sbp) %>%
  mutate(aantal_waarnemingen = n_distinct(oid), 
         aantal_plots = n_distinct(plotid), 
         aantal_soorten_stratum = n_distinct(naam)) %>%
  ungroup() %>%
  distinct(regio, jaar, openheid, sbp, aantal_waarnemingen, aantal_plots,
           aantal_soorten_stratum, aantal_soorten_regiojaar) %>%
  arrange(regio, jaar, openheid, sbp)

write_csv(summary_mas2018_2023, here(media_folder, "summary_mas_2018_2023.csv"))

summary_mas2018_2023 %>%
  kable()
```

```{r aantal-plots, message=FALSE}
mas_vogels %>% 
  group_by(regio, jaar, openheid, sbp) %>%
  st_drop_geometry() %>%
  summarise(tellingen = n_distinct(oid), 
            plots = n_distinct(plotid),
            .groups = "drop") %>%
  pivot_longer(cols = c(tellingen, plots),
               names_to = "legende",
               values_to = "aantal") %>%
  group_by(regio, jaar, legende) %>%
  mutate(tot = sum(aantal)) %>%
  ggplot() +
    geom_point(aes(x = jaar, y = aantal, colour = openheid, shape = sbp)) +
    geom_point(aes(x = jaar, y = tot, alpha = ""),
             shape = 8, colour = "darkgreen") +
    labs(x = "", y = "Aantal", alpha = "totaal aantal\nper jaar in regio") +
    scale_alpha_manual(values = 1) +
    facet_grid(legende~regio, scales = "free_y") 
```

```{r}
p <- mas_vogels %>%
  group_by(regio, jaar, periode_in_jaar) %>%
  mutate(n_per_telperiode = n_distinct(plotnaam)) %>%
  ungroup() %>%
  select(regio, jaar, periode_in_jaar, n_per_telperiode) %>%
  distinct() %>%
  ggplot(aes(x = periode_in_jaar, y = n_per_telperiode, 
             fill = periode_in_jaar)) +
    geom_hline(yintercept = 0, alpha = 0.2, linetype = "dashed") +
    geom_bar(stat = "identity") +
    facet_grid(regio~jaar, scales = "free_y") +
    labs(x = "Telperiode", y = "Aantal tellingen") +
    theme(legend.position = "")

p

ggsave(here(media_folder, "tellingen_mas_2018_2023.jpg"),
       p,
       dpi = 300,
       width = 8,
       height = 6)
```

```{r}
p <- mas_vogels %>%
  group_by(regio, jaar, periode_in_jaar, plotnaam) %>%
  summarise(n = n(), .groups = "drop") %>%
  ggplot(aes(x = periode_in_jaar, y = n, colour = periode_in_jaar)) +
    geom_hline(yintercept = 0, alpha = 0.2, linetype = "dashed") +
    geom_boxplot() +
    facet_grid(regio~jaar, scales = "free_y") +
    labs(x = "Telperiode", y = "Aantal waarnemingen") +
    theme(legend.position = "")
p
```

```{r}
p <- mas_vogels %>%
  group_by(regio, jaar, periode_in_jaar, plotnaam) %>%
  summarise(n = n(), .groups = "drop") %>%
  ggplot(aes(x = periode_in_jaar, y = n, fill = regio)) +
    geom_hline(yintercept = 0, alpha = 0.2, linetype = "dashed") +
    geom_boxplot() +
    facet_wrap(~jaar, scales = "free_y") +
    labs(x = "Telperiode", y = "Aantal waarnemingen", fill = "Regio")
p

ggsave(here(media_folder, "waarnemingen_mas_2018_2023.jpg"),
       p,
       dpi = 300,
       width = 8,
       height = 6)
```


## Soortendiversiteit

Is de soortendiversiteit in De Moeren hoger dan in de leemstreek?

```{r}
p <- mas_vogels %>%
  group_by(regio, jaar, periode_in_jaar, plotnaam) %>%
  summarise(n = n_distinct(naam), .groups = "drop") %>%
  ggplot(aes(x = periode_in_jaar, y = n, colour = periode_in_jaar)) +
    geom_hline(yintercept = 0, alpha = 0.2, linetype = "dashed") +
    geom_boxplot() +
    facet_grid(regio~jaar, scales = "free_y") +
    labs(x = "Telperiode", y = "Aantal soorten") +
    theme(legend.position = "")
p
```

```{r}
p <- mas_vogels %>%
  group_by(regio, jaar, periode_in_jaar, plotnaam) %>%
  summarise(n = n_distinct(naam), .groups = "drop") %>%
  ggplot(aes(x = periode_in_jaar, y = n, fill = regio)) +
    geom_hline(yintercept = 0, alpha = 0.2, linetype = "dashed") +
    geom_boxplot() +
    facet_wrap(~jaar) +
    labs(x = "Telperiode", y = "Aantal soorten", fill = "Regio")
p

ggsave(here(media_folder, "soorten_mas_2018_2023.jpg"),
       p,
       dpi = 300,
       width = 8,
       height = 6)
```

Gestratificeerd:

```{r soortendiversiteit-langetermijn-strat}
diversiteit_vogels_strat <- mas_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, openheid, sbp, stratum, jaar, periode_in_jaar, 
           naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop_last") %>%
  summarise(aantal_soorten = n(),
            .groups = "drop")
```

```{r soortenaantal-boxplot-langetermijn-strat}
p <- diversiteit_vogels_strat %>%
  ggplot() +
    geom_hline(yintercept = 0, alpha = 0.2, linetype = "dashed") +
    labs(y = "Aantal soorten", x = "Telperiode", fill = "Stratum") +
    geom_boxplot(aes(x = periode_in_jaar, y = aantal_soorten, fill = stratum)) +
    facet_grid(regio~jaar) +
  theme(legend.position = "top")
p
```

Om welke soorten gaat het?

```{r relfreqs-langetermijn}
relfreqs_vogels <- mas_vogels %>%
  st_drop_geometry() %>%
  filter(ifelse(naam %in% roofvogels_f(), wrntype >= 0L, wrntype > 0L)) %>%
  group_by(regio, plotnaam, jaar, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  full_join(bezoekenlijst_2018_2023,
            by = join_by(regio, jaar, plotnaam, periode_in_jaar)) %>%
  replace(is.na(.), 0) %>%
  mutate(jaar = factor(jaar)) %>%
  group_by(jaar, periode_in_jaar, regio) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
            n = n(),
            .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")
```

Overzicht van relatieve frequenties van de 20 meest frequente soorten in een bepaalde regio. Elk punt staat voor een relatieve frequentie in een bepaald jaar en een bepaalde telperiode van dat jaar. Enkel data met broedcode > 0 zijn weerhouden tenzij voor roofvogels.

```{r}
library(ggtext)
highlight <- function(x, pat, color="black", family="") {
  ifelse(x %in% pat,
         glue::glue("<b style='font-family:{family}; color:{color}'>{x}</b>"),
         x)
}
```

```{r soortenfreqs-langetermijn, fig.height = 200/25.4}
p <- relfreqs_vogels %>%
  mutate(naam = reorder(naam, relfreq, FUN = "mean")) %>%
  filter(as.numeric(naam) > length(unique(naam)) - 20 |
           naam %in% doelsoorten) %>%
  ggplot() +
    geom_vline(xintercept = 0, alpha = 0.2, linetype = "dashed") +
    geom_point(aes(x = relfreq, y = naam, colour = regio),
               size = 1) +
    labs(y = "", x = "Relatieve frequentie", colour = "Regio") +
    facet_wrap(~jaar, nrow = 3) +
    scale_y_discrete(labels = function(x) highlight(x, doelsoorten, "red")) +
    theme(legend.position = "top",
          axis.text = element_text(size = 8),
          axis.text.y = element_markdown()) +
    guides(colour = guide_legend(override.aes = list(size = 3)))
p

ggsave(here(media_folder, "soortenfreqs_mas_2018_2023.jpg"),
       p,
       dpi = 300,
       width = 6,
       height = 10)
```

> Opgepast! In de volgende tabellen wordt de gemiddelde relatieve frequentie berekend door een gemiddelde te nemen over de telperiodes en over de jaren (per regio en per soort). Het is mogelijks niet correct een ongewogen gemiddelde te nemen over de jaren heen. Dit moet verder uitgezocht worden. Over de telperiodes is op zich wel correct want dit zijn replicaten.

Top 20 van soorten die in termen van verschil in gemiddelde relatieve frequentie van voorkomen meer voorkomen in **De Moeren** dan in de Oostelijke leemstreek:

```{r meerfrequent-moeren-langetermijn}
relfreqs_vogels %>%
  group_by(regio, naam) %>%
  mutate(
    w = n / sum(n),
    gemiddelde_freq = weighted.mean(relfreq, w)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  slice_max(verschilfreq, n = 20) %>%
  kable(digits = 2)
```

```{r}
verschil_dm_2018_2023 <- relfreqs_vogels %>%
  group_by(jaar, regio, naam) %>%
  mutate(
    w = n / sum(n),
    gemiddelde_freq = weighted.mean(relfreq, w)) %>%
  distinct(jaar, regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  group_by(jaar) %>%
  slice_max(verschilfreq, n = 20) %>%
  mutate(rang = row_number()) %>%
  ungroup()
```


Top 20 van soorten die in termen van verschil in gemiddelde relatieve frequentie van voorkomen meer voorkomen in **de Oostelijke leemstreek** dan in De Moeren:

```{r meerfrequent-leemstreek-langetermijn}
relfreqs_vogels %>%
  group_by(regio, naam) %>%
  mutate(
    w = n / sum(n),
    gemiddelde_freq = weighted.mean(relfreq, w)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  slice_max(-verschilfreq, n = 20) %>%
  kable(digits = 2)
```

```{r}
verschil_ol_2018_2023 <- relfreqs_vogels %>%
  group_by(jaar, regio, naam) %>%
  mutate(
    w = n / sum(n),
    gemiddelde_freq = weighted.mean(relfreq, w)) %>%
  distinct(jaar, regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  group_by(jaar) %>%
  slice_max(-verschilfreq, n = 20) %>%
  mutate(rang = row_number()) %>%
  ungroup()
```

```{r}
bind_rows(verschil_dm_2018_2023, verschil_ol_2018_2023) %>%
  mutate(regio = ifelse(verschilfreq > 0,
                        "De Moeren", "Oostelijke leemstreek")) %>%
  write_csv(here(media_folder, "verschilfreq_mas_2018_2023.csv"))
```


## Doelsoorten

```{r selectie-doelsoorten-langetermijn}
doel_vogels <- mas_vogels %>% 
  filter(naam %in% doelsoorten,
         ifelse(naam == "Torenvalk", wrntype >= 0L, wrntype > 0L)) 
```

Enkel data met broedcode > 0 zijn weerhouden tenzij voor Torenvalk. De relatieve frequenties zullen dus niet exact hetzelfde zijn als in **4.2**.

<!--Opgepast: verwarrend is dat het veld broedcode niet de broedcode bevat. Hiervoor moet je het veld `wrntype` hebben.-->

> Opgepast! In de volgende tabel wordt de gemiddelde relatieve frequentie berekend door een gemiddelde te nemen over de telperiodes en over de jaren (per regio en per soort). Het is mogelijks niet correct een ongewogen gemiddelde te nemen over de jaren heen. Dit moet verder uitgezocht worden. Over de telperiodes is op zich wel correct want dit zijn replicaten.

 We nemen een gewogen gemiddelde.

```{r diversiteit-doelsoorten-langetermijn}
relfreqs_doel_2018_2023_jaar <- doel_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  full_join(bezoekenlijst_2018_2023,
            by = join_by(regio, jaar, plotnaam, periode_in_jaar)) %>%
  replace(is.na(.), 0) %>%
  mutate(jaar = factor(jaar)) %>%
  group_by(periode_in_jaar, jaar, regio) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
            n = n(),
            .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")

relfreqs_doel_2018_2023_jaar %>%
  filter(naam %in% doelsoorten) %>%
  group_by(regio, jaar, naam) %>%
  mutate(
    w = n / sum(n),
    gemiddelde_freq = weighted.mean(relfreq, w)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  ungroup() %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  arrange(naam) %>%
  kable(digits = 2)
```

De volgende figuren tonen de relatieve frequentie van de doelsoorten in een bepaalde telperiode voor de verschillende regio’s over de jaren.

```{r telperiode-doelsoorten-langetermijn, message=FALSE}
for (spec in sort(doelsoorten)) {
  p <- relfreqs_doel_2018_2023_jaar %>% 
      filter(naam == spec) %>%
      ggplot() +
        geom_hline(yintercept = 0, alpha = 0.2, linetype = "dashed") +
        geom_point(aes(x = periode_in_jaar, y = relfreq, colour = regio)) +
        labs(title = toString(spec), 
             y = "Relatieve frequentie", 
             x = "Telperiode",
             colour = "Regio") +
        scale_y_continuous(limits = c(0, NA)) +
        facet_wrap(~jaar)
  print(p)
}
```

Telperiodes zijn herhalingen binnen een jaar en we zijn vooral geïnteresseerd in de wijzigingen van jaar tot jaar:

```{r telperiode-doelsoorten-langetermijn2, message=FALSE}
for (spec in doelsoorten) {
  p <- relfreqs_doel_2018_2023_jaar %>% 
    filter(naam == spec) %>%
    ggplot() +
    geom_hline(yintercept = 0, alpha = 0.2, linetype = "dashed") +
    geom_point(aes(x = jaar, y = relfreq, colour = regio, 
                    shape = periode_in_jaar),
               position = position_dodge2(width = 0.4)) +
    labs(title = toString(spec), y = "Relatieve frequentie", x = "",
         colour = "Regio", shape = "Telperiode") +
    scale_y_continuous(limits = c(0, NA))
  print(p)
  
  name <- tolower(gsub("\\s", "", spec))
}
```

> We berekenen de relatieve frequenties apart binnen voor elke regio binnen elk stratum in elke telperiode in elk jaar. Deze resultaten kunnen niet zomaar uitgemiddeld worden om tot een gemiddelde over de strata en over de jaren te komen. Dit moet verder uitgezocht worden.

Gewogen gemiddelde.

```{r diversiteit-doelsoorten-langetermijn-strat}
relfreqs_doelvogels_strat <- mas_vogels %>% 
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, stratum, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  full_join(bezoekenlijst_2018_2023,
            by = join_by(regio, plotnaam, jaar, stratum, periode_in_jaar)) %>%
  replace(is.na(.), 0) %>%
  mutate(jaar = factor(jaar)) %>%
  group_by(periode_in_jaar, jaar, regio, stratum) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
            n = n(),
            .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")
```

```{r telperiode-doelsoorten-langetermijn-strat, message=FALSE}
for (spec in sort(doelsoorten)) {
  p <- relfreqs_doelvogels_strat %>%
      filter(naam == spec) %>%
      mutate(stratum = factor(stratum,
                              levels = c("OL - binnen",
                                         "OL - buiten",
                                         "HOL - binnen",
                                         "HOL - buiten"))) %>%
      ggplot() +
        geom_hline(yintercept = 0, alpha = 0.2, linetype = "dashed") +
        geom_point(aes(x = jaar, y = relfreq, colour = stratum, 
                      shape = periode_in_jaar),
                   position = position_dodge2(width = 0.4))  +
        labs(title = toString(spec), 
             y = "Relatieve frequentie", 
             x = "",
             shape = "Telperiode",
             colour = "Stratum") +
        scale_y_continuous(limits = c(0, NA)) +
        facet_wrap(~regio, strip.position = "right", ncol = 1)
  print(p)
  
  name <- tolower(gsub("\\s", "", spec))
}
```


## Oppervlakte beheerovereenkomsten


```{r bo-2022}
bo_2022 <- read_sf(
  here("data/bo_vlm/BO_2022_VLM_EXTERN.shp")) %>%
  janitor::clean_names() %>%
  mutate(start = lubridate::ymd(start),
         stop = lubridate::ymd(stop),
         startjaar = year(start),
         stopjaar = year(stop)) %>%
  st_transform(crs = 31370)

perimeters <- read_sf(
  here("data", "processed", "piloot_perimeters.gpkg"))

sbp_akkervogels <- tar_read(sbp_akkervogels,
                            store = targets_store)
```

```{r opp-bo-data}
bo_dm_ol <- bo_2022 %>%
  st_intersection(y = perimeters)

openheid_sf <- rast(here("data", "dem",
    "openness300m_chm_res25_c300_mean_vlaanderen_classified.tif")) %>%
  mask(perimeters %>% st_buffer(dist = 50)) %>%
  as.polygons() %>%
  st_as_sf() %>%
  mutate(openheid = factor(focal_sum, labels = c("GL", "HGL", "HOL", "OL")))

#mapview::mapview(openheid_sf, zcol = "openheid")
binnen_sbp <- perimeters %>%
  st_intersection(sbp_akkervogels) %>%
  select(Naam) %>%
  mutate(opp = st_area(.),
         is_sbp = "binnen sbp")

buiten_sbp <- perimeters %>%
  st_difference(sbp_akkervogels %>%
                  st_union() %>%
                  st_combine()) %>%
  select(Naam) %>%
  mutate(opp = st_area(.),
         is_sbp = "buiten sbp")

sbp_sf <- bind_rows(buiten_sbp, binnen_sbp)

regio_sbp_openheid <- sbp_sf %>%
  select(regio = Naam, is_sbp) %>%
  st_intersection(openheid_sf %>% select(openheid))

opp_evolutie <- bo_dm_ol %>%
  filter(eenheid == "Hectare") %>%
  select(bh_doelst, srt_object, bh_pakket, start, stop, startjaar, stopjaar) %>%
  st_intersection(regio_sbp_openheid) %>%
  mutate(opp = st_area(.)) %>%
  st_drop_geometry()
```

De volgende figuur geeft de cumulatieve oppervlakte aan afgesloten beheerovereenkomsten voor de verschillende soortbeschermingsmaatregelen over de jaren en opgesplitst per stratum.
Deze cijfers gelden voor het volledige projectgebied van de Moeren en de Oostelijke leemstreek zoals gedefinieerd in het MAS pilootproject.

```{r opp-bo-evolutie, out.width="100%"}
p <- opp_evolutie %>%
  expand_grid(jaar = 2018:2023) %>%
  mutate(
    opp2 = ifelse(startjaar <= jaar & stopjaar >= jaar, opp, 0)
  ) %>%
  filter(bh_doelst == "soortenbescherming (SB)",
         openheid %in% c("HOL", "OL")) %>%
  group_by(bh_doelst, srt_object, regio, is_sbp, openheid, jaar) %>%
  summarise(tot_opp_ha = sum(opp2) / 1e4,
            .groups = "drop") %>%
  ggplot() +
    geom_bar(aes(x = jaar, weight = tot_opp_ha,
                 fill = srt_object)) +
    scale_x_continuous(breaks = 2018:2023) +
    facet_grid(regio ~ openheid + is_sbp, scales = "free_y") +
    labs(y = "Oppervlakte (ha)",
         x = "") +
    theme(legend.position = "bottom",
          legend.title = element_blank(),
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
p

ggsave(here(media_folder,
            paste0("soortbeschermingsmaatregelen1_2018_2023.jpg")),
       p,
       dpi = 300,
       width = 8,
       height = 6)
```

Proporties binnen telcirkels:

```{r}
p <- mas_vogels %>%
  distinct(plotnaam, jaar, regio, sbp, openheid, stratum, area_prop_sb) %>%
  ggplot() +
    geom_boxplot(aes(x = factor(jaar), y = area_prop_sb)) +
    facet_wrap(~regio) +
    labs(x = "", y = "Proportie soorbeschermingsmaatregelen") +
    theme(legend.position = "bottom",
          legend.title = element_blank(),
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
p

ggsave(here(media_folder, paste0("soortbeschermingsmaatregelen2_2018_2023.jpg")),
       p,
       dpi = 300,
       width = 8,
       height = 6)
```


```{r}
p <- mas_vogels %>%
  distinct(plotnaam, jaar, regio, sbp, openheid, stratum, area_prop_sb) %>%
  ggplot() +
    geom_boxplot(aes(x = factor(jaar), y = area_prop_sb)) +
    facet_grid(regio ~ openheid + sbp, scales = "free_y") +
    labs(x = "", y = "Proportie soorbeschermingsmaatregelen") +
    theme(legend.position = "bottom",
          legend.title = element_blank(),
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
p
```

## Dichtheden (aantal per 100ha)

> dichtheden herberekend aantal broedpaar per 100ha (internationale maat, en ook beschreven als doelen bij soortbeschermingsplan akkervogels), zodat we die kunnen vergelijken gemiddeld voor De moeren en de Oostelijke leemstreek.  

### Algemeen

Zijn de dichtheden in De Moeren opvallend hoger/lager dan in de Oostelijke leemstreek? **echter zonder rekening te houden met koppels, territoria of detectiekansen**.

```{r dichtheden}
meanabu <- mas_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  mutate(jaar = factor(jaar)) %>%
  group_by(jaar, periode_in_jaar, regio) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x) / n() * (100 * 1e4) / (pi * 300^2)),
            n = n(),
            .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "aantal_per_100ha")
```

Overzicht van de 30 meest abundante soorten in een bepaalde regio. Elk punt staat voor een gemiddeld aantal broedparen per 100 ha in een bepaald jaar en een bepaalde telperiode van dat jaar.

```{r}
meanabu %>%
  mutate(naam = reorder(naam, aantal_per_100ha, FUN = "mean")) %>%
  filter(as.numeric(naam) > length(unique(naam)) - 30) %>%
  ggplot() +
    labs(y = "", x = "aantal_per_100ha") +
    geom_point(aes(x = aantal_per_100ha, y = naam, colour = regio))
```

Zonder spreeuw:

```{r, warning=FALSE}
meanabu %>%
  mutate(naam = reorder(naam, aantal_per_100ha, FUN = "mean")) %>%
  filter(as.numeric(naam) > length(unique(naam)) - 30) %>%
  mutate(aantal_per_100ha = replace(aantal_per_100ha, 
                                    naam == "Spreeuw", NA)) %>%
  ggplot() +
    labs(y = "", x = "aantal_per_100ha") +
    geom_point(aes(x = aantal_per_100ha, y = naam, colour = regio))
```

> Opgepast! In de volgende tabellen wordt de gemiddelde densiteit berekend door een gemiddelde te nemen over de telperiodes en over de jaren (per regio en per soort). Het is mogelijks niet correct een ongewogen gemiddelde te nemen over de jaren heen. Dit moet verder uitgezocht worden. Over de telperiodes is op zich wel correct want dit zijn replicaten.

Gewogen gemiddelde.

Top 20 van soorten die in termen van verschil in gemiddelde aantallen meer abundant zijn in **de Moeren** (aantallen per 100 ha):

```{r meerabundant-moeren}
meanabu %>%
  group_by(regio, naam) %>%
  mutate(
    w = n / sum(n),
    gemiddelde_aantal_per_100ha = weighted.mean(aantal_per_100ha, w)) %>%
  ungroup() %>%
  distinct(regio, naam, gemiddelde_aantal_per_100ha) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_aantal_per_100ha,
              values_fill = 0) %>%
  mutate(verschil = `De Moeren` - `Oostelijke leemstreek`) %>%
  slice_max(verschil, n = 20) %>%
  kable(digits = 2)
```

Top 20 van soorten die in termen van verschil in gemiddelde aantallen meer abundant zijn in **de Leemstreek**:

```{r meerabundant-leemstreek}
meanabu %>%
  group_by(regio, naam) %>%
  mutate(
    w = n / sum(n),
    gemiddelde_aantal_per_100ha = weighted.mean(aantal_per_100ha, w)) %>%
  ungroup() %>%
  distinct(regio, naam, gemiddelde_aantal_per_100ha) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_aantal_per_100ha,
              values_fill = 0) %>%
  mutate(verschil = `De Moeren` - `Oostelijke leemstreek`) %>%
  slice_max(-verschil, n = 20) %>%
  kable(digits = 2)
```

### Doelsoorten

#### Gemiddelde dichtheden

Enkel data met broedcode > 0 zijn weerhouden tenzij voor Torenvalk. De dichtheden zullen dus niet exact hetzelfde zijn als in sectie \@ref(algemeen).

<!--Opgepast: verwarrend is dat het veld broedcode niet de broedcode bevat. Hiervoor moet je het veld `wrntype` hebben.-->

```{r dichtheden-doelsoorten}
meanabu_doel <- doel_vogels  %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  full_join(bezoekenlijst_2018_2023,
            by = join_by(regio, jaar, plotnaam, periode_in_jaar)) %>%
  replace(is.na(.), 0) %>%
  mutate(jaar = factor(jaar)) %>%
  group_by(jaar, periode_in_jaar, regio) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x) / n() * (100 * 1e4) / (pi * 300^2)),
            n = n(),
            .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "aantal_per_100ha")
```

> Opgepast! In de volgende tabellen wordt de gemiddelde densiteit berekend door een gemiddelde te nemen over de telperiodes en over de jaren (per regio en per soort). Het is mogelijks niet correct een ongewogen gemiddelde te nemen over de jaren heen. Dit moet verder uitgezocht worden. Over de telperiodes is op zich wel correct want dit zijn replicaten.

Gewogen gemiddelde.

```{r tabel-doelsoorten}
meanabu_doel %>%
  filter(naam %in% doelsoorten) %>%
  group_by(regio, naam) %>%
  mutate(
    w = n / sum(n),
    gemiddelde_aantal_per_100ha = weighted.mean(aantal_per_100ha, w)) %>%
  distinct(regio, naam, gemiddelde_aantal_per_100ha) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_aantal_per_100ha,
              values_fill = 0) %>%
  ungroup() %>%
  arrange(naam) %>%
  kable(digits = 3)
```

De volgende figuren tonen de dichtheden van de doelsoorten in een bepaalde telperiode voor de verschillende regio’s over de jaren.

```{r telperiode-doelsoorten-dichtheden, message=FALSE}
for (spec in sort(doelsoorten)) {
  p <- meanabu_doel %>% 
    filter(naam == spec) %>%
    ggplot() +
      geom_hline(yintercept = 0, alpha = 0.2, linetype = "dashed") +
      geom_point(aes(x = periode_in_jaar, y = aantal_per_100ha, colour = regio)) +
      labs(title = toString(spec), 
           y = "Aantal per 100 ha", 
           x = "Telperiode",
           colour = "Regio") +
      scale_y_continuous(limits = c(0, NA)) +
      facet_wrap(~jaar)
  print(p)
}
```

Telperiodes zijn herhalingen binnen een jaar en we zijn vooral geïnteresseerd in de wijzigingen van jaar tot jaar:

```{r telperiode-doelsoorten-dichtheden2, message=FALSE}
for (spec in sort(doelsoorten)) {
  p <- meanabu_doel %>% 
    filter(naam == spec) %>%
    ggplot() +
    geom_hline(yintercept = 0, alpha = 0.2, linetype = "dashed") +
    geom_point(aes(x = jaar, y = aantal_per_100ha, colour = regio, 
                    shape = periode_in_jaar),
               position = position_dodge2(width = 0.4)) +
    labs(title = toString(spec), y = "Aantal per 100 ha", x = "",
         colour = "Regio", shape = "Telperiode") +
    scale_y_continuous(limits = c(0, NA))
  print(p)
}
```

> We berekenen de relatieve frequenties apart binnen voor elke regio binnen elk stratum in elke telperiode in elk jaar. Deze resultaten kunnen niet zomaar uitgemiddeld worden om tot een gemiddelde over de strata en over de jaren te komen. Dit moet verder uitgezocht worden.

```{r diversiteit-doelsoorten-dichtheden-strat}
meanabu_doelvogels_strat <- doel_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, stratum, periode_in_jaar, naam) %>%
  summarise(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  full_join(bezoekenlijst_2018_2023,
            by = join_by(regio, plotnaam, jaar, stratum, periode_in_jaar)) %>%
  replace(is.na(.), 0) %>%
  mutate(jaar = factor(jaar)) %>%
  group_by(jaar, periode_in_jaar, stratum, regio) %>%
  summarise(across(.cols = where(~ is.numeric(.x) && min(.x) == 0),
                   .fns = ~sum(.x) / n() * (100 * 1e4) / (pi * 300^2)),
            n = n(),
            .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "aantal_per_100ha")
```

```{r telperiode-doelsoorten-dichtheden-strat, message=FALSE}
for (spec in sort(doelsoorten)) {
  p <- meanabu_doelvogels_strat %>%
      filter(naam == spec) %>%
      mutate(stratum = factor(stratum,
                              levels = c("OL - binnen",
                                         "OL - buiten",
                                         "HOL - binnen",
                                         "HOL - buiten"))) %>%
      ggplot() +
        geom_hline(yintercept = 0, alpha = 0.2, linetype = "dashed") +
        geom_point(aes(x = jaar, y = aantal_per_100ha, colour = stratum, 
                      shape = periode_in_jaar),
                   position = position_dodge2(width = 0.4))  +
        labs(title = toString(spec), 
             y = "Aantal per 100 ha", 
             x = "",
             shape = "Telperiode",
             colour = "Stratum") +
        scale_y_continuous(limits = c(0, NA)) +
        facet_wrap(~regio, strip.position = "right", ncol = 1)
  print(p)
}
```

#### Gemiddelde dichtheden op basis van max-aantal broedparen

Voor de volgende figuren werd eerst per soort voor elk telpunt het max aantal broedparen bepaald in een jaar (over telrondes heen).
Dit werd gedaan om de methodiek van SOVON te benaderen.
Deze maximum aantallen zijn een benadering voor het aantal territoria.
De gemiddelden werden hiervan berekend en een 95% betrouwbaarheidsinterval op basis van bootstrap samples.
**Hier is ook geen rekening gehouden met detectiekansen.**

```{r}
plot_densiteit_max <- function(data, design, soort, show_data = TRUE,
                               seed = 123) {
  roofvogels <- roofvogels_f()
  
  # Oppervlakte telcirkels
  cirkelopp <- pi * 300^2

  set.seed(seed)
  average_df <- data %>%
    filter(naam == soort) %>%
    group_by(plotnaam, periode_in_jaar, regio, jaar) %>%
    summarise(totaal_aantal = sum(aantal),
              .groups = "drop") %>%
    full_join(design,
              by = join_by(plotnaam, periode_in_jaar, regio, jaar)) %>%
    replace(is.na(.), 0) %>%
    mutate(jaar = as.character(jaar)) %>%
    # Bepaal voor elke plot het maximum aantal individuen over
    # de telperiodes per jaar
    group_by(plotnaam, regio, jaar) %>%
    mutate(max_aantal = max(totaal_aantal)) %>%
    ungroup() %>%
    select(-c(periode_in_jaar, totaal_aantal)) %>%
    distinct() %>%
    group_by(regio, jaar, stratum) %>%
    mutate(bootstrap_max = mean_cl_boot(max_aantal)) %>%
    ungroup() %>%

    # Deel cirkeloppervlakte om densiteit broedkoppels per plot te krijgen
    mutate(max_densiteit = max_aantal / cirkelopp * 1e6,
           total_max_mean = bootstrap_max$y / cirkelopp * 1e6,
           lcl_max_mean = bootstrap_max$ymin / cirkelopp * 1e6,
           ucl_max_mean = bootstrap_max$ymax / cirkelopp * 1e6) %>%
    select(-c(bootstrap_max, max_aantal))

  p <- average_df %>%
    mutate(stratum = factor(stratum,
                              levels = c("OL - binnen",
                                         "OL - buiten",
                                         "HOL - binnen",
                                         "HOL - buiten"))) %>%
    ggplot() +
      stat_sum(aes(x = jaar, y = max_densiteit, colour = stratum),
               position = position_dodge(width = 0.5), alpha = 0.1) +
      geom_point(aes(x = jaar, y = total_max_mean,
                     colour = stratum), size = 2.5,
                 position = position_dodge(width = 0.5)) +
      geom_errorbar(aes(x = jaar, ymin = lcl_max_mean,
                        ymax = ucl_max_mean, colour = stratum),
                    width = 0.25, position = position_dodge(width = 0.5)) +
      facet_wrap(~regio) +
      labs(colour = "Stratum", size = "Aantal telpunten")

  if (soort == "Haas" | soort %in% paste(roofvogels, "zonder_broedcode",
                                         sep = "_")) {
    p <- p + labs(x = "", y = "Aantal individuen per 100 ha")
  } else {
    p <- p + labs(x = "", y = "Aantal broedparen per 100 ha")
  }

  if (show_data) {
    p <- p + scale_y_continuous(limits = c(0, NA),
                                trans = scales::pseudo_log_trans(),
                                breaks = c(0:5, seq(10, 50, 10),
                                           seq(75, 200, 25),
                                           seq(300, 1000, 100)))
  } else {
    p <- p + scale_y_continuous(limits = c(0, NA))
  }

  return(p)
}
```

```{r doelsoorten-dichtheden-strat-maxaantal}
for (spec in sort(doelsoorten)) {
  p <- plot_densiteit_max(doel_vogels, bezoekenlijst_2018_2023, spec) +
    ggtitle(spec)
  print(p)
}
```
