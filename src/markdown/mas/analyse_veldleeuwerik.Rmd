---
title: "Analyses Veldleeuwerik"
author: "Ward Langeraert"
date: "`r Sys.Date()`"

output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
    
editor_options: 
  chunk_output_type: console
  
bibliography: references.json
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/research-institute-for-nature-and-forest.csl
zotero: true
---

```{r setup, include=FALSE}
renv::restore()

# Set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE)
opts_knit$set(root.dir = here::here())

# Data preparation and visualization
library(tidyverse)
library(INBOtheme)

library(targets)
library(sf)
library(terra)
library(lubridate)

# Data analysis
library(Distance)

# Source
targets_store <- here("src", "targets", "mas_steekproef_pilootfase", "_targets")
mbag_dir <- here()
source(here("src", "R", "wfs_wcs.R"))
source(here("src", "R", "berekening_hulpvariabelen.R"))
source(here("src", "R", "plot_detection_curve.R"))
```

# Inlezen data {#inlezen-data}

We selecteren eerst de MAS-data binnen de telrondes.

```{r ronde-intervallen}
r1_start <- "04-01"
r1_stop <- "04-20"
r2_start <- "04-21"
r2_stop <- "05-10"
r3_start <- "05-11"
r3_stop <- "06-10"
r4_start <- "06-21"
r4_stop <- "07-15"
```

```{r inlezen-mas-waarnemingen-2018-2022}
mas <- read_sf(
  here("data/mas/20220906_qgis_export_sovon_wfs.gpkg")) %>%
  mutate(
    datum = ymd(paste(jaar, maand, dag, sep = "-")),
    periode_in_jaar = case_when(
      datum %within% interval(
        ymd(paste(jaar, r1_start, sep = "-")),
        ymd(paste(jaar, r1_stop, sep = "-"))) ~ "R1",
      datum %within% interval(
        ymd(paste(jaar, r2_start, sep = "-")),
        ymd(paste(jaar, r2_stop, sep = "-"))) ~ "R2",
      datum %within% interval(
        ymd(paste(jaar, r3_start, sep = "-")),
        ymd(paste(jaar, r3_stop, sep = "-"))) ~ "R3",
      datum %within% interval(
        ymd(paste(jaar, r4_start, sep = "-")),
        ymd(paste(jaar, r4_stop, sep = "-"))) ~ "R4"
    ))
```

De CRS moet aangepast worden naar Lambert 72.
Dit doen we via een specifieke pipeline, zie: <https://inbo.github.io/tutorials/tutorials/spatial_transform_crs_2/>

```{r mas-waarnemingen-conversie-31370}
Sys.setenv("PROJ_NETWORK" = "ON")
sf_proj_network(TRUE)
pipelines <- sf_proj_pipelines("EPSG:28992", "EPSG:31370")
glimpse(pipelines)
# We select the pipeline with lowest accuracy (< 0.02), by filtering on accuracy.
# If the grids are installed, this should match the first line of the pipelines object.
chosen_pipeline_definition <- pipelines %>%
  filter(accuracy < 0.02) %>% pull(definition)

mas_31370_pipeline1 <- 
  st_transform(st_geometry(mas), "EPSG:31370",
               pipeline = chosen_pipeline_definition) %>% 
  st_sf(st_drop_geometry(mas), geometry = .) %>% 
  as_tibble %>% 
  st_as_sf
```

```{r inlezen-polygoon-lagen}
perimeters <- read_sf(
  here("data", "processed", "piloot_perimeters.gpkg"))

vlaanderen <- get_feature_wfs(
  wfs = "https://eservices.minfin.fgov.be/arcgis/services/R2C/Regions/MapServer/WFSServer",
  layername = "regions",
  crs = "EPSG:31370",
  filter = "<Filter><PropertyIsEqualTo><PropertyName>regions:NameDUT</PropertyName><Literal>'Vlaams Gewest'</Literal></PropertyIsEqualTo></Filter>") %>%
  select(NameDUT)

sbp_akkervogels <- tar_read(sbp_akkervogels,
                            store = targets_store)

```

We bepalen alle plot-jaar combinaties waarvoor er waarnemingen zijn.
Het kan ook zijn dat een plot bezocht is, maar dat er geen waarnemingen van zijn.

```{r plot-jaar-waarnemingen-2018-2022}
plot_jaar_met_waarnemingen <- mas_31370_pipeline1 %>%
  st_drop_geometry() %>%
  distinct(plotnaam, jaar)
```

Voor 2022 kennen we alle telpunten die geteld/bezocht moesten worden.
Voor 2018-2021 moeten we er *voorlopig* vanuit gaan dat als er geen waarnemingen zijn voor een bepaald telpunt, het telpunt niet geteld werd.

<!--De plot-jaar lijsten voor 2018-2021 opvragen die bezocht werden zodat we nullen/afwezigheden correct kunnen toevoegen-->

We stellen nu eerst een lijst samen van plot - jaar combinaties die bezocht zijn.
Hiervoor moeten we eerst het design inlezen van 2022.

```{r design_2022}
design2022_raw <- read_csv(here(
    "data",
    "processed",
    "steekproef_piloot_avimap.csv")) %>%
  select(plotnaam = definitief_punt,
         regio,
         stratum,
         X, Y) %>%
  mutate(openheid = ifelse(grepl("HOL", stratum), "HOL", "OL"),
         sbp = ifelse(grepl("binnen", stratum), "binnen", "buiten"),
         stratum = gsub("L\\s{1}", "L\\\n", stratum),
         jaar = 2022L) %>%
  st_as_sf(coords = c("X", "Y"), crs = 31370)

plot_bezocht_2022 <- design2022_raw %>%
  st_drop_geometry() %>%
  distinct(plotnaam, jaar)
```

Vervolgens samenvoegen met 2018-2021

```{r plot-jaar-bezocht-2018-2022}
# veronderstel dat bezocht gelijk is aan die met waarnemingen voor 2018-2021
plot_jaar_bezocht <- plot_jaar_met_waarnemingen %>%
  filter(jaar < 2022) %>%
  rbind(plot_bezocht_2022)
```

Zijn er bezochte plots waarvan er geen waarnemingen zijn?

```{r bezocht-zonder-waarnemingen}
pjb <- plot_jaar_bezocht %>%
  anti_join(plot_jaar_met_waarnemingen)

pjb %>%
  kable()
```

Ja, in `r nrow(pjb)` telpunten werd niets waargenomen.
Dus het is aannemelijk dat dit ook in de eerdere jaren soms het geval zal geweest zijn.

We voegen nu eerst de locatie van de telpunten toe aan `plot_jaar_bezocht`.
De dataframe `telpunten_2018_2021` bevat alle MAS telpunten die in de periode 2018-2021 zijn doorgegeven aan SOVON.
Het is echter niet zo dat al deze telpunten in elk jaar geteld zijn.
Het kan zelfs zijn dat een telpunt uit deze lijst in geen enkel jaar werd geteld (= helemaal niet bezocht geweest).
Het kan ook zijn dat het wel bezocht is geweest, maar dat er geen waarnemingen zijn.

```{r telpunten-2018-2021}
telpunten_2018_2021 <- read_sf(
  here("data", "mas",
       "avimap_514_0_MAS_Werkgroep_Grauwe_Kiekendief_Belgi__telpunten_xy.shp")
) %>%
  rename(teller_2021 = teller) %>%
  mutate(
    regio = ifelse(is.na(regio), "Vlaanderen - Bilzen", regio),
    type_teller_2021 = case_when(
      teller_2021 %in% c("WVNT00", "JJNN16", "NOVN00") |
        regio == "Vlaanderen - Leefdaal" ~ "professioneel",
      is.na(teller_2021) &
        regio != "Vlaanderen - Leefdaal" ~ "niet geteld in 2021",
      TRUE ~ "vrijwilliger"))

telpunten_2018_2021_amersfoort <- telpunten_2018_2021 %>%
  st_drop_geometry() %>%
  st_as_sf(coords = c("st_x", "st_y"), crs = 28992)

telpunten_2018_2021 <- st_transform(
  st_geometry(telpunten_2018_2021_amersfoort), "EPSG:31370",
  pipeline = chosen_pipeline_definition) %>% 
  st_sf(st_drop_geometry(telpunten_2018_2021), geometry = .) %>% 
  as_tibble %>% 
  st_as_sf %>%
  mutate(regio = gsub("Vlaanderen - ", "", regio),
         regio = ifelse(regio == "Leemstreek", "Oostelijke leemstreek", regio),
         regio = ifelse(regio == "Bilzen", "Oostelijke leemstreek", regio))
```

```{r telpunten-2018-2022-locaties}
telpunten_2018_2021_geom_only <- telpunten_2018_2021 %>%
  select(plotnaam = naam, regio)

telpunten_2022_geom_only <- design2022_raw %>%
  select(plotnaam, regio)

# locaties 2022 zijn verkeerd in design_2022 voor VL plots
telpunten_geom_only <- bind_rows(
  telpunten_2018_2021_geom_only,
  telpunten_2022_geom_only %>% filter(!grepl("VL", .$plotnaam))
)
```

Nu voegen we de geometry toe aan de plot - jaar combinaties via een inner join.
Opgepast!
Er zijn een aantal telpunten die in geen enkel jaar werden bezocht.
Deze worden in deze stap verwijderd.
Het kan ook zijn dat er hier een aantal onterecht verwijderd worden (wel bezocht, maar geen waarnemingen).
Zoals eerder aangegeven in commentaar moeten we dit navragen.

```{r toevoegen-geoms}
plot_jaar_bezocht_sf <- telpunten_geom_only %>%
  inner_join(plot_jaar_bezocht)
```

Tot slot voegen we aan `plot_jaar_bezocht_sf` de strata toe waartoe ze behoren.
We gebruiken hiervoor dezelfde code als werd gebruikt in het `targets` project voor het trekken van de pilootsteekproef 2022.

```{r toevoegen-strata}
telpunten_strata <- add_openheid_landschap_to_frame(
  path = path_to_openheid_landschap(),
  punten_sf = plot_jaar_bezocht_sf %>% distinct(plotnaam, regio, geometry),
  gebied = vlaanderen,
  cutlevels = c(1.25, 1.35, 1.51),
  class_labels = c("GL", "HGL", "HOL", "OL")) %>%
  select(plotnaam, regio, openheid = openheid_klasse) %>%
  mutate(sbp = st_intersects(.,
                             st_union(sbp_akkervogels),
                             sparse = FALSE) %>%
           as.logical(),
         sbp = ifelse(sbp, "binnen", "buiten")
  ) %>%
  mutate(stratum = paste0(openheid, "\n", sbp, " plan"))

design_2018_2022_sf <- plot_jaar_bezocht_sf %>%
  st_join(telpunten_strata %>% select(-plotnaam, -regio)) %>%
  filter(regio %in% c("Oostelijke leemstreek", "De Moeren")) %>%
  mutate(openheid = as.character(openheid))
```

Voor de waarnemingen verwijderen we ook dubbeltellingen.
Indien de soort gezien was op meerdere teldagen binnen eenzelfde telperiode, wordt de laatste teldag genomen.

```{r check-dubbeltelling}
dubbels <- mas_31370_pipeline1 %>%
  st_drop_geometry() %>%
  group_by(plotid, jaar, periode_in_jaar, soortnr) %>%
  summarize(aantal_teldagen = n_distinct(doy),
            .groups = "drop") %>%
  filter(aantal_teldagen > 1)
# kan zowel zelfde waarnemer als andere waarnemer zijn

mas_clean <- mas_31370_pipeline1 %>%
  semi_join(dubbels, by = c("plotid", "jaar", "periode_in_jaar")) %>%
  group_by(plotid, jaar, periode_in_jaar) %>%
  filter(doy == max(doy)) %>%
  ungroup() %>%
  bind_rows(mas_31370_pipeline1 %>%
              anti_join(dubbels, by = c("plotid", "jaar", "periode_in_jaar")))
```

# Data selectie en preparatie {#selectie-prep-data}

## Data selectie {#selectie-data}

We zijn ge√Ønteresseerd in broedparen van de Veldleeuwerik in De Moeren en de Oostelijke leemstreek. Daarvoor selecteren we alleen waarnemingen met broedcode 1 of hoger. In het Nederlandse onderzoek van @wiersma2021 beschouwen ze tevens enkel waarnemingen van binnen soortspecifieke datumgrenzen om niet-broedende individuen uit te sluiten. Deze data hebben wij voorlopig niet. Wel selecteren we enkel waarnemingen binnen de telrondes van vogels die tot op maximum 300 m afstand van het telpunt zijn gezien.

```{r}
# design 2018-2022 Oostelijke leemstreek en De Moeren
design_2018_2022 <- design_2018_2022_sf %>%
  st_drop_geometry()

# Selecteer tellingen van Veldleeuwerik in 2018-2022 in de twee regio's
# met broedcode > 0, op minder dan 300 m en binnen telrondes
veldleeuwerik_presences <- mas_clean %>%
  filter(naam == "Veldleeuwerik", !is.na(periode_in_jaar), wrntype > 0L,
         distance2plot <= 300) %>%  
  inner_join(design_2018_2022, by = c("plotnaam", "jaar")) %>%
  mutate(Region.Label = paste(regio, jaar, sep = " - "))
```

In telperiodes 1-3 is het aantal waarnemingen van Veldleeuwerik ongeveer even groot. In telperiode 4 ligt dit iets lager. Tot we de data van de datumgrenzen hebben, houden we voorlopig alle telperiodes voor de analyses.

```{r}
veldleeuwerik_presences %>%
  ggplot() + 
  geom_bar(aes(x = periode_in_jaar, fill = factor(jaar))) +
  labs(y = "Aantal waarnemingen van Veldleeuwerik", x = "Telperiode",
       fill = "jaar") +
  facet_wrap(~regio, scales = "free_y") +
  theme(legend.position = "bottom")
```

## Data preparatie {#preparatie-data}

We maken een tweede dataset waarbij we ook afwezigheden toevoegen door te joinen met de lijst van alle bezochte plots voor elke telperiode.

```{r}
# Totale lijst van bezochte plots in 2018-2022
bezoekenlijst_2018_2022 <- design_2018_2022 %>% 
  expand_grid(distinct(mas_clean, periode_in_jaar)) %>% # voeg telperiodes toe
  filter(!is.na(periode_in_jaar)) %>%
  arrange(plotnaam, jaar, periode_in_jaar)

# Voeg afwezigheden toe door te mergen met alle bezoeken
veldleeuwerik_df <- veldleeuwerik_presences %>%
  st_drop_geometry() %>%
  group_by(plotnaam, jaar, periode_in_jaar) %>%
  summarise(aantal = sum(aantal)) %>% # som aantallen gespot per dag 
  full_join(bezoekenlijst_2018_2022, by = c("plotnaam", "jaar", 
                                            "periode_in_jaar")) %>%
  replace(is.na(.), 0) %>%
  arrange(plotnaam, jaar, periode_in_jaar) %>%
  mutate(Region.Label = paste(regio, jaar, sep = " - "))
```

# Data exploratie {#exploratie-data}

## Tellingen {#exploratie-tellingen}

We beschouwen data van De Moeren en de Oostelijke leemstreek van 2018-2022 waarbij er in elk jaar 4 telperiodes waren. Het aantal bezochte plots neemt over het algemeen toe over de jaren, behalve in De Moeren tussen 2019 en 2020. In De Moeren neemt het aantal waarnemingen ook toe met het aantal bezochte plots maar in De Oostelijke leemstreek is dit niet altijd het geval, namelijk van 2018 naar 2019 en 2021 naar 2022. Het aantal waargenomen broedparen is steeds gelijkaardig aan het aantal waarnemingen wat wil zeggen dat de meeste waarnemingen meestal om een enkel broedpaar (of een individu dat broedgedrag vertoont) gaat.

```{r}
plots_per_jaar <- bezoekenlijst_2018_2022 %>%
  group_by(regio, jaar) %>%
  summarise(aantal_plots = n_distinct(plotnaam))

telperiodes_per_jaar <- bezoekenlijst_2018_2022 %>%
  group_by(regio, jaar) %>%
  summarise(aantal_telperiodes = n_distinct(periode_in_jaar))

aantal_tabel <- veldleeuwerik_presences %>%
  st_drop_geometry() %>%
  group_by(regio, jaar) %>%
  summarise(aantal_waarnemingen = n(), 
            aantal_broedparen = sum(aantal),
            .groups = "drop") %>%
  full_join(plots_per_jaar, by = c("regio", "jaar")) %>%
  full_join(telperiodes_per_jaar, by = c("regio", "jaar")) %>%
  select(regio, jaar, aantal_telperiodes, aantal_plots, aantal_waarnemingen,
         aantal_broedparen) 

aantal_tabel %>%
  kable()
```

```{r}
aantal_tabel %>%
  ggplot(aes(x = aantal_plots, y = aantal_waarnemingen)) +
    geom_line() +
    geom_label(aes(label = jaar), vjust = "inward", hjust = "inward",
               alpha = 0.5) +
    labs(x = "Aantal plots", y = "Aantal waarnemingen") +
    facet_wrap(~regio, scales = "free")
```


## Aantallen {#exploratie-aantallen}

Wanneer we naar de aantallen kijken, zien we veel afwezigheden in de dataset. Vooral in De Moeren, minder in de Oostelijke leemstreek behalve voor 2022.

```{r}
veldleeuwerik_df %>%
  group_by(regio, jaar, periode_in_jaar) %>%
  summarise(min = min(aantal), 
            mediaan = median(aantal),
            gemiddelde = mean(aantal),
            max = max(aantal),
            varantie = var(aantal)) %>%
  kable()
```

```{r, fig.width=9.26, fig.height=6.09, fig.align='center'}
veldleeuwerik_df %>%
  group_by(regio, jaar, periode_in_jaar, aantal) %>%
  summarise(n = n(), .groups = "drop_last") %>%
  ggplot(aes(x = factor(aantal), y = n, fill = periode_in_jaar)) +
    geom_bar(stat = "identity") +
    theme(panel.grid.minor.x = element_blank(),
          panel.grid.major.x = element_blank()) + 
    facet_wrap(jaar~regio, scales = "free") +
    labs(y = "", x = "Aantal broedparen Veldleeuwerik per plot",
         fill = "telperiode") +
    theme(legend.position = c(1, 0),
          legend.justification = c(1, 0),
          legend.direction = "horizontal")
```

De volgende figuur toont het aantal getelde broedparen Veldleeuwerik per telcirkel met aanduiding van gemiddelde en 95% bootstrap betrouwbaarheidsinterval. Vooral in De Moeren zien we variatie in het gemiddelde aantal broedparen over de telperiodes zoals we ook al in \@ref(selectie-data) opmerkten. Zowel in De Moeren als in de Oostelijke leemstreek lijkt het gemiddelde min of meer constant over de jaren met een daling in 2022. 

```{r}
veldleeuwerik_df %>%
  ggplot(aes(x = jaar, y = aantal, colour = periode_in_jaar)) +
  stat_sum(position = position_dodge(width = 0.5), alpha = 0.5) +
  stat_summary(fun.data = mean_cl_boot,
               position = position_dodge(width = 0.5),
               fatten = 4, shape = "square") +
  facet_wrap(~regio, scales = "free_y") +
  labs(y = "Aantal broedparen Veldleeuwerik per plot", x = "Jaar",
       colour = "telperiode") +
  theme(legend.position = "bottom")
```


## Verklarende variabelen {#exploratie-variabelen}
### Openheid van het landschap

In De Moeren bevinden zich geen plots in half-gesloten landschap en in de Oostelijke leemstreek slechts 1 plot. Het gaat om plot VL0582 die enkel in 2021 werd geteld. Hier werden geen Veldleeuwerikken geteld. Voor analyses waarbij we ook afwezigheden in beschouwing nemen, zouden we deze plot best verwijderen. In beide regio's is er vooral geteld in open landschap en minder in half-open landschap.

```{r}
design_openheid <- bezoekenlijst_2018_2022 %>%
  expand(regio, jaar, openheid)
  
bezoekenlijst_2018_2022 %>%
  select(-periode_in_jaar) %>%
  distinct() %>%
  group_by(regio, jaar, openheid) %>%
  summarise(aantal_plots = n()) %>%
  full_join(design_openheid, by = c("regio", "jaar", "openheid")) %>%
  replace(is.na(.), 0) %>%
  arrange(regio, jaar, openheid) %>%
  kable()
```

```{r, fig.width=9.26, fig.height=6.09, fig.align='center'}
bezoekenlijst_2018_2022 %>%
  select(-periode_in_jaar) %>%
  distinct() %>%
  group_by(regio, jaar, openheid) %>%
  summarise(aantal_plots = n()) %>%
  ggplot(aes(x = openheid, y = aantal_plots, fill = factor(jaar))) +
    geom_bar(stat = "identity") +
    theme(panel.grid.minor.x = element_blank(),
          panel.grid.major.x = element_blank()) + 
    facet_wrap(jaar~regio, scales = "free_y") +
    labs(y = "", x = "Aantal plots per categorie openheid landschap",
         fill = "jaar") +
    theme(legend.position = c(1, 0),
          legend.justification = c(1, 0),
          legend.direction = "horizontal")
```

Het gemiddeld aantal broedparen is steeds hoger in open landschap. Daar waren ook meer plots.

```{r, fig.width=9.26, fig.height=6.09, fig.align='center'}
veldleeuwerik_df %>%
  ggplot(aes(x = openheid, y = aantal)) +
  stat_sum(position = position_dodge(width = 0.5), alpha = 0.2) +
  stat_summary(fun.data = mean_cl_boot,
               position = position_dodge(width = 0.5),
               fatten = 4, shape = "square") +
  facet_wrap(jaar~regio, scales = "free_y") +
  labs(y = "Aantal broedparen Veldleeuwerik per plot", 
       x = "Openheid landschap") +
  theme(legend.position = c(1, 0),
        legend.justification = c(1, 0),
        legend.direction = "horizontal")
```

### Soortbeschermingsplan

De plots bevinden zich in beide regio's mestal binnen het soorbeschermingsplan. In 2022 is dit verschil kleiner.

```{r}
design_sbp <- bezoekenlijst_2018_2022 %>%
  expand(regio, jaar, sbp)
  
bezoekenlijst_2018_2022 %>%
  select(-periode_in_jaar) %>%
  distinct() %>%
  group_by(regio, jaar, sbp) %>%
  summarise(aantal_plots = n()) %>%
  full_join(design_sbp, by = c("regio", "jaar", "sbp")) %>%
  replace(is.na(.), 0) %>%
  arrange(regio, jaar, sbp) %>%
  kable()
```

```{r, fig.width=9.26, fig.height=6.09, fig.align='center'}
bezoekenlijst_2018_2022 %>%
  select(-periode_in_jaar) %>%
  distinct() %>%
  group_by(regio, jaar, sbp) %>%
  summarise(aantal_plots = n()) %>%
  ggplot(aes(x = sbp, y = aantal_plots, fill = factor(jaar))) +
    geom_bar(stat = "identity") +
    theme(panel.grid.minor.x = element_blank(),
          panel.grid.major.x = element_blank()) + 
    facet_wrap(jaar~regio, scales = "free_y") +
    labs(y = "", x = "Aantal plots binnen en buiten soortbeschermingsplan",
         fill = "jaar") +
    theme(legend.position = c(1, 0),
          legend.justification = c(1, 0),
          legend.direction = "horizontal")
```

Het gemiddeld aantal broedparen lijkt niet te veel te verschillen binnen of buiten het soortbeschermingsplan.

```{r, fig.width=9.26, fig.height=6.09, fig.align='center'}
veldleeuwerik_df %>%
  ggplot(aes(x = sbp, y = aantal)) +
  stat_sum(position = position_dodge(width = 0.5), alpha = 0.2) +
  stat_summary(fun.data = mean_cl_boot,
               position = position_dodge(width = 0.5),
               fatten = 4, shape = "square") +
  facet_wrap(jaar~regio, scales = "free_y") +
  labs(y = "Aantal broedparen Veldleeuwerik per plot", 
       x = "Soortbeschermingsplan") +
  theme(legend.position = c(1, 0),
        legend.justification = c(1, 0),
        legend.direction = "horizontal")
```

### Interactie openheid en soortbeschermingsplan

```{r}
design_openheid <- bezoekenlijst_2018_2022 %>%
  expand(regio, jaar, openheid, sbp)
  
bezoekenlijst_2018_2022 %>%
  select(-periode_in_jaar) %>%
  distinct() %>%
  group_by(regio, jaar, openheid, sbp) %>%
  summarise(aantal_plots = n()) %>%
  full_join(design_openheid, by = c("regio", "jaar", "openheid", "sbp")) %>%
  replace(is.na(.), 0) %>%
  arrange(regio, jaar, openheid, sbp) %>%
  kable()
```

```{r, fig.width=9.26, fig.height=6.09, fig.align='center'}
bezoekenlijst_2018_2022 %>%
  select(-periode_in_jaar) %>%
  distinct() %>%
  group_by(regio, jaar, openheid, sbp) %>%
  summarise(aantal_plots = n()) %>%
  ggplot(aes(x = openheid, y = aantal_plots, fill = sbp)) +
    geom_bar(stat = "identity") +
    theme(panel.grid.minor.x = element_blank(),
          panel.grid.major.x = element_blank()) + 
    facet_wrap(jaar~regio, scales = "free_y") +
    labs(y = "", x = "Aantal plots per categorie",
         fill = "sbp") +
    theme(legend.position = c(1, 0),
          legend.justification = c(1, 0),
          legend.direction = "horizontal")
```

## Afstanden {#exploratie-afstanden}

Voor elke waarneming van een broedgeval (of aanwijzing voor een broedpaar) hebben we een afstand tussen 0 en 300 m. Deze hebben min of meer dezelfde verdeling in alle jaren en over alle regio's. De minima in De Moeren zijn wel opvallend hoog.

```{r}
# Dupliceer rijen volgens aantal (elke rij is 1 individu)
veldleeuwerik_presences2 <- 
    tibble(
      veldleeuwerik_presences[rep(seq_len(dim(veldleeuwerik_presences)[1]), 
                    veldleeuwerik_presences$aantal), , 
                    drop = FALSE], 
      row.names = NULL
    ) %>%
    mutate(aantal = 1)

veldleeuwerik_presences2 %>% 
  st_drop_geometry() %>%
  group_by(regio, jaar) %>%
  summarise(min = min(distance2plot, na.rm = TRUE), 
            mediaan = median(distance2plot, na.rm = TRUE),
            gemiddelde = mean(distance2plot, na.rm = TRUE),
            max = max(distance2plot, na.rm = TRUE),
            varantie = var(distance2plot, na.rm = TRUE)) %>%
  kable(digits = 1)
```

```{r, fig.width=9.26, fig.height=6.09, fig.align='center'}
veldleeuwerik_presences2 %>%
  ggplot() +
    geom_histogram(aes(x = distance2plot, fill = stratum), bins = 30) +
    scale_y_continuous(breaks = scales::pretty_breaks()) +
    facet_wrap(jaar~regio, scales = "free_y") +
    labs(y = "Aantal broedparen", x = "Afstand (m)") +
    theme(legend.position = "bottom",
          legend.direction = "horizontal")
```


# Distance sampling {#distance-sampling}

## Inleiding {#inleiding-distance}

## Data preparatie {#preparatie-distance}

## Model selectie {#selectie-distance}

## Model fit {#fit-distance}

## Resultaten {#resultaten-distance}

## Discussie {#discussie-distance}

## Referenties
