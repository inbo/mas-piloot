---
title: "Invloed van beheerovereenkomsten op akkervogels"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
bibliography: references.json
---

```{r setup, include=FALSE}
# renv
renv::restore()

# Set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE)
opts_knit$set(root.dir = here())

# Conflicting packages
conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)
conflicted::conflicts_prefer(dplyr::lag)
conflicted::conflicts_prefer(brms::ar)
conflicted::conflicts_prefer(brms::do_call)

# Packages
library(tidyverse)
library(INBOtheme)
library(sf)
library(brms)
```

# Inlezen data

```{r}
data_path <- here("data", "processed")
mas_data_df <- read_csv(here(data_path, "MAS_data_full_2018_2022.csv"))

```

```{r}
design <- mas_data_df %>%
  distinct(plotnaam, regio, periode_in_jaar, jaar)

mas_data_sf <- st_as_sf(mas_data_df, coords = c("x_lambert", "y_lambert"), 
                        crs = 31370)

perimeters <- read_sf(
  here("data", "processed", "piloot_perimeters.gpkg"))
```


# Dataset structuur

Hoe ziet de dataset eruit?

```{r}
glimpse(mas_data_df)
```

We visualiseren ook de waarnemingen en kleuren hoeveel jaren het telpunt geteld is.

```{r}
visits_per_jaar <- mas_data_sf %>%
  st_drop_geometry() %>%
  group_by(plotnaam) %>%
  mutate(n_per_jaar = n_distinct(jaar)) %>%
  ungroup() %>%
  select(plotnaam, n_per_jaar) %>%
  distinct()

mas_data_sf %>%
  filter(regio == "De Moeren") %>%
  left_join(visits_per_jaar, by = join_by(plotnaam)) %>%
  ggplot() +
    geom_sf(data = perimeters %>% filter(Naam == "De Moeren"), 
            colour = "firebrick") +
    geom_sf(aes(colour = factor(n_per_jaar)), size = 0.5) +
    labs(title = "De Moeren", colour = "aantal jaren\ntelpunt geteld") +
    guides(colour = guide_legend(override.aes = list(size = 3)))
```

```{r}
mas_data_sf %>%
  filter(regio == "Oostelijke leemstreek") %>%
  left_join(visits_per_jaar, by = join_by(plotnaam)) %>%
  ggplot() +
    geom_sf(data = perimeters %>% filter(Naam == "Oostelijke leemstreek"), 
            colour = "firebrick") +
    geom_sf(aes(colour = factor(n_per_jaar)), size = 0.5) +
    labs(title = "Oostelijke leemstreek", 
         colour = "aantal jaren\ntelpunt geteld") +
    guides(colour = guide_legend(override.aes = list(size = 3)))
```

# Gele kwikstaart
## Data exploratie

We selecteren de data van de Gele kwikstaart met broedcode > 0. We sommeren de aantal per telcirkel, telperiode en jaar. We voegen ook afwezigheden toe.

```{r}
# Presence data
gele_kwik_presences <- mas_data_df %>%
  filter(naam == "Gele Kwikstaart",
         wrntype > 0) %>%
  group_by(plotnaam, regio, periode_in_jaar, jaar) %>%
  summarise(aantal = sum(aantal),
            .groups = "drop")

# Add absences
gele_kwik_total <- design %>%
  left_join(gele_kwik_presences, 
            by = join_by(plotnaam, regio, periode_in_jaar, jaar)) %>%
  replace(is.na(.), 0) %>%
  arrange(plotnaam, periode_in_jaar, jaar)

# Add variables
gele_kwik_df1 <- gele_kwik_total %>%
  left_join(
    select(mas_data_df, plotnaam, regio, periode_in_jaar, jaar, status_teller,
    which(names(mas_data_df) == "n_predators"):length(names(mas_data_df))),
    by = join_by(plotnaam, regio, periode_in_jaar, jaar)) %>%
  distinct() %>%
  mutate(jaar.f = factor(jaar))
```

We herhalen enkele plots die we ook in `modelleeroefening_Gele_kwik.Rmd` maakten.

```{r}
gele_kwik_df1 %>%
  group_by(regio, jaar, periode_in_jaar, aantal) %>%
  summarise(n = n(), .groups = "drop_last") %>%
  ggplot(aes(x = aantal, y = n, fill = periode_in_jaar)) +
    geom_bar(stat = "identity", col = "black") +
    theme(panel.grid.minor.x = element_blank(),
          panel.grid.major.x = element_blank()) + 
    facet_wrap(jaar~regio, scales = "free") +
    labs(y = "", x = "Aantal broedparen Gele kwikstaart per plot") +
    theme(legend.position = c(1, 0),
          legend.justification = c(1, 0),
          legend.direction = "horizontal")
```

```{r}
gele_kwik_df1 %>%
  ggplot(aes(x = jaar, y = aantal, colour = periode_in_jaar)) +
  stat_sum(position = position_dodge(width = 0.5), alpha = 0.2) +
  stat_summary(fun.data = mean_cl_boot,
               position = position_dodge(width = 0.5),
               fatten = 4, shape = "square") +
  facet_wrap(~regio, scales = "free") +
  labs(y = "Aantal broedparen Gele kwikstaart per plot", x = "Telperiode") +
  theme(legend.position = "bottom")
```

```{r}
# Calculate zomergranen_hfdtlt2 as specified in 
# exploratie_verklarende_variabelen.rmd
gele_kwik_df <- gele_kwik_df1 %>%
  mutate(zomergranen_hfdtlt2 = rowSums(across(c(graangewassen_hfdtlt, 
                                               zomergranen_hfdtlt)))) %>%
  select(-c(graangewassen_hfdtlt, zomergranen_hfdtlt))

strat_vars <- c("plotnaam", "regio", "periode_in_jaar", "jaar", "jaar.f")
response_vars <- c("aantal")
pred_vars <- c("status_teller",
               "n_predators",
               "area_prop_sb",
               "area_prop_bo_overig",
               "landbouwinfrastructuur_hfdtlt",
               "grasland_hfdtlt",
               "aardappelen_hfdtlt",
               "wintergranen_hfdtlt",
               "bieten_hfdtlt",
               "mais_hfdtlt",
               "wortelgewassen_hfdtlt",
               "vlas_en_hennep_hfdtlt",
               "groententeelt_hfdtlt",
               "peulvruchten_hfdtlt",
               "meerjarige_fruitteelt_hfdtlt",
               "groenbemester_hfdtlt",
               "zomergranen_hfdtlt2",
               "zaden_hfdtlt", 
               "gewas_div_shannon",
               "perceel_cv_area",
               "inertie_sb",
               "inertie_overig",
               "openheid_waarde_1000",
               "openheid_klasse_300",
               "x_plot",
               "y_plot",
               "is_sbp",
               "sbp",
               "haag",
               "houtkant",
               "boom",
               "bomengroep",
               "bomenrij",
               "bosrand",
               "natuur_exp")
```


We zijn vooral geÃ¯nteresseerd hoe de aantallen zich verhouden tot de verklarende variabelen (en dit per jaar per regio). Dit zijn: `r pred_vars`.

```{r}
gele_kwik_df_mod <- gele_kwik_df %>%
  select(all_of(c(response_vars, strat_vars, pred_vars)))
```


## Model specificatie test

```{r}
# MCMC parameters
nchains <- 3           # number of chains
niter <- 4000          # number of iterations (incl. burn-in)
burnin <- niter / 2    # number of initial samples to discard (burn-in)
nparallel <- nchains   # number of cores used for parallel computing


brmpois1 <- brm(bf(aantal ~ periode_in_jaar + jaar.f + regio*area_prop_sb + 
                     (1 | plotnaam)), 
                data = gele_kwik_df_mod, family = poisson(), 
                chains = nchains, warmup = burnin, iter = niter, 
                cores = nparallel, backend = "cmdstanr")
```

MCMC convergence.

```{r}
plot(brmpois1)
```

Posterior predictive check.

```{r}
pp_check(brmpois1, type = "bars_grouped", ndraws = 100, group = "regio",
         facet_args = list(ncol = 1, scales = "free_y"))
```

Summary.

```{r}
summary(brmpois1)
```

```{r}
get_hyp_estimates <- function(model, regio, perc_inc) {
  if (regio == "De Moeren") {
    hyp <- paste0("exp(area_prop_sb*", perc_inc, ") = 1")
    est_hyp <- hypothesis(model, hyp)
  } else {
    hyp <- paste0("exp(area_prop_sb*", perc_inc, 
                  " + regioOostelijkeleemstreek:area_prop_sb*", 
                  perc_inc, ") = 1")
    est_hyp <- hypothesis(model, hyp)
  }
 est_hyp$hypothesis[,2:5] %>%
   mutate(regio = regio,
          perc_inc = perc_inc)
}

increases <- seq(0, 1, 0.01)
out <- vector(mode = "list", length = length(increases) * 
         length(unique(gele_kwik_df_mod$regio)))

for (i in seq_along(unique(gele_kwik_df_mod$regio))) {
  reg <- unique(gele_kwik_df_mod$regio)[i]
  for (j in seq_along(increases)) {
    perc <- increases[j]
    index <- j + (length(increases) * (i - 1))
    out[[index]] <- get_hyp_estimates(brmpois1, reg, perc)
  }
}

hyp_est_df <- do.call(rbind.data.frame, out)
```

```{r}
hyp_est_df %>%
  mutate(perc_inc = perc_inc * 100) %>%
  ggplot(aes(x = perc_inc, y = Estimate)) +
    geom_hline(yintercept = 0, colour = "grey", linetype = "dashed") +
    geom_line(colour = "black", linewidth = 1.2) +
    geom_ribbon(aes(ymin = CI.Lower, ymax = CI.Upper, fill = regio), alpha = 0.3) +
    facet_wrap(~regio) +
    theme(legend.position = "") +
    labs(x = "procent toename in oppervlakte soorbeschermingsplannen",
         y = "aantal keer meer Gele kwikstaarten")
```



http://mjskay.github.io/tidybayes/articles/tidybayes.html

```{r}
library(tidybayes)
library(modelr)
pred_df <- gele_kwik_df_mod %>%
  group_by(plotnaam, periode_in_jaar, jaar.f, regio) %>%
  data_grid(area_prop_sb = seq_range(area_prop_sb, n = 100)) %>%
  add_epred_draws(brmpois1)

pred_df %>%
  ggplot(aes(x = area_prop_sb, y = .epred, color = regio)) +
  stat_lineribbon() +
  scale_fill_brewer(palette = "Greys") +
  scale_color_brewer(palette = "Set2") +
  facet_grid(periode_in_jaar~jaar.f)
```

https://mc-stan.org/projpred/articles/projpred.html  
https://mc-stan.org/projpred/articles/latent.html

```{r}
library(projpred)
refm_poiss <- get_refmodel(brmpois1, latent = TRUE)
vs_lat <- cv_varsel(refm_poiss,
                    ### Only for the sake of speed (not recommended in general):
                    validate_search = FALSE, nclusters_pred = 20)
plot(vs_lat, stats = "mlpd", deltas = TRUE)
```

