---
title: "Vergelijking Leefdaal met controlegebied"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
renv::restore()
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE)
opts_knit$set(root.dir = here::here())
library(tidyverse)
library(sf)
library(terra)
library(mapview)
library(leafem)
mbag_dir <- here()
```


# Doel

We zullen een testcase maken van Leefdaal om het meetnet uit te breiden. Hiervoor moeten we een controlegebied voorzien. Deze moet vergelijkbaar zijn qua perceelsgrootte, dooradering, aandeel beheersovereenkomsten, landgebruik ...  
We beschouwen hier doelgebied Zavelberg:  
  
Dit is het deelgebied van plateau Leefdaal met de hoogste dekkingsgraad aan beheerovereenkomsten, nl. 12 %. De totale oppervlakte van deze polygoon is 478 ha. Ter vergelijking, UHasselt heeft daar 3 jaar lang ook MAS punten geteld, misschien interessant om daar later mee te vergelijken (puntenset staat op de drive).

We beschouwen twee potentiÃ«le controlegebieden:  
  
- Kortenberg (twee deelgebieden samen 480ha, vlakbij de luchthaven van Zaventem) waar er geen (echt nul) beheerovereenkomsten liggen, en er iets ten noorden van wel een kerngebied ligt (dus kan niet slecht zijn voor akkervogels).
- Lovenjoel, daar is een polygoon van 483ha getekend. Dat is zeer gelijkaardig gebied, en daar liggen al nieuwe MAS-punten. We zouden kunnen bekijken of we deze als test kunnen gebruiken. Daar liggen wel al redelijk wat beheerovereenkomsten, terwijl het geen kerngebied is.


# Inlezen data

We beschouwen vier deelgebieden van het Leefdaal plateau. Deze bevinden zich in een enkele shp-file.

```{r}
# Create data and source paths
data_path <- here("data", "mas")
source_path <- here("src", "R")

# Source functions
source(here(source_path, "berekening_hulpvariabelen.R"))
source(here(source_path, "geocomputations.R"))
```

```{r}
leefdaal_sf <- st_read(here(data_path, "Leefdaal_ctr.shp")) %>%
  st_transform(crs = 31370)

mapview(leefdaal_sf, zcol = "Naam", layer.name = "Deelgebied") %>%
  addStaticLabels(label = leefdaal_sf$Naam)
```


# Data voorbereiden

We maken een laag met 3 polygonen:

- Zavelberg
- Kortenberg
- Lovenjoel

```{r}
leefdaal <- leefdaal_sf %>%
  mutate(naam = ifelse(startsWith(Naam, "Kortenberg"), "Kortenberg", Naam)) %>%
  group_by(naam) %>%
  summarise(geometry = sf::st_union(geometry)) %>%
  ungroup()

mapview(leefdaal, zcol = "naam", layer.name = "Deelgebied") %>%
  addStaticLabels(label = leefdaal$naam)
```


# Vergelijking doel en controlegebieden
## Oppervlakte

```{r}
leefdaal %>%
  mutate(oppervlakte = st_area(leefdaal)) %>%
  st_drop_geometry() %>%
  kable()
```

**Conclusie**  
  
De oppervlaktes zijn gelijkaardig tussen alle deelgebieden.

```{r}
conclusie_df <- data.frame(onderdeel = "oppervlakte", 
                            Kortenberg = "0", Lovenjoel = "0")
```


## Landgebruik


## Beheerovereenkomsten

Toestand beheerovereenkomsten 2021.

Indeling voor niet-productieve gewassen / beheerovereenkomsten (instrumenten):

- soortbeschermingsmaatregelen
    - perceelsniveau
    - randen
- erosiemaatregelen
- bufferstroken

Voor de steekproeftrekking zijn vooral de oppervlakte aan soortbeschermingsmaatregelen van belang. Eventueel verder opgesplitst in winter-, zomer- en jaarrondmaatregelen.

```{r}
# Lees laag beheersovereenkomsten in
bo2021 <- read_bo2021(path = path_to_bo2021())
bo2021_leefdaal <- bo2021 %>%
  st_intersection(leefdaal)

# Visualisatie
mapview(leefdaal, zcol = "naam", layer.name = "Deelgebied") +
  mapview(bo2021_leefdaal, zcol = "BH_DOELST", 
          col.regions = list("red","blue", "green", "brown"),
          layer.name = "Beheersdoelstelling")
```

We willen voor elk deelgebied het oppervlakte-aandeel van de beheerovereenkomsten.

```{r}
# Bereken proporties beheersdoelstellingen
prop_bh_doelst_leefdaal <- landusemetrics_grid_cell(
    grid_cell = leefdaal,
    layer = bo2021_leefdaal,
    grid_group_by_col = "naam",
    layer_group_by_col = "BH_DOELST")

prop_srt_object_leefdaal <- landusemetrics_grid_cell(
    grid_cell = leefdaal,
    layer = bo2021_leefdaal,
    grid_group_by_col = "naam",
    layer_group_by_col = "SRT_OBJECT")

# Maak designmatrix om afwezige beheersvormen toe te voegen
design_bh_doelst <- expand.grid(prop_bh_doelst_leefdaal$naam, 
                                prop_bh_doelst_leefdaal$BH_DOELST) %>% 
  distinct() %>%
  rename(naam = Var1, BH_DOELST = Var2)

design_srt_object <- expand.grid(prop_srt_object_leefdaal$naam, 
                                 prop_srt_object_leefdaal$SRT_OBJECT) %>% 
  distinct() %>%
  rename(naam = Var1, SRT_OBJECT = Var2)


# Voeg afwezige beheersdoelstellingen toe aan dataframes
bh_doelst_leefdaal <- prop_bh_doelst_leefdaal %>% 
  full_join(design_bh_doelst, by = c("naam", "BH_DOELST")) %>%
  replace(is.na(.), 0)

srt_object_leefdaal <- prop_srt_object_leefdaal %>% 
  full_join(design_srt_object, by = c("naam", "SRT_OBJECT")) %>%
  replace(is.na(.), 0)
```

We vergelijken eerst het totale oppervlakte aandeel van beheersovereenkomsten. We zien dat het oppervlakte-aandeel beheersovereenkomsten veel groter is in Zavelberg dan Lovenjoel en zeker dan Kortenberg.

```{r}
bh_doelst_leefdaal %>%
  group_by(naam) %>%
  summarise(area_prop = sum(area_prop)) %>%
  ggplot(aes(x = naam, y = area_prop)) +
      geom_bar(aes(fill = naam), stat = "identity") +
      labs(x = "", y = "oppervlakte-aandeel", title = "Totaal") +
      theme(legend.position = "", 
            axis.text.x = element_text(angle = 90, vjust = 0.5))
```

Nu kunnen we ook per categorie vergelijken. We zien voor de variabele BH_DOELST dat soortbeschermingsmaatregelen een groot aandeel in Zavelberg innemen maar niet in de andere deelgebieden. Lovenjoel scoort wel hoger als het gaat om beheer van KLE's, erosiebestrijding en perceelrandsbeheer. In kortenberg is er slechts een kleine oppervlakte perceelrandsbeheer aanwezig en geen andere beheersovereenkomsten.

```{r}
bh_doelst_leefdaal %>%
  ggplot(aes(x = naam, y = area_prop)) +
    geom_bar(aes(fill = naam), stat = "identity") +
    facet_wrap(~BH_DOELST, ncol = 2, scales = "free_y") +
    labs(x = "", y = "oppervlakte-aandeel", title = "BH_DOELST per categorie") +
    theme(legend.position = "", 
          axis.text.x = element_text(angle = 90, vjust = 0.5))
```

We zien voor de variabele SRT_OBJECT dat Lovenjoel en Zavelberg grotendeels op andere beheersvormen inzetten, maar er is wel wat overlap bijvoorbeeld in erosiestroken en bufferstroken.

```{r}
srt_object_leefdaal %>%
  ggplot(aes(x = naam, y = area_prop)) +
    geom_bar(aes(fill = naam), stat = "identity") +
    facet_wrap(~SRT_OBJECT, ncol = 3, scales = "free_y") +
    labs(x = "", y = "oppervlakte-aandeel", title = "SRT_OBJECT per categorie") +
    theme(legend.position = "", 
          axis.text.x = element_text(angle = 90, vjust = 0.5))
```

**Conclusie**  
  
Op vlak van oppervlakte-aandeel beheersovereenkomsten is er in Kortenberg bijna niets te vinden en Lovenjoel is in dat opzicht meer vergelijkbaar met Zavelberg. Desondanks wordt in Lovenjoel wel vaak op andere beheersvormen ingezet dan in Zavelberg.

```{r}
conclusie_df <- rbind(conclusie_df, c("beheersovereenkomst", "-", "+"))
```


## Hoofdteelt


## Openheid landschap


## ...


# Discussie en conclusie

```{r}
conclusie_df %>% kable()
```

