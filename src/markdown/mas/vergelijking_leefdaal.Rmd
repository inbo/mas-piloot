---
title: "Vergelijking Leefdaal met controlegebied"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
renv::restore()
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE)
opts_knit$set(root.dir = here::here())
library(tidyverse)
library(sf)
library(terra)
library(mapview)
library(leafem)
mbag_dir <- here()
```


# Doel

We zullen een testcase maken van Leefdaal om het meetnet uit te breiden. Hiervoor moeten we een controlegebied voorzien. Deze moet vergelijkbaar zijn qua perceelsgrootte, dooradering, aandeel beheersovereenkomsten, landgebruik ...  
We beschouwen hier doelgebied Zavelberg:  
Dit is het deelgebied van plateau Leefdaal met de hoogste dekkingsgraad aan beheerovereenkomsten, nl. 12 %. De totale oppervlakte van deze polygoon is 478 ha. Ter vergelijking, UHasselt heeft daar 3 jaar lang ook MAS punten geteld, misschien interessant om daar later mee te vergelijken (puntenset staat op de drive).

We beschouwen twee potentiële controlegebieden:  
  
1. Kortenberg (twee deelgebieden samen 480 ha, vlakbij de luchthaven van Zaventem) waar er bijna geen beheerovereenkomsten liggen, en er iets ten noorden van wel een kerngebied ligt (dus kan niet slecht zijn voor akkervogels).
2. Lovenjoel, daar is een polygoon van 483 ha getekend. Dat is zeer gelijkaardig gebied, en daar liggen al nieuwe MAS-punten. We zouden kunnen bekijken of we deze als test kunnen gebruiken. Daar liggen wel al redelijk wat beheerovereenkomsten, terwijl het geen kerngebied is.


# Inlezen data

We beschouwen vier deelgebieden van het Leefdaal plateau. Deze bevinden zich in een enkele shp-file.

```{r}
# Create data and source paths
data_path <- here("data", "mas")
source_path <- here("src", "R")

# Source functions
source(here(source_path, "berekening_hulpvariabelen.R"))
source(here(source_path, "geocomputations.R"))
source(here(source_path, "steekproefkader.R"))
```

```{r}
leefdaal_sf <- st_read(here(data_path, "Leefdaal_ctr.shp")) %>%
  st_transform(crs = 31370)

mapview(leefdaal_sf, zcol = "Naam", layer.name = "Deelgebied") %>%
  addStaticLabels(label = leefdaal_sf$Naam)
```


# Data voorbereiden

We maken een laag met 3 polygonen:

- Zavelberg
- Kortenberg
- Lovenjoel

```{r}
leefdaal <- leefdaal_sf %>%
  mutate(naam = ifelse(startsWith(Naam, "Kortenberg"), "Kortenberg", Naam)) %>%
  group_by(naam) %>%
  summarise(geometry = sf::st_union(geometry)) %>%
  ungroup()

mapview(leefdaal, zcol = "naam", layer.name = "Deelgebied") %>%
  addStaticLabels(label = leefdaal$naam)
```

# Methodiek

Per categorie scoren we welk controlegebied het best lijkt op ons doelgebied (Zavelberg). Indien het ene gebied een voordeel is ten opzichte van het andere controlegebied, geven we een "+". Indien het ene gebied een nadeel is ten opzichte van het andere controlegebied, geven we een "-". Indien er geen duidelijk voor of nadeel is ten opzichte van het andere controlegebied, geven we een "0".  
  
Deze scores zijn tot op een zekere hoogte subjectief, maar ze kunnen ons op het einde een overzicht bieden van de voor- en nadelen tussen de verschillende gebieden. De finale keuze moet wel nog steeds afhangen van een meer genuanceerde discussie. Sommige categoriën kunnen zwaarder doorwegen dan andere.


# Vergelijking doel- en controlegebieden
## Oppervlakte

```{r}
leefdaal %>%
  mutate(oppervlakte = st_area(leefdaal)) %>%
  st_drop_geometry() %>%
  kable()
```

**Conclusie**  
  
De oppervlaktes zijn gelijkaardig tussen alle deelgebieden. Er is geen duidelijk voordeel van een controlegebied tegenover de ander.

```{r}
conclusie_df <- data.frame(onderdeel = "oppervlakte", 
                           Kortenberg = "0", Lovenjoel = "0",
                           opmerking = "bijna geen verschil")
```


## Landgebruiksamenstelling

We beschouwen de rasterlaag van landgebruiksamenstelling van 2019.  
-> nieuwe file? om de 3 jaar...

```{r}
# Lees in landgebruik raster
legende_landgebruik <- read_legend_lum(path_to_legend_lum()) %>%
  filter(bestand_id == "vito")
landgebruik <- read_lum_rast(file = path_to_lum(), legend = legende_landgebruik)
landgebruik_leefdaal_raster <- crop(landgebruik, leefdaal)

# Zet om naar raster en voeg categoriën opnieuw toe
levels_landgebruik <- levels(landgebruik_leefdaal_raster)
landgebruik_leefdaal_raster <- landgebruik_leefdaal_raster %>%
  raster::raster()
levels(landgebruik_leefdaal_raster) <- levels_landgebruik

# Visualisatie
kleur <- legende_landgebruik %>%
  pull(kleur)
mapview(leefdaal, zcol = "naam", layer.name = "Deelgebied") +
  mapview(landgebruik_leefdaal_raster, layer.name = "Landgebruik", 
          col.regions = kleur, att = "land_use")
```

We willen voor elk deelgebied het oppervlakte-aandeel van landgebruiksamenstelling.

```{r}
# Bereken proportie landgebruik
prop_landgebruik_leefdaal <- landusemetrics_grid_cell(
    grid_cell = leefdaal,
    layer = rast(landgebruik_leefdaal_raster),
    grid_group_by_col = "naam",
    layer_group_by_col = "") %>%
  ungroup() %>%
  mutate(landgebruik_klasse = factor(value,
                                     levels = legende_landgebruik$value,
                                     labels = legende_landgebruik$label)) %>%
  select(naam, landgebruik_klasse, area_prop = freq)

# Maak designmatrix om afwezige hoofdteelten toe te voegen
design_landgebruik <- expand.grid(prop_landgebruik_leefdaal$naam, 
                        prop_landgebruik_leefdaal$landgebruik_klasse) %>% 
  distinct() %>%
  rename(naam = Var1, landgebruik_klasse = Var2)

# Voeg afwezige hoofdteelten toe aan dataframes
landgebruik_leefdaal <- prop_landgebruik_leefdaal %>% 
  full_join(design_landgebruik, by = c("naam", "landgebruik_klasse")) %>%
  replace(is.na(.), 0)
```

We zien dat het oppervlakte-aandeel akker het grootst is in alle gebieden en dat de proportie voor Kortenberg iets dichter ligt bij Zavelberg dan voor Lovenjoel.

```{r}
landgebruik_leefdaal %>%
  mutate(landgebruik_klasse = reorder(landgebruik_klasse, area_prop, 
                                      FUN = "mean", decreasing = FALSE)) %>%
  ggplot(aes(x = area_prop, y = landgebruik_klasse)) +
    geom_point(aes(colour = naam)) +
    labs(x = "oppervlakte-aandeel", y = "", title = "Landgebruik",
         colour = "deelgebied") +
    theme(legend.position = c(1, 0), legend.justification = c(1, 0))
```

We willen een overzicht van de verschillen met Zavelberg. Hoe groter de waarde, hoe groter het verschil tussen de controlegebieden en Zavelberg.

```{r}
landgebruik_diff <- landgebruik_leefdaal %>%
  select(naam, landgebruik_klasse, area_prop) %>%
  group_by(landgebruik_klasse) %>%
  pivot_wider(names_from = naam, values_from = area_prop) %>%
  mutate(diff_Kortenberg = abs(Kortenberg - Zavelberg),
         diff_Lovenjoel = abs(Lovenjoel - Zavelberg)) %>%
  select(-c(Kortenberg, Lovenjoel, Zavelberg)) %>%
  ungroup() %>%
  mutate(check = case_when(
    diff_Kortenberg < diff_Lovenjoel ~ "Kortenberg",
    diff_Kortenberg > diff_Lovenjoel ~ "Lovenjoel",
    diff_Kortenberg == diff_Lovenjoel ~ "Kortenberg/Lovenjoel")
    )

landgebruik_diff %>%
  pivot_longer(cols = c(diff_Kortenberg, diff_Lovenjoel), names_to = "naam", 
               names_prefix = "diff_", values_to = "area_prop") %>%
  mutate(landgebruik_klasse = reorder(landgebruik_klasse, area_prop, 
                                      FUN = "mean", decreasing = FALSE)) %>%
  ggplot(aes(x = landgebruik_klasse, y = area_prop)) +
    geom_bar(aes(fill = naam), 
             stat = "identity", position = "dodge") +
    coord_flip() +
    labs(y = "oppervlakte-aandeel", x = "", title = "Hoofdteelten",
         fill = "deelgebied") +
    theme(legend.position = c(1, 0), legend.justification = c(1, 0))
```

Kortenberg heeft 1 keer vaker een kleiner verschil met Zavelberg dan Lovenjoel. Dit zegt echter niets over de grootte van het verschil. 

```{r}
landgebruik_diff %>%
  mutate(check = reorder(check, check, FUN = "length",
                         decreasing = TRUE)) %>%
  ggplot(aes(x = check)) +
    geom_bar() +
    scale_y_continuous(breaks = seq(0, 10, by = 2), limits = c(0, 10)) +
    labs(y = "aantal keer kleinste verschil\nmet Zavelberg", x = "", 
         title = "Landgebruik") +
    geom_text(aes(label = as.character(..count..)), stat = "count", vjust = -1)
```

We tellen daarom alle verschillen op. We zien dat Kortenberg een kleiner verschil heeft in proportie landgebruik met Zavelberg dan Lovenjoel.

```{r}
landgebruik_diff %>%
  pivot_longer(cols = c(diff_Kortenberg, diff_Lovenjoel), names_to = "naam", 
               names_prefix = "diff_", values_to = "area_prop") %>%
  group_by(naam) %>%
  mutate(som = sum(area_prop)) %>%
  select(naam, som) %>%
  distinct() %>%
  ggplot(aes(x = naam, y = som)) +
    geom_bar(stat = "identity") +
    scale_y_continuous(limits = c(0, 0.4)) +
    labs(y = "verschil met Zavelberg", x = "", 
         title = "Landgebruik") +
    geom_text(aes(label = round(som, digits = 3)), vjust = -1)
```

**Conclusie**  
  
Kortenberg heeft vaker een kleiner verschil in proportie landgebruik met Zavelberg dan Lovenjoel en het totale verschil is ook kleiner. Bovendien is het verschil met Zavelberg in akkerproportie kleinst voor Kortenberg. Deze verschillen zijn niet zo groot. We geven daarom Kortenberg een "+" en Lovenjoel een "0".

```{r}
conclusie_df <- rbind(conclusie_df, c("landgebruiksamenstelling", "+", "0",
                        "voordeel Kortenberg niet super groot"))
```


## Beheerovereenkomsten

We beschouwen de toestand beheerovereenkomsten van 2021. Indeling voor niet-productieve gewassen/beheerovereenkomsten (instrumenten):

- soortbeschermingsmaatregelen
    - perceelsniveau
    - randen
- erosiemaatregelen
- bufferstroken

Voor de steekproeftrekking zijn vooral de oppervlakte aan soortbeschermingsmaatregelen van belang. Eventueel verder opgesplitst in winter-, zomer- en jaarrondmaatregelen.

```{r}
# Lees laag beheersovereenkomsten in
bo2021 <- read_bo2021(path = path_to_bo2021())
bo2021_leefdaal <- bo2021 %>%
  st_intersection(leefdaal)

# Visualisatie
mapview(leefdaal, zcol = "naam", layer.name = "Deelgebied") +
  mapview(bo2021_leefdaal, zcol = "BH_DOELST", 
          col.regions = list("red","blue", "green", "brown"),
          layer.name = "Beheersdoelstelling")
```

We willen voor elk deelgebied het oppervlakte-aandeel van de beheerovereenkomsten.

```{r}
# Bereken proporties beheersdoelstellingen
prop_bh_doelst_leefdaal <- landusemetrics_grid_cell(
    grid_cell = leefdaal,
    layer = bo2021_leefdaal,
    grid_group_by_col = "naam",
    layer_group_by_col = "BH_DOELST") %>%
  ungroup()

prop_srt_object_leefdaal <- landusemetrics_grid_cell(
    grid_cell = leefdaal,
    layer = bo2021_leefdaal,
    grid_group_by_col = "naam",
    layer_group_by_col = "SRT_OBJECT") %>%
  ungroup()

# Maak designmatrix om afwezige beheersvormen toe te voegen
design_bh_doelst <- expand.grid(prop_bh_doelst_leefdaal$naam, 
                                prop_bh_doelst_leefdaal$BH_DOELST) %>% 
  distinct() %>%
  rename(naam = Var1, BH_DOELST = Var2)

design_srt_object <- expand.grid(prop_srt_object_leefdaal$naam, 
                                 prop_srt_object_leefdaal$SRT_OBJECT) %>% 
  distinct() %>%
  rename(naam = Var1, SRT_OBJECT = Var2)

# Voeg afwezige beheersdoelstellingen toe aan dataframes
bh_doelst_leefdaal <- prop_bh_doelst_leefdaal %>% 
  full_join(design_bh_doelst, by = c("naam", "BH_DOELST")) %>%
  replace(is.na(.), 0)

srt_object_leefdaal <- prop_srt_object_leefdaal %>% 
  full_join(design_srt_object, by = c("naam", "SRT_OBJECT")) %>%
  replace(is.na(.), 0)
```

We vergelijken eerst het totale oppervlakte aandeel van beheersovereenkomsten. We zien dat het oppervlakte-aandeel beheersovereenkomsten veel groter is in Zavelberg dan Lovenjoel en zeker dan Kortenberg.

```{r}
bh_doelst_leefdaal %>%
  group_by(naam) %>%
  summarise(area_prop = sum(area_prop)) %>%
  ggplot(aes(x = naam, y = area_prop)) +
      geom_bar(aes(fill = naam), stat = "identity") +
      labs(x = "", y = "oppervlakte-aandeel", title = "Totaal") +
      theme(legend.position = "", 
            axis.text.x = element_text(angle = 90, vjust = 0.5))
```

Nu kunnen we ook per categorie vergelijken. We zien voor de variabele BH_DOELST dat soortbeschermingsmaatregelen een groot aandeel in Zavelberg innemen maar niet in de andere deelgebieden. Lovenjoel scoort wel hoger als het gaat om beheer van KLE's, erosiebestrijding en perceelrandsbeheer. In Kortenberg is er slechts een kleine oppervlakte perceelrandsbeheer aanwezig en geen andere beheersovereenkomsten.

```{r}
bh_doelst_leefdaal %>%
  mutate(BH_DOELST = reorder(BH_DOELST, area_prop, FUN = "mean",
                             decreasing = TRUE)) %>%
  ggplot(aes(x = naam, y = area_prop)) +
    geom_bar(aes(fill = naam), stat = "identity") +
    facet_wrap(~BH_DOELST, ncol = 2, scales = "free_y") +
    labs(x = "", y = "oppervlakte-aandeel", title = "BH_DOELST per categorie") +
    theme(legend.position = "", 
          axis.text.x = element_text(angle = 90, vjust = 0.5))
```

We willen een overzicht van de verschillen met Zavelberg (categorie ‘Kortenberg/Lovenjoel’: verschil met Zavelberg gelijk voor controlegebieden). Dit zegt echter niets over de grootte van het verschil.

```{r}
bh_doelst_leefdaal %>%
  select(naam, BH_DOELST, area_prop) %>%
  group_by(BH_DOELST) %>%
  pivot_wider(names_from = naam, values_from = area_prop) %>%
  mutate(diff_Kortenberg = abs(Kortenberg - Zavelberg),
         diff_Lovenjoel = abs(Lovenjoel - Zavelberg)) %>%
  select(-c(Kortenberg, Lovenjoel, Zavelberg)) %>%
  ungroup() %>%
  mutate(check = case_when(
    diff_Kortenberg < diff_Lovenjoel ~ "Kortenberg",
    diff_Kortenberg > diff_Lovenjoel ~ "Lovenjoel",
    diff_Kortenberg == diff_Lovenjoel ~ "Kortenberg/Lovenjoel")
    ) %>%
  mutate(check = reorder(check, check, FUN = "length",
                         decreasing = TRUE)) %>%
  ggplot(aes(x = check)) +
    geom_bar() +
    scale_y_continuous(breaks = seq(0, 3), limits = c(0, 3)) +
    labs(y = "aantal keer kleinste verschil\nmet Zavelberg", x = "", 
         title = "BH_DOELST per categorie") +
    geom_text(aes(label = as.character(..count..)), stat = "count", vjust = -1)
```

We tellen daarom alle verschillen op. We zien dat Kortenberg een kleiner verschil heeft in proportie beheerovereenkomst met Zavelberg dan Lovenjoel.

```{r}
bh_doelst_leefdaal %>%
  select(naam, BH_DOELST, area_prop) %>%
  group_by(BH_DOELST) %>%
  pivot_wider(names_from = naam, values_from = area_prop) %>%
  mutate(diff_Kortenberg = abs(Kortenberg - Zavelberg),
         diff_Lovenjoel = abs(Lovenjoel - Zavelberg)) %>%
  select(-c(Kortenberg, Lovenjoel, Zavelberg)) %>%
  ungroup() %>%
  mutate(check = case_when(
    diff_Kortenberg < diff_Lovenjoel ~ "Kortenberg",
    diff_Kortenberg > diff_Lovenjoel ~ "Lovenjoel",
    diff_Kortenberg == diff_Lovenjoel ~ "Kortenberg/Lovenjoel")
    ) %>%
  pivot_longer(cols = c(diff_Kortenberg, diff_Lovenjoel), names_to = "naam", 
               names_prefix = "diff_", values_to = "area_prop") %>%
  group_by(naam) %>%
  mutate(som = sum(area_prop)) %>%
  select(naam, som) %>%
  distinct() %>%
  ggplot(aes(x = naam, y = som)) +
    geom_bar(stat = "identity") +
    scale_y_continuous(limits = c(0, 0.14)) +
    labs(y = "verschil met Zavelberg", x = "", 
         title = "BH_DOELST per categorie") +
    geom_text(aes(label = round(som, digits = 3)), vjust = -1)
```

We zien voor de variabele SRT_OBJECT dat Lovenjoel en Zavelberg grotendeels op andere beheersvormen inzetten, maar er is wel wat overlap bijvoorbeeld in erosiestroken en bufferstroken.

```{r}
srt_object_leefdaal %>%
  mutate(SRT_OBJECT = reorder(SRT_OBJECT, area_prop, FUN = "mean",
                             decreasing = TRUE)) %>%
  ggplot(aes(x = naam, y = area_prop)) +
    geom_bar(aes(fill = naam), stat = "identity") +
    facet_wrap(~SRT_OBJECT, ncol = 3, scales = "free_y") +
    labs(x = "", y = "oppervlakte-aandeel", title = "SRT_OBJECT per categorie") +
    theme(legend.position = "", 
          axis.text.x = element_text(angle = 90, vjust = 0.5))
```

```{r}
srt_object_leefdaal %>%
  select(naam, SRT_OBJECT, area_prop) %>%
  group_by(SRT_OBJECT) %>%
  pivot_wider(names_from = naam, values_from = area_prop) %>%
  mutate(diff_Kortenberg = abs(Kortenberg - Zavelberg),
         diff_Lovenjoel = abs(Lovenjoel - Zavelberg)) %>%
  select(-c(Kortenberg, Lovenjoel, Zavelberg)) %>%
  ungroup() %>%
  mutate(check = case_when(
    diff_Kortenberg < diff_Lovenjoel ~ "Kortenberg",
    diff_Kortenberg > diff_Lovenjoel ~ "Lovenjoel",
    diff_Kortenberg == diff_Lovenjoel ~ "Kortenberg/Lovenjoel")
    ) %>%
  mutate(check = reorder(check, check, FUN = "length",
                         decreasing = TRUE)) %>%
  ggplot(aes(x = check)) +
    geom_bar() +
    scale_y_continuous(breaks = seq(0, 6), limits = c(0, 6)) +
    labs(y = "aantal keer kleinste verschil\nmet Zavelberg", x = "", 
         title = "SRT_OBJECT per categorie") +
    geom_text(aes(label = as.character(..count..)), stat = "count", vjust = -1)
```

Het absolute verschil in oppervlakte beheerovereenkomsten zal het zelfde zijn als bij BH_DOELST.

**Conclusie**  
  
Op vlak van oppervlakte-aandeel beheersovereenkomsten is er in Kortenberg bijna niets te vinden en Lovenjoel is in dat opzicht meer vergelijkbaar met Zavelberg. Desondanks wordt in Lovenjoel wel vaker op andere beheersvormen ingezet dan in Zavelberg. Hierdoor heeft Kortenberg wel vaker een kleiner verschil in oppervlakte beheersovereenkomst met Zavelberg.

```{r}
conclusie_df <- rbind(conclusie_df, c("beheersovereenkomsten - totaal", "-", 
                          "+", "bijna niets aanwezig in Kortenberg"),
                        c("beheersovereenkomsten - verschil", "+", "-",
                          "vaker andere beheersvorm Zavelberg vs. Lovenjoel"))
```


## Hoofdteelt

Belangrijkste teelten in 2021: goeie file? nieuwere data?

```{r}
# Lees laag hoofdteelten in
lbg_binding <- st_read(here(mbag_dir, "data", "landbouwgebruikspercelen", 
                            "Shapefile", "Lbgbrprc21.shp")) %>%
  st_transform(crs = 31370)
hoofdteelten_leefdaal <- lbg_binding %>%
  st_intersection(leefdaal)

# Visualisatie
mapview(leefdaal, zcol = "naam", layer.name = "Deelgebied") +
  mapview(hoofdteelten_leefdaal, zcol = "LBLHFDTLT", legend = FALSE)
```

We willen voor elk deelgebied het oppervlakte-aandeel van de hoofdteelten.

```{r}
# Bereken proportie hoofdteelten
prop_hfdteelten_leefdaal <- landusemetrics_grid_cell(
    grid_cell = leefdaal,
    layer = hoofdteelten_leefdaal,
    grid_group_by_col = "naam",
    layer_group_by_col = "LBLHFDTLT") %>%
  ungroup()

# Maak designmatrix om afwezige hoofdteelten toe te voegen
design_hfdteelten <- expand.grid(prop_hfdteelten_leefdaal$naam, 
                                 prop_hfdteelten_leefdaal$LBLHFDTLT) %>% 
  distinct() %>%
  rename(naam = Var1, LBLHFDTLT = Var2)

# Voeg afwezige hoofdteelten toe aan dataframes
hfdteelten_leefdaal <- prop_hfdteelten_leefdaal %>% 
  full_join(design_hfdteelten, by = c("naam", "LBLHFDTLT")) %>%
  replace(is.na(.), 0)
```

```{r}
hfdteelten_leefdaal %>%
  mutate(LBLHFDTLT = reorder(LBLHFDTLT, area_prop, FUN = "mean",
                             decreasing = FALSE)) %>%
  ggplot(aes(x = area_prop, y = LBLHFDTLT)) +
    geom_point(aes(colour = naam)) +
    labs(x = "oppervlakte-aandeel", y = "", title = "Hoofdteelten",
         colour = "deelgebied") +
    theme(legend.position = c(1, 0), legend.justification = c(1, 0))
```

We willen een overzicht van de verschillen met Zavelberg. Hoe groter de waarde, hoe groter het verschil tussen de controlegebieden en Zavelberg.

```{r}
hfdteelten_diff <- hfdteelten_leefdaal %>%
  select(naam, LBLHFDTLT, area_prop) %>%
  group_by(LBLHFDTLT) %>%
  pivot_wider(names_from = naam, values_from = area_prop) %>%
  mutate(diff_Kortenberg = abs(Kortenberg - Zavelberg),
         diff_Lovenjoel = abs(Lovenjoel - Zavelberg)) %>%
  select(-c(Kortenberg, Lovenjoel, Zavelberg)) %>%
  ungroup() %>%
  mutate(check = case_when(
    diff_Kortenberg < diff_Lovenjoel ~ "Kortenberg",
    diff_Kortenberg > diff_Lovenjoel ~ "Lovenjoel",
    diff_Kortenberg == diff_Lovenjoel ~ "Kortenberg/Lovenjoel")
    )

hfdteelten_diff %>%
  pivot_longer(cols = c(diff_Kortenberg, diff_Lovenjoel), names_to = "naam", 
               names_prefix = "diff_", values_to = "area_prop") %>%
  mutate(LBLHFDTLT = reorder(LBLHFDTLT, area_prop, FUN = "mean",
                           decreasing = FALSE)) %>%
  ggplot(aes(x = LBLHFDTLT, y = area_prop)) +
    geom_bar(aes(fill = naam), 
             stat = "identity", position = "dodge") +
    coord_flip() +
    labs(y = "oppervlakte-aandeel", x = "", title = "Hoofdteelten",
         fill = "deelgebied") +
    theme(legend.position = c(1, 0), legend.justification = c(1, 0))
```

Kortenberg heeft vaker een kleiner verschil met Zavelberg dan Lovenjoel (categorie 'Kortenberg/Lovenjoel': verschil met Zavelberg gelijk voor controlegebieden), maar dit is maar 16 keer ten opzichte van 15 dus dit is geen groot verschil. Dit zegt echter niets over de grootte van het verschil.

```{r}
hfdteelten_diff %>%
  mutate(check = reorder(check, check, FUN = "length",
                         decreasing = TRUE)) %>%
  ggplot(aes(x = check)) +
    geom_bar() +
    scale_y_continuous(breaks = seq(0, 18, by = 2), limits = c(0, 17)) +
    labs(y = "aantal keer kleinste verschil\nmet Zavelberg", x = "", 
         title = "Hoofdteelten") +
    geom_text(aes(label = as.character(..count..)), stat = "count", vjust = -1)
```

We tellen daarom alle verschillen op. We zien dat Kortenberg een kleiner verschil heeft in proportie hoofdteeld met Zavelberg dan Lovenjoel. Dit is opnieuw maar een klein verschil.

```{r}
hfdteelten_diff %>%
  pivot_longer(cols = c(diff_Kortenberg, diff_Lovenjoel), names_to = "naam", 
               names_prefix = "diff_", values_to = "area_prop") %>%
  group_by(naam) %>%
  mutate(som = sum(area_prop)) %>%
  select(naam, som) %>%
  distinct() %>%
  ggplot(aes(x = naam, y = som)) +
    geom_bar(stat = "identity") +
    scale_y_continuous(limits = c(0, 0.525)) +
    labs(y = "verschil met Zavelberg", x = "", 
         title = "Hoofdteelten") +
    geom_text(aes(label = round(som, digits = 3)), vjust = -1)
```


**Conclusie**  

Zowel Kortenberg als Lovenjoel hebben ongeveer even vaak een kleiner verschil met Zavelberg en het totale verschil in oppervlakte-aandeel is slechts iets kleiner bij Kortenberg. We geven daarom Kortenberg een "+" en Lovenjoel een "0".

```{r}
conclusie_df <- rbind(conclusie_df, c("hoofdteelten", "+", "0", 
                        "voordeel Kortenberg niet super groot"))
```


## Openheid landschap

We onderscheiden vier categoriën:

- gesloten landschap: GL
- half-gesloten landschap: HGL
- half-open landschap: HoL
- open landschap: OL

```{r}
prop_openheid_landschap <- function(
  polygoon,
  openheid_laag,
  path = path_to_openheid_landschap(),
  cutlevels = c(1.25, 1.35, 1.51),
  class_labels = c("GL", "HGL", "HOL", "OL")) {
  
  # Splits raster in categoriën
  matvec <- c(0, rep(cutlevels, each = 2), +Inf)
  nclass <- length(matvec) / 2

  rclasmat <- matvec %>%
    matrix(ncol = 2, byrow = TRUE)
  rclasmat <- cbind(rclasmat, 1:nclass)
  
  openheid_klassen <- terra::classify(
    openheid_laag,
    rcl = rclasmat,
    include.lowest = TRUE)
  
  # Bereken proporties oppervlakte
  out <- landusemetrics_grid_cell(
           grid_cell = leefdaal,
           layer = openheid_klassen,
           grid_group_by_col = "naam",
           layer_group_by_col = "") %>%
    mutate(openheid_klasse = factor(value,
                                    levels = 1:nclass,
                                    labels = class_labels)) %>%
    select(naam, openheid_klasse, area_prop = freq)
  
  return(out)
}
```

```{r}
# Lees in openheid raster
openheid <- rast(path_to_openheid_landschap()) %>%
    project("epsg:31370")
openheid_leefdaal <- crop(openheid, leefdaal) %>%
  raster::raster()

# Splits raster in categoriën
cutlevels = c(1.25, 1.35, 1.51)
class_labels = c("GL", "HGL", "HOL", "OL")

openheid <- rast(path_to_openheid_landschap()) %>%
    project("epsg:31370")
openheid_leefdaal_cropped <- crop(openheid, leefdaal)

matvec <- c(0, rep(cutlevels, each = 2), +Inf)
nclass <- length(matvec) / 2

rclasmat <- matvec %>%
  matrix(ncol = 2, byrow = TRUE)
rclasmat <- cbind(rclasmat, 1:nclass)

openheid_leefdaal_klassen <- terra::classify(
  openheid_leefdaal_cropped,
  rcl = rclasmat,
  include.lowest = TRUE)

openheid_leefdaal_raster <- raster::raster(openheid_leefdaal_klassen)
openheid_leefdaal_raster <- raster::ratify(openheid_leefdaal_raster)
levels(openheid_leefdaal_raster)[[1]]$LO <- c("GL", "HGL", "HOL", "OL")

# Visualisatie
mapview(leefdaal, zcol = "naam", layer.name = "Deelgebied", 
        alpha.regions = 0.6, alpha = 1) +
  mapview(openheid_leefdaal_raster, layer.name = "Openheid", 
        alpha.regions = 0.4)
```

We willen voor elk deelgebied het oppervlakte-aandeel van openheid landschap.

```{r}
# Bereken proportie openheid landschap
prop_openheid_leefdaal <- prop_openheid_landschap(leefdaal, openheid) %>%
  ungroup()

# Maak designmatrix om afwezige hoofdteelten toe te voegen
design_openheid <- expand.grid(prop_openheid_leefdaal$naam, 
                               prop_openheid_leefdaal$openheid_klasse) %>% 
  distinct() %>%
  rename(naam = Var1, openheid_klasse = Var2)

# Voeg afwezige hoofdteelten toe aan dataframes
openheid_leefdaal <- prop_openheid_leefdaal %>% 
  full_join(design_openheid, by = c("naam", "openheid_klasse")) %>%
  replace(is.na(.), 0)
```

```{r}
openheid_leefdaal %>%
  mutate(openheid_klasse = reorder(openheid_klasse, area_prop, FUN = "mean",
                                   decreasing = TRUE)) %>%
  ggplot(aes(x = naam, y = area_prop)) +
    geom_bar(aes(fill = naam), stat = "identity") +
    facet_wrap(~openheid_klasse, ncol = 2, scales = "free_y") +
    labs(x = "", y = "oppervlakte-aandeel", title = "Openheid landschap") +
    theme(legend.position = "", 
          axis.text.x = element_text(angle = 90, vjust = 0.5))
```

De verschillen lijken kleiner in Kortenberg. Inderdaad, Kortenberg heeft steeds een kleiner verschil met Zavelberg dan Lovenjoel (categorie ‘Kortenberg/Lovenjoel’: verschil met Zavelberg gelijk voor controlegebieden). Dit zegt echter niets over de grootte van het verschil.

```{r}
openheid_leefdaal %>%
  select(naam, openheid_klasse, area_prop) %>%
  group_by(openheid_klasse) %>%
  pivot_wider(names_from = naam, values_from = area_prop) %>%
  mutate(diff_Kortenberg = abs(Kortenberg - Zavelberg),
         diff_Lovenjoel = abs(Lovenjoel - Zavelberg)) %>%
  select(-c(Kortenberg, Lovenjoel, Zavelberg)) %>%
  ungroup() %>%
  mutate(check = case_when(
    diff_Kortenberg < diff_Lovenjoel ~ "Kortenberg",
    diff_Kortenberg > diff_Lovenjoel ~ "Lovenjoel",
    diff_Kortenberg == diff_Lovenjoel ~ "Kortenberg/Lovenjoel")
    ) %>%
  mutate(check = reorder(check, check, FUN = "length",
                         decreasing = TRUE)) %>%
  ggplot(aes(x = check)) +
    geom_bar() +
    scale_y_continuous(limits = c(0, 4.5)) +
    labs(y = "aantal keer kleinste verschil\nmet Zavelberg", x = "", 
         title = "Openheid landschap") +
    geom_text(aes(label = as.character(..count..)), stat = "count", vjust = -1)
```

We tellen daarom alle verschillen op. Kortenberg heeft een kleiner verschil in proportie openheid met Zavelberg dan Lovenjoel.

```{r}
openheid_leefdaal %>%
  select(naam, openheid_klasse, area_prop) %>%
  group_by(openheid_klasse) %>%
  pivot_wider(names_from = naam, values_from = area_prop) %>%
  mutate(diff_Kortenberg = abs(Kortenberg - Zavelberg),
         diff_Lovenjoel = abs(Lovenjoel - Zavelberg)) %>%
  select(-c(Kortenberg, Lovenjoel, Zavelberg)) %>%
  ungroup() %>%
  mutate(check = case_when(
    diff_Kortenberg < diff_Lovenjoel ~ "Kortenberg",
    diff_Kortenberg > diff_Lovenjoel ~ "Lovenjoel",
    diff_Kortenberg == diff_Lovenjoel ~ "Kortenberg/Lovenjoel")
    ) %>%
  pivot_longer(cols = c(diff_Kortenberg, diff_Lovenjoel), names_to = "naam", 
               names_prefix = "diff_", values_to = "area_prop") %>%
  group_by(naam) %>%
  mutate(som = sum(area_prop)) %>%
  select(naam, som) %>%
  distinct() %>%
  ggplot(aes(x = naam, y = som)) +
    geom_bar(stat = "identity") +
    scale_y_continuous(limits = c(0, 1.1)) +
    labs(y = "verschil met Zavelberg", x = "", 
         title = "Openheid landschap") +
    geom_text(aes(label = round(som, digits = 3)), vjust = -1)
```


**Conclusie**  

Kortenberg is meer gelijkaardig aan Zavelberg dan Lovenjoel in termen van openheid van het landschap.

```{r}
conclusie_df <- rbind(conclusie_df, c("openheid landschap", "+", "-", 
                        "relatief groot voordeel voor Kortenberg"))
```


## Expertise

- In Lovenjoel liggen al MAS-punten.
- Kortenberg ligt iets ten zuiden van een kerngebied. Lovenjoel is geen kerngebied.

```{r}
conclusie_df <- rbind(conclusie_df, c("MAS-punten", "-", "+",
                          "MAS-punten reeds aanwezig in Lovenjoel"),
                        c("kerngebied", "0", "-", 
                          "kerngebied in de buurt van Kortenberg"))
```


# Discussie en conclusie

We krijgen een overzicht van alle categoriën:

```{r}
conclusie_df %>% kable()
```

```{r}
rbind(data.frame(conclusie = conclusie_df$Kortenberg, 
                 deelgebied = rep("Kortenberg", nrow(conclusie_df))),
      data.frame(conclusie = conclusie_df$Lovenjoel, 
                 deelgebied = rep("Lovenjoel", nrow(conclusie_df)))) %>%
  count(deelgebied, conclusie) %>%
  mutate(conclusie = factor(conclusie, levels = c("-", "0", "+"), 
                            ordered = TRUE)) %>%
  arrange(conclusie) %>%
  pivot_wider(names_from = conclusie, values_from = n) %>%
  kable()
```

De finale beslissing hangt af van het belang dat aan elke categorie wordt toegekend. Als aanwezigheid van beheerovereenkomsten en MAS-punten heel belangrijk zijn, kunnen we stellen dat Lovenjoel goed kan dienen als controlegebied. Indien oppervlakte-aandeel in landgebruik, hoofdteelt en openheid landschap zo goed mogelijk moet overeenkomen met Zavelberg, dan lijkt Kortenberg een betere kandidaat.
