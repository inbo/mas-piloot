---
title: "MAS steekproefontwerp zandleemstreek"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
bibliography: mas.json
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  out.width = "100%")
opts_knit$set(root.dir = here::here())

# packages
library(tidyverse)
library(targets)
library(sf)
library(mapview)
library(terra)

# globals
source(here("src", "R", "steekproefkader.R"))
source(here("src", "R", "wfs_wcs.R"))
targets_store <- here("src", "targets", "mas_steekproef_zavelberg", "_targets")
```

# Afbakening steekproefkader

## Perimeter bepalen

Intersectie landbouwstreek zandleemstreek in België met contour Vlaanderen.
Nieuwe file geschreven "zandleemstreek_perimeters.gpkg" met enkel de zandleemstreek multipolygoon.

    # Code uitvoeren in mas_steekproef_zavelberg.Rproj
    # na laden van globals in targets_steekproef_zavelberg.Rmd

    library(sf)

    # Lees in polygonen landbouwstreken
    landbouwstreken <- read_sf(file.path(mbag_dir, "data", "landbouwstreken", 
                                         "Lbstrbel.shp")) |>
      st_transform(crs = 31370)

    # Behoud Zandleemstreek
    vlaanderen <- read_sf("S:/Vlaanderen/Grenzen/Administratief/Vlaanderen.shp") |>
      st_transform(crs = 31370)

    zandleem_vlaanderen <- st_intersection(landbouwstreken, vlaanderen) |>
      filter(NAAM == "Zandleemstreek") |>
      mutate(section = NA) |>
      select(Naam = NAAM, section, geom = geometry)

    st_write(obj = zandleem_vlaanderen,
             dsn = path_to_perimeters("zandleemstreek_perimeters.gpkg"))

```{r}
perimeters_data <- tar_read(perimeters_data, store = targets_store)

mapview(perimeters_data, color = "red", alpha.regions = 0, legend = FALSE)
```

## Selectie openheid landschap

We maken gebruik van het DSM (digitaal oppervlakte model - DHMV II Vlaanderen) en DTM (digitaal terrein model) op 5 m resolutie.
Werkwijze:

-   berekening "canopy height model" (CHM) door verschil te berekenen tussen DSM en DTM. Dit geeft dan hoogte boven het maaiveld (gebouwen, bodem, struiken, ...).
-   berekening van "positive topographic openness" (dit is een waarde tussen 0 en 2 in radians) door voor elke rastercel van het CHM in 8 kijkrichtingen na te gaan wat de gemiddelde hoek is t.o.v. zenith binnen een straal van 300m. Deze hoek geeft aan hoe plat het landschap is. Indien volledig plat is de hoek 90° (of 1.57 radians).
-   met dit resultaat de gemiddelde (van de gemiddelde) topografische openheid berekenen in een cirkelvormig landschap rond elke cel met straal 300 m.
-   deze gemiddelden zijn daarna ingedeeld in drie klassen:
    -   OL open landschap (\> 86,5°),
    -   HOL halfopen landschap (77,3° - 86,5°),
    -   HGL halfgesloten landschap (71,6° - 77,3°)
    -   GL (\< 71,6°) gesloten landschap

We selecteren OL en HOL binnen de perimeters.

```{r}
selectie_openheid_klasses <- tar_read(selectie_openheid_klasses, 
                                      store = targets_store)
mapview(perimeters_data, color = "red", alpha.regions = 0, legend = FALSE) +
  mapview(selectie_openheid_klasses, col.regions = "red", legend = FALSE)
```

## Exclusie van bepaalde landgebruiken

We gebruiken kenmerken uit [OpenStreetMap](https://www.openstreetmap.org) om bepaalde landgebruiken uit te sluiten voor de steekproeftrekking.
We gebruiken hiervoor de kenmerken [landuse](https://wiki.openstreetmap.org/wiki/NL:Key:landuse) (grondgebruik), [leisure](https://wiki.openstreetmap.org/wiki/NL:Key:leisure) (vrije tijd), [aeroway](https://wiki.openstreetmap.org/wiki/Key:aeroway) (luchthaven) en [highway](https://wiki.openstreetmap.org/wiki/Key:highway) (wegen).
De links in voorgaande zin verwijzen naar de volledige lijst van mogelijke klassen.

We knippen we onderstaande landgebruiken uit de openheid selectie.
Rond autosnelwegen en invoegstroken en afritten van autosnelwegen trekken we een buffer van 50 m.

### Woongebied

-   OSM definitie: `landuse = residential`
-   Objecttype: woongebied
-   OSM Wiki: <https://wiki.openstreetmap.org/wiki/Tag:landuse%3Dresidential>

### Militair terrein

-   OSM definitie: `landuse = military`
-   Objecttype: militair terrein
-   OSM Wiki: <https://wiki.openstreetmap.org/wiki/Tag:landuse%3Dmilitary>

### Industriegebied

-   OSM definitie: `landuse = industrial`
-   Objecttype: industriegebied
-   OSM Wiki: <https://wiki.openstreetmap.org/wiki/Tag:landuse%3Dindustrial>

### Begraafplaats

-   OSM definitie: `landuse = cemetary`
-   Objecttype: begraafplaats
-   OSM Wiki: <https://wiki.openstreetmap.org/wiki/Tag:landuse%3Dcemetery>

### Spoorwegemplacement, spoorbedding

-   OSM definitie: `landuse = railway`
-   Objecttype: spoorwegemplacement, spoorbedding
-   OSM Wiki: <https://wiki.openstreetmap.org/wiki/Tag:landuse%3Drailway>

### Commercieel

-   OSM definitie: `landuse = commercial`
-   Objecttype: commercieel
-   OSM Wiki: <https://wiki.openstreetmap.org/wiki/Tag:landuse%3Dcommercial>

### Boerenerf

-   OSM definitie: `landuse = farmyard`
-   Objecttype: boerenerf
-   OSM Wiki: <https://wiki.openstreetmap.org/wiki/Tag:landuse%3Dfarmyard>

### Park

-   OSM definitie: `leisure = park`
-   Objecttype: park
-   OSM Wiki: <https://wiki.openstreetmap.org/wiki/Tag:leisure%3Dpark>

### Vliegveld

-   OSM definitie: `aeroway = aerodrome`
-   Objecttype: vliegveld
-   OSM Wiki: <https://wiki.openstreetmap.org/wiki/Tag:aeroway%3Daerodrome>

### Autosnelweg

-   OSM definitie: `highway = motorway`
-   Objecttype: autosnelweg
-   OSM Wiki: <https://wiki.openstreetmap.org/wiki/Tag:highway%3Dmotorway>

### Invoegstroken en afritten van autosnelwegen

-   OSM definitie: `highway = motorway_link`
-   Objecttype: invoegstroken en afritten van autosnelwegen
-   OSM Wiki: <https://wiki.openstreetmap.org/wiki/Tag:highway%3Dmotorway_link>

Verder vereenvoudigen van de polygonenkaart door:

-   alle polygonen samen te voegen tot 1 multipolygon (union)
-   bufferen met straal 20 m
-   overtollige vertices verwijderen met tolerantie 10 m
-   alle gaten (polygon holes) verwijderen

In groen de exclusiekaart en groen OL en HOL binnen de perimeter.

```{r}
exclusie_osm_landgebruiken <- tar_read(exclusie_osm_landgebruiken,
                                       store = targets_store)

detail <- c("xmin" = 150000,
            "ymin" = 160000,
            "xmax" = 177000,
            "ymax" = 180000)

detail_sf <- tibble(geometry = st_as_sfc(st_bbox(detail))) %>% 
  st_as_sf() %>%
  st_set_crs(31370)
```

```{r}
openheid_crop <- st_crop(selectie_openheid_klasses, detail)
selectie_openheid_klasses_crop <- st_cast(openheid_crop)[which(
  st_is(st_cast(openheid_crop), c("POLYGON", "MULTIPOLYGON"))), ]  %>% 
  summarise()

mapview(st_crop(perimeters_data, detail), color = "red", alpha.regions = 0, 
        legend = FALSE) +
  mapview(detail_sf, color = "purple", alpha.regions = 0, legend = FALSE) +
  mapview(selectie_openheid_klasses_crop, col.regions = "red", 
          legend = FALSE) +
  mapview(st_crop(exclusie_osm_landgebruiken, detail), col.regions = "green", 
          legend = FALSE)
```

## Bepalen geldige plaatsen waar telling kan uitgevoerd worden

We gebruiken kenmerken uit [OpenStreetMap](https://www.openstreetmap.org) om geldige locaties te extraheren waar tellingen kunnen uitgevoerd worden.
We gebruiken hiervoor het kenmerk [highway](https://wiki.openstreetmap.org/wiki/Key:highway) (wegen).

We selecteren de volgende wegen.

### Veldwegen en boswegen

-   OSM definitie: `highway = track`
-   Objecttype: veldwegen en boswegen
-   OSM Wiki: <https://wiki.openstreetmap.org/wiki/Tag:highway%3Dtrack>

### Voetpad

-   OSM definitie: `highway = footway`
-   Objecttype: voetpad
-   OSM Wiki: <https://en.wikipedia.org/wiki/nl:Voetpad>

### (Bos)Pad

-   OSM definitie: `highway = path`
-   Objecttype: (bos)pad
-   OSM Wiki: <https://wiki.openstreetmap.org/wiki/NL:Tag:highway%3Dpath>

### Fietspad

-   OSM definitie: `highway = cycleway`
-   Objecttype: fietspad
-   OSM Wiki: <https://wiki.openstreetmap.org/wiki/NL:Tag:highway%3Dcycleway>

### Ruiterpad

-   OSM definitie: `highway = bridleway`
-   Objecttype: ruiterpad
-   OSM Wiki: <https://wiki.openstreetmap.org/wiki/Tag:highway%3Dbridleway>

### Tertiare wegen

-   OSM definitie: `highway = tertiary`
-   Objecttype: tertiare wegen
-   OSM Wiki: <https://wiki.openstreetmap.org/wiki/Tag:highway%3Dtertiary>

### Afslagen tertiare wegen

-   OSM definitie: `highway = tertiary_link`
-   Objecttype: afslagen tertiare wegen
-   OSM Wiki: <https://wiki.openstreetmap.org/wiki/Tag:highway%3Dtertiary_link>

### Lokale wegen

-   OSM definitie: `highway = unclassified`
-   Objecttype: lokale wegen
-   OSM Wiki: <https://wiki.openstreetmap.org/wiki/Tag:highway%3Dunclassified>

We verwijderen wegen die overlappen met de exclusiekaart en verwijderen overlappende wegen.

```{r}
paden <- tar_read(paden, store = targets_store)

mapview(st_crop(perimeters_data, detail), color = "red", alpha.regions = 0, 
        legend = FALSE) +
  mapview(detail_sf, color = "purple", alpha.regions = 0, legend = FALSE) +
  mapview(selectie_openheid_klasses_crop, col.regions = "red", 
          legend = FALSE) +
  mapview(st_crop(exclusie_osm_landgebruiken, detail), col.regions = "green", 
          legend = FALSE) +
  mapview(st_crop(paden, detail), legend = FALSE)
```

Overzicht totale lengte per categorie:

```{r lengte-paden}
paden %>%
  group_by(Naam, key, value) %>%
  summarise(.groups = "drop") %>%
  mutate(lengte_km = as.numeric(st_length(.)) / 1e3) %>%
  st_drop_geometry() %>%
  kable(digits = 1)
```

## Punten langs de wegen en paden

Werkwijze:

-   Langs alle paden worden op regelmatige afstanden van 50 m punten gelegd
-   Daarna worden punten die op minder dan 40 m van elkaar liggen ruimtelijk gegroepeerd (dit gebeurt wanneer verschillende paden elkaar kruisen of op korte afstand parallel aan elkaar liggen) en uit elk van deze clusters wordt één punt overgehouden
-   potentiële telpunten moeten op minstens 300 m van de grens van de perimeter gelegen zijn

```{r}
punten <- tar_read(punten, store = targets_store)

mapview(st_crop(perimeters_data, detail), color = "red", alpha.regions = 0, 
        legend = FALSE) +
  mapview(detail_sf, color = "purple", alpha.regions = 0, legend = FALSE) +
  mapview(selectie_openheid_klasses_crop, col.regions = "red", 
          legend = FALSE) +
  mapview(st_crop(exclusie_osm_landgebruiken, detail), col.regions = "green", 
          legend = FALSE) +
  mapview(st_crop(paden, detail), legend = FALSE) +
  mapview(st_crop(punten, detail), zcol = "value", layer = "Type weg/pad")
```

Overzicht aantal punten per categorie:

```{r}
punten %>%
  st_drop_geometry() %>%
  count(Naam, key, value, name = "Aantal punten") %>%
  kable()
```

## Exclusie van potentiële telpunten / telcirkels

### Exclusie op basis van landgebruiksamenstelling

Voor elk potentieel telpunt / telcirkel:

-   landgebruik oppervlaktes

> VITO 2019 landgebruikskaart (update elke 3 jaar)

```{r}
telcirkels_selectie_landgebruik <- tar_read(telcirkels_selectie_landgebruik,
                                   store = targets_store)
```

We gebruiken volgende regel als criterium voor telpunten die in aanmerkingen komen voor wat betreft de samenstelling van het landgebruik in een buffer van 300 m rond het punt:

-   Akker + Grasland \> 40% én Grasland + Bos + Struikgewas + Akker \> 50%

De gebruikte landgebruikskaart dekt enkel het Vlaamse grondgebied.
Indien de telcirkel deels in een andere gewest / land gelegen is, zal het landgebruik daar ontbreken.
In de momenteel gebruikte berekening is dit "ontbrekend" landgebruik weggefilterd en slaat het oppervlakte-aandeel enkel op het deel van de telcirkel waar we data voor hebben.
Het kan dus zijn dat op de volledige telcirkel deze oppervlakte-aandelen verschillend zijn (en al dan niet zouden moeten uitgesloten worden volgens het criterium).

```{r}
telcirkels_selectie_landgebruik %>%
  ggtern::ggtern(aes(x = Akker + Grasland,
                     y = Bos + Struikgewas,
                     z = Overige)) + 
  geom_point(alpha = 0.1,
             aes(colour = selectie2))
```

De kaart toont de punten die op deze manier niet meer in aanmerkingen komen.

```{r map-exclusie-landgebruik-vito}
exclusie_punten <- punten %>%
  left_join(telcirkels_selectie_landgebruik %>%
              group_by(pointid) %>%
              summarize(selectie2 = any(selectie2)),
            by = "pointid") %>%
  filter(!selectie2)

mapview(st_crop(perimeters_data, detail), color = "red", alpha.regions = 0, 
        legend = FALSE) +
  mapview(detail_sf, color = "purple", alpha.regions = 0, legend = FALSE) +
  mapview(selectie_openheid_klasses_crop, col.regions = "red", 
          legend = FALSE) +
  mapview(st_crop(exclusie_osm_landgebruiken, detail), col.regions = "green", 
          legend = FALSE) +
  mapview(st_crop(paden, detail), legend = FALSE) +
  mapview(st_crop(exclusie_punten, detail), col.regions = "black", legend = FALSE)
```

## Berekening volledig gekende variabelen die relatie hebben met respons

Dit zijn interessante variabelen om in rekening te brengen bij het steekproefdesign.
Dit kan bijvoorbeeld door middel van stratificatie of door te zorgen dat de steekproef op een homogene manier de gradiënt van deze hulpvariabele(n) afdekt.

Voor elk potentieel telpunt / telcirkel:

-   Beheerovereenkomst oppervlaktes: vooral de soortbeschermingsmaatregelen
-   maat voor openheid van het landschap (cf. OLA, HOLA, KLA)
-   oppervlakte-aandelen van hoofdteelten (landbouwgebruikspercelen)

### Oppervlakte-aandeel beheerovereenkomsten

Toestand beheerovereenkomsten 2022.

Indeling voor niet-productieve gewassen / beheerovereenkomsten (instrumenten):

-   soortbeschermingsmaatregelen
    -   perceelsniveau
    -   randen
-   erosiemaatregelen
-   bufferstroken

Voor de steekproeftrekking zijn vooral de oppervlakte aan soortbeschermingsmaatregelen van belang.
Eventueel verder opgesplitst in winter-, zomer- en jaarrondmaatregelen.

```{r bo-sbp}
steekproefkader_finaal <- tar_read(steekproefkader_finaal, store = targets_store)
```

```{r}
steekproefkader_finaal %>%
  ggplot() +
  geom_histogram(aes(x = area_prop_sb)) +
  labs(
    x = "Oppervlakte-aandeel soortbeschermingsmaatregelen binnen 300 m buffer",
    y = "Aantal potentiële telpunten (steekproefkader)")
```

Verdeling zonder nullen.

```{r}
steekproefkader_finaal %>%
  filter(area_prop_sb != 0) %>%
  ggplot() +
  geom_histogram(aes(x = area_prop_sb)) +
  labs(
    x = "Oppervlakte-aandeel soortbeschermingsmaatregelen binnen 300 m buffer",
    y = "Aantal potentiële telpunten (steekproefkader)")
```

### Oppervlakte-aandeel hoofdteelt

```{r lbg-stats}
lbg_statistieken <- tar_read(lbg_statistics, store = targets_store)
```

Belangrijkste teelten in 2022.
Voorlopige kaart.
Finale kaart wordt eind maart gepubliceerd.
Omzetten naar .parquet file.

    # Code uitvoeren in mas_steekproef_zavelberg.Rproj
    # na laden van globals in targets_steekproef_zavelberg.Rmd
        
    file <- sf::read_sf(file.path(mbag_dir, "data", "landbouwgebruikspercelen", "Shapefile",
                                  "Lbgbrprc22.shp"), query = NA)

    temp <- file %>%
      mutate(OIDN = NA, 
             UIDN = NA,
             LENGTE = NA,
             OPPERVL = NA) %>%
      select(OIDN, UIDN, ALVID = REF_ID, HFDTLT = GWSCOD_H, LBLHFDTLT = GWSNAM_H, 
             GEWASGROEP = GWSGRPH_LB, PM = GESP_PM, LBLPM = GESP_PM_LB, LENGTE, OPPERVL)

    sfarrow::st_write_parquet(obj = temp, 
      dsn = file.path(mbag_dir, "data", "landbouwgebruikspercelen", "parquet",
                      "lbgbrprc2022.parquet"), chunk_size = 10000)

```{r lbg-per-hoofdteelt}
lbg_statistieken %>%
  ungroup() %>%
  left_join(steekproefkader_finaal %>% st_drop_geometry() %>%
              select(pointid, Naam),
            by = "pointid") %>%
  select(Naam, pointid, LBLHFDTLT, area_prop) %>%
  pivot_wider(names_from = LBLHFDTLT,
              values_from = area_prop,
              values_fill = list(area_prop = 0),
              values_fn = list(area_prop = sum)) %>%
  pivot_longer(cols = -c(Naam, pointid)) %>%
  group_by(Naam, name) %>%
  summarise(prop_n_points = sum(value > 0) / n(),
            mean_prop = mean(value),
            mean_prop_present = mean(value[value > 0]),
            .groups = "drop_last") %>%
  filter(mean_prop > 0.01) %>%
  pivot_longer(cols = c(prop_n_points, mean_prop, mean_prop_present),
               names_to = "variable",
               values_to = "value") %>%
  ggplot() +
  geom_point(aes(y = forcats::fct_reorder(name, value, mean),
                 x = value, colour = variable)) +
  scale_x_continuous(labels = scales::percent) +
  scale_color_discrete(labels = c("Gemiddeld oppervlakteperc.",
                                  "Gemiddeld oppervlakteperc.\nwaar aanwezig",
                                  "Percentage pot. telpunten\n aanwezig")) +
  labs(x = "Percentage in telcirkel") + 
  theme(axis.title.y = element_blank())
```

Een logische en veelgebruikte opdeling voor gewassen is:

-   graangewassen (monocotylen zoals tarwe, gerst, etc..)
-   grasland (opdelen permanent en tijdelijk)
-   mais
-   aardappelen
-   wortelgewassen (biet, chicorei, wortel)
-   peulvruchten (erwt)
-   groententeelt (kolen zoals bloemkool, brocolli, spruiten, prei, ajuin, sla)
-   groenbemester (klavers, luzerne, mosterd) of koolzaad
-   meerjarige fruitteelt (appel, peer, kers, ea)
-   vlas
-   andere (vb eenjarig fruitteelt)

Hier gebruiken we de indeling volgens 'gewasgroep' zoals deze in de landbouwgebruikspercelenkaart zit.

```{r lbg-per-gewasgroep, warning=FALSE}
lbg_statistieken %>%
  ungroup() %>%
  left_join(steekproefkader_finaal %>% st_drop_geometry() %>%
              select(pointid, Naam),
            by = "pointid") %>%
  select(pointid, Naam, GEWASGROEP, area_prop) %>%
  pivot_wider(names_from = GEWASGROEP,
              values_from = area_prop,
              values_fill = list(area_prop = 0),
              values_fn = list(area_prop = sum)) %>%
  pivot_longer(cols = -c(Naam, pointid)) %>%
  group_by(Naam, name) %>%
  summarise(prop_n_points = sum(value > 0) / n(),
            mean_prop = mean(value),
            mean_prop_present = mean(value[value > 0]),
            .groups = "drop_last") %>%
  pivot_longer(cols = c(prop_n_points, mean_prop, mean_prop_present),
               names_to = "variable",
               values_to = "value") %>%
  ggplot() +
  geom_point(aes(y = forcats::fct_reorder(name, value, mean),
                 x = value, colour = variable)) +
  scale_x_continuous(labels = scales::percent) +
  scale_color_discrete(labels = c("Gemiddeld oppervlakteperc.",
                                  "Gemiddeld oppervlakteperc.\nwaar aanwezig",
                                  "Percentage pot. telpunten\n aanwezig")) +
  labs(x = "Percentage in telcirkel") + 
  theme(axis.title.y = element_blank())
```

### Openheid landschap

We maken gebruik van het DSM (digitaal oppervlakte model - DHMV II Vlaanderen) en DTM (digitaal terrein model) op 5 m resolutie.
Werkwijze:

-   berekening "canopy height model" (CHM) door verschil te berekenen tussen DSM en DTM. Dit geeft dan hoogte boven het maaiveld (gebouwen, bodem, struiken, ...).
-   berekening van "positive topographic openness" (dit is een waarde tussen 0 en 2 in radians) door voor elke rastercel van het CHM in 8 kijkrichtingen na te gaan wat de gemiddelde hoek is t.o.v. zenith binnen een straal van 300m. Deze hoek geeft aan hoe plat het landschap is. Indien volledig plat is de hoek 90° (of 1.57 radians).
-   met dit resultaat de gemiddelde (van de gemiddelde) topografische openheid berekenen in een cirkelvormig landschap rond elke cel met straal 300 m.
-   deze gemiddelden zijn daarna ingedeeld in drie klassen:
    -   OL open landschap (\> 86,5°),
    -   HOL halfopen landschap (77,3° - 86,5°),
    -   HGL halfgesloten landschap (71,6° - 77,3°)
    -   GL (\< 71,6°) gesloten landschap

Akkervogelgemeenschappen worden vaak ingedeeld volgens hun affiniteit met open landschap (OLA - Open landschap Akkervogels), half-open landschap (HOLA) en kleinschalig landschap (KLA).
Onder kleinschalig landschap verstaat men een landschap waar de percelen relatief klein zijn en het landschap in sterke mate dooraderd is door hagen, rietkragen en andere lijn- of puntvormige kleine landschapselementen (KLE's).
De manier waarop we openheid van het landschap hebben bepaald laat niet toe om KLA te bepalen zonder bijkomende berekeningen.
KLA zullen een subset zijn van wat wij HOL noemen, met name HOL waar de gemiddelde perceelsgrootte relatief klein is.

We hadden in de eerste stap al OL en HOL geselecteerd.
Toch is er nog een beetje HGL over maar in de allocatie zullen deze punten wegvallen.

```{r landschap-openheid}
openheid_classified <- rast(
  here("data", "dem",
       "openness300m_chm_res25_c300_mean_vlaanderen_classified.tif")) %>%
  crop(perimeters_data) %>%
  mask(terra::vect(perimeters_data))
```

```{r landschapsopenheid, warning=FALSE}
openheid_raster <- raster::raster(openheid_classified)
openheid_raster <- raster::ratify(openheid_raster)
levels(openheid_raster)[[1]]$LO <- c("GL", "HGL", "HOL", "OL")

openheid_raster %>%
  mapview(alpha = 0.3)
```

```{r openheid-points}
steekproefkader_finaal %>%
  ggplot() +
  geom_histogram(aes(x = openheid_waarde * 180 / pi,
                     fill = openheid_klasse),
                 binwidth = 0.5) +
  facet_wrap(~Naam, scales = "free_y") +
  labs(x = "Gemiddelde openheid landschap binnen 300 m buffer (in graden)",
       y = "Aantal potentiële telpunten (steekproefkader)")
```

### Soortbeschermingsplan

Zowel binnen kerngebied als zoekzones zijn er soortbeschermende maatregelen (SB BO's) gelegd (zie kaart VLM BO's).
In theorie waren deze maatregelen vooral bedoeld voor kerngebied, en zal daar een hogere dichtheid (bedekkingsgraad) liggen, maar de VLM heeft het toegelaten om ook in zoekzones deze maatregelen te sluiten (al was dat minder de prioriteit).
Daar werd bv in de Moeren geen rekening mee gehouden, en werden erg veel SB BOs gelegd, ook omdat dit gebied wél kerngebied is In de toekomst heeft VLM beloofd om meer/enkel rekening te houden met kerngebied, en dus nog meer te sturen op.

We nemen kerngebieden en zoekzones samen als onderzoeksgebied en alles hierbuiten beschouwen we als controle.
Als SBP laag gebruiken we perimeter SBP akkervogels, SBP grauwe kiekendief, sBP bruine kiekendief, SBP zomertortel en SBP hamster.

> SBP grauwe kiekendief, bruine kiekendief, hamster en zomertortel nog implementeren

```{r}
sbp_akkervogels <- tar_read(sbp_akkervogels, store = targets_store)

mapview(perimeters_data, color = "red", alpha.regions = 0, legend = FALSE) +
  mapview(sbp_akkervogels, col.regions = "yellow", legend = FALSE)
```

```{r}
binnen_sbp <- perimeters_data %>%
  st_intersection(sbp_akkervogels) %>%
  select(Naam) %>%
  mutate(opp = st_area(.),
         is_sbp = "binnen sbp")

buiten_sbp <- perimeters_data %>%
  st_difference(sbp_akkervogels %>%
                  st_union() %>%
                  st_combine()) %>%
  select(Naam) %>%
  mutate(opp = st_area(.),
         is_sbp = "buiten sbp")

opps <- bind_rows(buiten_sbp, binnen_sbp) %>% 
  st_drop_geometry()

opps %>%
  mutate(opp = units::set_units(opp, "ha")) %>%
  group_by(Naam) %>%
  mutate(opp_aandeel = opp / sum(opp)) %>%
  units::drop_units() %>%
  rename(opp_ha = opp) %>%
  relocate(is_sbp, .before = opp_ha) %>%
  arrange(Naam, is_sbp) %>%
  kable(digits = 2)
```

### Overzicht

```{r}
steekproefkader_finaal_strata <- steekproefkader_finaal %>%
  mutate(stratum = ifelse(is_sbp, paste0(openheid_klasse, " binnen sbp"),
                                  paste0(openheid_klasse, " buiten sbp")))

mapview(st_crop(perimeters_data, detail), color = "red", alpha.regions = 0, 
        legend = FALSE) +
  mapview(detail_sf, color = "purple", alpha.regions = 0, legend = FALSE) +
  mapview(selectie_openheid_klasses_crop, col.regions = "red", 
          legend = FALSE) +
  mapview(st_crop(exclusie_osm_landgebruiken, detail), col.regions = "green", 
          legend = FALSE) +
  mapview(st_crop(paden, detail), legend = FALSE) +
  mapview(st_crop(steekproefkader_finaal_strata, detail), zcol = "stratum",
          layer = "stratum")
```

# Trekking steekproef zandleemstreek

## Stratificatie steekproef

-   Stratificatie:
    -   binnen vs. buiten SBP perimeter
        -   allocatiefactor 50 %
    -   OL vs. HOL landschap
        -   allocatiefactor proportioneel aan aantal potentiële telpunten (\~ stratumoppervlakte)
-   Gebalanceerde en goed gespreide trekking: - ruimtelijk (x- en y-coördinaten) - oppervlakte aandeel beheerovereenkomsten

Allocatie van de steekproefgrootte over de verschillende strata:

-   Hier moeten we afweging maken tussen de precisie per stratum en precisie voor de leemstreek in zijn geheel.
    -   Voor het geheel zou een allocatie evenredig aan het steekproefkader van elk stratum wellicht de voorkeur hebben.
    -   Indien we echter ook geïnteresseerd zijn in uitspraken voor elk stratum apart en in onderlinge vergelijkingen tussen de strata, dan is een allocatie waarbij in elk stratum evenveel punten liggen meer aangewezen.

Tussen deze twee scenario's zijn er veel tussenposities.
In het algemeen kunnen we voor een kostenoptimale allocatie gebruik maken van een formule die stelt dat de allocatie recht evenredig is met de oppervlakte van een stratum en de variabilitiet in een stratum en omgekeerd evenredig is met de vierkantswortel van de kosten van het veldwerk in het stratum.

***Hoe is het nu gedaan?***

Target sample size is het maximaal aantal plots die binnen de OL, HOL perimeters kunnen gelegd worden.

```{r}
st_area(selectie_openheid_klasses) / units::set_units(300 * 300 * pi, m^2)
```

Minima onder $\times 4$ scenario.
4 strata (OL, HOL en binnen, buiten sbp) met minstens 50 telpunten per stratum.
$\times 4$ betekend halvering betrouwbaarheidsinterval $\rightarrow$ minimum sample size is 200 telpunten per stratum.

```{r}
allocatie <- tar_read(allocatie_df, store = targets_store) %>%
   mutate(openheid_sbp = paste(openheid_klasse,
                             ifelse(is_sbp,
                                    "binnen plan",
                                    "buiten plan"))
         )

allocatie %>%
  select(-openheid_sbp) %>%
  kable(digits = 3)
```

## Steekproeftrekking

We trekken geen veelvoud van het vooropgestelde aantal telpunten getrokken worden (enkel eerste batch van punten).
Elk telpunt zal een volgnummer hebben.
De eerste bv.
300 (laagste volgnummers) zullen dan de set zijn voor de zandleemstreek, die kan verdeeld worden over de medewerkers.
Indien een punt uitvalt, kan dit vervangen worden door het eerstvolgende uit de reeks dat nog niet toegewezen werd (het 301ste).
De methode garandeert dat deze nieuwe set ruimtelijk goed gespreid is en een aselecte steekproef is.

Temporeel design:

-   elk punt wordt elk jaar opnieuw bezocht

N.B.
voor de steekproef over Vlaanderen is het best mogelijk dat een ander temporeel design nodig is zoals een 'rotating panel design' of een 'augmented panel design'.

```{r trekking}
steekproef <- tar_read(steekproef_zichtbaarheid, store = targets_store) %>%
  mutate(openheid_sbp = paste(openheid_klasse,
                             ifelse(is_sbp,
                                    "binnen plan",
                                    "buiten plan"))
         )
```

Kaart van de steekproef:

```{r kaart-steekproef, warning=FALSE}
steekproef %>%
  st_buffer(dist = 300) %>%
  mapview(zcol = "openheid_sbp", layer = "stratum") +
  mapview(perimeters_data, color = "red", alpha.regions = 0, legend = FALSE)
```

De meest open landschappen zitten volledig binnen de perimeter van het SBP plan.
De vergelijking van HOL binnen vs. buiten plan en OL binnen vs. buiten plan is dus bemoeilijkt omdat de gemiddelde openheid systematisch hoger zal liggen binnen de SBP perimeter.

```{r check-balans}
balansvergelijking <- steekproef %>%
  mutate(puntenset = "steekproef") %>%
  bind_rows(steekproefkader_finaal %>%
              filter(openheid_klasse %in% c("OL", "HOL")) %>% 
              mutate(puntenset = "volledige steekproefkader")) %>%
  mutate(sbp_akkervogels = ifelse(is_sbp,
                                  "binnen sbp",
                                  "buiten sbp")) %>%
  cbind(st_coordinates(.)) %>%
  mutate(fillvar = ifelse(!is.na(batch),
                          paste("steekproef", batch),
                          puntenset))

balansvergelijking %>%
  ggplot() +
  geom_boxplot(aes(x = sbp_akkervogels, y = openheid_waarde,
                   fill = fillvar)) +
  facet_grid(Naam~openheid_klasse) +
  theme(legend.title = element_blank())
```

Een confounding probleem is dat HOL gemiddeld oostelijker gelegen is dan OL binnen en buiten de SBP perimeter.
Ook is HOL gemiddeld iets zuidelijker gelegen binnen de SBP perimeter dan OL.

```{r}
balansvergelijking %>%
  ggplot() + 
  geom_boxplot(aes(x = sbp_akkervogels,
                   y = X,
                   fill = fillvar)) +
  facet_grid(Naam~openheid_klasse, scales = "free") +
  theme(legend.title = element_blank())

balansvergelijking %>%
  ggplot() + 
  geom_boxplot(aes(x = sbp_akkervogels,
                   y = Y,
                   fill = fillvar)) +
  facet_grid(Naam~openheid_klasse, scales = "free") +
  theme(legend.title = element_blank())
```

Verder is ook duidelijk te zien dat de meeste SB beheerovereenkomsten afgesloten zijn binnen de SBP perimeter.
De stratificatie binnen vs. buiten SBP kunnen we dus effectief gebruiken als factor om na te gaan of er een effect is van deze maatregelen.
We zullen wel moeten corrigeren voor de confounders door de confounders op te nemen in een model en/of door de data te filteren met behulp van statistical matching technieken in functie van specifieke vraagstellingen over de effectiviteit van beheerovereenkomsten.

```{r}
balansvergelijking %>%
  ggplot() +
  geom_boxplot(aes(x = sbp_akkervogels,
                   y = area_prop_sb,
                   fill = fillvar)) +
  scale_y_sqrt() +
  facet_grid(~openheid_klasse) +
  labs(y = "Oppervlakte-aandeel SB beheerovereenkomsten") +
  theme(legend.title = element_blank())
```

We zien wel dat de steekproef een goede afspiegeling is van de volledige populatie (boxplots voor steekproef en populatie zijn zeer gelijkend).

> Hier niet van toepassing.
> Steekproef is volledige populatie.

```{r}
balansvergelijking %>%
  ggplot() + 
  geom_boxplot(aes(x = sbp_akkervogels,
                   y = Y,
                   fill = fillvar)) +
  facet_grid(Naam~openheid_klasse, scales = "free") +
  theme(legend.title = element_blank())
```

# Nabehandeling steekproef

## Filteren op basis van zichtbaarheid

cvvi \< 0.10

```{r}
ggplot(steekproef) +
  geom_histogram(aes(x = cvvi, fill = openheid_klasse)) +
  coord_cartesian(c(0, 1)) +
  scale_x_continuous(breaks = seq(0, 1, 0.1))
```

## Uitdunnen

```{r}
steekproef_nn <- tar_read(steekproef_nn, store = targets_store) %>%
  mutate(openheid_sbp = paste(openheid_klasse,
                             ifelse(is_sbp,
                                    "binnen plan",
                                    "buiten plan"))
         )
```

```{r}
steekproef_nn %>%
  st_buffer(dist = 300) %>%
  mapview(zcol = "openheid_sbp", layer = "stratum") +
  mapview(perimeters_data, color = "red", alpha.regions = 0, legend = FALSE)
```

## Overlap met bestaande telpunten

...
