---
title: "MAS steekproefontwerp zandleemstreek"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
bibliography: mas.json
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  out.width = "100%")
opts_knit$set(root.dir = here::here())

# packages
library(tidyverse)
library(targets)
library(sf)
library(mapview)

# globals
source(here("src", "R", "steekproefkader.R"))
source(here("src", "R", "wfs_wcs.R"))
targets_store <- here("src", "targets", "mas_steekproef_zavelberg", "_targets")
```

# Afbakening steekproefkader

## Perimeter bepalen

Intersectie landbouwstreek zandleemstreek in België met contour Vlaanderen. Nieuwe file geschreven "zandleemstreek_perimeters.gpkg" met enkel de zandleemstreek multipolygoon.

```{r, eval=FALSE}
# Code uitvoeren in mas_steekproef_zavelberg.Rproj
# na laden van globals in targets_steekproef_zavelberg.Rmd

library(sf)

# Lees in polygonen landbouwstreken
landbouwstreken <- read_sf(file.path(mbag_dir, "data", "landbouwstreken", 
                                     "Lbstrbel.shp")) |>
  st_transform(crs = 31370)

# Behoud Zandleemstreek
vlaanderen <- read_sf("S:/Vlaanderen/Grenzen/Administratief/Vlaanderen.shp") |>
  st_transform(crs = 31370)

zandleem_vlaanderen <- st_intersection(landbouwstreken, vlaanderen) |>
  filter(NAAM == "Zandleemstreek") |>
  mutate(section = NA) |>
  select(Naam = NAAM, section, geom = geometry)

st_write(obj = zandleem_vlaanderen,
         dsn = path_to_perimeters("zandleemstreek_perimeters.gpkg"))
```

In geel: prioritaire gebieden voor akkervogels.

```{r}
perimeters_data <- tar_read(perimeters_data, store = targets_store)
sbp_akkervogels <- tar_read(sbp_akkervogels, store = targets_store)

mapview(perimeters_data, color = "red", alpha.regions = 0) +
  mapview(sbp_akkervogels, col.regions = "yellow")
```

```{r}
binnen_sbp <- perimeters_data %>%
  st_intersection(sbp_akkervogels) %>%
  select(Naam) %>%
  mutate(opp = st_area(.),
         is_sbp = "binnen sbp")

buiten_sbp <- perimeters_data %>%
  st_difference(sbp_akkervogels %>%
                  st_union() %>%
                  st_combine()) %>%
  select(Naam) %>%
  mutate(opp = st_area(.),
         is_sbp = "buiten sbp")

opps <- bind_rows(buiten_sbp, binnen_sbp) %>% 
  st_drop_geometry()

opps %>%
  mutate(opp = units::set_units(opp, "ha")) %>%
  group_by(Naam) %>%
  mutate(opp_aandeel = opp / sum(opp)) %>%
  units::drop_units() %>%
  rename(opp_ha = opp) %>%
  relocate(is_sbp, .before = opp_ha) %>%
  arrange(Naam, is_sbp) %>%
  kable(digits = 2)
```


## Selectie openheid landschap

We selecteren OL en HOL binnen de perimeters.

```{r}
selectie_openheid_klasses <- tar_read(selectie_openheid_klasses, 
                                      store = targets_store)
mapview(perimeters_data, color = "red", alpha.regions = 0, legend = FALSE) +
  mapview(selectie_openheid_klasses, col.regions = "red", legend = FALSE)
```


## Exclusie van bepaalde landgebruiken

We gebruiken kenmerken uit [OpenStreetMap](https://www.openstreetmap.org) om bepaalde landgebruiken uit te sluiten voor de steekproeftrekking. We gebruiken hiervoor de kenmerken [landuse](https://wiki.openstreetmap.org/wiki/NL:Key:landuse) (grondgebruik), [leisure](https://wiki.openstreetmap.org/wiki/NL:Key:leisure) (vrije tijd), [aeroway](https://wiki.openstreetmap.org/wiki/Key:aeroway) (luchthaven) en [highway](https://wiki.openstreetmap.org/wiki/Key:highway) (wegen). De links in voorgaande zin verwijzen naar de volledige lijst van mogelijke klassen.  
  
We knippen we onderstaande landgebruiken uit de openheid selectie. Rond autosnelwegen en invoegstroken en afritten van autosnelwegen trekken we een buffer van 50 m.
  
### Woongebied

-   OSM definitie: `landuse = residential`
-   Objecttype: woongebied
-   OSM Wiki: https://wiki.openstreetmap.org/wiki/Tag:landuse%3Dresidential

### Militair terrein

-   OSM definitie: `landuse = military`
-   Objecttype: militair terrein
-   OSM Wiki: https://wiki.openstreetmap.org/wiki/Tag:landuse%3Dmilitary
  
### Industriegebied

-   OSM definitie: `landuse = industrial`
-   Objecttype: industriegebied
-   OSM Wiki: https://wiki.openstreetmap.org/wiki/Tag:landuse%3Dindustrial

### Begraafplaats

-   OSM definitie: `landuse = cemetary`
-   Objecttype: begraafplaats
-   OSM Wiki: https://wiki.openstreetmap.org/wiki/Tag:landuse%3Dcemetery
  
### Spoorwegemplacement, spoorbedding

-   OSM definitie: `landuse = railway`
-   Objecttype: spoorwegemplacement, spoorbedding
-   OSM Wiki: https://wiki.openstreetmap.org/wiki/Tag:landuse%3Drailway

### Commercieel

-   OSM definitie: `landuse = commercial`
-   Objecttype: commercieel
-   OSM Wiki: https://wiki.openstreetmap.org/wiki/Tag:landuse%3Dcommercial

### Boerenerf

-   OSM definitie: `landuse = farmyard`
-   Objecttype: boerenerf
-   OSM Wiki: https://wiki.openstreetmap.org/wiki/Tag:landuse%3Dfarmyard

### Park

-   OSM definitie: `leisure = park`
-   Objecttype: park
-   OSM Wiki: https://wiki.openstreetmap.org/wiki/Tag:leisure%3Dpark

### Vliegveld

-   OSM definitie: `aeroway = aerodrome`
-   Objecttype: vliegveld
-   OSM Wiki: https://wiki.openstreetmap.org/wiki/Tag:aeroway%3Daerodrome


### Autosnelweg

-   OSM definitie: `highway = motorway`
-   Objecttype: autosnelweg
-   OSM Wiki: https://wiki.openstreetmap.org/wiki/Tag:highway%3Dmotorway


### Invoegstroken en afritten van autosnelwegen

-   OSM definitie: `highway = motorway_link`
-   Objecttype: invoegstroken en afritten van autosnelwegen
-   OSM Wiki: https://wiki.openstreetmap.org/wiki/Tag:highway%3Dmotorway_link

Verder vereenvoudigen van de polygonenkaart door:

-   alle polygonen samen te voegen tot 1 multipolygon (union)
-   bufferen met straal 20 m
-   overtollige vertices verwijderen met tolerantie 10 m
-   alle gaten (polygon holes) verwijderen

In groen de exclusiekaart en blauw OL en HOL binnen de perimeter.

```{r}
exclusie_osm_landgebruiken <- tar_read(exclusie_osm_landgebruiken,
                                       store = targets_store)

detail <- c("xmin" = 150000,
            "ymin" = 160000,
            "xmax" = 177000,
            "ymax" = 180000)
detail_sf <- st_as_sfc(st_bbox(detail)) %>% st_set_crs(31370) %>% st_as_sf()

mapview(st_crop(perimeters_data, detail), color = "red", alpha.regions = 0, 
        legend = FALSE) +
  mapview(detail_sf, color = "purple", alpha.regions = 0, legend = FALSE) +
  mapview(st_crop(selectie_openheid_klasses, detail), col.regions = "red", 
          legend = FALSE) +
  mapview(st_crop(exclusie_osm_landgebruiken, detail), col.regions = "green", 
          legend = FALSE)
```

## Bepalen geldige plaatsen waar telling kan uitgevoerd worden

We gebruiken kenmerken uit [OpenStreetMap](https://www.openstreetmap.org) om geldige locaties te extraheren waar tellingen kunnen uitgevoerd worden. We gebruiken hiervoor het kenmerk [highway](https://wiki.openstreetmap.org/wiki/Key:highway) (wegen).  
  
We selecteren de volgende wegen.

### Veldwegen en boswegen

-   OSM definitie: `highway = track`
-   Objecttype: veldwegen en boswegen
-   OSM Wiki: https://wiki.openstreetmap.org/wiki/Tag:highway%3Dtrack

### Voetpad

-   OSM definitie: `highway = footway`
-   Objecttype: voetpad
-   OSM Wiki: https://en.wikipedia.org/wiki/nl:Voetpad

### (Bos)Pad

-   OSM definitie: `highway = path`
-   Objecttype: (bos)pad
-   OSM Wiki: https://wiki.openstreetmap.org/wiki/NL:Tag:highway%3Dpath

### Fietspad

-   OSM definitie: `highway = cycleway`
-   Objecttype: fietspad
-   OSM Wiki: https://wiki.openstreetmap.org/wiki/NL:Tag:highway%3Dcycleway

### Ruiterpad

-   OSM definitie: `highway = bridleway`
-   Objecttype: ruiterpad
-   OSM Wiki: https://wiki.openstreetmap.org/wiki/Tag:highway%3Dbridleway

### Tertiare wegen

-   OSM definitie: `highway = tertiary`
-   Objecttype: tertiare wegen
-   OSM Wiki: https://wiki.openstreetmap.org/wiki/Tag:highway%3Dtertiary

### Afslagen tertiare wegen

-   OSM definitie: `highway = tertiary_link`
-   Objecttype: afslagen tertiare wegen
-   OSM Wiki: https://wiki.openstreetmap.org/wiki/Tag:highway%3Dtertiary_link

### Lokale wegen

-   OSM definitie: `highway = unclassified`
-   Objecttype: lokale wegen
-   OSM Wiki: https://wiki.openstreetmap.org/wiki/Tag:highway%3Dunclassified

We verwijderen wegen die overlappen met de exclusiekaart en verwijderen overlappende wegen.

```{r}
paden <- tar_read(paden, store = targets_store)

mapview(st_crop(perimeters_data, detail), color = "red", alpha.regions = 0, 
        legend = FALSE) +
  mapview(detail_sf, color = "purple", alpha.regions = 0, legend = FALSE) +
  mapview(st_crop(selectie_openheid_klasses, detail), col.regions = "red", 
          legend = FALSE) +
  mapview(st_crop(exclusie_osm_landgebruiken, detail), col.regions = "green", 
          legend = FALSE) +
  mapview(st_crop(paden, detail), legend = FALSE) +
```

Overzicht totale lengte per categorie:

```{r lengte-paden}
paden %>%
  group_by(Naam, key, value) %>%
  summarise(.groups = "drop") %>%
  mutate(lengte_km = as.numeric(st_length(.)) / 1e3) %>%
  st_drop_geometry() %>%
  kable(digits = 1)
```


## Punten langs de wegen en paden

Werkwijze:

- Langs alle paden worden op regelmatige afstanden van 50 m punten gelegd
- Daarna worden punten die op minder dan 40 m van elkaar liggen ruimtelijk gegroepeerd (dit gebeurt wanneer verschillende paden elkaar kruisen of op korte afstand parallel aan elkaar liggen) en uit elk van deze clusters wordt één punt overgehouden
- potentiële telpunten moeten op minstens 300 m van de grens van de perimeter gelegen zijn

```{r}
punten <- tar_read(punten, store = targets_store)

mapview(st_crop(perimeters_data, detail), color = "red", alpha.regions = 0, 
        legend = FALSE) +
  mapview(detail_sf, color = "purple", alpha.regions = 0, legend = FALSE) +
  mapview(st_crop(selectie_openheid_klasses, detail), col.regions = "red", 
          legend = FALSE) +
  mapview(st_crop(exclusie_osm_landgebruiken, detail), col.regions = "green", 
          legend = FALSE) +
  mapview(st_crop(paden, detail), legend = FALSE) +
  mapview(st_crop(punten, detail), zcol = "value", layer = "Type weg/pad")
```

Overzicht aantal punten per categorie:

```{r}
punten %>%
  st_drop_geometry() %>%
  count(Naam, key, value, name = "Aantal punten") %>%
  kable()
```

