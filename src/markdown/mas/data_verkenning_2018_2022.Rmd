---
title: "Verkenning MAS veldwerk data van 2018 tot en met 2022"
author: "Ward Langeraert, Hans Van Calster"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
renv::restore()
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE)
opts_knit$set(root.dir = here::here())
library(tidyverse)
library(sf)
library(lubridate)
library(targets)
library(terra)
targets_store <- here("src", "targets", "mas_steekproef_pilootfase", "_targets")
source(here("src", "R", "berekening_hulpvariabelen.R"))
source(here("src", "R", "wfs_wcs.R"))
```

# Inlezen data

```{r ronde-intervallen}
r1_start <- "04-01"
r1_stop <- "04-20"
r2_start <- "04-21"
r2_stop <- "05-10"
r3_start <- "05-11"
r3_stop <- "06-10"
r4_start <- "06-21"
r4_stop <- "07-15"
```

```{r inlezen-mas-data}
mas <- read_sf(
  here("data/mas/20220906_qgis_export_sovon_wfs.gpkg")) %>%
  mutate(
    datum = ymd(paste(jaar, maand, dag, sep = "-")),
    periode_in_jaar = case_when(
      datum %within% interval(
        ymd(paste(jaar, r1_start, sep = "-")),
        ymd(paste(jaar, r1_stop, sep = "-"))) ~ "R1",
      datum %within% interval(
        ymd(paste(jaar, r2_start, sep = "-")),
        ymd(paste(jaar, r2_stop, sep = "-"))) ~ "R2",
      datum %within% interval(
        ymd(paste(jaar, r3_start, sep = "-")),
        ymd(paste(jaar, r3_stop, sep = "-"))) ~ "R3",
      datum %within% interval(
        ymd(paste(jaar, r4_start, sep = "-")),
        ymd(paste(jaar, r4_stop, sep = "-"))) ~ "R4"
    ))
```

```{r design2022}
design2022 <- read_csv(here(
    "data",
    "processed",
    "steekproef_piloot_avimap.csv")) %>%
  select(plotnaam = definitief_punt,
         regio,
         stratum) %>%
  mutate(openheid = ifelse(grepl("HOL", stratum), "HOL", "OL"),
         sbp = ifelse(grepl("binnen", stratum), "binnen", "buiten"),
         stratum = gsub("L\\s{1}", "L\\\n", stratum))
```


```{r design-2018-2022}
telpunten_avimap_2021 <- read_sf(
  here("data", "mas",
       "avimap_514_0_MAS_Werkgroep_Grauwe_Kiekendief_Belgi__telpunten_xy.shp")
) %>%
  rename(teller_2021 = teller) %>%
  mutate(
    regio = ifelse(is.na(regio), "Vlaanderen - Bilzen", regio),
    type_teller_2021 = case_when(
      teller_2021 %in% c("WVNT00", "JJNN16", "NOVN00") |
        regio == "Vlaanderen - Leefdaal" ~ "professioneel",
      is.na(teller_2021) &
        regio != "Vlaanderen - Leefdaal" ~ "niet geteld in 2021",
      TRUE ~ "vrijwilliger")) %>%
  select(-st_x, -st_y)

perimeters <- read_sf(
  here("data", "processed", "piloot_perimeters.gpkg"))

vlaanderen <- get_feature_wfs(
  wfs = "https://eservices.minfin.fgov.be/arcgis/services/R2C/Regions/MapServer/WFSServer",
  layername = "regions",
  crs = "EPSG:31370",
  filter = "<Filter><PropertyIsEqualTo><PropertyName>regions:NameDUT</PropertyName><Literal>'Vlaams Gewest'</Literal></PropertyIsEqualTo></Filter>") %>%
  select(NameDUT)


sbp_akkervogels <- tar_read(sbp_akkervogels,
                            store = targets_store)

design_2018_2021 <- add_openheid_landschap_to_frame(
  path = here("data", "dem",
    "openness300m_chm_res25_c300_mean_vlaanderen.tif"),
  punten_sf = telpunten_avimap_2021,
  gebied = vlaanderen,
  cutlevels = c(1.25, 1.35, 1.51),
  class_labels = c("GL", "HGL", "HOL", "OL")) %>%
  select(plotnaam = naam, regio, openheid = openheid_klasse) %>%
  mutate(sbp = st_intersects(.,
                             st_union(sbp_akkervogels),
                             sparse = FALSE) %>%
           as.logical(),
         sbp = ifelse(sbp, "binnen", "buiten")
  ) %>%
  st_drop_geometry() %>%
  mutate(stratum = paste0(openheid, "\n", sbp, " plan"),
         regio = gsub("Vlaanderen - ", "", regio),
         regio = ifelse(regio == "Leemstreek", "Oostelijke leemstreek", regio))
 
plotlijst_2018_2022 <- mas %>%
  st_drop_geometry() %>%
  distinct(plotnaam) %>%
  arrange(plotnaam)

design_2018_2022 <- bind_rows(
  design_2018_2021,
  design2022) %>%
  distinct() %>%
  arrange(plotnaam)
# er zitten duplos in (zie volgende chunk)


```


```{r probleemgevallen, eval=FALSE}
# probleemgevallen met verschillende classificatie
is_duplo <- duplicated(design_2018_2022$plotnaam)
duplo_plotnaam <- design_2018_2022 %>%
  select(plotnaam) %>%
  filter(is_duplo)
design_2018_2022 %>%
  inner_join(duplo_plotnaam) %>%
  View()

# volgens bestand buiten plan, maar lijkt niet te kloppen
# iets mis in targets analyse pipeline?
avimap <- telpunten_avimap_2021 %>%
  filter(naam == "VL0003")

read_csv(here(
    "data",
    "processed",
    "steekproef_piloot_avimap.csv")) %>%
  filter(definitief_punt == "VL0003") %>%
  st_as_sf(coords = c("X", "Y"), crs = 31370) %>%
  mapview::mapview()  +
  mapview::mapview(sbp_akkervogels, col.regions = "yellow") +
  mapview::mapview(avimap)

read_csv(here(
    "data",
    "processed",
    "steekproef_piloot_avimap.csv")) %>%
  inner_join(duplo_plotnaam, by = c("definitief_punt" = "plotnaam")) %>%
  st_as_sf(coords = c("X", "Y"), crs = 31370) %>%
  mapview::mapview()  +
  mapview::mapview(sbp_akkervogels, col.regions = "yellow")
```

```{r omzeilen-probleemgevallen}
# probleemgevallen voorlopig omzeilen
design_2018_2022 <- bind_rows(
  design_2018_2021,
  design2022 %>%
    filter(!grepl("^VL", plotnaam))) %>%
  distinct() %>%
  arrange(plotnaam)
```



```{r overzicht-data, eval=FALSE}
head(mas)
summary(mas)
glimpse(mas)
```

Dubbeltellingen zijn eruit (soort gezien op meerdere teldagen binnen eenzelfde telperiode): in dat geval de laatste teldag genomen.

```{r check-dubbeltelling}
dubbels <- mas %>%
  st_drop_geometry() %>%
  group_by(plotid, jaar, periode_in_jaar, soortnr) %>%
  summarize(aantal_teldagen = n_distinct(doy),
            .groups = "drop") %>%
  filter(aantal_teldagen > 1)
# kan zowel zelfde waarnemer als andere waarnemer zijn

mas_clean <- mas %>%
  semi_join(dubbels, by = c("plotid", "jaar", "periode_in_jaar")) %>%
  group_by(plotid, jaar, periode_in_jaar) %>%
  filter(doy == max(doy)) %>%
  ungroup() %>%
  bind_rows(mas %>%
              anti_join(dubbels, by = c("plotid", "jaar", "periode_in_jaar")))
```


# Resultaten vogels 2022

```{r selectie-vogels}
mas2022 <- mas_clean %>% 
  filter(soortgrp == 2,                # vogels
         jaar == 2022,                 # 2022
         !is.na(periode_in_jaar)       # binnen telronde
         ) %>%  # Moeren en Leemstreek
  inner_join(design2022, by = "plotnaam")

# To detect absences
bezoekenlijst_2022 <- design2022 %>% 
  expand_grid(distinct(mas2022, periode_in_jaar))
```

Selectie van vogelsoorten waargenomen in 2022. Waarnemingen buiten officiële telrondes en buiten De Moeren en de Leemstreek zijn eruit gehaald.


## Enkele cijfers

```{r tabel-vogels, message=FALSE}
mas2022 %>% group_by(regio, openheid, sbp) %>%
  st_drop_geometry() %>%
  summarise(aantal_tellingen = n_distinct(oid), 
            aantal_plots = n_distinct(plotid), 
            aantal_soorten = n_distinct(naam)) %>%
  kable()

mas2022 <- mas2022 %>% 
  group_by(regio) %>%
  mutate(plots_per_regio = n_distinct(plotid))
```


## Soortendiversiteit

Is de soortendiversiteit in De Moeren hoger dan in de leemstreek?

```{r soortendiversiteit}
diversiteit <- mas2022 %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, openheid, sbp, stratum, periode_in_jaar, naam) %>%
  summarize(totaal_aantal = sum(aantal),
            .groups = "drop_last") %>%
  summarize(aantal_soorten = n(),
            .groups = "drop")
```

```{r soortenaantal-boxplot}
diversiteit %>%
  ggplot() +
    geom_boxplot(aes(x = stratum, y = aantal_soorten,
                     fill = periode_in_jaar)) +
    facet_wrap(~regio, scales = "free_x") +
    labs(y = "Aantal soorten", x = "Stratum", fill = "Telperipode")
```

Om welke soorten gaat het?

```{r relfreqs-vogels}
relfreqs <- mas2022 %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, periode_in_jaar, naam) %>%
  summarize(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  group_by(periode_in_jaar, regio) %>%
  summarise(across(.cols = where(~ is.integer(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
                   .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")
```

Overzicht van relatieve frequenties van de 30 meest frequente soorten in een bepaalde regio. Elk punt staat voor een relatieve frequentie in een bepaalde telperiode van 2022.

```{r soortenfreqs-vogels, fig.height = 200/25.4}
relfreqs %>%
  mutate(naam = reorder(naam, relfreq, FUN = "mean")) %>%
  filter(as.numeric(naam) > length(unique(naam)) - 30) %>%
  ggplot() +
    labs(y = "", x = "Relatieve frequentie") +
    geom_point(aes(x = relfreq, y = naam, colour = regio))
```

Top 20 van soorten die in termen van verschil in gemiddelde relatieve frequentie van voorkomen meer voorkomen in __De Moeren__:

```{r meerfrequent-moeren}
relfreqs %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  slice_max(verschilfreq, n = 20) %>%
  kable(digits = 2)
```

Top 20 van soorten die in termen van verschil in gemiddelde relatieve frequentie van voorkomen meer voorkomen in __de Leemstreek__:

```{r meerfrequent-leemstreek}
relfreqs %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  slice_max(-verschilfreq, n = 20) %>%
  kable(digits = 2)
```


## Doelsoorten

```{r selectie-doelsoorten}
doelsoorten <- c("Veldleeuwerik", "Gele Kwikstaart", "Geelgors", "Fazant")
doel_df <- mas2022 %>% filter(naam %in% doelsoorten, wrntype > 0L) 
```

Enkel data met broedcode > 0 zijn weerhouden. De relatieve frequenties zullen dus niet exact hetzelfde zijn als in **2.2**. Opgepast: verwarrend is dat het veld broedcode niet de broedcode bevat. Hiervoor moet je het veld `wrntype` hebben. In De Moeren is geen half-open landschap aanwezig (NA).

```{r diversiteit-doelsoorten}
relfreqs_doel <- doel_df %>% 
  st_drop_geometry() %>%
  group_by(regio, plotnaam, stratum, openheid, sbp, periode_in_jaar, naam) %>%
  summarize(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  group_by(periode_in_jaar, regio, stratum, openheid, sbp) %>%
  summarise(across(.cols = where(~ is.integer(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
                   .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")

relfreqs_doel %>%
  group_by(regio, stratum, openheid, sbp, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, stratum, openheid, sbp, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  group_by(openheid, sbp) %>%
  arrange(naam) %>%
  select(-stratum) %>%
  kable(digits = 2)
```

De volgende figuur geeft een overzicht van de genoteerde broedcodes per regio voor elke soort. Een telling is hier geïnterpreteerd als een waarneming van een bepaalde soort op een bepaalde afstand in een bepaalde plot in een bepaalde telperiode. Er is dus geen rekening gehouden met het aantal vogels genoteerd per telling. De tellingen zijn hoger in de Leemstreek maar daar waren ook meer plots. Deze figuur geeft dus enkel de absolute aantallen weer. 

```{r broedcodes-doelsoorten, message=FALSE, fig.height=7, fig.width=9}
# Save totals to put labels on plot
totals <- doel_df %>%
    st_drop_geometry() %>%
    group_by(naam, stratum, regio) %>%
    summarise(total = n())

# Summarize data and make plot
doel_df %>% 
  st_drop_geometry() %>%
  mutate(wrntype_omschrijving2 = paste(wrntype, wrntype_omschrijving, 
                                       sep = ": ")) %>%
  group_by(naam, stratum, regio, wrntype_omschrijving2) %>%
  summarise(N = n()) %>%
  ggplot(aes(x = stratum, y = N, fill = wrntype_omschrijving2)) +
    geom_bar(stat = "identity", colour = "black") +
    geom_text(data = totals, aes(x = stratum, 
                                 y = total + c(rep(30, 17), rep(125, 6)),
                                 label = total, fill = NULL)) +
    labs(y = "Aantal tellingen", x = "") +
    guides(fill = guide_legend(title = "broedcode")) +
    facet_grid(naam~regio, scales = "free") 
```

De volgende figuur toont de relatieve frequentie van de doelsoorten in een bepaalde telperiode voor de verschillende regio's gestratificeerd volgens openheid van het landschap en binnen of buiten sbp's. 

```{r telperiode-doelsoorten, message=FALSE}
relfreqs_doel %>%
  ggplot() +
    labs(y = "Relatieve frequentie", x = "Telperiode") +
    geom_point(aes(x = periode_in_jaar, y = relfreq,
                   colour = openheid, shape = sbp)) +
    facet_grid(naam~regio) +
    scale_y_continuous(limits = c(0, 1))
```


Voor de Torenvalk wordt geen rekening gehouden met broedcodes. Alle waarnemingen zijn relevant o.w.v. terreingebruik. De relatieve frequentie is dus identiek als in **2.2**.

```{r relfreq-torenvalk, message=FALSE}
relfreq_torenvalk <- mas2022 %>%
  st_drop_geometry() %>%
  filter(naam == "Torenvalk") %>%
  group_by(regio, plotnaam, stratum, openheid, sbp, periode_in_jaar, naam) %>%
  summarize(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  full_join(bezoekenlijst_2022, 
            by = c("regio", "plotnaam", "stratum", "openheid", "sbp", 
                   "periode_in_jaar")) %>%
  mutate(totaal_aantal = ifelse(is.na(totaal_aantal), 0, totaal_aantal)) %>%
  group_by(periode_in_jaar, regio, stratum, openheid, sbp) %>%
  summarise(relfreq = sum(totaal_aantal > 0) / n(),
                   .groups = "drop")

```


```{r freq-torenvalk}
relfreq_torenvalk %>%
  group_by(regio, openheid, sbp) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, openheid, sbp, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  kable(digits = 2)
```

De volgende figuur toont de relative frequentie van de soort in een bepaalde telperiode voor de verschillende regio's en strata.

```{r telperiode-torenvalk, message=FALSE}
relfreq_torenvalk %>%
  ggplot() +
    labs(y = "Relatieve frequentie", x = "Telperiode") +
    geom_point(aes(x = periode_in_jaar, y = relfreq,
                   colour = openheid, shape = sbp)) +
    facet_wrap(~regio) +
    scale_y_continuous(limits = c(0, 1))
```


# Resultaten zoogdieren 2022

```{r selectie-zoogdieren}
zoogdieren <- mas_clean %>% 
  filter(soortgrp == 1,                # zoogdieren
         jaar == 2022,                 # 2022
         !is.na(periode_in_jaar)       # binnen telronde
         ) %>%  # Moeren en Leemstreek
  inner_join(design2022, by = "plotnaam")
```

Selectie van zoogdieren waargenomen in 2022. Waarnemingen buiten officiële telrondes en buiten De Moeren en de Leemstreek zijn eruit gehaald.

## Enkele cijfers

```{r tabel-zoogdieren}
zoogdieren %>% group_by(regio) %>%
  st_drop_geometry() %>%
  summarise(aantal_tellingen = n_distinct(oid), 
            aantal_plots = n_distinct(plotid), 
            aantal_soorten = n_distinct(naam)) %>%
  kable()
```


## Soortendiversiteit

```{r relfreqs-zoogdieren}
relfreqs_z <- zoogdieren %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, periode_in_jaar, naam) %>%
  summarize(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  group_by(periode_in_jaar, regio) %>%
  summarise(across(.cols = where(~ is.integer(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
                   .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")
```

Overzicht van relatieve frequenties van de zoogdieren in een bepaalde regio. Elk punt staat voor een relatieve frequentie in een bepaalde telperiode van 2022. De frequenties zijn relatief ten opzichte van de andere zoogdieren. Als er een zoogdier wordt gezien, is dit vaak de Haas.

```{r soortenfreqs-zoogdieren}
relfreqs_z %>%
  mutate(naam = reorder(naam, relfreq, FUN = "mean")) %>%
  ggplot() +
    labs(y = "", x = "Relatieve frequentie") +
    geom_point(aes(x = relfreq, y = naam, colour = regio))
```

```{r freqtable-zoogdieren}
relfreqs_z %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  # Same order as in the previous plot
  rowwise() %>%
  mutate(max = max(`De Moeren`, `Oostelijke leemstreek`)) %>%
  arrange(desc(max)) %>% select(-max) %>%
  kable(digits = 3)
```


# Resultaten vogels 2018--2022

```{r selectie-vogels-langetermijn}
mas_vogels <- mas_clean %>% 
  filter(soortgrp == 2,                # vogels
         !is.na(periode_in_jaar)       # binnen telronde
         ) %>%  # Moeren en Leemstreek
  inner_join(design_2018_2022, by = "plotnaam")
```

Selectie van vogelsoorten. Waarnemingen buiten officiële telrondes en buiten Bilzen, De Moeren en de Leemstreek zijn eruit gehaald.


## Enkele cijfers

```{r tabel-langetermijn, message=FALSE}
mas_vogels %>% group_by(regio, jaar) %>%
  st_drop_geometry() %>%
  summarise(aantal_tellingen = n_distinct(oid), 
            aantal_plots = n_distinct(plotid), 
            aantal_soorten = n_distinct(naam)) %>%
  kable()
```

```{r aantal-plots, message=FALSE}
mas_vogels %>% 
  filter(regio != "Bilzen") %>%
  group_by(regio, jaar, openheid, sbp) %>%
  st_drop_geometry() %>%
  summarise(tellingen = n_distinct(oid), 
            plots = n_distinct(plotid)) %>%
  pivot_longer(cols = c(tellingen, plots),
               names_to = "legende",
               values_to = "aantal") %>%
  group_by(regio, jaar, legende) %>%
  mutate(tot = sum(aantal)) %>%
  ggplot() +
    geom_point(aes(x = jaar, y = aantal, colour = openheid, shape = sbp)) +
    geom_point(aes(x = jaar, y = tot, alpha = ""),
             shape = 8, colour = "darkgreen") +
    labs(x = "", y = "Aantal", alpha = "totaal aantal\nper jaar in regio") +
    scale_alpha_manual(values = 1) +
    facet_grid(legende~regio, scales = "free_y") 
```

## Soortendiversiteit

Is de soortendiversiteit in De Moeren hoger dan in de leemstreek?

```{r soortendiversiteit-langetermijn}
diversiteit_vogels <- mas_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, periode_in_jaar, naam) %>%
  summarize(totaal_aantal = sum(aantal),
            .groups = "drop_last") %>%
  summarize(aantal_soorten = n(),
            .groups = "drop")
```

```{r soortenaantal-boxplot-langetermijn}
diversiteit_vogels %>%
  ggplot() +
    geom_boxplot(aes(x = periode_in_jaar, y = aantal_soorten, fill = regio)) +
    labs(y = "Aantal soorten", x = "Telperiode") +
    facet_wrap(~jaar)
```

Overzichtelijkere figuren om te vergelijken binnen gebieden:

```{r soortenaantal-boxplot-langetermijn2}
cols <- c("#F8766D", "#00BA38", "#619CFF")
for (i in 1:length(unique(diversiteit_vogels$regio))) {
  reg <- unique(diversiteit_vogels$regio)[i]
  print(
    diversiteit_vogels %>%
    filter(regio == reg) %>%
    ggplot() +
      geom_boxplot(aes(x = periode_in_jaar, y = aantal_soorten), fill = cols[i]) +
      facet_wrap(regio~jaar) +
      labs(y = "Aantal soorten", x = "Telperiode")
  )
}
```

Gestratificeerd:

```{r soortendiversiteit-langetermijn-strat}
diversiteit_vogels_strat <- mas_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, openheid, sbp, stratum, jaar, periode_in_jaar, naam) %>%
  summarize(totaal_aantal = sum(aantal),
            .groups = "drop_last") %>%
  summarize(aantal_soorten = n(),
            .groups = "drop")
```

```{r soortenaantal-boxplot-langetermijn-strat}
for (reg in unique(diversiteit_vogels_strat$regio)) {
  print(
    diversiteit_vogels_strat %>%
    filter(regio == reg) %>%
    ggplot() +
      labs(y = "Aantal soorten", x = "Telperiode") +
      geom_boxplot(aes(x = periode_in_jaar, y = aantal_soorten, fill = stratum)) +
      facet_wrap(regio~jaar)
  )
}
```

Om welke soorten gaat het?

```{r relfreqs-langetermijn}
relfreqs_vogels <- mas_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, periode_in_jaar, naam) %>%
  summarize(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  group_by(jaar, periode_in_jaar, regio) %>%
  summarise(across(.cols = where(~ is.integer(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
                   .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")
```

Overzicht van relatieve frequenties van de 30 meest frequente soorten in een bepaalde regio. Elk punt staat voor een relatieve frequentie in een bepaald jaar en een bepaalde telperiode van dat jaar.

```{r soortenfreqs-langetermijn, fig.height = 200/25.4}
relfreqs_vogels %>%
  mutate(naam = reorder(naam, relfreq, FUN = "mean")) %>%
  filter(as.numeric(naam) > length(unique(naam)) - 30) %>%
  ggplot() +
    labs(y = "", x = "Relatieve frequentie") +
    geom_point(aes(x = relfreq, y = naam, colour = regio))
```

> Opgepast! In de volgende tabellen wordt de gemiddelde relatieve frequentie berekend door een gemiddelde te nemen over de telperiodes en over de jaren (per regio en per soort). Het is mogelijks niet correct een ongewogen gemiddelde te nemen over de jaren heen. Dit moet verder uitgezocht worden. Over de telperiodes is op zich wel correct want dit zijn replicaten.

Top 20 van soorten die in termen van verschil in gemiddelde relatieve frequentie van voorkomen meer voorkomen in __De Moeren__ dan in de Oostelijke leemstreek:

```{r meerfrequent-moeren-langetermijn}
relfreqs_vogels %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>% # Correct?
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  slice_max(verschilfreq, n = 20) %>%
  select(-Bilzen) %>%
  kable(digits = 2)
```

Top 20 van soorten die in termen van verschil in gemiddelde relatieve frequentie van voorkomen meer voorkomen in __de Oostelijke leemstreek__ dan in De Moeren:

```{r meerfrequent-leemstreek-langetermijn}
relfreqs_vogels %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>% # Correct?
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  slice_max(-verschilfreq, n = 20) %>%
  select(-Bilzen) %>%
  kable(digits = 2)
```


## Doelsoorten

```{r selectie-doelsoorten-langetermijn}
doel_vogels <- mas_vogels %>% filter(naam %in% doelsoorten, wrntype > 0L) 
```

Enkel data met broedcode > 0 zijn weerhouden. De relatieve frequenties zullen dus niet exact hetzelfde zijn als in **4.2**. Opgepast: verwarrend is dat het veld broedcode niet de broedcode bevat. Hiervoor moet je het veld `wrntype` hebben.

> Opgepast! In de volgende tabel wordt de gemiddelde relatieve frequentie berekend door een gemiddelde te nemen over de telperiodes en over de jaren (per regio en per soort). Het is mogelijks niet correct een ongewogen gemiddelde te nemen over de jaren heen. Dit moet verder uitgezocht worden. Over de telperiodes is op zich wel correct want dit zijn replicaten.

```{r diversiteit-doelsoorten-langetermijn}
relfreqs_doelvogels <- mas_vogels %>% 
  filter(wrntype > 0L) %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, periode_in_jaar, naam) %>%
  summarize(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  group_by(periode_in_jaar, jaar, regio) %>%
  summarise(across(.cols = where(~ is.integer(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
                   .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")

relfreqs_doelvogels %>%
  filter(naam %in% doelsoorten) %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>% # Correct?
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  ungroup() %>%
  arrange(naam) %>%
  kable(digits = 2)
```

De volgende figuren tonen de relatieve frequentie van de doelsoorten in een bepaalde telperiode voor de verschillende regio’s over de jaren.

```{r telperiode-doelsoorten-langetermijn, message=FALSE}
for (soort in doelsoorten) {
  print(
    relfreqs_doelvogels %>% 
    filter(naam == soort) %>%
    ggplot() +
      geom_point(aes(x = periode_in_jaar, y = relfreq, colour = regio)) +
      labs(title = toString(soort), 
           y = "Relatieve frequentie", 
           x = "Telperiode") +
      scale_y_continuous(limits = c(0, 1)) +
      facet_wrap(~jaar)
    )
}
```

Telperiodes zijn herhalingen binnen een jaar en we zijn vooral geïnteresseerd in de wijzigingen van jaar tot jaar:

```{r telperiode-doelsoorten-langetermijn2, message=FALSE}
for (soort in doelsoorten) {
  print(
    relfreqs_doelvogels %>% 
    filter(naam == soort) %>%
    ggplot() +
      geom_jitter(aes(x = jaar, y = relfreq, colour = regio, 
                     shape = periode_in_jaar),
                  width = 0.1) +
      labs(title = toString(soort), y = "Relatieve frequentie", x = "") +
      scale_y_continuous(limits = c(NA, 1))
    )
}
```

> We berekenen de relatieve frequenties apart binnen voor elke regio binnen elk stratum in elke telperiode in elk jaar. Deze resultaten kunnen niet zomaar uitgemiddeld worden om tot een gemiddelde over de strata en over de jaren te komen. Dit moet verder uitgezocht worden.

```{r diversiteit-doelsoorten-langetermijn-strat}
relfreqs_doelvogels_strat <- mas_vogels %>% 
  filter(wrntype > 0L) %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, stratum, periode_in_jaar, naam) %>%
  summarize(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  group_by(periode_in_jaar, jaar, regio, stratum) %>%
  summarise(across(.cols = where(~ is.integer(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
                   .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")
```

```{r telperiode-doelsoorten-langetermijn-strat, message=FALSE}
for (soort in doelsoorten) {
  for (reg in unique(diversiteit_vogels_strat$regio)) {
    print(
      relfreqs_doelvogels_strat %>% 
      filter(naam == soort, regio == reg) %>%
      ggplot() +
        geom_jitter(aes(x = as.factor(jaar), y = relfreq, colour = stratum,
                       shape = periode_in_jaar),
                    width = 0.1) +
        labs(title = toString(soort), 
             y = "Relatieve frequentie", 
             x = "") +
        expand_limits(y = 1) +
        facet_wrap(~regio)
      )
  }
}
```

Voor de Torenvalk wordt geen rekening gehouden met broedcodes. Alle waarnemingen zijn relevant o.w.v. terreingebruik. De relatieve frequentie is dus identiek als in **2.2**.

> Opgepast! In de volgende tabel wordt de gemiddelde relatieve frequentie berekend door een gemiddelde te nemen over de telperiodes en over de jaren (per regio en per soort). Het is mogelijks niet correct een ongewogen gemiddelde te nemen over de jaren heen. Dit moet verder uitgezocht worden. Over de telperiodes is op zich wel correct want dit zijn replicaten.

```{r freq-torenvalk-langetermijn}
relfreqs_vogels %>%
  filter(naam == "Torenvalk") %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  ungroup() %>%
  arrange(naam) %>%
  kable(digits = 2)
```

De volgende figuur toont de relatieve frequentie van de soort in een bepaalde telperiode voor de verschillende regio's over de jaren.

```{r telperiode-torenvalk-langetermijn, message=FALSE}
relfreqs_vogels %>%
  filter(naam == "Torenvalk") %>%
  ggplot() +
    geom_point(aes(x = periode_in_jaar, y = relfreq, colour = regio)) +
    labs(title = "Torenvalk", y = "Relatieve frequentie", x = "Telperiode") +
    scale_y_continuous(limits = c(0, 1)) +
    facet_wrap(~jaar, scales = "free_y")
```

Telperiodes zijn herhalingen binnen een jaar en we zijn vooral geïnteresseerd in de wijzigingen van jaar tot jaar:

```{r telperiode-torenvalk-langetermijn2, message=FALSE}
relfreqs_doelvogels %>% 
filter(naam == "Torenvalk") %>%
group_by(regio, jaar, periode_in_jaar) %>%
mutate(gemiddelde_freq = mean(relfreq)) %>%
ggplot() +
  geom_jitter(aes(x = jaar, y = gemiddelde_freq, colour = regio, 
                 shape = periode_in_jaar),
              width = 0.1) +
  labs(title = "Torenvalk", y = "Relatieve frequentie", x = "") +
  expand_limits(y = 1)
```

> We berekenen de relatieve frequenties apart binnen voor elke regio binnen elk stratum in elke telperiode in elk jaar. Deze resultaten kunnen niet zomaar uitgemiddeld worden om tot een gemiddelde over de strata en over de jaren te komen. Dit moet verder uitgezocht worden.

```{r diversiteit-torenvalk-langetermijn-strat}
relfreqs_torenvalk_strat <- mas_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, stratum, periode_in_jaar, naam) %>%
  summarize(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  group_by(periode_in_jaar, jaar, regio, stratum) %>%
  summarise(across(.cols = where(~ is.integer(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
                   .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")
```

```{r telperiode-torenvalk-langetermijn-strat, message=FALSE}
for (reg in unique(diversiteit_vogels_strat$regio)) {
  print(
    relfreqs_torenvalk_strat %>% 
    filter(naam == "Torenvalk", regio == reg) %>%
    ggplot() +
      geom_jitter(aes(x = as.factor(jaar), y = relfreq, colour = stratum,
                     shape = periode_in_jaar),
                  width = 0.1) +
      labs(title = "Torenvalk", 
           y = "Relatieve frequentie", 
           x = "") +
      expand_limits(y = 1) +
      facet_wrap(~regio)
    )
}
```


## Oppervlakte beheerovereenkomsten


```{r bo-2021}
bo_2021 <- read_sf(
  here("data/bo_vlm/BO_2021_VLM_EXTERN.shp")) %>%
  janitor::clean_names() %>%
  mutate(start = lubridate::ymd(start),
         stop = lubridate::ymd(stop)) %>%
  st_transform(crs = 31370)
```

```{r opp-bo-data}
bo_dm_ol <- bo_2021 %>%
  st_intersection(y = perimeters)

openheid <- rast(here("data", "dem",
    "openness300m_chm_res25_c300_mean_vlaanderen_classified.tif")) %>%
  mask(perimeters %>% st_buffer(dist = 50)) %>%
  as.polygons() %>%
  st_as_sf() %>%
  mutate(openheid = factor(focal_sum, labels = c("GL", "HGL", "HOL", "OL")))

#mapview::mapview(openheid, zcol = "openheid")
binnen_sbp <- perimeters %>%
  st_intersection(sbp_akkervogels) %>%
  select(Naam) %>%
  mutate(opp = st_area(.),
         is_sbp = "binnen sbp")

buiten_sbp <- perimeters %>%
  st_difference(sbp_akkervogels %>%
                  st_union() %>%
                  st_combine()) %>%
  select(Naam) %>%
  mutate(opp = st_area(.),
         is_sbp = "buiten sbp")

sbp_sf <- bind_rows(buiten_sbp, binnen_sbp)

regio_sbp_openheid <- sbp_sf %>%
  select(regio = Naam, is_sbp) %>%
  st_intersection(openheid %>%
             select(openheid))

opp_evolutie <- bo_dm_ol %>%
  filter(eenheid == "Hectare") %>%
  select(bh_doelst, srt_object, bhpakket, start, stop) %>%
  st_intersection(regio_sbp_openheid) %>%
  mutate(opp = st_area(.)) %>%
  st_drop_geometry()
```

De volgende figuur geeft de cumulatieve oppervlakte aan afgesloten beheerovereenkomsten voor de verschillende soortbeschermingsmaatregelen over de jaren en opgesplitst per stratum.
Deze cijfers gelden voor het volledige projectgebied van de Moeren en de Oostelijke leemstreek zoals gedefinieerd in het MAS pilootproject.
De data voor 2022 zitten hier nog niet bij.

```{r opp-bo-evolutie}
library(units)
opp_evolutie %>%
  expand_grid(jaar = ymd(paste0(2017:2021, "-02-02"))) %>%
  mutate(opp2 = case_when(
    jaar < start ~ 0,
    jaar %within% interval(start, stop) ~ as.numeric(opp),
    jaar > stop ~ -as.numeric(opp)
  )) %>%
  filter(bh_doelst == "soortenbescherming (SB)",
         openheid %in% c("HOL", "OL")) %>%
  group_by(bh_doelst, srt_object, regio, is_sbp, openheid, jaar) %>%
  summarize(tot_opp_ha = sum(opp2) / 1e4) %>%
  ggplot() +
  geom_bar(aes(x = jaar, weight = tot_opp_ha,
               fill = srt_object)) +
  facet_grid(regio ~ openheid + is_sbp, scales = "free") +
  labs(y = "Oppervlakte (Hectare)")
```


## Dichtheden (aantal per 100ha)

> dichtheden herberekend aantal broedpaar per 100ha (internationale maat, en ook beschreven als doelen bij soortbeschermingsplan akkervogels), zodat we die kunnen vergelijken gemiddeld voor de moeren en de leemstreek.  

### Algemeen

Zijn de dichtheden in de Moeren opvallend hoger/lager dan in de leemstreek? __echter zonder rekening te houden met koppels, territoria of detectiekansen__.

```{r dichtheden}
meanabu <- mas_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, periode_in_jaar, naam) %>%
  summarize(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  group_by(jaar, periode_in_jaar, regio) %>%
  summarise(across(.cols = where(~ is.integer(.x) && min(.x) == 0),
                   .fns = ~sum(.x) / n() * (100 * 1e4) / (pi * 300^2)),
            .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "aantal_per_100ha")
```

Overzicht van de 30 meest abundante soorten in een bepaalde regio. Elk punt staat voor een aantal per 100 ha in een bepaald jaar en een bepaalde telperiode van dat jaar.

```{r}
meanabu %>%
  mutate(naam = reorder(naam, aantal_per_100ha, FUN = "mean")) %>%
  filter(as.numeric(naam) > length(unique(naam)) - 30) %>%
  ggplot() +
    labs(y = "", x = "aantal_per_100ha") +
    geom_point(aes(x = aantal_per_100ha, y = naam, colour = regio))
```

Zonder spreeuw:

```{r, warning=FALSE}
meanabu %>%
  mutate(naam = reorder(naam, aantal_per_100ha, FUN = "mean")) %>%
  filter(as.numeric(naam) > length(unique(naam)) - 30) %>%
  mutate(aantal_per_100ha = replace(aantal_per_100ha, 
                                    naam == "Spreeuw", NA)) %>%
  ggplot() +
    labs(y = "", x = "aantal_per_100ha") +
    geom_point(aes(x = aantal_per_100ha, y = naam, colour = regio))
```

> Opgepast! In de volgende tabellen wordt de gemiddelde densiteit berekend door een gemiddelde te nemen over de telperiodes en over de jaren (per regio en per soort). Het is mogelijks niet correct een ongewogen gemiddelde te nemen over de jaren heen. Dit moet verder uitgezocht worden. Over de telperiodes is op zich wel correct want dit zijn replicaten.

Top 20 van soorten die in termen van verschil in gemiddelde aantallen meer abundant zijn in __de Moeren__ (aantallen per 100 ha):

```{r meerabundant-moeren}
meanabu %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_aantal_per_100ha = mean(aantal_per_100ha)) %>%
  distinct(regio, naam, gemiddelde_aantal_per_100ha) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_aantal_per_100ha,
              values_fill = 0) %>%
  mutate(verschil = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  slice_max(verschil, n = 20) %>%
  select(-Bilzen) %>%
  kable(digits = 2)
```

Top 20 van soorten die in termen van verschil in gemiddelde aantallen meer abundant zijn in __de Leemstreek__:

```{r meerabundant-leemstreek}
meanabu %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_aantal_per_100ha = mean(aantal_per_100ha)) %>%
  distinct(regio, naam, gemiddelde_aantal_per_100ha) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_aantal_per_100ha,
              values_fill = 0) %>%
  mutate(verschil = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  slice_max(-verschil, n = 20) %>%
  select(-Bilzen) %>%
  kable(digits = 2)
```

### Doelsoorten

Enkel data met broedcode > 0 zijn weerhouden. De dichtheden zullen dus niet exact hetzelfde zijn als in **4.5.1**. Opgepast: verwarrend is dat het veld broedcode niet de broedcode bevat. Hiervoor moet je het veld `wrntype` hebben.

```{r dichtheden-doelsoorten}
meanabu_doel <- mas_vogels %>%
  filter(wrntype > 0L) %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, periode_in_jaar, naam) %>%
  summarize(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  group_by(jaar, periode_in_jaar, regio) %>%
  summarise(across(.cols = where(~ is.integer(.x) && min(.x) == 0),
                   .fns = ~sum(.x) / n() * (100 * 1e4) / (pi * 300^2)),
            .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "aantal_per_100ha")
```

> Opgepast! In de volgende tabellen wordt de gemiddelde densiteit berekend door een gemiddelde te nemen over de telperiodes en over de jaren (per regio en per soort). Het is mogelijks niet correct een ongewogen gemiddelde te nemen over de jaren heen. Dit moet verder uitgezocht worden. Over de telperiodes is op zich wel correct want dit zijn replicaten.

```{r tabel-doelsoorten}
meanabu_doel %>%
  filter(naam %in% doelsoorten) %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_aantal_per_100ha = mean(aantal_per_100ha)) %>%
  distinct(regio, naam, gemiddelde_aantal_per_100ha) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_aantal_per_100ha,
              values_fill = 0) %>%
  ungroup() %>%
  arrange(naam) %>%
  kable(digits = 2)
```

De volgende figuren tonen de dichtheden van de doelsoorten in een bepaalde telperiode voor de verschillende regio’s over de jaren.

```{r telperiode-doelsoorten-dichtheden, message=FALSE}
for (soort in doelsoorten) {
  print(
    meanabu_doel %>% 
    filter(naam == soort) %>%
    ggplot() +
      geom_point(aes(x = periode_in_jaar, y = aantal_per_100ha, colour = regio)) +
      labs(title = toString(soort), 
           y = "Aantal per 100 ha", 
           x = "Telperiode") +
      facet_wrap(~jaar)
    )
}
```

Telperiodes zijn herhalingen binnen een jaar en we zijn vooral geïnteresseerd in de wijzigingen van jaar tot jaar:

```{r telperiode-doelsoorten-dichtheden2, message=FALSE}
for (soort in doelsoorten) {
  print(
    meanabu_doel %>% 
    filter(naam == soort) %>%
    ggplot() +
      geom_jitter(aes(x = jaar, y = aantal_per_100ha, colour = regio, 
                     shape = periode_in_jaar),
                  width = 0.1) +
      labs(title = toString(soort), y = "Aantal per 100 ha", x = "")
    )
}
```

> We berekenen de relatieve frequenties apart binnen voor elke regio binnen elk stratum in elke telperiode in elk jaar. Deze resultaten kunnen niet zomaar uitgemiddeld worden om tot een gemiddelde over de strata en over de jaren te komen. Dit moet verder uitgezocht worden.

```{r diversiteit-doelsoorten-dichtheden-strat}
meanabu_doelvogels_strat <- mas_vogels %>% 
  filter(wrntype > 0L) %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, stratum, periode_in_jaar, naam) %>%
  summarize(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  group_by(jaar, periode_in_jaar, stratum, regio) %>%
  summarise(across(.cols = where(~ is.integer(.x) && min(.x) == 0),
                   .fns = ~sum(.x) / n() * (100 * 1e4) / (pi * 300^2)),
            .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "aantal_per_100ha")
```

```{r telperiode-doelsoorten-dichtheden-strat, message=FALSE}
for (soort in doelsoorten) {
  for (reg in unique(meanabu_doelvogels_strat$regio)) {
    print(
      meanabu_doelvogels_strat %>% 
      filter(naam == soort, regio == reg) %>%
      ggplot() +
        geom_jitter(aes(x = as.factor(jaar), y = aantal_per_100ha, 
                       colour = stratum, shape = periode_in_jaar),
                   width = 0.1) +
        labs(title = toString(soort), 
             y = "Aantal per 100 ha", 
             x = "") +
        facet_wrap(~regio, scales = "free_y")
      )
  }
}
```

Voor de Torenvalk wordt geen rekening gehouden met broedcodes. Alle waarnemingen zijn relevant o.w.v. terreingebruik. De densiteit is dus identiek als in **4.5.1**.

```{r tabel-torenvalk}
meanabu %>%
  filter(naam == "Torenvalk") %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_aantal_per_100ha = mean(aantal_per_100ha)) %>%
  distinct(regio, naam, gemiddelde_aantal_per_100ha) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_aantal_per_100ha,
              values_fill = 0) %>%
  ungroup() %>%
  arrange(naam) %>%
  kable(digits = 2)
```

De volgende figuur toont de dichtheden van de soort in een bepaalde telperiode voor de verschillende regio's over de jaren.

```{r telperiode-torenvalk-dichtheden, message=FALSE}
meanabu %>%
  filter(naam == "Torenvalk") %>%
  ggplot() +
    geom_point(aes(x = periode_in_jaar, y = aantal_per_100ha, colour = regio)) +
    labs(title = "Torenvalk", y = "Aantal per 100 ha", x = "Telperiode") +
    facet_wrap(~jaar)
```

Telperiodes zijn herhalingen binnen een jaar en we zijn vooral geïnteresseerd in de wijzigingen van jaar tot jaar:

```{r telperiode-torenvalk-dichtheden2, message=FALSE}
meanabu %>% 
filter(naam == "Torenvalk") %>%
ggplot() +
  geom_jitter(aes(x = jaar, y = aantal_per_100ha, colour = regio, 
                 shape = periode_in_jaar), 
              width = 0.1) +
  labs(title = "Torenvalk", y = "Aantal per 100 ha", x = "")
```

> We berekenen de relatieve frequenties apart binnen voor elke regio binnen elk stratum in elke telperiode in elk jaar. Deze resultaten kunnen niet zomaar uitgemiddeld worden om tot een gemiddelde over de strata en over de jaren te komen. Dit moet verder uitgezocht worden.

```{r diversiteit-torenvalk-dichtheden-strat}
meanabu_torenvalk_strat <- mas_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, stratum, periode_in_jaar, naam) %>%
  summarize(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  group_by(periode_in_jaar, jaar, regio, stratum) %>%
  summarise(across(.cols = where(~ is.integer(.x) && min(.x) == 0),
                   .fns = ~sum(.x) / n() * (100 * 1e4) / (pi * 300^2)),
            .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "aantal_per_100ha")
```

```{r telperiode-torenvalk-dichtheden-strat, message=FALSE}
for (reg in unique(diversiteit_vogels_strat$regio)) {
  print(
    meanabu_torenvalk_strat %>% 
    filter(naam == "Torenvalk", regio == reg) %>%
    ggplot() +
      geom_jitter(aes(x = as.factor(jaar), y = aantal_per_100ha, colour = stratum,
                     shape = periode_in_jaar),
                  width = 0.1) +
      labs(title = "Torenvalk", 
           y = "Aantal per 100 ha", 
           x = "") +
      facet_wrap(~regio, scales = "free_y")
    )
}
```
