---
title: "Verkenning MAS veldwerk data van 2018 tot en met 2022"
author: "Ward Langeraert, Hans Van Calster"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
renv::restore()
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE)
opts_knit$set(root.dir = here::here())
library(tidyverse)
library(sf)
library(lubridate)
```

# Inlezen data

```{r ronde-intervallen}
r1_start <- "04-01"
r1_stop <- "04-20"
r2_start <- "04-21"
r2_stop <- "05-10"
r3_start <- "05-11"
r3_stop <- "06-10"
r4_start <- "06-21"
r4_stop <- "07-15"
```

```{r inlezen-mas-data}
mas <- read_sf(
  here("data/mas/20220906_qgis_export_sovon_wfs.gpkg")) %>%
  mutate(
    datum = ymd(paste(jaar, maand, dag, sep = "-")),
    periode_in_jaar = case_when(
      datum %within% interval(
        ymd(paste(jaar, r1_start, sep = "-")),
        ymd(paste(jaar, r1_stop, sep = "-"))) ~ "R1",
      datum %within% interval(
        ymd(paste(jaar, r2_start, sep = "-")),
        ymd(paste(jaar, r2_stop, sep = "-"))) ~ "R2",
      datum %within% interval(
        ymd(paste(jaar, r3_start, sep = "-")),
        ymd(paste(jaar, r3_stop, sep = "-"))) ~ "R3",
      datum %within% interval(
        ymd(paste(jaar, r4_start, sep = "-")),
        ymd(paste(jaar, r4_stop, sep = "-"))) ~ "R4"
    ))
```

```{r design}
design2022 <- read_csv(here(
    "data",
    "processed",
    "steekproef_piloot_avimap.csv")) %>%
  select(plotnaam = definitief_punt,
         regio,
         stratum) %>%
  mutate(openheid = ifelse(grepl("HOL", stratum), "HOL", "OL"),
         sbp = ifelse(grepl("binnen", stratum), "binnen", "buiten"))
```

```{r overzicht-data, eval=FALSE}
head(mas)
summary(mas)
glimpse(mas)
```

Dubbeltellingen zijn eruit (soort gezien op meerdere teldagen binnen eenzelfde telperiode): in dat geval de laatste teldag genomen.

```{r check-dubbeltelling}
dubbels <- mas %>%
  st_drop_geometry() %>%
  group_by(plotid, jaar, periode_in_jaar, soortnr) %>%
  summarize(aantal_teldagen = n_distinct(doy),
            .groups = "drop") %>%
  filter(aantal_teldagen > 1)
# kan zowel zelfde waarnemer als andere waarnemer zijn

mas_clean <- mas %>%
  semi_join(dubbels, by = c("plotid", "jaar", "periode_in_jaar")) %>%
  group_by(plotid, jaar, periode_in_jaar) %>%
  filter(doy == max(doy)) %>%
  ungroup() %>%
  bind_rows(mas %>%
              anti_join(dubbels, by = c("plotid", "jaar", "periode_in_jaar")))
```


# Resultaten vogels 2022

```{r selectie-vogels}
mas2022 <- mas_clean %>% 
  filter(soortgrp == 2,                # vogels
         jaar == 2022,                 # 2022
         !is.na(periode_in_jaar)       # binnen telronde
         ) %>%  # Moeren en Leemstreek
  inner_join(design2022, by = "plotnaam")

# To detect absences
bezoekenlijst_2022 <- design2022 %>% 
  expand_grid(distinct(mas2022, periode_in_jaar))
```

Selectie van vogelsoorten waargenomen in 2022. Waarnemingen buiten officiële telrondes en buiten De Moeren en de Leemstreek zijn eruit gehaald.


## Enkele cijfers

```{r tabel-vogels}
mas2022 %>% group_by(regio, openheid, sbp) %>%
  st_drop_geometry() %>%
  summarise(aantal_tellingen = n_distinct(oid), 
            aantal_plots = n_distinct(plotid), 
            aantal_soorten = n_distinct(naam)) %>%
  kable()

mas2022 <- mas2022 %>% 
  group_by(regio) %>%
  mutate(plots_per_regio = n_distinct(plotid),
         stratum = gsub("L\\s{1}", "L\\\n", stratum))
```


## Soortendiversiteit

Is de soortendiversiteit in De Moeren hoger dan in de leemstreek?

```{r soortendiversiteit}
diversiteit <- mas2022 %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, openheid, sbp, stratum, periode_in_jaar, naam) %>%
  summarize(totaal_aantal = sum(aantal),
            .groups = "drop_last") %>%
  summarize(aantal_soorten = n(),
            .groups = "drop")
```

```{r soortenaantal-boxplot}
diversiteit %>%
  ggplot() +
  geom_boxplot(aes(x = stratum, y = aantal_soorten,
                   fill = periode_in_jaar)) +
  facet_wrap(~regio, scales = "free_x") +
  labs(y = "Aantal soorten", x = "Stratum", fill = "Telperipode")
```

Om welke soorten gaat het?

```{r relfreqs-vogels}
relfreqs <- mas2022 %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, periode_in_jaar, naam) %>%
  summarize(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  group_by(periode_in_jaar, regio) %>%
  summarise(across(.cols = where(~ is.integer(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
                   .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")
```

Overzicht van relatieve frequenties van de 30 meest frequente soorten in een bepaalde regio. Elk punt staat voor een relatieve frequentie in een bepaalde telperiode van 2022.

```{r soortenfreqs-vogels, fig.height = 200/25.4}
relfreqs %>%
  mutate(naam = reorder(naam, relfreq, FUN = "mean")) %>%
  filter(as.numeric(naam) > length(unique(naam)) - 30) %>%
  ggplot() +
  labs(y = "", x = "Relatieve frequentie") +
  geom_point(aes(x = relfreq, y = naam, colour = regio))
```

Top 20 van soorten die in termen van verschil in gemiddelde relatieve frequentie van voorkomen meer voorkomen in __De Moeren__:

```{r meerfrequent-moeren}
relfreqs %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  slice_max(verschilfreq, n = 20) %>%
  kable(digits = 2)
```

Top 20 van soorten die in termen van verschil in gemiddelde relatieve frequentie van voorkomen meer voorkomen in __de Leemstreek__:

```{r meerfrequent-leemstreek}
relfreqs %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  slice_max(-verschilfreq, n = 20) %>%
  kable(digits = 2)
```


## Doelsoorten

```{r selectie-doelsoorten}
doelsoorten <- c("Veldleeuwerik", "Gele Kwikstaart", "Geelgors", "Fazant")
doel_df <- mas2022 %>% filter(naam %in% doelsoorten, wrntype > 0L) 
```

Enkel data met broedcode > 0 zijn weerhouden. De relatieve frequenties zullen dus niet exact hetzelfde zijn als in **2.2**. Opgepast: verwarrend is dat het veld broedcode niet de broedcode bevat. Hiervoor moet je het veld `wrntype` hebben.

```{r diversiteit-doelsoorten}
relfreqs_doel <- doel_df %>% 
  st_drop_geometry() %>%
  group_by(regio, plotnaam, stratum, openheid, sbp, periode_in_jaar, naam) %>%
  summarize(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  group_by(periode_in_jaar, regio, stratum, openheid, sbp) %>%
  summarise(across(.cols = where(~ is.integer(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
                   .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")

relfreqs_doel %>%
  group_by(regio, stratum, openheid, sbp, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, stratum, openheid, sbp, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  group_by(stratum, openheid, sbp) %>%
  arrange(naam) %>%
  select(-stratum) %>%
  kable(digits = 2)
```

De volgende figuur geeft een overzicht van de genoteerde broedcodes per regio voor elke soort. Een telling is hier geïnterpreteerd als een waarneming van een bepaalde soort op een bepaalde afstand in een bepaalde plot in een bepaalde telperiode. Er is dus geen rekening gehouden met het aantal vogels genoteerd per telling. De tellingen zijn hoger in de Leemstreek maar daar waren ook meer plots. Deze figuur geeft dus enkel de absolute aantallen weer. 

```{r broedcodes-doelsoorten, message=FALSE}
# Save totals to put labels on plot
totals <- doel_df %>%
    st_drop_geometry() %>%
    group_by(naam, stratum, regio) %>%
    summarise(total = n())

# Summarize data and make plot
doel_df %>% 
  st_drop_geometry() %>%
  mutate(wrntype_omschrijving2 = paste(wrntype, wrntype_omschrijving, 
                                       sep = ": ")) %>%
  group_by(naam, stratum, regio, wrntype_omschrijving2) %>%
  summarise(N = n()) %>%
  ggplot(aes(x = stratum, y = N, fill = wrntype_omschrijving2)) +
    geom_bar(stat = "identity", colour = "black") +
    geom_text(data = totals, aes(x = stratum, y = total + c(rep(30, 6), rep(125, 2)),
              label = total, fill = NULL)) +
    labs(y = "Aantal tellingen", x = "") +
    guides(fill = guide_legend(title = "broedcode")) +
    facet_grid(naam~regio, scales = "free") 
```

De volgende figuur toont de relatieve frequentie van de doelsoorten in een bepaalde telperiode voor de verschillende regio's. 

```{r telperiode-doelsoorten, message=FALSE}
relfreqs_doel %>%
  filter(naam %in% doelsoorten) %>%
  ggplot() +
    labs(y = "Relatieve frequentie", x = "Telperiode") +
    geom_point(aes(x = periode_in_jaar, y = relfreq, colour = regio)) +
    facet_wrap(~naam) +
    scale_y_continuous(limits = c(0, 1))
```

Relatief aantal tellingen waarbij het aantal tellingen in de verschillende regio's is gedeeld door het aantal plots in die regio (zie hoger). De curve is een loess smoother.

```{r datum-doelsoorten, message=FALSE}
# Summarize data to plot
plots_per_regio_merge <- mas2022 %>%
  st_drop_geometry() %>%
  select(regio, plots_per_regio) %>%
  distinct()
summary_doel <- doel_df %>%
  st_drop_geometry() %>%
  group_by(naam, regio, datum) %>% 
  summarise(N = n())  %>% 
  left_join(plots_per_regio_merge, by = "regio") %>%
  ungroup() %>%
  mutate(relatief_aantal = N / plots_per_regio)

# Summarize data to make loess smoother
subset_loess <- summary_doel %>%
  filter(!(naam == "Geelgors" & regio == "De Moeren"))

# Create plot
ggplot() +
  labs(y = "Aantal tellingen / aantal plots", x = "") +
  geom_point(data = summary_doel, aes(x = datum, y = relatief_aantal, colour = regio)) +
  geom_smooth(data = subset_loess, aes(x = datum, y = relatief_aantal, colour = regio),
              method = "loess", formula = "y ~ x", se = FALSE) +
  facet_wrap(~naam, scales = "free_y")
```

Voor de Torenvalk wordt geen rekening gehouden met broedcodes. Alle waarnemingen zijn relevant o.w.v. terreingebruik. De relatieve frequentie is dus identiek als in **2.2**.

```{r freq-torenvalk}
relfreqs %>%
  filter(naam == "Torenvalk") %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  kable(digits = 2)
```

De volgende figuren tonen hoeveel keer de soort is gezien in een bepaalde telperiode en per dag voor de verschillende regio's. De curve is een loess smoother. De tellingen zijn hoger in de Leemstreek maar daar waren ook meer plots. Deze figuren geven enkel de absolute aantallen weer.

```{r telperiode-torenvalk, message=FALSE}
relfreqs %>%
  filter(naam == "Torenvalk") %>%
  ggplot() +
    labs(y = "Relatieve frequentie", x = "Telperiode") +
    geom_point(aes(x = periode_in_jaar, y = relfreq, colour = regio)) +
    scale_y_continuous(limits = c(0, 1))
```

```{r datum-torenvalk, message=FALSE}
mas2022 %>%
  st_drop_geometry() %>% 
  filter(naam == "Torenvalk") %>%
  group_by(naam, regio, datum) %>% 
  summarise(N = n()) %>% 
  left_join(plots_per_regio_merge, by = "regio") %>%
  ungroup() %>%
  mutate(relatief_aantal = N / plots_per_regio) %>%
  ggplot() +
    labs(title = "Torenvalk", y = "Aantal tellingen / aantal plots", x = "") +
    geom_point(aes(x = datum, y = relatief_aantal, colour = regio)) +
    geom_smooth(aes(x = datum, y = relatief_aantal, colour = regio),
                method = "loess", formula = "y ~ x", se = FALSE)
```


# Resultaten zoogdieren 2022

```{r selectie-zoogdieren}
zoogdieren <- mas_clean %>% 
  filter(soortgrp == 1,                # zoogdieren
         jaar == 2022,                 # 2022
         !is.na(periode_in_jaar)       # binnen telronde
         ) %>%  # Moeren en Leemstreek
  inner_join(design2022, by = "plotnaam")
```

Selectie van zoogdieren waargenomen in 2022. Waarnemingen buiten officiële telrondes en buiten De Moeren en de Leemstreek zijn eruit gehaald.

## Enkele cijfers

```{r tabel-zoogdieren}
zoogdieren %>% group_by(regio) %>%
  st_drop_geometry() %>%
  summarise(aantal_tellingen = n_distinct(oid), 
            aantal_plots = n_distinct(plotid), 
            aantal_soorten = n_distinct(naam)) %>%
  kable()
```


## Soortendiversiteit

```{r relfreqs-zoogdieren}
relfreqs_z <- zoogdieren %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, periode_in_jaar, naam) %>%
  summarize(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  group_by(periode_in_jaar, regio) %>%
  summarise(across(.cols = where(~ is.integer(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
                   .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")
```

Overzicht van relatieve frequenties van de zoogdieren in een bepaalde regio. Elk punt staat voor een relatieve frequentie in een bepaalde telperiode van 2022. De frequenties zijn relatief ten opzichte van de andere zoogdieren. Als er een zoogdier wordt gezien, is dit vaak de Haas.

```{r soortenfreqs-zoogdieren}
relfreqs_z %>%
  mutate(naam = reorder(naam, relfreq, FUN = "mean")) %>%
  ggplot() +
  labs(y = "", x = "Relatieve frequentie") +
  geom_point(aes(x = relfreq, y = naam, colour = regio))
```

```{r freqtable-zoogdieren}
relfreqs_z %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  # Same order as in the previous plot
  rowwise() %>%
  mutate(max = max(`De Moeren`, `Oostelijke leemstreek`)) %>%
  arrange(desc(max)) %>% select(-max) %>%
  kable(digits = 3)
```


# Resultaten vogels 2018--2022

```{r selectie-vogels-langetermijn}
mas_vogels <- mas_clean %>% 
  filter(soortgrp == 2,                # vogels
         !is.na(periode_in_jaar)       # binnen telronde
         ) %>%  # Moeren en Leemstreek
  inner_join(design2022, by = "plotnaam")
```

Selectie van vogelsoorten. Waarnemingen buiten officiële telrondes en buiten De Moeren en de Leemstreek zijn eruit gehaald.


## Enkele cijfers

```{r tabel-langetermijn, message=FALSE}
mas_vogels %>% group_by(regio, jaar) %>%
  st_drop_geometry() %>%
  summarise(aantal_tellingen = n_distinct(oid), 
            aantal_plots = n_distinct(plotid), 
            aantal_soorten = n_distinct(naam)) %>%
  kable()
```

```{r aantal-plots}
for (reg in unique(mas_vogels$regio)) {
  print(mas_vogels %>% 
    filter(regio == reg) %>%
    group_by(jaar) %>%
    st_drop_geometry() %>%
    summarise(aantal_tellingen = n_distinct(oid), 
              aantal_plots = n_distinct(plotid), 
              aantal_soorten = n_distinct(naam)) %>%
    pivot_longer(cols = c(aantal_tellingen, aantal_plots),
                 names_to = "legende",
                 values_to = "Aantal") %>%
    ggplot() +
      geom_point(aes(x = jaar, y = Aantal, colour = legende)) +
      labs(title = as.character(reg)))
}
```


## Soortendiversiteit

Is de soortendiversiteit in De Moeren hoger dan in de leemstreek?

```{r soortendiversiteit-langetermijn}
diversiteit_vogels <- mas_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, periode_in_jaar, naam) %>%
  summarize(totaal_aantal = sum(aantal),
            .groups = "drop_last") %>%
  summarize(aantal_soorten = n(),
            .groups = "drop")
```

```{r soortenaantal-boxplot-langetermijn}
diversiteit_vogels %>%
  ggplot() +
  labs(y = "Aantal soorten", x = "Telperiode") +
  geom_boxplot(aes(x = periode_in_jaar, y = aantal_soorten, fill = regio)) +
  facet_wrap(~jaar)
```

Om welke soorten gaat het?

```{r relfreqs-langetermijn}
relfreqs_vogels <- mas_vogels %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, periode_in_jaar, naam) %>%
  summarize(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  group_by(jaar, periode_in_jaar, regio) %>%
  summarise(across(.cols = where(~ is.integer(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
                   .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")
```

Overzicht van relatieve frequenties van de 30 meest frequente soorten in een bepaalde regio. Elk punt staat voor een relatieve frequentie in een bepaald jaar en een bepaalde telperiode van dat jaar.

```{r soortenfreqs-langetermijn, fig.height = 200/25.4}
relfreqs_vogels %>%
  mutate(naam = reorder(naam, relfreq, FUN = "mean")) %>%
  filter(as.numeric(naam) > length(unique(naam)) - 30) %>%
  ggplot() +
  labs(y = "", x = "Relatieve frequentie") +
  geom_point(aes(x = relfreq, y = naam, colour = regio))
```

Top 20 van soorten die in termen van verschil in gemiddelde relatieve frequentie van voorkomen meer voorkomen in __De Moeren__:

```{r meerfrequent-moeren-langetermijn}
relfreqs_vogels %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  slice_max(verschilfreq, n = 20) %>%
  kable(digits = 2)
```

Top 20 van soorten die in termen van verschil in gemiddelde relatieve frequentie van voorkomen meer voorkomen in __de Leemstreek__:

```{r meerfrequent-leemstreek-langetermijn}
relfreqs_vogels %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  slice_max(-verschilfreq, n = 20) %>%
  kable(digits = 2)
```


## Doelsoorten

```{r selectie-doelsoorten-langetermijn}
doel_vogels <- mas_vogels %>% filter(naam %in% doelsoorten, wrntype > 0L) 
```

Enkel data met broedcode > 0 zijn weerhouden. De relatieve frequenties zullen dus niet exact hetzelfde zijn als in **4.2**. Opgepast: verwarrend is dat het veld broedcode niet de broedcode bevat. Hiervoor moet je het veld `wrntype` hebben.

```{r diversiteit-doelsoorten-langetermijn}
relfreqs_doelvogels <- mas_vogels %>% 
  filter(wrntype > 0L) %>%
  st_drop_geometry() %>%
  group_by(regio, plotnaam, jaar, periode_in_jaar, naam) %>%
  summarize(totaal_aantal = sum(aantal),
            .groups = "drop") %>%
  pivot_wider(names_from = naam,
              values_from = totaal_aantal,
              values_fill = list(totaal_aantal = 0)) %>%
  group_by(jaar, periode_in_jaar, regio) %>%
  summarise(across(.cols = where(~ is.integer(.x) && min(.x) == 0),
                   .fns = ~sum(.x > 0) / n()),
                   .groups = "drop") %>%
  pivot_longer(cols = where(is.double),
               names_to = "naam",
               values_to = "relfreq")

relfreqs_doelvogels %>%
  filter(naam %in% doelsoorten) %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  arrange(naam) %>%
  kable(digits = 2)
```

De volgende figuren tonen hoeveel keer een soort is gezien in een bepaalde telperiode en per dag voor de verschillende regio's. De curve is een loess smoother. De tellingen zijn hoger in de Leemstreek maar daar waren ook meer plots. Deze figuren geven enkel de absolute aantallen weer.

```{r telperiode-doelsoorten-langetermijn, message=FALSE}
tel_df <- doel_vogels %>%
  group_by(naam, regio, jaar, periode_in_jaar) %>% 
  summarise(N = n())

for (soort in doelsoorten) {
  print(tel_df %>% filter(naam == soort) %>%
  ggplot() +
  labs(title = toString(soort), y = "Aantal tellingen", x = "Telperiode") +
  geom_point(aes(x = periode_in_jaar, y = N, colour = regio)) +
  facet_wrap(~jaar, scales = "free_y"))
}
```

```{r datum-doelsoorten-langetermijn, message=FALSE}
# Summarize data to plot
summary_doelvogels <- doel_vogels %>%
  st_drop_geometry() %>%
  group_by(naam, regio, jaar, datum) %>% 
  summarise(N = n())

# Create plot
for (soort in doelsoorten) {
  
  # Not enough data to make loess smoother for Geelgors
  if (soort == "Geelgors") {
    subset_loess2 <- summary_doelvogels %>%
                     filter(naam == soort,
                            regio != "De Moeren")
    print(summary_doelvogels %>% filter(naam == soort) %>%
    ggplot() +
    geom_point(aes(x = datum, y = N, colour = regio)) +
    geom_smooth(data = subset_loess2, aes(x = datum, y = N, colour = regio),
                method = "loess", formula = "y ~ x", se = FALSE) +
    labs(title = toString(soort), y = "Aantal tellingen", x = "") +
    facet_wrap(~jaar, scales = "free"))
    
  } else {
    print(summary_doelvogels %>% filter(naam == soort) %>%
    ggplot() +
    geom_point(aes(x = datum, y = N, colour = regio)) +
    geom_smooth(aes(x = datum, y = N, colour = regio),
                method = "loess", formula = "y ~ x", se = FALSE) +
    labs(title = toString(soort), y = "Aantal tellingen", x = "") +
    facet_wrap(~jaar, scales = "free"))
  }
}
```

Voor de Torenvalk wordt geen rekening gehouden met broedcodes. Alle waarnemingen zijn relevant o.w.v. terreingebruik. De relatieve frequentie is dus identiek als in **2.2**.

```{r freq-torenvalk-langetermijn}
relfreqs_vogels %>%
  filter(naam == "Torenvalk") %>%
  group_by(regio, naam) %>%
  mutate(gemiddelde_freq = mean(relfreq)) %>%
  distinct(regio, naam, gemiddelde_freq) %>%
  pivot_wider(names_from = regio,
              values_from = gemiddelde_freq,
              values_fill = 0) %>%
  mutate(verschilfreq = `De Moeren` - `Oostelijke leemstreek`) %>%
  ungroup() %>%
  arrange(naam) %>%
  kable(digits = 2)
```

De volgende figuren tonen hoeveel keer de soort is gezien in een bepaalde telperiode en per dag voor de verschillende regio's. De curve is een loess smoother. De tellingen zijn hoger in de Leemstreek maar daar waren ook meer plots. Deze figuren geven enkel de absolute aantallen weer.

```{r telperiode-torenvalk-langetermijn, message=FALSE}
mas_vogels %>% filter(naam == "Torenvalk") %>%
  group_by(regio, jaar, periode_in_jaar) %>% 
  summarise(N = n()) %>%
  ggplot() +
  labs(title = "Torenvalk", y = "Aantal tellingen", x = "Telperiode") +
  geom_point(aes(x = periode_in_jaar, y = N, colour = regio)) +
  facet_wrap(~jaar, scales = "free_y")
```

```{r datum-torenvalk-langetermijn, message=FALSE}
summary_torenvalk <- mas_vogels %>% 
  filter(naam == "Torenvalk") %>%
  group_by(regio, jaar, datum) %>% 
  summarise(N = n())

# Not enough data to make loess smoother for each year
subset_loess3 <- summary_torenvalk %>% 
  filter(!(jaar %in% c(2018, 2019, 2020) & regio == "De Moeren"))

ggplot() +
  labs(title = "Torenvalk", y = "Aantal tellingen", x = "") +
  geom_point(data = summary_torenvalk, aes(x = datum, y = N, colour = regio)) +
  geom_smooth(data = subset_loess3, aes(x = datum, y = N, colour = regio),
              method = "loess", formula = "y ~ x", se = FALSE) +
  facet_wrap(~jaar, scales = "free")
```
