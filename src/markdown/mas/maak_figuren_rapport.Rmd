---
title: "Maak figuren voor rapport"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
renv::restore()

# Set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE)
opts_knit$set(root.dir = here::here())

# Packages
library(tidyverse)
library(INBOtheme)
library(gridExtra)
library(Distance)
library(targets)
library(sf)
library(GVI)
library(inbospatial)
library(terra)

conflicted::conflicts_prefer(dplyr::filter)
theme_set(theme_inbo(transparent = TRUE))

# Source
dir.create("media", FALSE)
media_folder <- here("media")

source(here("src", "R", "plot_detection_curve.R"))
source(here("src", "R", "create_figures.R"))
source(here("src", "R", "sim.pdata.R"))

targets_store <- here("src", "targets", "mas_steekproef_pilootfase", "_targets")
mbag_dir <- here()

new_tar_vector <- function(value, objects) {
    out <- do.call(vctrs::vec_rbind, objects)
    if (any(sapply(out, inherits, what = "sfc"))) {
      sf::st_as_sf(out)
    } else {out}
}
try(assignInNamespace(
  "value_produce_aggregate.tar_vector",
  new_tar_vector,
  ns = "targets"))
```


# Distance sampling

```{r}
dir.create("media/distance", FALSE)
out_folder_distance <- here("media/distance")
dsmodel_path <- here("src/markdown/mas/distance_models")
```

## Methodes

Punttransect.

```{r}
circle_fun <- function(center = c(0, 0), diameter = 600, npoints = 100) {
    r <- diameter / 2
    tt <- seq(0, 2 * pi, length.out = npoints)
    xx <- center[1] + r * cos(tt)
    yy <- center[2] + r * sin(tt)
    return(data.frame(x = xx, y = yy))
}

p1 <- ggplot(data = circle_fun()) +
    geom_segment(aes(x = 0, y = 0, xend = 300, yend = 0)) +
    geom_text(aes(x = 150, y = 0, label = "w"), nudge_y = 25) +
    geom_segment(aes(x = 0, y = 0, xend = -100, yend = 200)) +
    geom_point(aes(x = -100, y = 200), shape = "\U1F986", size = 10) +
    geom_text(aes(x = -50, y = 100), label = "r[i]", nudge_y = 20,
              nudge_x = 20, parse = TRUE) +
    geom_path(aes(x, y), colour = "red") + 
    geom_point(aes(x = 0, y = 0), colour = "red", size = 2) +
    labs(x = "", y = "") +
    coord_fixed() +
    theme_void()
```

Detectiefunctie:

```{r}
set.seed(1234)
dist_data <- sim.pdata(N = 1000, sigma = 120, B = 300)

# Fit model
ds_model <- ds(dist_data$d, key = "hn", truncation = 300, transect = "point", 
               dht_group = FALSE, convert_units = conversion_factor)

# Plot detection curve
p2 <- plot_detection_curve(ds_model, show_data = FALSE) +
    geom_rect(aes(xmin = 0, xmax = 300, ymin = 0, ymax = 1),
              colour = "red", fill = alpha("white", 0)) +
    geom_text(aes(x = 150, y = 0.6),
              label = expression(italic("g(r;"*theta*")")))
```

```{r}
p_dist_methode <- cowplot::plot_grid(p1, p2, nrow = 1, labels = c("A.", "B."),
                                     rel_widths = c(1.5, 2))

ggsave(here(out_folder_distance, "methode_distance.jpg"),
       p_dist_methode,
       dpi = 300,
       width = 8,
       height = 4)
```


## Per jaar

```{r}
dir.create("media/distance/per_jaar", FALSE)
dsmodels_per_jaar <- readRDS(here(dsmodel_path, "models_2018_2023.rds"))
```

### Strata oppervlakte

```{r}
# Lees steekproefkader in
steekproefkader <- tar_read(steekproefkader_finaal, store = targets_store)

# Selectie en buffer
perimeters_strata <- steekproefkader %>%
  filter(openheid_klasse %in% c("HOL", "OL"),
         !(Naam == "De Moeren" & openheid_klasse == "HOL")) %>%
  st_buffer(dist = 300) %>%
  group_by(Naam) %>%
  summarise(geometry = st_union(geometry)) %>%
  ungroup()

# Visualisatie
p_moeren <- perimeters_strata %>%
  filter(Naam == "De Moeren") %>%
  ggplot() +
    geom_sf() +
    facet_grid(~Naam)

p_leemstreek <- perimeters_strata %>%
  filter(Naam == "Oostelijke leemstreek") %>%
  ggplot() +
    geom_sf() +
    facet_grid(~Naam)

# Bereken oppervlaktes van de regio's
areas <- perimeters_strata %>% 
  mutate(Area = as.numeric(st_area(geometry)) / 1e6) %>%
  select(regio = Naam, Area) %>%
  st_drop_geometry()
table_area <- areas %>%
  rename(`oppervlakte (kmÂ²)` = Area) %>%
  tableGrob(rows = NULL)

# Plot
p <- grid.arrange(p_moeren, p_leemstreek, table_area, 
                  layout_matrix = rbind(c(1, 2), c(1, 3)))

ggsave(here(out_folder_distance, "per_jaar", "oppervlakte_strata.jpg"),
       p,
       dpi = 300,
       width = 8,
       height = 6)
```


### Densiteitschattingen

```{r}
for (spec in names(dsmodels_per_jaar)) {
  file <- paste0("densiteit_per_jaar_", tolower(spec), ".jpg")
  ds_model <- dsmodels_per_jaar[[spec]]
  p <- plot_densiteit(ds_model, spec, show_data = FALSE) +
    ggtitle("")
  
  ggsave(here(out_folder_distance, "per_jaar", file),
         p,
         dpi = 300,
         width = 8,
         height = 6)
}
```

```{r}
df_obs_list <- readRDS(here("output", "results", "distance_sampling",
                            "df_obs_list.rds"))
design_2018_2023_mas <- readRDS(file.path("output", "results",
                                          "distance_sampling",
                                          "design_2018_2023_mas.rds"))

for (spec in names(dsmodels_per_jaar)) {
  file <- paste0("densiteit_per_jaar_", tolower(spec), "_data", ".jpg")
  ds_model <- dsmodels_per_jaar[[spec]]
  p <- plot_densiteit(ds_model, spec, show_data = TRUE,
                      design = design_2018_2023_mas,
                      obs_df = df_obs_list[[spec]])
  
  ggsave(here(out_folder_distance, "per_jaar", file),
         p,
         dpi = 300,
         width = 8,
         height = 6)
}
```


### Detectiekans

```{r}
spec <- "Veldleeuwerik"
file <- paste0("detectiekans_per_jaar_simple_", tolower(spec), ".jpg")
ds_model <- dsmodels_per_jaar[[spec]]
p <- plot_detection_curve(ds_model)

ggsave(here(out_folder_distance, "per_jaar", file),
       p,
       dpi = 300,
       width = 8,
       height = 6)
```

```{r}
p1 <- plot_detection_curve(dsmodels_per_jaar[["Kneu"]]) +
  ggtitle("Kneu")

p2 <- plot_detection_curve(dsmodels_per_jaar[["Kievit"]]) +
  labs(title = "Kievit",
       y = "")

ymax_lim <- max(max(p1$plot_env$hist_df$counts),
                    max(p2$plot_env$hist_df$counts),
                    1)
p1 <- p1 +
  scale_y_continuous(limits = c(0, ymax_lim),
                     breaks = seq(0, 100, by = 0.25))
p2 <- p2 +
  scale_y_continuous(limits = c(0, ymax_lim),
                     breaks = seq(0, 100, by = 0.25))

p <- grid.arrange(p1, p2, ncol = 2)

ggsave(here(out_folder_distance, "per_jaar",
            "detectiekans_per_jaar_vergelijking.jpg"),
         p,
         dpi = 300,
         width = 10,
         height = 6)
```


```{r}
for (i in seq_along(dsmodels_per_jaar)) {
  spec <- names(dsmodels_per_jaar)[i]
  file <- paste0("detectiekans_per_jaar_", tolower(spec), ".jpg")
  ds_model <- dsmodels_per_jaar[[spec]] 
  variables <- names(ds_model$ddf$ds$aux$ddfobj$scale$parameters)
  
  if (any(grepl("regio", variables)) && any(grepl("jaar", variables))) {
    design_plot <- matrix(rep(0, 12 * 7), ncol = 7, byrow = TRUE)
    design_plot[, 1] <- 1
    design_plot[2, 2] <- 1
    design_plot[3, 3] <- 1
    design_plot[4, 4] <- 1
    design_plot[5, 5] <- 1
    design_plot[6, 6] <- 1
    design_plot[7, 7] <- 1
    design_plot[8:12, 2] <- 1
    design_plot[8, 3] <- 1
    design_plot[9, 4] <- 1
    design_plot[10, 5] <- 1
    design_plot[11, 6] <- 1
    design_plot[12, 7] <- 1
    
    labels_plot <- paste(c("De Moeren", "Oostelijke leemstreek", 
                           rep(c("De Moeren", "Oostelijke leemstreek"), each = 5)),
                         c(2018, 2018, rep(2019:2023, 2)), sep = " - ")
    
    mytheme <- theme(legend.position = "right")
  } else if (any(grepl("regio", variables))) {
    design_plot <- matrix(c(1, 0, 1, 1), ncol = 2, byrow = TRUE)
    labels_plot <- c("De Moeren", "Oostelijke leemstreek")
    mytheme <- theme()
  } else if (any(grepl("jaar", variables))) {
    labels_plot <- as.numeric(unique(ds_model$ddf$data$jaar))
    
    dim_design <- length(labels_plot)
    design_plot <- matrix(rep(1, dim_design), ncol = 1,
                          byrow = TRUE)
    design_plot <- cbind(design_plot, contr.treatment(dim_design))
    
    mytheme <- theme()
  } else {
    design_plot <- NULL
    labels_plot <- NULL
    mytheme <- theme()
  }
  palette <- colorRampPalette(RColorBrewer::brewer.pal(9,name = 'Set1'))(length(labels_plot))
  
  p <- plot_detection_curve(ds_model, design_mat = design_plot, 
                            labels = labels_plot) +
    scale_colour_manual(values = palette) +
    mytheme
  
  ggsave(here(out_folder_distance, "per_jaar", file),
         p,
         dpi = 300,
         width = 8,
         height = 6)
}
```

## Per stratum

```{r}
dir.create("media/distance/per_stratum", FALSE)
dsmodels_per_stratum2022 <- readRDS(here(dsmodel_path, "models_2022.rds"))
dsmodels_per_stratum2023 <- readRDS(here(dsmodel_path, "models_2023.rds"))
```

### Strata oppervlakte

```{r}
# Lees steekproefkader in
steekproefkader <- tar_read(steekproefkader_finaal, store = targets_store)

perimeters_strata <- steekproefkader %>%
  filter(openheid_klasse %in% c("HOL", "OL"),
         !(Naam == "De Moeren" & openheid_klasse == "HOL")) %>%
  group_by(Naam, openheid_klasse, is_sbp) %>%
  st_buffer(dist = 300) %>%
  summarize() %>%
  mutate(stratum = paste(openheid_klasse, ifelse(is_sbp, "binnen", "buiten"), 
                         sep = " - "))

# Visualisatie
p_moeren <- perimeters_strata %>%
  filter(Naam == "De Moeren") %>%
  mutate(stratum = factor(stratum, levels = c("OL - binnen", "OL - buiten",
                                              "HOL - binnen", "HOL - buiten"))) %>%
  ggplot(aes(fill = stratum)) +
    geom_sf(alpha = 0.8) +
    facet_grid(~Naam) +
    theme(legend.position = "",
          axis.text = element_text(size = 4),
          axis.ticks.length = unit(0.05, "cm"))

p_leemstreek <- perimeters_strata %>%
  filter(Naam == "Oostelijke leemstreek") %>%
  mutate(stratum = factor(stratum, levels = c("OL - binnen", "OL - buiten",
                                              "HOL - binnen", "HOL - buiten"))) %>%
  ggplot(aes(fill = stratum)) +
    geom_sf(alpha = 0.8) +
    facet_grid(~Naam) +
    labs(fill = "Stratum") +
    theme(legend.position = "right",
          axis.text = element_text(size = 6),
          legend.key.size = unit(0.5, 'cm'),
          legend.text = element_text(size = 8),
          axis.ticks.length = unit(0.05, "cm"))

# Bereken oppervlaktes van de strata
areas <- perimeters_strata %>% 
  mutate(Area = as.numeric(st_area(geometry)) / 1e6) %>%
  select(regio = Naam, stratum, Area) %>%
  st_drop_geometry()
table_area <- areas %>%
  rename(`oppervlakte (kmÂ²)` = Area) %>%
  tableGrob(rows = NULL)

# Plot
p <- grid.arrange(table_area, p_moeren, p_leemstreek, 
                  layout_matrix = rbind(c(2, 3, 3), c(1, 1, 1)))

ggsave(here(out_folder_distance, "per_stratum", "oppervlakte_strata.jpg"),
       p,
       dpi = 300,
       width = 8,
       height = 4)
```

### Densiteitschattingen

```{r}
spec <- "Veldleeuwerik"
file <- paste0("densiteit_per_stratum_data_", tolower(spec), ".jpg")
ds_model2022 <- dsmodels_per_stratum2022[[spec]]
ds_model2023 <- dsmodels_per_stratum2023[[spec]]

df_obs_list <- readRDS(here("output", "results", "distance_sampling",
                            "df_obs_list.rds"))
veldleeuwerik_df <- df_obs_list$Veldleeuwerik

design_2018_2023_mas <- readRDS(file.path("output", "results",
                                          "distance_sampling",
                                          "design_2018_2023_mas.rds"))

p <- plot_densiteit(ds_model2022, spec,
               show_data = TRUE,
               year = 2022:2023,
               dsmodel2 = ds_model2023,
               obs_df = veldleeuwerik_df,
               design = design_2018_2023_mas,
               test = TRUE) +
      ggtitle("") + 
      scale_y_continuous(limits = c(0, NA),
                                trans = scales::pseudo_log_trans(),
                                breaks = c(0:4, 6, 8, seq(10, 20, 5), 
                                           seq(30, 50, 10),
                                           60, 80, 100,
                                           seq(125, 200, 25),
                                           seq(300, 1000, 100))) +
      theme(plot.margin = unit(c(-8, 6, 6, 6), 
                                "pt"),
            axis.title.y = element_text(margin = margin(r = 20))) +
      labs(size = "Aantal telpunten")

ggsave(here(out_folder_distance, "per_stratum",
       paste0("densiteit_per_stratum_max_", tolower(spec), ".jpg")),
         p,
         dpi = 300,
         width = 8,
         height = 8)
```

p <- ggplot() +
          stat_sum(data = average_df, aes(x = stratum, y = Estimate,
                                          colour = jaar.f),
                   position = position_dodge(width = 0.5), alpha = 0.1) +
          geom_point(data = average_df, aes(x = stratum, y = total_max_mean,
                                            colour = jaar.f), size = 2.5,
                     position = position_dodge(width = 0.5)) +
          geom_errorbar(data = average_df, aes(x = stratum, ymin = lcl_max_mean,
                          ymax = ucl_max_mean, colour = jaar.f),
                        width = 0.25, position = position_dodge(width = 0.5)) +
          geom_point(data = summary_df, aes(x = stratum, y = Estimate,
                                              group = jaar), size = 2.5,
                       position = position_dodge(width = 1.2),
                     colour = "black") +
          geom_errorbar(data = summary_df, aes(x = stratum, ymin = lcl,
                                               ymax = ucl, group = jaar),
                        colour = "black",
                        width = 0.25, position = position_dodge(width = 1.2)) +
          facet_wrap(~regio, scales = "free_x") +
          labs(colour = "Jaar", x = "", y = "Aantal broedparen per 100 ha") +
          theme(legend.position = "top",
                legend.background = element_rect(fill = "white",
                                                 color = "darkgrey"),
                legend.margin = margin(6, 6, 6, 6))


```{r}
species <- sort(union(names(dsmodels_per_stratum2022),
                      names(dsmodels_per_stratum2023)))
for (spec in species) {
  file <- paste0("densiteit_per_stratum_", tolower(spec), ".jpg")
  ds_model2022 <- dsmodels_per_stratum2022[[spec]]
  ds_model2023 <- dsmodels_per_stratum2023[[spec]]
  
  if (is.null(ds_model2022)) {
    p <- plot_densiteit(ds_model2023, spec, show_data = FALSE,
                      year = 2023) +
      ggtitle("2023")
  } else if (is.null(ds_model2023)) {
    p <- plot_densiteit(ds_model2022, spec, show_data = FALSE,
                      year = 2022) +
      ggtitle("2022")
  } else {
    p <- plot_densiteit(ds_model2022, spec, show_data = FALSE,
                      year = 2022:2023,
                      dsmodel2 = ds_model2023) +
      ggtitle("") + 
      theme(plot.margin = unit(c(-8, 6, 6, 6), 
                                "pt"))
  }
  
  ggsave(here(out_folder_distance, "per_stratum", file),
         p,
         dpi = 300,
         width = 8,
         height = 6)
}
```

### Detectiekans

```{r}
spec <- "Veldleeuwerik"
file <- paste0("detectiekans_per_stratum_", tolower(spec), ".jpg")
ds_model2022 <- dsmodels_per_stratum2022[[spec]]
ds_model2023 <- dsmodels_per_stratum2023[[spec]]

design_plot <- matrix(c(1, 0, 1, 1), ncol = 2, byrow = TRUE)
labels_plot <- c("HOL", "OL")

# 2022
p1 <- plot_detection_curve(ds_model2022,
                           design_mat = design_plot,
                           labels = labels_plot,
                           plot_average_fit = TRUE)

# 2023
p2 <- plot_detection_curve(ds_model2023,
                           design_mat = design_plot,
                           labels = labels_plot,
                           plot_average_fit = TRUE)

# adjust y-limits
ymax_lim <- max(max(p1$plot_env$hist_df$counts),
                max(p2$plot_env$hist_df$counts),
                1)
p1 <- p1 +
  scale_y_continuous(limits = c(0, ymax_lim),
                     breaks = seq(0, 100, by = 0.25)) +
  ggtitle("2022") +
  theme(legend.position = "")
  
p2 <- p2 +
  scale_y_continuous(limits = c(0, ymax_lim),
                     breaks = seq(0, 100, by = 0.25)) +
  labs(y = "") +
  ggtitle("2023")

p <- grid.arrange(p1, p2, ncol = 2)

ggsave(here(out_folder_distance, "per_stratum", file),
       p,
       dpi = 300,
       width = 10,
       height = 6)
```


```{r}
for (spec in species) {
  file <- paste0("detectiekans_per_stratum_simple_", tolower(spec), ".jpg")
  ds_model2022 <- dsmodels_per_stratum2022[[spec]]
  ds_model2023 <- dsmodels_per_stratum2023[[spec]]
  
  if (is.null(ds_model2022)) {
    p <- plot_detection_curve(ds_model2023) +
      ggtitle("2023")
  } else if (is.null(ds_model2023)) {
    p <- plot_detection_curve(ds_model2022) +
      ggtitle("2022")
  } else {
    # 2022
    p1 <- plot_detection_curve(ds_model2022)
    
    # 2023
    p2 <- plot_detection_curve(ds_model2023)
    
    # adjust y-limits
    ymax_lim <- max(max(p1$plot_env$hist_df$counts),
                    max(p2$plot_env$hist_df$counts),
                    1)
    p1 <- p1 +
      scale_y_continuous(limits = c(0, ymax_lim),
                         breaks = seq(0, 100, by = 0.25)) +
      ggtitle("2022")
    p2 <- p2 +
      scale_y_continuous(limits = c(0, ymax_lim),
                         breaks = seq(0, 100, by = 0.25)) +
      labs(y = "") +
      ggtitle("2023")
    
    p <- grid.arrange(p1, p2, ncol = 2)
  }
  
  ggsave(here(out_folder_distance, "per_stratum", file),
         p,
         dpi = 300,
         width = 10,
         height = 6)
}
```


# Beheerovereenkomsten

```{r}
beheermodel_path <- here("src/markdown/mas/analyses_cache")
```


## Oostelijke leemstreek

```{r}
dir.create("media/beheerovereenkomsten/oostelijke_leemstreek", FALSE)
mod_final_olpropsb_list <- readRDS(here(beheermodel_path,
                                        "mod_final_olpropsb_list.rds"))
```

```{r}
# get posterior draws for parameters of interest
draws_olpropsb_list <- lapply(mod_final_olpropsb_list, create_draws_df)
draws_olpropsb_list_wt <- lapply(mod_final_olpropsb_list,
                                 create_weighted_draws_df)
```

```{r}
min_threshold <- log(0.8)
max_threshold <- log(1.25)

area_prop_cats <- tibble(
  area_prop_sb_cat = c("nulbeleid", "laagbeleid", "middellaagbeleid",
                       "middelhoogbeleid", "hoogbeleid"),
  prop_area_sb = c("0", "<0.04", "0.04-0.07", "0.07-0.1", ">0.1")
  ) %>%
  rowid_to_column("order")

area_prop_cats2 <- tibble(
  area_prop_sb_cat = c("nulbeleid", "laagbeleid", "hoogbeleid"),
  prop_area_sb = c("0", "<0.07", ">0.07")
  ) %>%
  rowid_to_column("order")
```

```{r}
for (spec in names(draws_olpropsb_list)) {
  file <- paste0("beleidstoestand_", tolower(spec), "_fine.jpg")
  
  p <- draws_olpropsb_list[[spec]] %>%
    left_join(area_prop_cats, by = join_by(area_prop_sb_cat)) %>%
    mutate(label = paste0(area_prop_sb_cat, "\n(", prop_area_sb, ")"),
           label = reorder(label, order, decreasing = FALSE)) %>%
    ggplot(aes(x = label)) +
      geom_violin(aes(y = value_log, fill = trend_coarse),
                  colour = alpha("white", 0)) +
      geom_hline(yintercept = 0, linetype = "longdash", colour = "black") +
      geom_hline(yintercept = c(min_threshold, max_threshold),
                 linetype = "dotdash") +
      geom_errorbar(aes(ymin = lcl_log, ymax = ucl_log),
                    linewidth = 1, colour = "black", width = 0.1) +
      geom_point(aes(y = median_log),
                 size = 2.2, colour = "black") +
      scale_fill_manual(values =  c("chartreuse3",
                                    "gold",
                                    "firebrick1",
                                    "skyblue"),
                        drop = FALSE) +
      labs(y = "Procentueel verschil t.o.v. nulbeleid",
           x = "",
           fill = "Verschil") +
      scale_y_continuous(
        breaks = index_breaks(),
        labels = index_labels,
        minor_breaks = minor_breaks(),
        sec.axis = sec_axis(~ exp(.),
          breaks = index_breaks_rev(),
          labels = index_labels_rev(),
          name = "Relatief verschil t.o.v. nulbeleid")
        ) +
      theme(
        legend.position = "right",
        legend.background = element_rect(fill = "white", color = "darkgrey"),
        legend.margin = margin(6, 6, 6, 6)
        )
  
  ggsave(here("media", "beheerovereenkomsten", "oostelijke_leemstreek", file),
         p,
         dpi = 300,
         width = 8,
         height = 6)
}
```

```{r}
for (spec in names(draws_olpropsb_list_wt)) {
  file <- paste0("beleidstoestand_", tolower(spec), "_coarse.jpg")
  
  p <- draws_olpropsb_list_wt[[spec]] %>%
    left_join(area_prop_cats2, by = join_by(area_prop_sb_cat)) %>%
    mutate(label = paste0(area_prop_sb_cat, "\n(", prop_area_sb, ")"),
           label = reorder(label, order, decreasing = FALSE)) %>%
    ggplot(aes(x = label)) +
      geom_violin(aes(y = value_log, fill = trend_coarse),
                  colour = alpha("white", 0)) +
      geom_hline(yintercept = 0, linetype = "longdash", colour = "black") +
      geom_hline(yintercept = c(min_threshold, max_threshold),
                 linetype = "dotdash") +
      geom_errorbar(aes(ymin = lcl_log, ymax = ucl_log),
                    linewidth = 1, colour = "black", width = 0.1) +
      geom_point(aes(y = median_log),
                 size = 2.2, colour = "black") +
      scale_fill_manual(values =  c("chartreuse3",
                                    "gold",
                                    "firebrick1",
                                    "skyblue"),
                        drop = FALSE) +
      labs(y = "Procentueel verschil t.o.v. nulbeleid",
           x = "",
           fill = "Verschil") +
      scale_y_continuous(
        breaks = index_breaks(),
        labels = index_labels,
        minor_breaks = minor_breaks(),
        sec.axis = sec_axis(~ exp(.),
          breaks = index_breaks_rev(),
          labels = index_labels_rev(),
          name = "Relatief verschil t.o.v. nulbeleid")
        ) +
      theme(
        legend.position = "right",
        legend.background = element_rect(fill = "white", color = "darkgrey"),
        legend.margin = margin(6, 6, 6, 6)
        )
  
  ggsave(here("media", "beheerovereenkomsten", "oostelijke_leemstreek", file),
         p,
         dpi = 300,
         width = 8,
         height = 6)
}
```

# Zichtbaarheid

```{r}
steekproef <- tar_read(steekproef_zichtbaarheid, store = targets_store) %>%
  mutate(openheid_sbp = paste(openheid_klasse,
                             ifelse(is_sbp,
                                    "binnen plan",
                                    "buiten plan"))
         )
```

```{r bereken-zichtbaarheid}
bereken_vvi <- function(point,
                       dist = 300,
                       obs_height = 1.7,
                       resolution = 1,
                       spacing = 5,
                       dsm_offset = 0,
                       output_type) {

  bbox_buffer <- point %>% st_buffer(dist = dist + 10) %>% st_bbox()

  dsm_r1 <- inbospatial::get_coverage_wcs(wcs = "dsm",
                             bbox = bbox_buffer,
                             layername = "EL.GridCoverage.DSM",
                             resolution = resolution)
  dtm_r1 <- inbospatial::get_coverage_wcs(wcs = "dtm",
                             bbox = bbox_buffer,
                             layername = "EL.GridCoverage.DTM",
                             resolution = resolution)
  
  poly25 <- point %>% st_buffer(dist = 25)

  vvi_from_sf(
    observer = poly25,
    spacing = spacing,
    cores = 1,
    progress = TRUE,
    max_distance = dist,
    dsm_rast = dsm_r1 + dsm_offset,
    dtm_rast = dtm_r1,
    observer_height = obs_height,
    raster_res = resolution,
    output_type = output_type)
}
```

```{r}
vvi_res5sp10 <- steekproef %>%
  filter(pointid == "Ol_4269.12") %>%
  bereken_vvi(output_type = "VVI", resolution = 5, spacing = 10)

cvvi_res5sp10 <- steekproef %>%
  filter(pointid == "Ol_4269.12") %>%
  bereken_vvi(output_type = "cumulative", resolution = 5, spacing = 10)

sviewshed_res5sp10 <- steekproef %>%
  filter(pointid == "Ol_4269.12") %>%
  bereken_vvi(output_type = "viewshed", resolution = 5, spacing = 10)

cirkel_25m <- steekproef %>%
  filter(pointid == "Ol_4269.12") %>%
  st_buffer(25)

cirkel_300m <- steekproef %>%
  filter(pointid == "Ol_4269.12") %>%
  st_buffer(300)

p1 <- ggplot() +
  tidyterra::geom_spatraster(data = sviewshed_res5sp10) +
  geom_sf(data = cirkel_300m, alpha = 0, colour = "firebrick") +
  geom_sf(data = cirkel_25m, alpha = 0, colour = "firebrick") +
  geom_sf(data = vvi_res5sp10, aes(colour =  VVI)) +
  tidyterra::scale_fill_terrain_c() +
  labs(title = paste0("Telpunt Ol_4269.12 (CVVI = ",
                      round(cvvi_res5sp10, 2), ")"))

ggsave(here("media", "visibility", "voorbeeld_zichtbaarheid.jpg"),
       p1,
       dpi = 300,
       width = 8,
       height = 6)
```


