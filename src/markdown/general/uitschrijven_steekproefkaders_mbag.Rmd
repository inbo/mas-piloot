---
title: "Uitschrijven steekproefkaders MBAG"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# renv
renv::restore()

# Set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE)
opts_knit$set(root.dir = here())

# Conflicting packages
conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)
conflicted::conflicts_prefer(dplyr::lag)

# Packages
library(tidyverse)
library(sf)
library(nngeo)
library(mapview)

# Source
mbag_dir <- here()
source(file.path(mbag_dir, "src", "R", "steekproefkader.R"))
source(file.path(mbag_dir, "src", "R", "berekening_hulpvariabelen.R"))
```

# Doel

We willen voor het MBAG project een duidelijk overzicht van het steekproefkader en de steekproef.
Hiervoor schrijven we uit het pilootproject voor de Leemstreek en de Zandleemstreek 4 bestanden weg (als CSV-bestanden):

1.  steekproefkader

2.  gewichten steekproefkader

3.  steekproef

4.  finale steekproef na manuele controle (punten die effectief zijn geteld)

# Leemstreek

We splitsen de Leemstreek op in twee delen aangezien de Oostelijke leemstreek deel uitmaakte van het pilootproject.

## Oostelijke leemstreek
### Steekproefkader

Voor de Oostelijke leemstreek moeten we de variabele SBP opnieuw berekenen omdat we voor het MAS vlaanderen ook andere SBP lagen gebruiken.
Bovendien werd `area_prop_sb` berekend op basis van de kaart van 2021, maar hier werd geen gebruik van gemaakt bij de steekproeftrekking (in het geval van MBAG wordt deze berekend op basis van de kaart van 2022 en wel in rekening genomen voor een gebalanceerde steekproef).
We zetten deze variabele hier op `NA` omdat deze niet is gebruikt.
We lezen het steekproefkader in van de pilootstudie en selecteren de Oostelijke leemstreek.

```{r}
# Read in steekproefkader pilot study
steekproefkader_piloot <- git2rdata::read_vc(
  file.path(
    "data", "processed", "steekproefkader_piloot")
  )

# Select Oostelijke leemstreek
steekproefkader_ol_raw <- steekproefkader_piloot %>%
  filter(Naam == "Oostelijke leemstreek")

steekproefkader_ol_raw_sf <- steekproefkader_ol_raw %>%
  st_as_sf(coords = c("X", "Y"), crs = st_crs(31370))
```

We herberekenen `is_sbp`.

```{r}
# Get perimeter Oostelijke leemstreek
perimeters_piloot <- st_read(path_to_perimeters())

perimeters_ol <- perimeters_piloot %>%
  filter(Naam == "Oostelijke leemstreek")

# Get sbp areas for perimeter
sbp_akkervogels <- read_sbp_akkervogels(
      path = path_to_sbp_akkervogels(
        file = "akkervogelgebieden2022.shp"),
      gebied = perimeters_ol,
      path_extra_soorten = path_to_sbp_akkervogels(
        file = "sbp_overige_soorten.shp"),
      extra_soorten = c("hamster",
                        "bruine kiekendief",
                        "zomertortel", 
                        "grauwe kiekendief")
      )

# Calculate variable sbp
steekproefkader_ol_sbp <- add_stratum_sbp(
      punten_sf = steekproefkader_ol_raw_sf,
      sbp = sbp_akkervogels
      )

# Prepare final dataframe
steekproefkader_ol <- steekproefkader_ol_sbp %>%
  mutate(x_coord = st_coordinates(geometry)[,1],
         y_coord = st_coordinates(geometry)[,2]) %>%
  st_drop_geometry() %>%
  mutate(area_prop_sb = NA,
         sbp = ifelse(is_sbp, "binnen", "buiten"),
         crs = 31370) %>%
  select(pointid, regio = Naam, area_prop_sb, openheid_klasse, sbp, x_coord,
         y_coord, crs) %>%
  filter(openheid_klasse %in% c("OL", "HOL"))
```

Controle berekeningen.

```{r}
steekproefkader_ol_sf <- steekproefkader_ol %>%
  st_as_sf(coords = c("x_coord", "y_coord"), crs = st_crs(31370)) %>%
  mutate(stratum = paste(openheid_klasse, sbp, sep = " - "))

# Visualise
mapview(steekproefkader_ol_sf,
        zcol = "sbp", layer = "sbp") +
  mapview(sbp_akkervogels, col.regions = "red",
          alpha.regions = 0.5, legend = FALSE)
```

```{r}
head(steekproefkader_ol) %>%
  kable(digits = 2)
```

### Gewichten steekproefkader

Deze zullen niet hetzelfde zijn als in de oorspronkelijke allocatietabel omdat we sbp hebben herberekend.

```{r}
gewichten_ol <- steekproefkader_ol %>%
  count(regio, openheid_klasse, sbp) %>%
  group_by(openheid_klasse) %>%
  mutate(prop_openheid = sum(n) / nrow(steekproefkader_ol)) %>%
  group_by(sbp) %>%
  mutate(prop_sbp = sum(n) / nrow(steekproefkader_ol)) %>%
  ungroup() %>%
  mutate(prop = n / nrow(steekproefkader_ol))

gewichten_ol %>%
  kable(digits = 5)
```

### Steekproef

```{r}
# Read in steekproef pilot study
steekproef_piloot <- git2rdata::read_vc(
  file.path(
    "data", "processed", "steekproef_piloot")
  )

# Select Oostelijke leemstreek
steekproef_ol_raw <- steekproef_piloot %>%
  filter(Naam == "Oostelijke leemstreek")
```

We voegen de SBP variabele toe door te joinen met het steekproefkader.

```{r}
# Prepare dataframe
steekproef_ol <- steekproef_ol_raw %>%
  select(pointid, sample_order, batch) %>%
  left_join(steekproefkader_ol, by = join_by(pointid))

head(steekproef_ol) %>%
  kable(digits = 2)
```

### Finale steekproef na manuele controle

Dit zijn de punten die in avimap zijn ingevoerd.

```{r}
# Read in final steekproef pilot study
steekproef_piloot_avimap <- git2rdata::read_vc(
  file.path(
    "data", "processed", "steekproef_piloot_avimap")
  )

# Select Oostelijke leemstreek
steekproef_ol_avimap_raw <- steekproef_piloot_avimap %>%
  filter(regio == "Oostelijke leemstreek",
         status_claim == "geclaimd")
```

Zijn dit effectief de punten die vorig jaar zijn geteld?

```{r}
mas_data_full <- read_csv(
  here("data", "processed","MAS_data_full_2018_2023.csv"))

plotnaam_2022 <- mas_data_full %>%
  filter(regio == "Oostelijke leemstreek",
         jaar == 2022) %>%
  distinct(plotnaam) %>%
  arrange(plotnaam) %>%
  pull()

plotnaam_2023 <- mas_data_full %>%
  filter(regio == "Oostelijke leemstreek",
         jaar == 2023) %>%
  distinct(plotnaam) %>%
  arrange(plotnaam) %>%
  pull()
```

We vergelijken met de telpunten van 2022.
We zien dat het gaat om oude punten die hergebruikt worden die niet in de avimap dataset zitten.

```{r}
waldo::compare(sort(plotnaam_2022),
               sort(steekproef_ol_avimap_raw$definitief_punt),
               max_diffs = Inf)
```

We vergelijken met de telpunten van 2023.
We zien opnieuw dat het gaat om oude punten die hergebruikt worden die niet in de avimap dataset zitten, maar ook 1 recent punt dat niet meer is geteld in 2023.

```{r}
waldo::compare(sort(plotnaam_2023),
               sort(steekproef_ol_avimap_raw$definitief_punt),
               max_diffs = Inf)
```

Als we de punten van 2022 en 2023 onderling vergelijken, zien we verschil in 3 punten.
Ol_2954.5 is niet meer geteld in 2023 en VL0363 en VL0605 waren niet geteld in 2022.

```{r}
waldo::compare(sort(plotnaam_2022), sort(plotnaam_2023),
               max_diffs = Inf)
```

We vergelijken met de ruwe data.
Misschien zijn deze wel geteld, maar buiten telperiodes of dergelijke.

```{r}
export_mas <- st_read(
  here(
    "data", "mas", "20230509_qgis_export_sovon_wfs.geojson")
  )

export_mas_2023 <- st_read(
  here(
    "data", "mas", "20230810_qgis_export_sovon_wfs_2023.geojson")
  )
```

Ol_2954.5: geen data in 2023

```{r}
export_mas_2023 %>%
  filter(plotnaam == "Ol_2954.5")
```


VL0363: geen data in 2022

```{r}
export_mas %>%
  filter(plotnaam == "VL0363",
         jaar == 2022)
```

VL0605: geen data in 2022

```{r}
export_mas %>%
  filter(plotnaam == "VL0605",
         jaar == 2022)
```

Welke punten nemen we op?

> Voorlopig nemen we de geclaimde punten.

We nemen de gerecycleerde punten en berekenen de SBP variabele.

```{r}
# We need to calculate SBP variable for the old points
old_points_ol_avimap_sf <- steekproef_ol_avimap_raw %>%
  filter(!grepl("^Ol", definitief_punt)) %>%
  separate_wider_delim(stratum, " ",
                       names = c("openheid_klasse", "sbp", "plan")) %>%
  mutate(batch = NA,
         area_prop_sb = NA) %>%
  select(pointid = definitief_punt, sample_order, batch, regio, area_prop_sb,
         openheid_klasse, x_coord = X, y_coord = Y) %>%
  st_as_sf(coords = c("x_coord", "y_coord"), crs = 31370)

old_points_ol_avimap_sf2 <- add_stratum_sbp(
      punten_sf = old_points_ol_avimap_sf,
      sbp = sbp_akkervogels
      )

old_points_ol_avimap <- old_points_ol_avimap_sf2 %>%
  mutate(x_coord = st_coordinates(geometry)[,1],
         y_coord = st_coordinates(geometry)[,2]) %>%
  st_drop_geometry() %>%
  mutate(sbp = ifelse(is_sbp, "binnen", "buiten"),
         crs = 31370) %>%
  select(pointid, sample_order, batch, regio, area_prop_sb, openheid_klasse,
         sbp, x_coord, y_coord, crs)
```

We voegen deze toe aan de andere punten om tot een finale dataset te komen.

```{r}
steekproef_ol_avimap <- steekproef_ol %>%
  filter(pointid %in% unique(steekproef_ol_avimap_raw$definitief_punt)) %>%
  bind_rows(old_points_ol_avimap)

head(steekproef_ol_avimap) %>%
  kable(digits = 2)
```

Dit zijn `r nrow(steekproef_ol_avimap)` punten.

## Westelijke leemstreek
### Steekproefkader

We lezen het steekproefkader in van de Leemstreek. We lezen ook de perimeters van de Oostelijke leemstreek in zodat we de punten van de Westelijke leemstreek kunnen selecteren.

```{r}
# Read in steekproefkader Leemstreek, Zandleemstreek
steekproefkader_zavelberg <- git2rdata::read_vc(
  file.path(
    "src", "targets", "mas_steekproef_zavelberg", "output", "steekproefkader")
  )

# Select Leemstreek
steekproefkader_leemstreek <- steekproefkader_zavelberg %>%
   filter(Naam == "Leemstreek") 

# Convert to sf
steekproefkader_leemstreek_sf <- steekproefkader_leemstreek %>%
  st_as_sf(coords = c("X", "Y"), crs = st_crs(31370))

# Use perimeter to select points Westelijke leemstreek
steekproefkader_wl_sf <- st_difference(steekproefkader_leemstreek_sf,
                                       perimeters_ol)

# Prepare final dataframe
steekproefkader_wl <- steekproefkader_wl_sf %>%
  mutate(x_coord = st_coordinates(geometry)[,1],
         y_coord = st_coordinates(geometry)[,2]) %>%
  st_drop_geometry() %>%
  mutate(sbp = ifelse(is_sbp, "binnen", "buiten"),
         crs = 31370,
         regio = "Westelijke leemstreek") %>%
  select(pointid, regio, area_prop_sb, openheid_klasse, sbp, x_coord, y_coord,
         crs) %>%
  filter(openheid_klasse %in% c("OL", "HOL"))
```

```{r}
head(steekproefkader_wl) %>%
  kable(digits = 2)
```

### Gewichten steekproefkader

Deze zullen niet hetzelfde zijn als in de oorspronkelijke allocatietabel omdat we een subset van de Leemstreek hebben

```{r}
gewichten_wl <- steekproefkader_wl %>%
  count(regio, openheid_klasse, sbp) %>%
  group_by(openheid_klasse) %>%
  mutate(prop_openheid = sum(n) / nrow(steekproefkader_wl)) %>%
  group_by(sbp) %>%
  mutate(prop_sbp = sum(n) / nrow(steekproefkader_wl)) %>%
  ungroup() %>%
  mutate(prop = n / nrow(steekproefkader_wl))

gewichten_wl %>%
  kable(digits = 5)
```

### Steekproef

We maken weer een overlay zodat we enkel de punten van de Westelijke leemstreek selecteren.

```{r}
# Read in steekproef Leemstreek, Zandleemstreek
steekproef_zavelberg <- git2rdata::read_vc(
  file.path(
    "src", "targets", "mas_steekproef_zavelberg", "output", "steekproef")
  )

# Select Leemstreek
steekproef_leemstreek <- steekproef_zavelberg %>%
  filter(Naam == "Leemstreek")
```

```{r}
# Convert to sf
steekproef_leemstreek_sf <- steekproef_leemstreek %>%
  st_as_sf(coords = c("X", "Y"), crs = st_crs(31370))

# Use perimeter to select points Westelijke leemstreek
steekproef_wl_sf <- st_difference(steekproef_leemstreek_sf, perimeters_ol)

# Prepare final dataframe
steekproef_wl <- steekproef_wl_sf %>%
  st_drop_geometry() %>%
  select(pointid, sample_order, batch) %>%
  left_join(steekproefkader_wl, by = join_by(pointid))

head(steekproef_wl) %>%
  kable(digits = 2)
```

### Finale steekproef na manuele controle

Dit zijn de punten die in avimap zijn ingevoerd en zijn geteld.

```{r}
# Read in final steekproef Leemstreek
steekproef_wl_avimap_raw <- st_read(
  here(
    "data", "processed", "steekproef_leemstreek_avimap.gpkg")
  )
```

Zijn dit effectief de punten die vorig jaar zijn geteld?

```{r}
# Get names of plots from data
plotnaam_wl <- export_mas_2023 %>%
  st_drop_geometry() %>%
  filter(grepl("^Lm", plotnaam)) %>%
  distinct(plotnaam) %>%
  pull()

# Make comparison
waldo::compare(sort(plotnaam_wl),
               sort(steekproef_wl_avimap_raw$pointid))
```

Yes.

```{r}
steekproef_wl_avimap <- steekproef_wl %>%
  filter(pointid %in% plotnaam_wl)

head(steekproef_wl_avimap) %>%
  kable(digits = 2)
```

# Zandleemstreek
## Steekproefkader

We lezen het steekproefkader in van de Zandeemstreek.

```{r}
# Select Zandleemstreek
steekproefkader_zandleemstreek <- steekproefkader_zavelberg %>%
   filter(Naam == "Zandleemstreek") 

# Prepare final dataframe
steekproefkader_zn <- steekproefkader_zandleemstreek %>%
  mutate(sbp = ifelse(is_sbp, "binnen", "buiten"),
         crs = 31370) %>%
  select(pointid, regio = Naam, area_prop_sb, openheid_klasse, sbp, x_coord = X,
         y_coord = Y, crs) %>%
  filter(openheid_klasse %in% c("OL", "HOL"))
```

```{r}
head(steekproefkader_zn) %>%
  kable(digits = 2)
```

## Gewichten steekproefkader

De aantallen zijn hetzelfde als in de oorspronkelijke allocatietabel.

```{r}
gewichten_zn <- steekproefkader_zn %>%
  count(regio, openheid_klasse, sbp) %>%
  group_by(openheid_klasse) %>%
  mutate(prop_openheid = sum(n) / nrow(steekproefkader_zn)) %>%
  group_by(sbp) %>%
  mutate(prop_sbp = sum(n) / nrow(steekproefkader_zn)) %>%
  ungroup() %>%
  mutate(prop = n / nrow(steekproefkader_zn))

gewichten_zn %>%
  kable(digits = 5)
```

## Steekproef

```{r}
# Select Zandleemstreek
steekproef_zandleemstreek <- steekproef_zavelberg %>%
  filter(Naam == "Zandleemstreek")

# Prepare final dataframe
steekproef_zn <- steekproef_zandleemstreek %>%
  st_drop_geometry() %>%
  mutate(sbp = ifelse(is_sbp, "binnen", "buiten"),
         crs = 31370) %>%
  select(pointid, sample_order, batch, regio = Naam, area_prop_sb,
         openheid_klasse, sbp, x_coord = X, y_coord = Y, crs)

head(steekproef_zn) %>%
  kable(digits = 2)
```

## Finale steekproef na manuele controle

Dit zijn de punten die in avimap zijn ingevoerd.

```{r}
# Read in final steekproef Zandleemstreek
steekproef_zn_avimap_raw <- st_read(
  here(
    "data", "processed", "steekproef_zandleemstreek_avimap.gpkg")
  )
```

Zijn dit effectief de punten die vorig jaar zijn geteld?

```{r}
# Get names of plots from data
plotnaam_zn <- export_mas_2023 %>%
  st_drop_geometry() %>%
  filter(grepl("^Zn", plotnaam)) %>%
  distinct(plotnaam) %>%
  pull()

# Make comparison
waldo::compare(sort(plotnaam_zn),
               sort(steekproef_zn_avimap_raw$pointid))
```

Yes. De mismatch is een punt die wel geteld is maar is overgenomen van de pilootstudie in De Moeren.

```{r}
old_points <- export_mas_2023 %>%
  st_drop_geometry() %>%
  distinct(plotnaam) %>%
  pull()

"DM_386.7" %in%  old_points
```

```{r}
steekproef_zn_avimap <- steekproef_zn %>%
  filter(pointid %in% unique(steekproef_zn_avimap_raw$pointid))

head(steekproef_zn_avimap) %>%
  kable(digits = 2)
```

# Uitschrijven datasets

```{r}
dir.create(here("data", "steekproefkaders"), showWarnings = FALSE)
```


## Steekproefkader

Dit is een CSV-bestand van alle steekproefkaders.
In het MBAG project worden deze van andere landbouwregio's hieraan toegevoegd.

```{r}
bind_rows(
    steekproefkader_ol,
    steekproefkader_wl,
    steekproefkader_zn) %>%
  write_csv(here("data", "steekproefkaders", "steekproefkader_mbag_piloot.csv"))
```

## Gewichten steekproefkader

Dit zijn aparte CSV-bestanden voor elke regio.

```{r}
write_csv(gewichten_ol, 
          here("data", "steekproefkaders",
               "gewichten_oostelijke_leemstreek.csv"))
write_csv(gewichten_wl, 
          here("data", "steekproefkaders",
               "gewichten_westelijke_leemstreek.csv"))
write_csv(gewichten_zn, 
          here("data", "steekproefkaders",
               "gewichten_zandleemstreek.csv"))
```

## Steekproef

Dit is een CSV-bestand van alle steekproeven.
In het MBAG project worden deze van andere landbouwregio's hieraan toegevoegd.

```{r}
bind_rows(
    steekproef_ol,
    steekproef_wl,
    steekproef_zn) %>%
  write_csv(here("data", "steekproefkaders", "steekproef_mbag_piloot.csv"))
```

## Finale steekproef na manuele controle

Dit is een CSV-bestand van alle finale telpunten.
In het MBAG project worden deze van andere landbouwregio's hieraan toegevoegd.

```{r}
bind_rows(
    steekproef_ol_avimap,
    steekproef_wl_avimap,
    steekproef_zn_avimap) %>%
  write_csv(here("data", "steekproefkaders",
                 "steekproef_avimap_mbag_piloot.csv"))
```
