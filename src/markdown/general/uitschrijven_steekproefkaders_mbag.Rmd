---
title: "Uitschrijven steekproefkaders MBAG"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# renv
renv::restore()

# Set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE)
opts_knit$set(root.dir = here())

# Conflicting packages
conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)
conflicted::conflicts_prefer(dplyr::lag)

# Packages
library(tidyverse)
library(sf)
library(nngeo)
library(mapview)

# Source
mbag_dir <- here()
source(file.path(mbag_dir, "src", "R", "steekproefkader.R"))
source(file.path(mbag_dir, "src", "R", "berekening_hulpvariabelen.R"))
```

# Doel

We willen voor het MBAG project een duidelijk overzicht van het steekproefkader en de steekproef.
Hiervoor schrijven we uit het pilootproject voor de Leemstreek en de Zandleemstreek 4 bestanden weg (als CSV-bestanden):

1.  steekproefkader

2.  gewichten steekproefkader

3.  steekproef

4.  finale steekproef na manuele controle (punten die effectief zijn geteld)

# Leemstreek

We splitsen de Leemstreek op in twee delen aangezien de Oostelijke leemstreek deel uitmaakte van het pilootproject.

## Oostelijke leemstreek
### Steekproefkader

Voor de Oostelijke leemstreek moeten we de variabele SBP opnieuw berekenen omdat we voor het MAS vlaanderen ook andere SBP lagen gebruiken.
Bovendien werd `area_prop_sb` berekend op basis van de kaart van 2021, maar hier werd geen gebruik van gemaakt bij de steekproeftrekking (in het geval van MBAG wordt deze berekend op basis van de kaart van 2022 en wel in rekening genomen voor een gebalanceerde steekproef).
We zetten deze variabele hier op `NA` omdat deze niet is gebruikt.
We lezen het steekproefkader in van de pilootstudie en selecteren de Oostelijke leemstreek.

```{r}
# Read in steekproefkader pilot study
steekproefkader_piloot <- git2rdata::read_vc(
  file.path(
    "data", "processed", "steekproefkader_piloot")
  )

# Select Oostelijke leemstreek
steekproefkader_ol_raw <- steekproefkader_piloot %>%
  filter(Naam == "Oostelijke leemstreek")

steekproefkader_ol_raw_sf <- steekproefkader_ol_raw %>%
  st_as_sf(coords = c("X", "Y"), crs = st_crs(31370))
```

We herberekenen `is_sbp`.

```{r}
# Get perimeter Oostelijke leemstreek
perimeters_piloot <- st_read(path_to_perimeters())

perimeters_ol <- perimeters_piloot %>%
  filter(Naam == "Oostelijke leemstreek")

# Get sbp areas for perimeter
sbp_akkervogels <- read_sbp_akkervogels(
      path = path_to_sbp_akkervogels(
        file = "akkervogelgebieden2022.shp"),
      gebied = perimeters_ol,
      path_extra_soorten = path_to_sbp_akkervogels(
        file = "sbp_overige_soorten.shp"),
      extra_soorten = c("hamster",
                        "bruine kiekendief",
                        "zomertortel", 
                        "grauwe kiekendief")
      )

# Calculate variable sbp
steekproefkader_ol_sbp <- add_stratum_sbp(
      punten_sf = steekproefkader_ol_raw_sf,
      sbp = sbp_akkervogels
      )

# Prepare final dataframe
steekproefkader_ol <- steekproefkader_ol_sbp %>%
  mutate(x_coord = st_coordinates(geometry)[,1],
         y_coord = st_coordinates(geometry)[,2]) %>%
  st_drop_geometry() %>%
  mutate(area_prop_sb = NA,
         sbp = ifelse(is_sbp, "binnen", "buiten"),
         crs = 31370) %>%
  select(pointid, regio = Naam, area_prop_sb, openheid_klasse, sbp, x_coord,
         y_coord, crs) %>%
  filter(openheid_klasse %in% c("OL", "HOL"))
```

Controle berekeningen.

```{r}
steekproefkader_ol_sf <- steekproefkader_ol %>%
  st_as_sf(coords = c("x_coord", "y_coord"), crs = st_crs(31370)) %>%
  mutate(stratum = paste(openheid_klasse, sbp, sep = " - "))

# Visualise
mapview(steekproefkader_ol_sf,
        zcol = "sbp", layer = "sbp") +
  mapview(sbp_akkervogels, col.regions = "red",
          alpha.regions = 0.5, legend = FALSE)
```

```{r}
head(steekproefkader_ol) %>%
  kable(digits = 2)
```

### Gewichten steekproefkader

Deze zullen niet hetzelfde zijn als in de oorspronkelijke allocatietabel omdat we sbp hebben herberekend.

```{r}
gewichten_ol <- steekproefkader_ol %>%
  count(regio, openheid_klasse, sbp) %>%
  group_by(openheid_klasse) %>%
  mutate(prop_openheid = sum(n) / nrow(steekproefkader_ol)) %>%
  group_by(sbp) %>%
  mutate(prop_sbp = sum(n) / nrow(steekproefkader_ol)) %>%
  ungroup() %>%
  mutate(prop = n / nrow(steekproefkader_ol))

gewichten_ol %>%
  kable(digits = 5)
```

### Steekproef

```{r}
# Read in steekproef pilot study
steekproef_piloot <- git2rdata::read_vc(
  file.path(
    "data", "processed", "steekproef_piloot")
  )

# Select Oostelijke leemstreek
steekproef_ol_raw <- steekproef_piloot %>%
  filter(Naam == "Oostelijke leemstreek")
```

We voegen de SBP variabele toe door te joinen met het steekproefkader.

```{r}
# Prepare dataframe
steekproef_ol <- steekproef_ol_raw %>%
  select(pointid, sample_order, batch) %>%
  left_join(steekproefkader_ol, by = join_by(pointid))

head(steekproef_ol) %>%
  kable(digits = 2)
```

### Finale steekproef na manuele controle

Dit zijn de punten die in avimap zijn ingevoerd.

```{r}
# Read in final steekproef pilot study
steekproef_piloot_avimap <- git2rdata::read_vc(
  file.path(
    "data", "processed", "steekproef_piloot_avimap")
  )

# Select Oostelijke leemstreek
steekproef_ol_avimap_raw <- steekproef_piloot_avimap %>%
  filter(regio == "Oostelijke leemstreek",
         status_claim == "geclaimd")
  
```

```{r}
export_mas <- st_read(
  here(
    "data", "mas", "20230810_qgis_export_sovon_wfs_2023.geojson")
  )

export_ol <- export_mas %>%
  st_transform(31370) %>%
  st_intersection(perimeters_ol)

plotnaam_ol <- export_ol %>%
  st_drop_geometry() %>%
  distinct(plotnaam) %>%
  pull()
```

Zijn dit effectief de punten die vorig jaar zijn geteld?

```{r}
waldo::compare(sort(plotnaam_ol),
               sort(steekproef_ol_avimap_raw$definitief_punt))
```


## Westelijke leemstreek
### Steekproefkader

We lezen het steekproefkader in van de Leemstreek. We lezen ook de perimeters van de Oostelijke leemstreek in zodat we de punten van de Westelijke leemstreek kunnen selecteren.

```{r}
# Read in steekproefkader Leemstreek, Zandleemstreek
steekproefkader_zavelberg <- git2rdata::read_vc(
  file.path(
    "src", "targets", "mas_steekproef_zavelberg", "output", "steekproefkader")
  )

# Select Leemstreek
steekproefkader_leemstreek <- steekproefkader_zavelberg %>%
   filter(Naam == "Leemstreek") 

# Convert to sf
steekproefkader_leemstreek_sf <- steekproefkader_leemstreek %>%
  st_as_sf(coords = c("X", "Y"), crs = st_crs(31370))

# Use perimeter to select points Westelijke leemstreek
steekproefkader_wl_sf <- st_difference(steekproefkader_leemstreek_sf,
                                       perimeters_ol)

# Prepare final dataframe
steekproefkader_wl <- steekproefkader_wl_sf %>%
  mutate(x_coord = st_coordinates(geometry)[,1],
         y_coord = st_coordinates(geometry)[,2]) %>%
  st_drop_geometry() %>%
  mutate(sbp = ifelse(is_sbp, "binnen", "buiten"),
         crs = 31370,
         regio = "Westelijke leemstreek") %>%
  select(pointid, regio, area_prop_sb, openheid_klasse, sbp, x_coord, y_coord,
         crs) %>%
  filter(openheid_klasse %in% c("OL", "HOL"))
```

```{r}
head(steekproefkader_wl) %>%
  kable(digits = 2)
```

### Gewichten steekproefkader

Deze zullen niet hetzelfde zijn als in de oorspronkelijke allocatietabel omdat we een subset van de Leemstreek hebben

```{r}
gewichten_wl <- steekproefkader_wl %>%
  count(regio, openheid_klasse, sbp) %>%
  group_by(openheid_klasse) %>%
  mutate(prop_openheid = sum(n) / nrow(steekproefkader_wl)) %>%
  group_by(sbp) %>%
  mutate(prop_sbp = sum(n) / nrow(steekproefkader_wl)) %>%
  ungroup() %>%
  mutate(prop = n / nrow(steekproefkader_wl))

gewichten_wl %>%
  kable(digits = 5)
```

### Steekproef

We maken weer een overlay zodat we enkel de punten van de Westelijke leemstreek selecteren.

```{r}
# Read in steekproef Leemstreek, Zandleemstreek
steekproef_zavelberg <- git2rdata::read_vc(
  file.path(
    "src", "targets", "mas_steekproef_zavelberg", "output", "steekproef")
  )

# Select Leemstreek
steekproef_leemstreek <- steekproef_zavelberg %>%
  filter(Naam == "Leemstreek")
```

```{r}
# Convert to sf
steekproef_leemstreek_sf <- steekproef_leemstreek %>%
  st_as_sf(coords = c("X", "Y"), crs = st_crs(31370))

# Use perimeter to select points Westelijke leemstreek
steekproef_wl_sf <- st_difference(steekproef_leemstreek_sf, perimeters_ol)

# Prepare final dataframe
steekproef_wl <- steekproef_wl_sf %>%
  st_drop_geometry() %>%
  select(pointid, sample_order, batch) %>%
  left_join(steekproefkader_wl, by = join_by(pointid))

head(steekproef_wl) %>%
  kable(digits = 2)
```

### Finale steekproef na manuele controle

Dit zijn de punten die in avimap zijn ingevoerd en zijn geteld.

```{r}
# Read in final steekproef Leemstreek
steekproef_leemstreek_avimap <- st_read(
  here(
    "data", "processed", "steekproef_leemstreek_avimap.gpkg")
  )
```

Zijn dit effectief de punten die vorig jaar zijn geteld?

```{r}
# Get names of plots from data
plotnaam_wl <- export_mas %>%
  st_drop_geometry() %>%
  filter(grepl("^Lm", plotnaam)) %>%
  distinct(plotnaam) %>%
  pull()

# Make comparison
waldo::compare(sort(plotnaam_wl), sort(steekproef_leemstreek_avimap$pointid))
```

Yes.

# Zandleemstreek
## Steekproefkader

## Gewichten steekproefkader

## Steekproef

## Finale steekproef na manuele controle

Dit zijn de punten die in avimap zijn ingevoerd.

> dubbeltellingen?

# Uitschrijven datasets
## Steekproefkader

Dit is een CSV-bestand van alle steekproefkaders.
In het MBAG project worden deze van andere landbouwregio's hieraan toegevoegd.


## Gewichten steekproefkader

Dit zijn aparte CSV-bestanden voor elke regio.

## Steekproef

Dit is een CSV-bestand van alle steekproeven.
In het MBAG project worden deze van andere landbouwregio's hieraan toegevoegd.

## Finale steekproef na manuele controle

Dit is een CSV-bestand van alle finale telpunten.
In het MBAG project worden deze van andere landbouwregio's hieraan toegevoegd.
