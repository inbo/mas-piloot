---
title: "MAS afbakening steekproefkader"
author: "Hans Van Calster"
date: "`r Sys.Date()`"
bibliography: mas.json
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
---

```{r setup, include=FALSE}
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE)
opts_knit$set(root.dir = here::here())
library(tidyverse)
library(sf)
library(nngeo)
library(mapview)
library(readxl)
library(gt)
library(httr)
library(osmextract)
source(here("R", "wfs_wcs.R"))
```

# Afbakening steekproefkader

## Perimeter bepalen

= intersectie landbouwstreek België met contour Vlaanderen en overlappend met prioritaire gebieden voor akkervogels

```{r warning=FALSE}
landbouwstreken <- read_sf(
  here("data", "landbouwstreken", "Lbstrbel.shp")) %>%
  st_transform(crs = 31370) %>%
  select(NAAM)

vlaanderen <- get_feature_wfs(
  wfs = "https://eservices.minfin.fgov.be/arcgis/services/R2C/Regions/MapServer/WFSServer",
  layername = "regions",
  crs = "EPSG:31370",
  filter = "<Filter><PropertyIsEqualTo><PropertyName>regions:NameDUT</PropertyName><Literal>'Vlaams Gewest'</Literal></PropertyIsEqualTo></Filter>") %>%
  select(NameDUT)

westkustpolder <- get_feature_wfs(
  wfs = "https://geoservices.informatievlaanderen.be/overdrachtdiensten/Polders/wfs",
  version = "1.1.0",
  layername = "Polders:Polder",
  crs = "urn:x-ogc:def:crs:EPSG:31370",
  ) %>%
  st_cast(to = "GEOMETRYCOLLECTION") %>%
  mutate(id = seq_len(nrow(.))) %>%
  st_collection_extract("POLYGON") %>%
  aggregate(list(.$id), first, do_union = FALSE) %>%
  select(NAAMPOL) %>%
  filter(NAAMPOL == "Westkustpolder") %>%
  as_tibble %>%
  st_as_sf(crs = 31370)

plan_kiekendief_perimeter <- read_sf(
  here("data", "mas", "Grauwe_kiekendief_VLM3.kml")
) %>%
  select(-Description) %>%
  st_simplify() %>%
  st_transform(crs = 31370) %>%
  mutate(regio = case_when(
    Name == "moeren" ~ "Moeren",
    Name %in% c(
      "akkerplateau omgeving Gingelom",
      "akkerplateaus Heers-Riemst",
      "landbouwgebieden ruime omgeving Hoegaarden"
    ) ~ "Leemstreek",
    TRUE ~ "Limburg"
  )) %>%
  filter(regio != "Limburg")

leemstreek <- landbouwstreken %>%
  filter(NAAM == "Leemstreek") %>%
  st_intersection(vlaanderen)

polders <- landbouwstreken %>%
  filter(NAAM == "Polders") %>%
  st_intersection(vlaanderen)
```

```{r map-1, out.width="100%"}
mapview(leemstreek) +
  mapview(polders) +
  mapview(plan_kiekendief_perimeter)
```

```{r}
leemstreek_pk <- leemstreek %>%
  st_cast("POLYGON") %>%
  st_filter(plan_kiekendief_perimeter)

polders_pk <- polders %>%
  st_cast("POLYGON") %>%
  st_filter(plan_kiekendief_perimeter)
  
```

```{r map-2, out.width="100%"}
mapview(leemstreek_pk, color = "brown", col.regions = "brown") +
  mapview(polders_pk) +
  mapview(plan_kiekendief_perimeter, zcol = "regio")
```

We gaan verder met enkel de Leemstreek.

## Exclusie van bepaalde landgebruiken

- https://wiki.openstreetmap.org/wiki/Key:leisure
    - park
- https://wiki.openstreetmap.org/wiki/Key:landuse
    - residential
    - military
    - industrial
    - cemetery

```{r leemstreek-exclusie}
# Define the vectortranslate options
landuse_exclusie_vectortranslate = c(
  "-t_srs", "EPSG:31370",
  "-select", "landuse",
  "-where", "landuse IN ('residential', 'military', 'industrial', 'cemetery') OR 
  leisure IN ('park')",
  "-nlt", "PROMOTE_TO_MULTI"
)

leemstreek_exclusie <- oe_get(
  place = leemstreek_pk,
  layer = "multipolygons",
  vectortranslate_options = landuse_exclusie_vectortranslate,
  boundary = leemstreek_pk,
  boundary_type = "clipsrc",
  download_directory = here("data", "osmdata"))

leemstreek_exclusie <- leemstreek_exclusie %>%
  st_cast("GEOMETRYCOLLECTION") %>%
  mutate(id = seq_len(nrow(.))) %>%
  st_collection_extract("POLYGON") %>%
  aggregate(list(.$id), first, do_union = FALSE) %>%
  select(-id, -Group.1) %>%
  as_tibble %>%
  st_as_sf()
```


Verder vereenvoudigen van de polygonenkaart door:

- alle polygonen samen te voegen tot 1 multipolygon (union)
- bufferen met straal 20 m
- overtollige vertices verwijderen met tolerantie 10 m
- alle gaten (polygon holes) verwijderen


```{r exclusie-simplified}
leemstreek_exclusie %>%
  st_union() %>%
  st_buffer(dist = 20) %>%
  st_simplify(dTolerance = 10) %>%
  st_remove_holes() -> leemstreek_exclusie_simplified
```

```{r map-exclusies, out.width="100%"}
complex <- leemstreek_exclusie %>%
  mapview()
eenvoudig <- leemstreek_exclusie_simplified %>%
  mapview()

leafsync::sync(complex, eenvoudig)
```

## Bepalen geldige plaatsen waar telling kan uitgevoerd worden

Extractie uit Openstreetmap:

- https://wiki.openstreetmap.org/wiki/Key:highway
    - track
    - footway
    - path
    - cycleway
    - bridleway
    - tertiary
    - tertiary_link
    - unclassified

```{r leemstreek-paden}
# Define the vectortranslate options
my_vectortranslate = c(
  "-t_srs", "EPSG:31370",
  "-select", "highway",
  "-where", "highway IN ('track', 'footway', 'path', 'cycleway',
  'bridleway', 'tertiary', 'tertiary_link', 'unclassified')",
  "-nlt", "PROMOTE_TO_MULTI"
)

# Read-in data
leemstreek_paden <- oe_get(
  place = leemstreek_pk,
  vectortranslate_options = my_vectortranslate,
  boundary = leemstreek_pk,
  boundary_type = "spat",
  download_directory = here("data", "osmdata"))
```

Verwijderen van paden die overlappen met exclusiekaart.

```{r verwijder-paden}
leemstreek_paden %>%
  st_difference(
    leemstreek_exclusie_simplified) %>%
  st_intersection(
    leemstreek_pk %>% st_buffer(dist = 10)) -> leemstreek_paden_kader
```

```{r map-5, out.width="100%"}
mapview(leemstreek_exclusie_simplified) +
  mapview(leemstreek_paden_kader)
```

Overzicht totale lengte per categorie:

```{r lengte-paden}
leemstreek_paden_kader %>%
  group_by(highway) %>%
  summarise() %>%
  mutate(lengte_km = as.numeric(st_length(.)) / 1e3) %>%
  st_drop_geometry() %>%
  kable(digits = 1)
```

## Verrastering van de paden

- verrasteren op 10 m resolutie
- Verderwerken met centroïden van elke rastercel

## Berekening van attributen in buffer met straal 300 m

Voor elke centroïde:

- BO oppervlaktes
- landgebruik oppervlaktes
- KLE oppervlaktes / lengtes
- kwantiel van de hoogteligging ter plaatse van de centroïde (om in te schatten of de centroïde laag, gemiddeld of hoog gelegen is in omgevend landschap)
- maat voor complexiteit van het landschap (=> OLA vs KLA)

## Exclusie telcirkels op basis van attributen

Nodig?

Criteria?

- oppervlakte-aandeel landbouw < x ha
- ...


## DTM

Opvragen van DTM op 20 m resolutie.
Dit is wellicht voldoende resolutie?
Hogere resolutie via WCS opvragen gaf error voor zo'n groot gebied - de DTM is origineel op 1 m resolutie, maar dat is wellicht niet nodig.

```{r leemstreek-dtm, eval=!file.exists(here("data", "dtm", "leemstreek_dtm.tif"))}
bbox <- round(st_bbox(leemstreek_pk))
bbox <- bbox[c("xmin", "xmax", "ymin", "ymax")]

leemstreek_dtm20 <- get_coverage_wcs(
  wcs = "dtm",
  bbox = bbox,
  layername = "EL.GridCoverage.DTM",
  resolution = 20)
```

```{r}
terra::plot(leemstreek_dtm20)
```

